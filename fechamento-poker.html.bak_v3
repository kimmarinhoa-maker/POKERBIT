<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fechamento Semanal · Poker Manager</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --bg:#0d1117;--sb:#0a0d13;--s1:#161b27;--s2:#1c2333;--s3:#222d42;
  --b1:#21293d;--b2:#2a3550;
  --gold:#f0b429;--gold-d:rgba(240,180,41,.12);--gold-b:rgba(240,180,41,.22);
  --green:#10b981;--green-d:rgba(16,185,129,.1);
  --red:#ef4444;--red-d:rgba(239,68,68,.1);
  --blue:#3b82f6;--teal:#14b8a6;--purple:#a855f7;
  --t1:#e2e8f0;--t2:#94a3b8;--t3:#4a5568;
  --sw:240px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;display:flex;overflow:hidden;}

/* ── SIDEBAR ── */
.sidebar{width:var(--sw);background:var(--sb);border-right:1px solid var(--b1);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;}
.sb-logo{padding:22px 20px 18px;border-bottom:1px solid var(--b1);}
.logo-mark{display:flex;align-items:center;gap:10px;}
.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--gold),#c47d00);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 4px 14px rgba(240,180,41,.3);}
.logo-txt{font-size:.95rem;font-weight:700;letter-spacing:-.3px;}
.logo-txt span{color:var(--gold);}
.sb-sec{padding:18px 12px 6px;}
.sb-sec-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);padding:0 8px;margin-bottom:8px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:.845rem;font-weight:500;color:var(--t2);margin-bottom:2px;transition:all .15s;border:1px solid transparent;}
.nav-item:hover{background:var(--s2);color:var(--t1);}
.nav-item.active{background:var(--gold-d);color:var(--gold);border-color:rgba(240,180,41,.2);}
.nav-item .ni{font-size:.9rem;width:18px;text-align:center;}
.nav-item .nav-badge{margin-left:auto;background:var(--s3);border-radius:9px;padding:1px 7px;font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--t3);}
.nav-item.active .nav-badge{background:rgba(240,180,41,.2);color:var(--gold);}
.sb-bottom{margin-top:auto;padding:14px 12px;border-top:1px solid var(--b1);}
.week-pill-sb{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:9px 12px;}
.week-pill-sb .wv{font-family:'JetBrains Mono',monospace;color:var(--gold);font-weight:600;display:block;margin-top:2px;font-size:.77rem;}
.week-pill-sb .wlbl{font-size:.65rem;color:var(--t3);text-transform:uppercase;letter-spacing:1px;font-weight:700;}

/* ── MAIN ── */
.main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;height:100vh;overflow-y:auto;}
.topbar{background:var(--sb);border-bottom:1px solid var(--b1);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;}
.topbar-title{font-size:.95rem;font-weight:600;}
.topbar-title span{color:var(--t2);font-weight:400;}
.topbar-right{display:flex;align-items:center;gap:10px;}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 7px var(--green);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.content{padding:28px 28px 50px;flex:1;}

/* ── STEP 1: IMPORT GERAL ── */
.import-hero{background:var(--s1);border:1px solid var(--b1);border-radius:16px;padding:40px;margin-bottom:24px;}
.import-hero-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;}
.import-hero-title{font-size:1.5rem;font-weight:800;letter-spacing:-.5px;line-height:1.2;}
.import-hero-title span{color:var(--gold);}
.import-hero-sub{color:var(--t2);font-size:.875rem;margin-top:6px;line-height:1.5;}

/* WEEK SELECTOR */
.week-section{margin-bottom:32px;}
.sec-lbl{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.4px;color:var(--t3);margin-bottom:12px;}
.week-row{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.week-nav-btn{width:36px;height:36px;border-radius:8px;background:var(--s2);border:1px solid var(--b2);color:var(--t1);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.week-nav-btn:hover{border-color:var(--gold);color:var(--gold);}
.week-display{background:var(--s2);border:1px solid var(--b2);border-radius:9px;padding:9px 20px;font-family:'JetBrains Mono',monospace;font-size:.875rem;font-weight:600;color:var(--gold);min-width:240px;text-align:center;}
.week-chips{display:flex;flex-wrap:wrap;gap:6px;}
.wchip{background:var(--s2);border:1px solid var(--b1);border-radius:16px;padding:5px 12px;font-size:.71rem;font-family:'JetBrains Mono',monospace;cursor:pointer;color:var(--t2);transition:all .18s;}
.wchip:hover{border-color:var(--b2);color:var(--t1);}
.wchip.active{border-color:var(--gold);color:var(--gold);background:var(--gold-d);}

/* DROP ZONE */
.drop-section{margin-bottom:28px;}
.drop-zone{border:2px dashed var(--b2);border-radius:14px;padding:48px 32px;text-align:center;cursor:pointer;transition:all .25s;background:var(--s2);}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--gold);background:rgba(240,180,41,.04);}
.drop-zone.loaded{border-color:var(--green);background:rgba(16,185,129,.04);}
.drop-icon{font-size:2.8rem;margin-bottom:14px;display:block;}
.drop-title{font-size:1.05rem;font-weight:700;margin-bottom:6px;}
.drop-sub{font-size:.82rem;color:var(--t3);line-height:1.6;}
.drop-formats{display:inline-block;margin-top:14px;background:var(--s1);border:1px solid var(--b2);padding:5px 14px;border-radius:18px;font-size:.73rem;color:var(--gold);font-family:'JetBrains Mono',monospace;}
.drop-btn{display:inline-flex;align-items:center;gap:7px;margin-top:18px;background:linear-gradient(135deg,var(--gold),#c47d00);color:#000;border:none;padding:11px 28px;border-radius:9px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.875rem;cursor:pointer;box-shadow:0 4px 16px rgba(240,180,41,.25);transition:all .2s;}
.drop-btn:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(240,180,41,.35);}

/* COL MAPPER */
.mapper-card{background:var(--s2);border:1px solid var(--b2);border-radius:12px;padding:20px 22px;margin-bottom:22px;display:none;}
.mapper-card.show{display:block;animation:fadeIn .3s ease;}
.mapper-title{font-size:.88rem;font-weight:700;margin-bottom:4px;}
.mapper-sub{font-size:.78rem;color:var(--t2);margin-bottom:18px;}
.cm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:10px;margin-bottom:18px;}
.cm-field label{display:block;font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:5px;}
.cm-field select{width:100%;background:var(--s3);border:1px solid var(--b2);color:var(--t1);padding:7px 9px;border-radius:7px;font-family:'Outfit',sans-serif;font-size:.8rem;cursor:pointer;}
.cm-field select:focus{outline:none;border-color:var(--gold);}

.btn-primary{background:linear-gradient(135deg,var(--gold),#c47d00);color:#000;border:none;padding:11px 26px;border-radius:9px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.875rem;cursor:pointer;display:inline-flex;align-items:center;gap:7px;box-shadow:0 4px 16px rgba(240,180,41,.25);transition:all .2s;}
.btn-primary:hover{transform:translateY(-1px);}
.btn-primary:disabled{opacity:.35;pointer-events:none;}
.btn-sec{background:transparent;color:var(--t2);border:1px solid var(--b2);padding:11px 20px;border-radius:9px;font-family:'Outfit',sans-serif;font-size:.875rem;cursor:pointer;transition:all .2s;}
.btn-sec:hover{border-color:var(--t2);color:var(--t1);}

/* ── OVERVIEW: ALL CLUBS ── */
.overview-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.overview-title{font-size:1.3rem;font-weight:800;letter-spacing:-.4px;}
.overview-title span{color:var(--gold);}
.overview-week{font-family:'JetBrains Mono',monospace;font-size:.82rem;color:var(--t2);background:var(--s2);border:1px solid var(--b2);padding:6px 14px;border-radius:20px;}

.overview-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:24px;}
.ok-card{background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:16px 18px;position:relative;overflow:hidden;}
.ok-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.ok-card.g::after{background:var(--gold);}
.ok-card.gr::after{background:var(--green);}
.ok-card.r::after{background:var(--red);}
.ok-card.b::after{background:var(--blue);}
.ok-lbl{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:7px;}
.ok-val{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;letter-spacing:-.5px;}
.ok-val.g{color:var(--gold);}
.ok-val.gr{color:var(--green);}
.ok-val.r{color:var(--red);}
.ok-val.b{color:var(--blue);}

/* CLUB CARDS OVERVIEW */
.clubs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-bottom:28px;}
.club-ov-card{background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.club-ov-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:3px;}
.club-ov-card.imperio::before{background:var(--gold);}
.club-ov-card.confraria::before{background:var(--green);}
.club-ov-card.tbet::before{background:var(--purple);}
.club-ov-card.tgp::before{background:#fb923c;}
.club-ov-card.ch::before{background:var(--blue);}
.club-ov-card:hover{border-color:var(--b2);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3);}
.coc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.coc-name{display:flex;align-items:center;gap:9px;font-size:1rem;font-weight:700;}
.coc-count{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--t3);background:var(--s2);padding:3px 9px;border-radius:10px;}
.coc-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.coc-stat{background:var(--s2);border-radius:8px;padding:9px 11px;}
.coc-stat-lbl{font-size:.64rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);margin-bottom:4px;}
.coc-stat-val{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:600;}
.coc-action{display:flex;align-items:center;justify-content:space-between;}
.coc-btn{background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:7px 14px;border-radius:7px;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;}
.coc-btn:hover{color:var(--t1);border-color:var(--t2);}
.coc-unlinked{font-size:.73rem;color:var(--red);display:flex;align-items:center;gap:4px;}
.coc-unlinked.ok{color:var(--green);}

/* ── DETAIL VIEW (per club) ── */
.detail-layout{display:grid;grid-template-columns:210px 1fr;gap:18px;}
.detail-nav{background:var(--s1);border:1px solid var(--b1);border-radius:13px;padding:14px;height:fit-content;position:sticky;top:20px;}
.dn-title{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.4px;color:var(--t3);margin-bottom:10px;}
.dn-item{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:7px;cursor:pointer;font-size:.82rem;color:var(--t2);transition:all .15s;margin-bottom:2px;border:1px solid transparent;}
.dn-item:hover{background:var(--s2);color:var(--t1);}
.dn-item.active{background:var(--gold-d);color:var(--gold);border-color:rgba(240,180,41,.2);}
.dn-item .dnc{margin-left:auto;background:var(--s3);border-radius:9px;padding:1px 7px;font-size:.67rem;font-family:'JetBrains Mono',monospace;color:var(--t3);}
.dn-item.active .dnc{background:rgba(240,180,41,.2);color:var(--gold);}
.rb-itab{background:var(--s2);border:1px solid var(--b1);color:var(--t2);padding:6px 16px;border-radius:7px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;font-family:'Outfit',sans-serif;}
.rb-itab:hover{color:var(--t1);border-color:var(--b2);}
.rb-itab.rb-itab-active{background:var(--gold-d);color:var(--gold);border-color:rgba(240,180,41,.25);}

.detail-content{background:var(--s1);border:1px solid var(--b1);border-radius:13px;padding:22px;min-height:500px;}
.dc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--b1);}
.dc-clube{display:flex;align-items:center;gap:12px;}
.dc-icon{width:44px;height:44px;border-radius:11px;background:var(--gold-d);border:2px solid rgba(240,180,41,.3);display:flex;align-items:center;justify-content:center;font-size:1.4rem;}
.dc-name{font-size:1.15rem;font-weight:700;}
.dc-week{font-size:.74rem;color:var(--t2);margin-top:2px;font-family:'JetBrains Mono',monospace;}
.dc-actions{display:flex;align-items:center;gap:8px;}
.back-btn{background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:7px 13px;border-radius:7px;cursor:pointer;font-size:.78rem;font-family:'Outfit',sans-serif;transition:all .2s;display:flex;align-items:center;gap:5px;}
.back-btn:hover{border-color:var(--t2);color:var(--t1);}

.sub-tab{display:none;}
.sub-tab.active{display:block;animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* KPI ROW */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.km{background:var(--s2);border:1px solid var(--b1);border-radius:11px;padding:13px;position:relative;overflow:hidden;}
.km::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.km.g::after{background:var(--gold);}
.km.gr::after{background:var(--green);}
.km.r::after{background:var(--red);}
.km.b::after{background:var(--blue);}
.km-lbl{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:6px;}
.km-val{font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:600;}
.km-val.g{color:var(--gold);}
.km-val.gr{color:var(--green);}
.km-val.r{color:var(--red);}
.km-val.b{color:var(--blue);}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;gap:8px;flex-wrap:wrap;}
.tl{display:flex;align-items:center;gap:7px;}
.tr{display:flex;align-items:center;gap:7px;}
.search-box{background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:7px 12px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.8rem;width:180px;}
.search-box:focus{outline:none;border-color:var(--gold);}
.search-box::placeholder{color:var(--t3);}
.fsel{background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:7px 9px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.79rem;cursor:pointer;}
.fsel:focus{outline:none;border-color:var(--gold);}
.btn-sm{background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:7px 12px;border-radius:7px;font-family:'Outfit',sans-serif;font-size:.77rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;}
.btn-sm:hover{border-color:var(--gold);color:var(--gold);}

.unl-bar{background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2);border-radius:9px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
.unl-txt{font-size:.8rem;color:var(--red);display:flex;align-items:center;gap:7px;}
.btn-link-all{background:var(--red);color:#fff;border:none;padding:6px 13px;border-radius:7px;font-family:'Outfit',sans-serif;font-weight:600;font-size:.76rem;cursor:pointer;}
.btn-link-all:hover{filter:brightness(1.1);}

/* TABLE */
.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:1050px;}
thead{background:rgba(20,29,47,.9);}
th{padding:9px 11px;font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);text-align:left;white-space:nowrap;border-bottom:1px solid var(--b1);}
td{padding:8px 11px;font-size:.79rem;border-bottom:1px solid rgba(33,41,61,.45);vertical-align:middle;white-space:nowrap;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.016);}
.mono{font-family:'JetBrains Mono',monospace;font-size:.74rem;}

/* PADRONIZAÇÃO — tabelas do sistema */
.tbl-wrap{overflow-x:auto;}
.tbl{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--b1);border-radius:10px;overflow:hidden;}
.tbl thead th{padding:10px 14px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);background:var(--s2);border-bottom:1px solid var(--b1);white-space:nowrap;}
.tbl tbody tr{transition:background .12s;}
.tbl tbody tr:hover{background:rgba(255,255,255,.02);}
.tbl tbody tr.fin-pago{opacity:.5;transition:opacity .2s;}
.tbl tbody tr.fin-pago:hover{opacity:1;}
.tbl tbody td{padding:10px 14px;border-bottom:1px solid var(--b1);font-size:.78rem;vertical-align:middle;}
.tbl tbody td:not(:first-child){text-align:right;font-family:'JetBrains Mono',monospace;font-size:.76rem;}
.tbl tbody tr:last-child td{border-bottom:none;}

.ct{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:17px;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;}
.ct-imp{background:rgba(240,180,41,.13);color:var(--gold);border:1px solid rgba(240,180,41,.22);}
.ct-ch{background:rgba(59,130,246,.13);color:#60a5fa;border:1px solid rgba(59,130,246,.22);}
.ct-3bt{background:rgba(168,85,247,.13);color:#c084fc;border:1px solid rgba(168,85,247,.22);}
.ct-con{background:rgba(16,185,129,.13);color:var(--green);border:1px solid rgba(16,185,129,.22);}
.ct-tgp{background:rgba(249,115,22,.13);color:#fb923c;border:1px solid rgba(249,115,22,.22);}
.ct-unk{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.25);cursor:pointer;}
.ct-unk:hover{background:rgba(239,68,68,.2);}

.fb{display:inline-block;padding:2px 8px;border-radius:9px;font-size:.66rem;font-weight:600;}
.fb-j{background:rgba(14,165,233,.1);color:#38bdf8;}
.fb-a{background:rgba(240,180,41,.1);color:var(--gold);}
.fb-s{background:rgba(168,85,247,.1);color:#c084fc;}

.rb-wrap{display:flex;align-items:center;gap:4px;}
.rb-inp{background:var(--s3);border:1px solid var(--b2);color:var(--gold);width:58px;padding:4px 7px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:.76rem;text-align:center;}
.rb-inp:focus{outline:none;border-color:var(--gold);}
.rb-pct{color:var(--t3);font-size:.72rem;}

.vp{color:var(--green);font-family:'JetBrains Mono',monospace;font-size:.7rem;}
.vn{color:var(--red);font-family:'JetBrains Mono',monospace;font-size:.7rem;}
.vz{color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:.7rem;}
.vm{color:var(--t2);font-family:'JetBrains Mono',monospace;font-size:.7rem;}

.pagination{display:flex;align-items:center;justify-content:space-between;padding:10px 0 0;}
.pg-info{font-size:.76rem;color:var(--t3);}
.pg-btns{display:flex;gap:5px;}
.pg-btn{background:var(--s2);border:1px solid var(--b1);color:var(--t2);padding:5px 10px;border-radius:6px;cursor:pointer;font-size:.76rem;font-family:'Outfit',sans-serif;transition:all .15s;}
.pg-btn:hover{border-color:var(--gold);color:var(--gold);}
.pg-btn.act{background:var(--gold-d);border-color:var(--gold);color:var(--gold);}
.pg-btn:disabled{opacity:.3;pointer-events:none;}

.empty-tbl{text-align:center;padding:45px 20px;color:var(--t3);}
.empty-tbl .ei{font-size:2.3rem;margin-bottom:10px;}
.empty-tbl p{font-size:.8rem;line-height:1.6;}

/* ═══ FINANCEIRO SaaS DASHBOARD ═══ */
.fin-filter-btn{padding:5px 13px;border-radius:7px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--b2);background:var(--s2);color:var(--t3);transition:all .15s;}
.fin-filter-btn.active{background:rgba(240,180,41,.1);border-color:rgba(240,180,41,.3);color:var(--gold);}
.fin-filter-btn[data-filter="aberto"].active{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.25);color:#ef4444;}
.fin-filter-btn[data-filter="parcial"].active{background:rgba(251,146,60,.1);border-color:rgba(251,146,60,.25);color:#fb923c;}
.fin-filter-btn[data-filter="pago"].active{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.25);color:#10b981;}

/* KPI strip */
/* Fin Sub-tabs */
.fin-stabs{display:flex;gap:4px;border-bottom:1px solid var(--b1);padding-bottom:0;}
.fin-stab{background:none;border:none;border-bottom:2px solid transparent;color:var(--t3);padding:8px 16px;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .15s;}
.fin-stab:hover{color:var(--t1);}
.fin-stab.active{color:var(--gold);border-bottom-color:var(--gold);}
.conc-tabs{display:flex;gap:4px;background:var(--s2);border-radius:8px;padding:3px;}
.conc-tab{background:none;border:none;color:var(--t3);padding:7px 14px;font-size:.72rem;font-weight:700;cursor:pointer;border-radius:6px;transition:all .15s;}
.conc-tab:hover{color:var(--t1);background:rgba(255,255,255,.04);}
.conc-tab.active{color:var(--t1);background:var(--s1);box-shadow:0 1px 3px rgba(0,0,0,.2);}
.badge-linked{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:2px 8px;border-radius:5px;font-size:.6rem;font-weight:700;}
.badge-unlinked{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.2);color:#fb923c;padding:2px 8px;border-radius:5px;font-size:.6rem;font-weight:700;}
.badge-applied{background:rgba(129,140,248,.1);border:1px solid rgba(129,140,248,.2);color:#818cf8;padding:2px 8px;border-radius:5px;font-size:.6rem;font-weight:700;}
.conc-summary{display:flex;gap:16px;flex-wrap:wrap;padding:12px 0;margin-bottom:12px;border-bottom:1px solid var(--b1);}
.conc-summary .cs-box{text-align:center;}
.conc-summary .cs-lbl{font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;}
.conc-summary .cs-val{font-weight:800;font-size:.82rem;}
.conc-entity-sel{background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:4px 8px;border-radius:6px;font-size:.72rem;max-width:180px;cursor:pointer;}
.conc-btn{padding:5px 12px;border-radius:6px;font-size:.7rem;font-weight:700;cursor:pointer;border:1px solid;transition:all .15s;}
.conc-btn-link{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.25);color:#10b981;}
.conc-btn-link:hover{background:rgba(16,185,129,.2);}
.conc-btn-ign{background:none;border-color:var(--b1);color:var(--t3);font-size:.68rem;padding:3px 8px;}
.bank-card{background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.bank-card .bank-name{font-weight:700;color:var(--t1);font-size:.82rem;}
.bank-card .bank-info{font-size:.68rem;color:var(--t3);}
.bank-card .bank-default{background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:2px 8px;border-radius:5px;font-size:.58rem;font-weight:700;margin-left:8px;}
.bank-card .bank-actions{display:flex;gap:6px;}
.bank-card .bank-actions button{background:none;border:1px solid var(--b1);color:var(--t3);padding:4px 8px;border-radius:5px;font-size:.68rem;cursor:pointer;}
.bank-card .bank-actions button:hover{color:var(--t1);border-color:var(--t3);}
.fkpi-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;}
.fkpi{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;position:relative;overflow:hidden;transition:border-color .2s;}
.fkpi:hover{border-color:var(--b2);}
.fkpi-lbl{font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:7px;display:flex;align-items:center;gap:5px;}
.fkpi-val{font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:800;line-height:1;}
.fkpi-sub{font-size:.6rem;color:var(--t3);margin-top:4px;}
.fkpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.fkpi.green::after{background:linear-gradient(90deg,#10b981,rgba(16,185,129,.2));}
.fkpi.red::after{background:linear-gradient(90deg,#ef4444,rgba(239,68,68,.2));}
.fkpi.blue::after{background:linear-gradient(90deg,#3b82f6,rgba(59,130,246,.2));}
.fkpi.purple::after{background:linear-gradient(90deg,#8b5cf6,rgba(139,92,246,.2));}
.fkpi.gold::after{background:linear-gradient(90deg,var(--gold),rgba(240,180,41,.2));}

/* Controls bar */
.fin-controls{display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;}
.fin-search{background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:7px 12px 7px 32px;border-radius:8px;font-size:.78rem;width:220px;outline:none;transition:border-color .15s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:10px center;}
.fin-search:focus{border-color:rgba(240,180,41,.4);}
.fin-search::placeholder{color:var(--t3);}
.fin-toggle{display:flex;align-items:center;gap:6px;font-size:.72rem;color:var(--t3);cursor:pointer;padding:5px 10px;border-radius:7px;border:1px solid var(--b2);background:var(--s2);transition:all .15s;user-select:none;}
.fin-toggle.on{background:rgba(96,165,250,.1);border-color:rgba(96,165,250,.3);color:#60a5fa;}
.fin-toggle .fin-sw{width:28px;height:15px;border-radius:20px;background:var(--b2);position:relative;transition:background .2s;}
.fin-toggle .fin-sw::after{content:'';position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:var(--t3);transition:all .2s;}
.fin-toggle.on .fin-sw{background:rgba(96,165,250,.5);}
.fin-toggle.on .fin-sw::after{left:15px;background:#60a5fa;}

/* Table — see .tbl above */

/* Entity cell */
.fin-ent{display:flex;align-items:center;gap:9px;}
.fin-ent-ico{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.82rem;flex-shrink:0;}
.fin-ent-ico.ag{background:rgba(192,132,252,.1);border:1px solid rgba(192,132,252,.18);}
.fin-ent-ico.pl{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.18);}
.fin-ent-name{font-weight:700;font-size:.8rem;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;}
.fin-ent-sub{font-size:.62rem;color:var(--t3);margin-top:1px;}

/* Status pill */
.fin-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.64rem;font-weight:700;white-space:nowrap;}
.fin-pill.aberto{background:rgba(239,68,68,.09);border:1px solid rgba(239,68,68,.15);color:#ef4444;}
.fin-pill.parcial{background:rgba(251,146,60,.09);border:1px solid rgba(251,146,60,.18);color:#fb923c;}
.fin-pill.pago{background:rgba(16,185,129,.09);border:1px solid rgba(16,185,129,.18);color:#10b981;}
.fin-pill.neutro{background:var(--s2);border:1px solid var(--b2);color:var(--t3);}

/* Action buttons */
.fin-act{display:flex;gap:5px;justify-content:center;}
.fin-act button{padding:4px 9px;border-radius:6px;font-size:.65rem;font-weight:700;cursor:pointer;border:1px solid;transition:all .12s;white-space:nowrap;}
.fin-act .fa-recv{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.2);color:#10b981;}
.fin-act .fa-recv:hover{background:rgba(16,185,129,.18);}
.fin-act .fa-pay{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.2);color:#60a5fa;}
.fin-act .fa-pay:hover{background:rgba(96,165,250,.18);}
.fin-act .fa-hist{background:var(--s2);border-color:var(--b2);color:var(--t3);}
.fin-act .fa-hist:hover{background:rgba(255,255,255,.06);color:var(--t2);}

/* History Drawer */
.fin-drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9998;opacity:0;pointer-events:none;transition:opacity .25s;}
.fin-drawer-overlay.open{opacity:1;pointer-events:auto;}
.fin-drawer{position:fixed;top:0;right:-480px;width:460px;max-width:92vw;height:100vh;background:var(--s1);border-left:1px solid var(--b1);z-index:9999;transition:right .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;box-shadow:-8px 0 32px rgba(0,0,0,.4);}
.fin-drawer.open{right:0;}
.fin-drawer-head{padding:18px 20px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.fin-drawer-close{background:var(--s2);border:1px solid var(--b2);color:var(--t2);width:30px;height:30px;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all .12s;}
.fin-drawer-close:hover{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.2);color:#ef4444;}
.fin-drawer-body{flex:1;overflow-y:auto;padding:16px 20px;}
.fin-drawer-foot{padding:14px 20px;border-top:1px solid var(--b1);flex-shrink:0;}

/* Drawer items */
.fd-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:18px;}
.fd-box{background:var(--s2);border-radius:8px;padding:10px 12px;text-align:center;}
.fd-box-lbl{font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:4px;}
.fd-box-val{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:.88rem;}
.fd-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--s2);border-radius:8px;margin-bottom:6px;transition:background .1s;}
.fd-item:hover{background:rgba(255,255,255,.04);}
.fd-dir{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.72rem;flex-shrink:0;}
.fd-dir.in{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.18);color:#10b981;}
.fd-dir.out{background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.18);color:#60a5fa;}
.fd-info{flex:1;min-width:0;}
.fd-metodo{font-size:.72rem;font-weight:700;color:var(--t1);}
.fd-meta{font-size:.62rem;color:var(--t3);margin-top:1px;}
.fd-val{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:.82rem;white-space:nowrap;}
.fd-actions{display:flex;gap:4px;flex-shrink:0;}
.fd-actions button{background:none;border:none;color:var(--t3);cursor:pointer;padding:3px;border-radius:4px;font-size:.72rem;transition:all .1s;}
.fd-actions button:hover{color:#ef4444;background:rgba(239,68,68,.08);}
.fd-empty{text-align:center;padding:32px 16px;color:var(--t3);font-size:.8rem;}

/* Metodo btn (kept) */
.fin-metodo-btn{padding:7px 14px;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;border:1px solid var(--b2);background:var(--s2);color:var(--t2);transition:all .15s;}
.fin-metodo-btn.active{background:rgba(240,180,41,.12);border-color:var(--gold);color:var(--gold);}
.saldo-prev-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);border-radius:6px;padding:3px 8px;font-size:.68rem;color:#ef4444;font-weight:600;}

/* auto-save indicator */
.autosave-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#10b981;margin-right:4px;animation:pulse-green 2s infinite;}
@keyframes pulse-green{0%,100%{opacity:1}50%{opacity:.3}}

/* ── OFX ── */
.ofx-filter{padding:4px 12px;border-radius:7px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--b2);background:var(--s2);color:var(--t3);transition:all .15s;}
.ofx-filter.active{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.3);color:#60a5fa;}
.ofx-bank-tab{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:.7rem;font-weight:700;border:1px solid rgba(59,130,246,.25);background:rgba(59,130,246,.07);color:#60a5fa;}
.ofx-tab-x{background:none;border:none;color:rgba(96,165,250,.5);cursor:pointer;padding:0;font-size:.75rem;line-height:1;margin-left:2px;transition:color .1s;}
.ofx-tab-x:hover{color:#ef4444;}
.ofx-row td{padding:7px 10px;border-bottom:1px solid var(--b1);font-size:.77rem;vertical-align:middle;}
.ofx-row:hover td{background:rgba(255,255,255,.02);}
.ofx-row.aplicado td{opacity:.4;}
.ofx-row.ignorado td{opacity:.28;}
.ofx-entity-select{background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:5px 8px;border-radius:7px;font-size:.72rem;width:100%;cursor:pointer;outline:none;}
.ofx-entity-select:focus{border-color:rgba(59,130,246,.5);}
.ofx-badge-vinc{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.ofx-badge-aplic{background:rgba(129,140,248,.1);border:1px solid rgba(129,140,248,.2);color:#818cf8;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.ofx-badge-pend{background:rgba(251,146,60,.08);border:1px solid rgba(251,146,60,.2);color:#fb923c;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.ofx-badge-ign{background:var(--s2);border:1px solid var(--b2);color:var(--t3);padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.ofx-btn-ign{background:none;border:none;color:var(--t3);cursor:pointer;font-size:.75rem;padding:2px 6px;border-radius:5px;transition:all .1s;}
.ofx-btn-ign:hover{color:#ef4444;background:rgba(239,68,68,.08);}

/* ── CP DROPDOWN CUSTOMIZADO ── */
.cp-dd{position:relative;width:100%;}
.cp-dd-trigger{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:5px 8px;border-radius:7px;font-size:.72rem;cursor:pointer;gap:4px;min-width:0;}
.cp-dd-trigger:hover{border-color:rgba(16,185,129,.4);}
.cp-dd-trigger.active{border-color:rgba(16,185,129,.5);border-radius:7px 7px 0 0;}
.cp-dd-trigger span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.cp-dd-panel{display:none;position:absolute;top:100%;left:0;right:0;background:var(--s1);border:1px solid rgba(16,185,129,.35);border-top:none;border-radius:0 0 8px 8px;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,.4);}
.cp-dd-panel.open{display:block;}
.cp-dd-input{width:100%;box-sizing:border-box;background:var(--s2);border:none;border-bottom:1px solid var(--b1);color:var(--t1);padding:7px 10px;font-size:.72rem;outline:none;}
.cp-dd-input::placeholder{color:var(--t3);}
.cp-dd-list{max-height:180px;overflow-y:auto;}
.cp-dd-group{padding:5px 10px 2px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);background:var(--s2);}
.cp-dd-item{padding:6px 12px;font-size:.73rem;color:var(--t2);cursor:pointer;transition:background .1s;}
.cp-dd-item:hover,.cp-dd-item.focused{background:rgba(16,185,129,.1);color:#10b981;}
.cp-dd-item mark{background:rgba(16,185,129,.25);color:#10b981;border-radius:2px;padding:0 2px;}
.cp-dd-empty{padding:12px;text-align:center;font-size:.72rem;color:var(--t3);}


.cp-filter{padding:4px 12px;border-radius:7px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--b2);background:var(--s2);color:var(--t3);transition:all .15s;}
.cp-filter.active{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3);color:#34d399;}
.cp-row td{padding:7px 10px;border-bottom:1px solid var(--b1);font-size:.77rem;vertical-align:middle;}
.cp-row:hover td{background:rgba(255,255,255,.02);}
.cp-row.aplicado td{opacity:.4;}
.cp-row.ignorado td{opacity:.28;}
.cp-select{background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:5px 8px;border-radius:7px;font-size:.72rem;width:100%;cursor:pointer;outline:none;}
.cp-select:focus{border-color:rgba(16,185,129,.5);}
.cp-badge-vinc{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.cp-badge-aplic{background:rgba(129,140,248,.1);border:1px solid rgba(129,140,248,.2);color:#818cf8;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.cp-badge-pend{background:rgba(251,146,60,.08);border:1px solid rgba(251,146,60,.2);color:#fb923c;padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.cp-badge-ign{background:var(--s2);border:1px solid var(--b2);color:var(--t3);padding:2px 8px;border-radius:5px;font-size:.65rem;font-weight:700;}
.cp-btn-ign{background:none;border:none;color:var(--t3);cursor:pointer;font-size:.75rem;padding:2px 6px;border-radius:5px;transition:all .1s;}
.cp-btn-ign:hover{color:#ef4444;background:rgba(239,68,68,.08);}

/* ── FECHAMENTO DE AGENTES ── */
/* ── COMPROVANTES (card row layout) ── */
.comp-card{background:var(--s1);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;overflow:hidden;transition:border-color .2s;}
.comp-card:hover{border-color:var(--b2);}
.comp-card-dim{opacity:.4;}
.comp-row{display:flex;align-items:center;padding:8px 12px;gap:10px;}
.comp-left{display:flex;align-items:center;gap:7px;flex-shrink:0;min-width:160px;}
.comp-avatar{width:26px;height:26px;border-radius:6px;background:var(--gold-d);border:1px solid rgba(240,180,41,.25);display:flex;align-items:center;justify-content:center;font-size:.72rem;flex-shrink:0;}
.comp-name-line{display:flex;align-items:center;gap:5px;}
.comp-name{font-weight:700;font-size:.74rem;color:var(--t1);white-space:nowrap;}
.comp-cnt{font-size:.52rem;color:var(--t3);}
.comp-meta{margin-top:2px;}
.comp-badge{padding:1px 5px;border-radius:4px;font-size:.46rem;font-weight:700;border:1px solid;}
.comp-edit-btn{background:none;border:1px solid var(--b1);color:var(--t3);padding:0 3px;border-radius:3px;font-size:.42rem;cursor:pointer;line-height:1.3;margin-left:3px;}
.comp-tog{display:inline-flex;border:1px solid var(--b2);border-radius:4px;overflow:hidden;}
.comp-tog-btn{padding:1px 5px;font-size:.46rem;font-weight:700;cursor:pointer;border:none;background:transparent;color:var(--t3);transition:all .12s;white-space:nowrap;}
.comp-tog-btn.sel{background:rgba(255,255,255,.06);color:var(--t1);}
.comp-ok-btn{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);color:#10b981;padding:1px 6px;border-radius:4px;font-size:.46rem;font-weight:700;cursor:pointer;margin-left:3px;}
.comp-vals{display:flex;align-items:center;gap:16px;flex:1;justify-content:flex-end;}
.comp-v{text-align:right;flex-shrink:0;}
.comp-v-lbl{font-size:.38rem;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);font-weight:600;line-height:1;margin-bottom:1px;}
.comp-v-num{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;line-height:1.2;}
.comp-v-final{min-width:75px;}
.comp-v-res{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:900;line-height:1.2;}
.comp-actions{display:flex;align-items:center;gap:5px;flex-shrink:0;margin-left:6px;}
.comp-btn-gen{background:linear-gradient(135deg,var(--gold),#c47d00);color:#000;border:none;padding:5px 10px;border-radius:5px;font-size:.55rem;font-weight:700;cursor:pointer;white-space:nowrap;transition:opacity .15s;min-width:120px;text-align:center;}
.comp-btn-gen:hover{opacity:.85;}
.comp-btn-det{background:none;border:none;color:var(--t3);padding:3px 5px;font-size:.5rem;cursor:pointer;white-space:nowrap;transition:color .15s;}
.comp-btn-det:hover{color:var(--gold);}
.comp-expand{border-top:1px solid var(--b1);padding:12px 14px;background:rgba(255,255,255,.01);animation:cSlide .12s ease-out;}
@keyframes cSlide{from{opacity:0;transform:translateY(-3px);}to{opacity:1;transform:translateY(0);}}
.comp-fin{background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:8px 12px;max-width:360px;}
.comp-fin-r{display:flex;justify-content:space-between;align-items:center;font-size:.72rem;padding:2px 0;}
.comp-pl{width:100%;border-collapse:collapse;}
.comp-pl th{padding:3px 7px;font-size:.44rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);border-bottom:1px solid var(--b1);background:var(--s2);}
.comp-pl td{padding:3px 7px;font-size:.68rem;font-family:'JetBrains Mono',monospace;border-bottom:1px solid rgba(33,41,61,.1);}
.comp-pl tfoot td{font-weight:800;border-top:2px solid var(--b1);background:var(--s2);padding:4px 7px;}

/* PDF PREVIEW MODAL */
#pdf-modal .modal{width:680px;max-width:96vw;padding:0;overflow:hidden;}
.pdf-preview{background:#1a1f2e;padding:0;}
.pdf-doc{background:#fff;color:#111;font-family:'Outfit',sans-serif;padding:32px 36px;min-height:400px;}
.pdf-header-doc{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #f0b429;}
.pdf-logo{font-size:1.2rem;font-weight:800;color:#111;}
.pdf-logo span{color:#f0b429;}
.pdf-period{font-size:.78rem;color:#666;text-align:right;}
.pdf-agent-title{font-size:1.1rem;font-weight:800;margin-bottom:4px;color:#111;}
.pdf-agent-sub{font-size:.78rem;color:#888;margin-bottom:20px;}
.pdf-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:.78rem;}
.pdf-table th{background:#f8f4e8;padding:7px 10px;text-align:left;font-weight:700;color:#555;font-size:.68rem;text-transform:uppercase;letter-spacing:.5px;}
.pdf-table td{padding:7px 10px;border-bottom:1px solid #f0f0f0;}
.pdf-table tr:last-child td{border-bottom:none;}
.pdf-totals{background:#f8f4e8;border-radius:8px;padding:14px 16px;margin-bottom:16px;}
.pdf-total-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:.82rem;}
.pdf-total-row:last-child{margin-bottom:0;font-weight:800;font-size:.9rem;color:#111;border-top:1px solid #ddd;padding-top:8px;margin-top:4px;}
.pdf-total-label{color:#666;}
.pdf-total-val{font-family:'Courier New',monospace;font-weight:700;}
.pos-val{color:#16a34a;}
.neg-val{color:#dc2626;}
.pdf-footer-doc{margin-top:16px;padding-top:12px;border-top:1px solid #eee;font-size:.68rem;color:#aaa;text-align:center;}

.rs-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:9px;margin-bottom:6px;background:var(--s2);border:1px solid var(--b1);gap:12px;}
.rs-row.rs-row-ref{background:transparent;border-color:var(--b1);opacity:.7;}
.rs-row.rs-manual{background:var(--s2);border:1px solid var(--b2);}
.rs-label{font-size:.82rem;font-weight:600;color:var(--t1);display:flex;flex-direction:column;gap:3px;}
.rs-formula{font-size:.68rem;color:var(--t3);font-weight:400;}
.rs-val{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:700;min-width:130px;text-align:right;white-space:nowrap;}
.rs-val.gr{color:var(--green);}
.rs-val.rd{color:var(--red);}
.rs-input-wrap{display:flex;align-items:center;gap:7px;}
.rs-currency{font-size:.78rem;font-weight:700;color:var(--t3);}
.rs-inp{background:var(--s3);border:1px solid var(--b2);color:var(--gold);width:130px;padding:7px 10px;border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:.84rem;text-align:right;transition:border-color .2s;}
.rs-inp:focus{outline:none;border-color:var(--gold);}
.rs-final-box{background:linear-gradient(135deg,rgba(240,180,41,.08),rgba(240,180,41,.03));border:2px solid rgba(240,180,41,.25);border-radius:14px;padding:20px 22px;}
.rs-breakdown{display:flex;flex-wrap:wrap;gap:7px;margin-top:14px;padding-top:14px;border-top:1px solid rgba(240,180,41,.15);}
.rs-bd-item{background:rgba(240,180,41,.07);border:1px solid rgba(240,180,41,.14);border-radius:8px;padding:6px 12px;font-size:.73rem;display:flex;align-items:center;gap:6px;}
.rs-bd-lbl{color:rgba(240,180,41,.6);font-weight:600;white-space:nowrap;}
.rs-bd-val{font-family:'JetBrains Mono',monospace;font-weight:700;}
.rs-bd-val.pos{color:var(--green);}
.rs-bd-val.neg{color:var(--red);}
.rs-bd-val.neu{color:var(--t2);}

/* ── CONFIGURAÇÕES / LOGOS ── */
.cfg-card{background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:16px 18px;display:flex;align-items:center;gap:16px;}
.cfg-logo-preview{width:56px;height:56px;border-radius:12px;background:var(--s2);border:2px solid var(--b2);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;overflow:hidden;}
.cfg-logo-preview img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.cfg-info{flex:1;}
.cfg-name{font-size:.92rem;font-weight:700;color:var(--t1);}
.cfg-sub{font-size:.73rem;color:var(--t3);margin-top:3px;}
.cfg-actions{display:flex;gap:8px;align-items:center;}
.cfg-upload-btn{background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:7px 14px;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;}
.cfg-upload-btn:hover{border-color:var(--gold);color:var(--gold);}
.cfg-remove-btn{background:transparent;border:1px solid rgba(239,68,68,.3);color:rgba(239,68,68,.7);padding:7px 10px;border-radius:8px;font-size:.75rem;cursor:pointer;transition:all .15s;}
.cfg-remove-btn:hover{border-color:var(--red);color:var(--red);}
.ni-logo{width:18px;height:18px;border-radius:4px;object-fit:cover;vertical-align:middle;}
.dc-icon img{width:100%;height:100%;object-fit:cover;border-radius:9px;}
.coc-logo{width:28px;height:28px;border-radius:7px;object-fit:cover;vertical-align:middle;margin-right:4px;}

/* ── EXPANDABLE AGENT ROWS ── */
tr.agent-row{cursor:pointer;background:rgba(240,180,41,.05);}
tr.agent-row:hover td{background:rgba(240,180,41,.09)!important;}
tr.agent-row td{border-bottom:1px solid rgba(240,180,41,.15);font-weight:600;}
.agent-toggle{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:5px;background:var(--s3);border:1px solid var(--b2);font-size:.7rem;margin-right:6px;transition:transform .2s;flex-shrink:0;color:var(--gold);}
tr.agent-row.open .agent-toggle{transform:rotate(90deg);}
tr.player-sub{background:rgba(255,255,255,.012);}
tr.player-sub td{font-size:.76rem;border-bottom:1px solid rgba(33,41,61,.3);}
tr.player-sub td:first-child{padding-left:28px;}
tr.player-sub:last-of-type td{border-bottom:2px solid rgba(240,180,41,.12);}
tr.player-sub.hidden{display:none;}
.agent-name-cell{display:flex;align-items:center;}
.agent-count-badge{margin-left:8px;background:var(--s3);border-radius:8px;padding:1px 7px;font-size:.67rem;font-family:'JetBrains Mono',monospace;color:var(--t3);font-weight:400;}
/* Totals footer row */
tr.agent-total-row td{font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;background:rgba(240,180,41,.04);border-top:1px solid rgba(240,180,41,.15);border-bottom:2px solid rgba(240,180,41,.2);}
/* Grand total row */
tr.grand-total-row td{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:800;background:rgba(240,180,41,.1);border-top:2px solid rgba(240,180,41,.3);color:var(--gold);}

/* ── REDESIGNED TABLE V2 ── */
.v2-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px;}
.v2-kpi{background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:12px 14px;position:relative;overflow:hidden;}
.v2-kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.v2-kpi.k-rake::before{background:var(--green);}
.v2-kpi.k-rbp::before{background:#fb923c;}
.v2-kpi.k-rba::before{background:#c084fc;}
.v2-kpi.k-res::before{background:var(--gold);}
.v2-kpi.k-aberto::before{background:var(--red);}
.v2-kpi-lbl{font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.9px;color:var(--t3);margin-bottom:5px;}
.v2-kpi-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;}

/* Agent row V2 */
tr.ag2{cursor:pointer;background:rgba(240,180,41,.04);}
tr.ag2:hover td{background:rgba(240,180,41,.08)!important;}
tr.ag2 td{border-bottom:1px solid rgba(240,180,41,.12);padding:10px 11px;}
.ag2-name{display:flex;align-items:center;gap:7px;}
.ag2-toggle{width:18px;height:18px;border-radius:4px;background:var(--s3);border:1px solid var(--b2);display:inline-flex;align-items:center;justify-content:center;font-size:.6rem;color:var(--gold);transition:transform .2s;flex-shrink:0;}
tr.ag2.open .ag2-toggle{transform:rotate(90deg);}
.ag2-label{font-weight:700;font-size:.82rem;color:var(--t1);}
.ag2-count{background:var(--s3);border-radius:7px;padding:1px 7px;font-size:.62rem;font-family:'JetBrains Mono',monospace;color:var(--t3);}
.ag2-resultado{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:.82rem;padding:4px 10px;border-radius:6px;}
.ag2-resultado.pos{background:rgba(16,185,129,.1);color:#10b981;}
.ag2-resultado.neg{background:rgba(239,68,68,.08);color:#ef4444;}
.ag2-resultado.zero{background:rgba(74,85,104,.1);color:var(--t3);}

/* Player row V2 */
tr.pl2{background:transparent;}
tr.pl2 td{font-size:.77rem;padding:7px 11px;border-bottom:1px solid rgba(33,41,61,.3);}
tr.pl2.hidden{display:none;}
tr.pl2 td:first-child{padding-left:32px;}
.pl2-nick{font-weight:600;color:var(--t1);font-size:.8rem;}
.pl2-id{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--t3);margin-top:1px;}
.pl2-rb{display:flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;font-size:.7rem;}
.pl2-rb-pct{color:var(--t3);font-size:.65rem;}
.pl2-rb-val{color:#a3e635;font-weight:700;}
.pl2-resultado{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:.8rem;padding:3px 8px;border-radius:5px;display:inline-block;}
.pl2-resultado.pos{background:rgba(16,185,129,.08);color:#10b981;}
.pl2-resultado.neg{background:rgba(239,68,68,.06);color:#ef4444;}
.pl2-resultado.zero{color:var(--t3);}
.pl2-saldo-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:.68rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.pl2-saldo-badge.deve{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.15);color:#ef4444;}
.pl2-saldo-badge.receber{background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.15);color:#60a5fa;}
.pl2-saldo-badge.quitado{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.15);color:#10b981;}
/* Level 3 subtle */
.v2-subtle{color:var(--t3)!important;font-size:.7rem!important;}

/* Agent summary footer */
tr.ag2-footer td{background:rgba(240,180,41,.06);border-bottom:2px solid rgba(240,180,41,.15);padding:0;}
tr.ag2-footer.hidden{display:none;}
.ag2-summary{display:flex;gap:16px;padding:10px 14px 10px 32px;flex-wrap:wrap;align-items:center;}
.ag2-sum-item{text-align:center;}
.ag2-sum-lbl{font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);margin-bottom:2px;}
.ag2-sum-val{font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:700;}
.ag2-sum-sep{width:1px;height:28px;background:var(--b2);flex-shrink:0;}

.cs{text-align:center;padding:50px 20px;color:var(--t3);}
.cs .ci{font-size:2.5rem;margin-bottom:12px;}
.cs h3{font-size:.92rem;color:var(--t2);margin-bottom:7px;}
.cs p{font-size:.8rem;line-height:1.6;}
.cs-badge{display:inline-block;margin-top:12px;background:var(--gold-d);color:var(--gold);border:1px solid rgba(240,180,41,.25);padding:5px 14px;border-radius:17px;font-size:.7rem;font-weight:600;}

/* MODALS */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.mo.open{display:flex;animation:fadeIn .2s ease;}
.modal{background:var(--s1);border:1px solid var(--b2);border-radius:16px;padding:24px;width:460px;max-width:92vw;max-height:90vh;overflow-y:auto;}
.modal-title{font-size:1rem;font-weight:700;margin-bottom:5px;}
.modal-sub{font-size:.81rem;color:var(--t2);margin-bottom:18px;}
.modal-lbl{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:8px;}
.pi{background:var(--s2);border:1px solid var(--b1);border-radius:9px;padding:11px 14px;margin-bottom:16px;}
.pi-id{font-family:'JetBrains Mono',monospace;font-size:.84rem;color:var(--gold);font-weight:600;}
.pi-nick{font-size:.79rem;color:var(--t2);margin-top:3px;}
.pi-agent{font-size:.73rem;color:var(--t3);margin-top:2px;}
.co-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:18px;}
.co{background:var(--s2);border:2px solid var(--b1);border-radius:9px;padding:9px 12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:8px;font-size:.82rem;font-weight:600;color:var(--t2);}
.co:hover{border-color:var(--b2);color:var(--t1);}
.co.sel{border-color:var(--gold);background:var(--gold-d);color:var(--gold);}
.ma{display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{background:transparent;border:1px solid var(--b2);color:var(--t2);padding:8px 17px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.82rem;cursor:pointer;transition:all .2s;}
.btn-cancel:hover{border-color:var(--t2);color:var(--t1);}
.btn-confirm{background:linear-gradient(135deg,var(--gold),#c47d00);color:#000;border:none;padding:8px 20px;border-radius:8px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer;}

#toast{position:fixed;bottom:20px;right:20px;background:var(--s2);border:1px solid var(--green);color:var(--green);padding:10px 17px;border-radius:9px;font-size:.8rem;font-weight:600;transform:translateY(70px);opacity:0;transition:all .3s;z-index:999;}
#toast.show{transform:translateY(0);opacity:1;}
#toast.err{border-color:var(--red);color:var(--red);}

/* STEP PAGES */
.page{display:none;}
.page.active{display:block;animation:fadeIn .3s ease;}

/* ══════ HAMBURGER ══════ */
.hamburger-btn{display:none;background:none;border:1px solid var(--b1);color:var(--t1);font-size:1.2rem;padding:4px 8px;border-radius:6px;cursor:pointer;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:49;}

/* ══════ RESPONSIVE ══════ */

/* Tablet */
@media(max-width:1024px){
  .kpi-row{grid-template-columns:repeat(2,1fr)!important;}
}

/* Mobile */
@media(max-width:768px){
  .hamburger-btn{display:block;}
  .sidebar{transform:translateX(-100%);transition:transform .25s ease;}
  .sidebar.open{transform:translateX(0);}
  .sidebar-overlay.open{display:block;}
  .main{margin-left:0!important;}
  .topbar{padding:10px 14px!important;}
  .topbar-title{font-size:.82rem!important;}
  .content{padding:12px!important;}
  .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}

  /* Tables scroll horizontally */
  table{display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;}
  thead,tbody,tfoot,tr{display:table;width:100%;table-layout:auto;}
  .dn-tabs{flex-wrap:wrap;gap:2px;}
  .dn-tabs .dn-item{font-size:.62rem;padding:6px 8px;}
  .dc-header{flex-direction:column;gap:10px;align-items:flex-start!important;}
  .dc-actions{width:100%;justify-content:flex-start!important;flex-wrap:wrap;}

  .comp-row{flex-wrap:wrap;gap:8px;}
  .comp-left{min-width:unset;width:100%;}
  .comp-vals{width:100%;justify-content:space-between;}
  .comp-actions{width:100%;justify-content:flex-end;}

  /* Config */
  .cfg-card{flex-direction:column!important;align-items:flex-start!important;}

  /* Week chips scroll */
  .week-chips{overflow-x:auto;flex-wrap:nowrap!important;-webkit-overflow-scrolling:touch;padding-bottom:4px;}

  /* Overview cards */
  .club-cards{grid-template-columns:1fr!important;}

  /* Modals full-width */
  .modal{width:96vw!important;max-width:96vw!important;margin:2vh auto!important;}

  /* Fech dashboard grid */
  .fech-club-grid{grid-template-columns:1fr!important;}

  /* Hide topbar-right on very small */
  .topbar-right span{display:none;}
}

/* Small phone */
@media(max-width:480px){
  .kpi-row{grid-template-columns:1fr!important;}
  .km{min-width:unset!important;}
  .topbar-title span{display:none;}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sb-logo">
    <div class="logo-mark">
      <div class="logo-icon">♠</div>
      <div><div class="logo-txt">Poker<span>Manager</span></div></div>
    </div>
  </div>
  <div class="sb-sec">
    <div class="sb-sec-lbl">Navegação</div>
    <div class="nav-item active" id="nav-home" onclick="goPage('import')"><span class="ni">🏠</span> Início / Importar</div>
    <div class="nav-item" id="nav-overview" onclick="goPage('overview')"><span class="ni">📊</span> Visão Geral <span class="nav-badge" id="sb-total">0</span></div>
    <div class="nav-item" id="nav-config" onclick="goPage('config')"><span class="ni">⚙️</span> Configurações</div>
  </div>
  <div class="sb-sec">
    <div class="sb-sec-lbl">Fechamento por Clube</div>
    <div class="nav-item" id="nav-fech-dash" onclick="goPage('fech-dash')" style="font-size:.78rem;"><span class="ni">💼</span> Dashboard <span class="nav-badge" id="sb-fech-status" style="background:var(--gold-d);color:var(--gold);">—</span></div>
    <div class="nav-item" id="nav-imp" onclick="goClube('IMPÉRIO')"><span class="ni">👑</span> Império <span class="nav-badge" id="sb-imp">0</span></div>
    <div class="nav-item" id="nav-con" onclick="goClube('CONFRARIA')"><span class="ni">🎯</span> Confraria <span class="nav-badge" id="sb-con">0</span></div>
    <div class="nav-item" id="nav-3bt" onclick="goClube('3BET')"><span class="ni">🃏</span> 3Bet <span class="nav-badge" id="sb-3bt">0</span></div>
    <div class="nav-item" id="nav-tgp" onclick="goClube('TGP')"><span class="ni">🏆</span> TGP <span class="nav-badge" id="sb-tgp">0</span></div>
    <div class="nav-item" id="nav-ch" onclick="goClube('CH')"><span class="ni">⚡</span> CH <span class="nav-badge" id="sb-ch">0</span></div>
  </div>
  <div class="sb-sec">
    <div class="sb-sec-lbl">Consolidação</div>
    <div class="nav-item" id="nav-lancamentos" onclick="goPage('lancamentos')"><span class="ni">📝</span> Lançamentos</div>
    <div class="nav-item" id="nav-liga-global" onclick="goPage('liga-global')"><span class="ni">🏆</span> Liga Consolidado</div>
    <div class="nav-item" id="nav-caixa-global" onclick="goPage('caixa-global')"><span class="ni">🏦</span> Caixa Geral</div>
  </div>
  <div class="sb-bottom">
    <div class="week-pill-sb" style="cursor:pointer;position:relative;" onclick="toggleWeekDropdown(event)">
      <span class="wlbl">Semana Selecionada ▾</span>
      <span class="wv" id="sb-week">—</span>
      <div id="week-dropdown" style="display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--s1);border:1px solid var(--b1);border-radius:8px;margin-bottom:4px;max-height:280px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:999;">
        <div id="week-dropdown-items"></div>
      </div>
    </div>
    <div style="padding:8px 12px;font-size:.67rem;color:var(--t3);display:flex;align-items:center;gap:5px;border-top:1px solid var(--b1);margin-top:4px;">
      <span class="autosave-dot"></span> Configurações salvas automaticamente
    </div>
  </div>
</aside>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="hamburger-btn" onclick="toggleMobileSidebar()">☰</button>
      <div class="topbar-title">Poker Manager <span>/ <span id="topbarLabel">Importação Geral</span></span></div>
    </div>
    <div class="topbar-right"><div class="status-dot"></div><span style="font-size:.78rem;color:var(--t2)">Sistema Ativo</span></div>
  </div>
  <div class="content">

    <!-- ════ PAGE: IMPORT ════ -->
    <div class="page active" id="page-import">
      <div class="import-hero">
        <div class="import-hero-header">
          <div>
            <div class="import-hero-title">Importação <span>Geral</span></div>
            <div class="import-hero-sub">Importe a planilha completa <strong>uma única vez</strong>.<br>O sistema distribui os jogadores automaticamente para cada clube.</div>
          </div>
          <div id="import-status-badge" style="display:none;background:var(--green-d);border:1px solid rgba(16,185,129,.3);border-radius:10px;padding:9px 14px;text-align:right;">
            <div style="font-size:.65rem;color:var(--t3);text-transform:uppercase;letter-spacing:1px;font-weight:700;">Planilha Carregada</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;color:var(--green);font-weight:600;margin-top:2px;" id="imp-status-file">—</div>
          </div>
        </div>

        <!-- WEEK -->
        <div class="week-section">
          <div class="sec-lbl">1. Selecione a Semana do Fechamento</div>
          <div class="week-row">
            <button class="week-nav-btn" onclick="changeWeek(-1)">‹</button>
            <div class="week-display" id="weekDisplay">—</div>
            <button class="week-nav-btn" onclick="changeWeek(1)">›</button>
          </div>
          <div class="week-chips" id="weekChips"></div>
        </div>

        <!-- DROP -->
        <div class="drop-section">
          <div class="sec-lbl">2. Importe a Planilha Completa (todos os clubes)</div>
          <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileMain').click()">
            <span class="drop-icon" id="dropIcon">📊</span>
            <div class="drop-title" id="dropTitle">Arraste a planilha aqui ou clique para selecionar</div>
            <div class="drop-sub" id="dropSub">Planilha geral com todos os jogadores de todos os clubes</div>
            <div class="drop-formats">.xlsx &nbsp;·&nbsp; .xls &nbsp;·&nbsp; .csv</div>
            <div><label class="drop-btn">📂 Escolher Arquivo</label></div>
          </div>
          <input type="file" id="fileMain" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFile(this.files[0])">
        </div>

        <!-- MAPPER -->
        <div class="mapper-card" id="mapperCard">
          <div class="mapper-title">⚙️ Mapear Colunas</div>
          <div class="mapper-sub">Confirme quais colunas da planilha correspondem a cada campo. Detectamos automaticamente — ajuste se necessário.</div>
          <div class="cm-grid" id="cmGrid"></div>
          <div style="display:flex;align-items:center;gap:12px;">
            <button class="btn-primary" id="btnProcess" onclick="processImport()">✔ Processar e Distribuir para os Clubes</button>
            <button class="btn-sec" onclick="resetImport()">↺ Cancelar</button>
          </div>
        </div>

      </div><!-- /import-hero -->

      <!-- DIAGNOSTIC PANEL -->
      <div id="diagPanel" style="display:none;background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:22px;margin-bottom:20px;animation:fadeIn .3s ease;"></div>

      <!-- REGRAS INFO -->
      <div style="background:var(--s1);border:1px solid var(--b1);border-radius:14px;padding:22px;">
        <div style="font-size:.82rem;font-weight:700;color:var(--t2);margin-bottom:14px;text-transform:uppercase;letter-spacing:1px;font-size:.68rem;">📋 Regras de Classificação Automática por Agente</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;">
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--b1);">
            <span style="font-size:1.2rem">👑</span>
            <div style="font-weight:700;font-size:.82rem;color:var(--gold);margin-top:5px;">Império</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);margin-top:4px;line-height:1.7;">AMS...<br>BB AMS...<br>TW...</div>
          </div>
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--b1);">
            <span style="font-size:1.2rem">⚡</span>
            <div style="font-weight:700;font-size:.82rem;color:#60a5fa;margin-top:5px;">CH</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);margin-top:4px;line-height:1.7;">CH...</div>
          </div>
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--b1);">
            <span style="font-size:1.2rem">🃏</span>
            <div style="font-weight:700;font-size:.82rem;color:#c084fc;margin-top:5px;">3Bet</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);margin-top:4px;line-height:1.7;">3BET...</div>
          </div>
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--b1);">
            <span style="font-size:1.2rem">🎯</span>
            <div style="font-weight:700;font-size:.82rem;color:var(--green);margin-top:5px;">Confraria</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);margin-top:4px;line-height:1.7;">CONFRA...</div>
          </div>
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid var(--b1);">
            <span style="font-size:1.2rem">🏆</span>
            <div style="font-weight:700;font-size:.82rem;color:#fb923c;margin-top:5px;">TGP</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--t3);margin-top:4px;line-height:1.7;">TGP...</div>
          </div>
          <div style="background:var(--s2);border-radius:9px;padding:11px;border:1px solid rgba(239,68,68,.2);">
            <span style="font-size:1.2rem">⚠️</span>
            <div style="font-weight:700;font-size:.82rem;color:var(--red);margin-top:5px;">Não Identificado</div>
            <div style="font-size:.72rem;color:var(--t3);margin-top:4px;line-height:1.5;">Vinculação manual após importação</div>
          </div>
        </div>
      </div>

    </div><!-- /page-import -->

    <!-- ════ PAGE: OVERVIEW ════ -->
    <div class="page" id="page-overview">
      <div class="overview-header">
        <div>
          <div class="overview-title">Visão <span>Geral</span></div>
          <div style="font-size:.82rem;color:var(--t2);margin-top:3px;">Todos os clubes · Clique num clube para detalhar</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="overview-week" id="ov-week">—</div>
          <button class="btn-sec" style="font-size:.8rem;padding:8px 14px;" onclick="goPage('import')">↺ Nova Importação</button>
        </div>
      </div>

      <div class="overview-kpis">
        <div class="ok-card g"><div class="ok-lbl">Total Jogadores</div><div class="ok-val g" id="ov-total">0</div></div>
        <div class="ok-card gr"><div class="ok-lbl">Rake Geral</div><div class="ok-val gr" id="ov-rake">—</div></div>
        <div class="ok-card r"><div class="ok-lbl">Rakeback Geral</div><div class="ok-val r" id="ov-rb">—</div></div>
        <div class="ok-card b"><div class="ok-lbl">Não Classificados</div><div class="ok-val b" id="ov-unk" style="color:var(--red)">0</div></div>
      </div>

      <div class="clubs-grid" id="clubsGrid"></div>

      <!-- ALL PLAYERS TABLE on overview -->
      <div style="background:var(--s1);border:1px solid var(--b1);border-radius:13px;padding:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
          <div style="font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);">Todos os Jogadores</div>
          <div style="display:flex;gap:7px;">
            <input class="search-box" type="text" placeholder="🔍 Buscar..." oninput="filterAll(this.value)" id="srchAll">
            <button class="btn-sm" onclick="exportAll()">⬇ Exportar CSV</button>
          </div>
        </div>
        <div id="unl-bar-ov" class="unl-bar" style="display:none">
          <div class="unl-txt">⚠️ <span id="unl-count-ov">0</span> jogadores sem classificação — clique no badge ⚠ para vincular</div>
          <button class="btn-link-all" onclick="openBulk()">Vincular Todos</button>
        </div>
        <div id="ignored-bar" style="display:none;align-items:center;gap:10px;padding:8px 14px;background:rgba(107,114,128,.08);border:1px solid rgba(107,114,128,.2);border-radius:8px;margin-bottom:8px;flex-wrap:wrap;">
          <div style="font-size:.68rem;color:var(--t2);">🚫 <strong id="ignored-count">0</strong> agente(s) ignorado(s) — jogadores excluídos dos fechamentos</div>
          <button onclick="openIgnoredPanel()" style="font-size:.6rem;padding:3px 10px;border-radius:5px;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;">Ver / Reativar</button>
        </div>
        <!-- Painel de agentes ignorados (colapsável) -->
        <div id="ignored-panel" style="display:none;background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:12px 14px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:.7rem;font-weight:700;color:var(--t2);">Agentes Ignorados</span>
            <button onclick="document.getElementById('ignored-panel').style.display='none'" style="font-size:.6rem;background:none;border:none;color:var(--t3);cursor:pointer;">✕ fechar</button>
          </div>
          <div id="ignored-list"></div>
        </div>
        <div class="tw">
          <table class="tbl" style="min-width:960px;">
            <thead><tr>
              <th>Jogador / Agência</th>
              <th>Clube</th>
              <th style="text-align:right">Ganhos</th>
              <th style="text-align:right">Rake</th>
              <th style="text-align:right">Rakeback</th>
              <th style="text-align:right">Resultado Semana</th>
            </tr></thead>
            <tbody id="allBody"></tbody>
          </table>
        </div>
        <div class="pagination"><div class="pg-info" id="allPgInfo">0 registros</div><div class="pg-btns" id="allPgBtns"></div></div>
      </div>
    </div><!-- /page-overview -->

    <!-- ════ PAGE: CONFIGURAÇÕES ════ -->
    <div class="page" id="page-config">
      <div style="max-width:640px;margin:0 auto;">
        <div style="margin-bottom:28px;">
          <div style="font-size:1.3rem;font-weight:800;letter-spacing:-.4px;">⚙️ Configurações <span style="color:var(--gold)">Globais</span></div>
          <div style="font-size:.84rem;color:var(--t2);margin-top:5px;">Regras da Liga, taxas e personalização dos clubes.</div>
        </div>

        <!-- Liga Rules -->
        <div style="background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:18px 20px;margin-bottom:20px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <div>
              <div style="font-size:.88rem;font-weight:700;color:var(--t1);">🏆 Regras da Liga</div>
              <div style="font-size:.7rem;color:var(--t3);margin-top:2px;">Taxas aplicadas automaticamente nos cálculos de todos os clubes</div>
            </div>
            <button onclick="resetLigaConfig()" style="background:var(--s2);border:1px solid var(--b1);color:var(--t3);padding:4px 10px;border-radius:5px;font-size:.58rem;cursor:pointer;">↻ Reset Padrão</button>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;" id="liga-config-grid">
            <!-- rendered by JS -->
          </div>
        </div>

        <!-- Club Logos -->
        <div style="background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:18px 20px;margin-bottom:20px;">
          <div style="font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:4px;">🎨 Logos dos Clubes</div>
          <div style="font-size:.7rem;color:var(--t3);margin-bottom:14px;">Aparecem no sidebar, cards, cabeçalhos e comprovantes</div>
          <div style="display:flex;flex-direction:column;gap:10px;" id="config-clubs-list">
            <!-- gerado por JS -->
          </div>
        </div>

        <!-- Backup / Restore -->
        <div style="background:var(--s1);border:1px solid var(--b1);border-radius:12px;padding:18px 20px;margin-bottom:20px;">
          <div style="font-size:.88rem;font-weight:700;color:var(--t1);margin-bottom:4px;">💾 Backup & Restauração</div>
          <div style="font-size:.7rem;color:var(--t3);margin-bottom:14px;">Exporte/importe todo o estado do sistema. Proteja seus dados.</div>

          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px;">
            <button onclick="backupState()" style="background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);color:#10b981;padding:14px 10px;border-radius:10px;cursor:pointer;font-size:.72rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:6px;">
              <span style="font-size:1.4rem;">💾</span>Backup JSON
            </button>
            <label style="background:rgba(96,165,250,.06);border:1px solid rgba(96,165,250,.15);color:#60a5fa;padding:14px 10px;border-radius:10px;cursor:pointer;font-size:.72rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;">
              <span style="font-size:1.4rem;">📂</span>Restaurar JSON
              <input type="file" accept=".json" onchange="restoreState(this)" style="display:none;">
            </label>
            <button onclick="saveLocalSnapshot()" style="background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.15);color:var(--gold);padding:14px 10px;border-radius:10px;cursor:pointer;font-size:.72rem;font-weight:700;display:flex;flex-direction:column;align-items:center;gap:6px;">
              <span style="font-size:1.4rem;">🧷</span>Snapshot Local
            </button>
          </div>

          <div id="backup-snapshots-list" style="margin-bottom:8px;"></div>

          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:.58rem;color:var(--t3);" id="backup-info">Schema v—</span>
            <span style="font-size:.58rem;color:var(--t3);">·</span>
            <span style="font-size:.58rem;color:var(--t3);" id="backup-size">—</span>
          </div>
        </div>

        <!-- Danger Zone -->
        <div style="background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1);border-radius:12px;padding:18px 20px;margin-bottom:20px;">
          <div style="font-size:.88rem;font-weight:700;color:#ef4444;margin-bottom:4px;">⚠️ Zona de Perigo</div>
          <div style="font-size:.7rem;color:var(--t3);margin-bottom:14px;">Ações irreversíveis. Faça backup antes.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button onclick="clearAllData()" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:7px 14px;border-radius:7px;font-size:.68rem;font-weight:700;cursor:pointer;">🗑️ Limpar Todos os Dados</button>
            <button onclick="cleanDeadKeys()" style="background:var(--s2);border:1px solid var(--b1);color:var(--t3);padding:7px 14px;border-radius:7px;font-size:.68rem;cursor:pointer;">🧹 Limpar Chaves Órfãs</button>
          </div>
        </div>

        <div style="background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.15);border-radius:11px;padding:14px 16px;font-size:.8rem;color:rgba(240,180,41,.7);line-height:1.6;">
          💡 Todas as configurações são salvas automaticamente no navegador (localStorage).
        </div>
      </div>
    </div><!-- /page-config -->

    <!-- ════ PAGE: LANÇAMENTOS ════ -->
    <div class="page" id="page-lancamentos">
      <div id="lancamentos-content" style="margin:0 auto;">
        <div class="cs"><div class="ci">📝</div><h3>Lançamentos</h3><p>Importe a planilha primeiro.</p></div>
      </div>
    </div>

    <!-- ════ PAGE: LIGA CONSOLIDADO (GLOBAL) ════ -->
    <div class="page" id="page-liga-global">
      <div id="liga-global-content" style="margin:0 auto;">
        <div class="cs"><div class="ci">🏆</div><h3>Liga — Consolidado</h3><p>Importe a planilha primeiro.</p></div>
      </div>
    </div>

    <!-- ════ PAGE: FECHAMENTO DASHBOARD ════ -->
    <div class="page" id="page-fech-dash">
      <div id="fech-dash-content" style="margin:0 auto;">
        <div class="cs"><div class="ci">💼</div><h3>Fechamento por Clube</h3><p>Importe a planilha primeiro.</p></div>
      </div>
    </div>

    <!-- ════ PAGE: CAIXA GERAL ════ -->
    <div class="page" id="page-caixa-global">
      <div id="caixa-global-content" style="margin:0 auto;">
        <div class="cs"><div class="ci">🏦</div><h3>Caixa Geral</h3><p>Importe a planilha primeiro.</p></div>
      </div>
    </div>

    <!-- ════ PAGE: CLUBE DETAIL ════ -->
    <div class="page" id="page-clube">
      <div class="detail-layout">
        <div class="detail-nav">
          <div class="dn-title">Operação</div>
          <div class="dn-item active" onclick="switchDN(this,'dn-resumo')"><span class="ni">📋</span> Resumo do Clube</div>
          <div class="dn-item" onclick="switchDN(this,'dn-detalhamento')"><span class="ni">🔍</span> Detalhamento</div>
          <div class="dn-item" onclick="switchDN(this,'dn-rakeback')"><span class="ni">💸</span> Rakeback</div>
          <div style="margin:8px 0 4px;border-top:1px solid var(--b1);padding-top:8px;">
            <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);padding:0 10px 4px;font-weight:600;">Fechamentos</div>
          </div>
          <div class="dn-item" onclick="switchDN(this,'dn-jogadores')"><span class="ni">👥</span> Jogadores <span class="dnc" id="dn-count">0</span></div>
          <div class="dn-item" onclick="switchDN(this,'dn-fechamentos')"><span class="ni">💼</span> Liquidação</div>
          <div class="dn-item" onclick="switchDN(this,'dn-agentes')"><span class="ni">🤝</span> Comprovantes</div>
          <div class="dn-item" onclick="switchDN(this,'dn-extrato')"><span class="ni">📊</span> Extrato</div>
          <div style="margin:8px 0 4px;border-top:1px solid var(--b1);padding-top:8px;">
            <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);padding:0 10px 4px;font-weight:600;">Financeiro</div>
          </div>
          <div class="dn-item" onclick="switchDN(this,'dn-conciliacao')"><span class="ni">🔄</span> Conciliação</div>
          <div class="dn-item" onclick="switchDN(this,'dn-ajustes')"><span class="ni">🏦</span> Ajustes</div>
          <div style="margin:8px 0 4px;border-top:1px solid var(--b1);padding-top:8px;">
            <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);padding:0 10px 4px;font-weight:600;">Resultado</div>
          </div>
          <div class="dn-item" onclick="switchDN(this,'dn-resultado')"><span class="ni">📊</span> DRE</div>
          <div class="dn-item" onclick="switchDN(this,'dn-liga')"><span class="ni">🏆</span> Liga</div>
          <div style="margin-top:16px;padding-top:13px;border-top:1px solid var(--b1);">
            <button class="btn-primary" style="width:100%;justify-content:center;font-size:.77rem;padding:9px;" onclick="goPage('overview')">← Voltar à Visão Geral</button>
          </div>
        </div>
        <div class="detail-content">
          <div class="dc-header">
            <div class="dc-clube">
              <div class="dc-icon" id="dc-icon">♠</div>
              <div><div class="dc-name" id="dc-name">—</div><div class="dc-week" id="dc-week">—</div></div>
            </div>
            <div class="dc-actions" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <div id="dc-lock-btn"></div>
              <button class="btn-sm" onclick="openClubConfig()" style="font-size:.68rem;">⚙️ Config</button>
              <button class="btn-sm" onclick="exportResumoJPG()">📤 Exportar Resumo</button>
              <button class="btn-sm" onclick="exportClub()">⬇ CSV</button>
              <button class="back-btn" onclick="goPage('overview')">← Voltar</button>
            </div>
          </div>

          <!-- RESUMO -->
          <div class="sub-tab active" id="dn-resumo">
            <div id="resumo-content">
              <div class="cs"><div class="ci">📋</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- DETALHAMENTO -->
          <div class="sub-tab" id="dn-detalhamento">
            <div id="det-content">
              <div class="cs"><div class="ci">🔍</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- JOGADORES -->
          <div class="sub-tab" id="dn-jogadores">

            <!-- OPERATION BADGE -->
            <div style="margin-bottom:12px;">
              <span style="display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);padding:5px 12px;border-radius:7px;font-size:.62rem;font-weight:700;color:#10b981;letter-spacing:.5px;">🟢 OPERAÇÃO DA SEMANA</span>
            </div>

            <!-- 5 COMPACT KPIs -->
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px;" id="v2-kpis">
              <div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid var(--blue);">
                <div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">👥 Jogadores Ativos</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;color:var(--t1);" id="v2k-ativos">—</div>
              </div>
              <div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid var(--gold);">
                <div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">📈 Profit/Loss</div>
                <div style="font-size:.48rem;color:var(--t3);margin-bottom:2px;">Ganho/Perda bruta da operação</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;" id="v2k-pl">—</div>
              </div>
              <div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid var(--green);">
                <div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">💎 Rake Gerado</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;color:var(--green);" id="v2k-rake">—</div>
              </div>
              <div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid #a3e635;">
                <div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">💸 Rakeback Total</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;color:#a3e635;" id="v2k-rb">—</div>
              </div>
              <div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid var(--gold);">
                <div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">📊 Resultado Semana</div>
                <div style="font-size:.48rem;color:var(--t3);margin-bottom:2px;">Após rake e rakeback</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;" id="v2k-resultado">—</div>
              </div>
            </div>

            <div class="toolbar">
              <div class="tl">
                <input class="search-box" type="text" placeholder="🔍 Buscar..." oninput="filterClub(this.value)" id="srchClub">
              </div>
              <div class="tr">
                <button class="btn-sm" onclick="exportClub()">⬇ Exportar CSV</button>
              </div>
            </div>
            <div id="unl-bar-club" class="unl-bar" style="display:none">
              <div class="unl-txt">⚠️ <span id="unl-count-club">0</span> jogadores sem classificação</div>
              <button class="btn-link-all" onclick="openBulkClub()">Vincular</button>
            </div>
            <div class="tw">
              <table class="tbl" style="min-width:960px;">
                <thead><tr>
                  <th>Jogador / Agência</th>
                  <th style="text-align:right">Ganhos</th>
                  <th style="text-align:right">Rake</th>
                  <th style="text-align:right">Rakeback</th>
                  <th style="text-align:right">Resultado Semana</th>
                  <th style="text-align:right">Saldo Ant.</th>
                  <th style="text-align:right">Pagamento</th>
                  <th style="text-align:right">Saldo Atual</th>
                  <th>Situação</th>
                </tr></thead>
                <tbody id="clubBody"></tbody>
              </table>
            </div>
            <div class="pagination"><div class="pg-info" id="clubPgInfo">0 registros</div><div class="pg-btns" id="clubPgBtns"></div></div>
          </div>

          <!-- RAKEBACK -->
          <div class="sub-tab" id="dn-rakeback">
            <!-- Área comum: KPIs + busca + tabs (renderizada por JS) -->
            <div id="rb-common-area">
              <div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>
            </div>
            <!-- Panel: Agências -->
            <div id="rb-panel-agencias">
              <div id="rb-summary-content"></div>
            </div>
            <!-- Panel: Jogadores -->
            <div id="rb-panel-diretos" style="display:none;">
              <div id="rb-diretos-content"></div>
            </div>
          </div>

          <!-- FECHAMENTOS (Liquidação) -->
          <div class="sub-tab" id="dn-fechamentos">
            <!-- Header -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
              <div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-size:.95rem;font-weight:700;color:var(--t1);">💼 Fechamentos</span>
                  <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.15);padding:3px 10px;border-radius:6px;font-size:.55rem;font-weight:700;color:var(--gold);letter-spacing:.5px;">LIQUIDAÇÃO</span>
                </div>
                <div style="font-size:.72rem;color:var(--t3);margin-top:3px;">Controle de quem pagou, quem recebeu e o que está pendente</div>
              </div>
            </div>

            <!-- Dynamic content rendered by JS -->
            <div id="fech-full-content">
              <div class="cs"><div class="ci">💼</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- AGENTES -->
          <div class="sub-tab" id="dn-agentes">
            <!-- Header + KPIs -->
            <div style="margin-bottom:16px;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
                <div>
                  <div style="font-size:.9rem;font-weight:700;color:var(--t1);">📄 Comprovantes</div>
                  <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Gere e exporte extratos por agente</div>
                </div>
                <button class="btn-sm" onclick="exportAllAgentsPDF()">📄 Exportar Todos</button>
              </div>
              <div id="comp-kpis" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;"></div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <input class="search-box" type="text" id="agent-search" placeholder="🔍 Buscar agente..." oninput="filterAgentList(this.value)" style="flex:1;min-width:180px;max-width:360px;">
                <select id="comp-filter-result" onchange="filterAgentList(document.getElementById('agent-search').value)" style="background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:6px 10px;border-radius:6px;font-size:.7rem;">
                  <option value="all">Resultado: Todos</option>
                  <option value="pagar">A Pagar</option>
                  <option value="receber">A Receber</option>
                  <option value="zero">Sem Movimento</option>
                </select>
              </div>
            </div>

            <!-- Lista de agentes -->
            <div id="agent-closing-list">
              <div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- RESUMO FINANCEIRO -->
          <!-- RESULTADO DO CLUBE -->
          <div class="sub-tab" id="dn-resultado">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
              <div>
                <div style="font-size:.9rem;font-weight:700;color:var(--t1);">📊 DRE do Clube</div>
                <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Demonstração de Resultado — visão econômica completa da operação</div>
              </div>
            </div>
            <div id="resultado-clube-content">
              <div class="cs"><div class="ci">📊</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- CONSOLIDAÇÃO LIGA -->
          <div class="sub-tab" id="dn-liga">
            <div id="liga-content">
              <div class="cs"><div class="ci">🏆</div><h3>Consolidação Liga</h3><p>Importe a planilha primeiro</p></div>
            </div>
          </div>

          <!-- FINANCEIRO -->
          <!-- EXTRATO (read-only history) -->
          <div class="sub-tab" id="dn-extrato">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
              <div>
                <div style="font-size:.9rem;font-weight:700;color:var(--t1);">📊 Extrato</div>
                <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Histórico de movimentações e pagamentos registrados</div>
              </div>
            </div>
            <div style="background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.12);border-radius:8px;padding:8px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;">
              <span style="font-size:.78rem;">💼</span>
              <span style="font-size:.72rem;color:var(--t2);">Pagamentos e acertos são registrados na aba <strong style="color:var(--gold);">Liquidação</strong></span>
              <button onclick="document.querySelectorAll('.dn-item').forEach(i=>{if(i.textContent.includes('Liquidação'))i.click();});" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:4px 10px;border-radius:6px;font-size:.62rem;font-weight:700;cursor:pointer;margin-left:auto;">Ir para Liquidação →</button>
            </div>
            <!-- Reuses existing fin-content for extrato rendering -->
            <div id="fin-kpi-strip"></div>
            <div id="fin-filters" style="margin-bottom:12px;"></div>
            <div id="fin-content">
              <div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>
            </div>
          </div>

          <!-- CONCILIAÇÃO -->
          <div class="sub-tab" id="dn-conciliacao">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
              <div>
                <div style="font-size:.9rem;font-weight:700;color:var(--t1);">🔄 Conciliação</div>
                <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Cruzamento de pagamentos registrados com movimentações bancárias reais</div>
              </div>
            </div>
            <div style="background:rgba(96,165,250,.05);border:1px solid rgba(96,165,250,.1);border-radius:8px;padding:8px 14px;margin-bottom:14px;font-size:.72rem;color:var(--t2);">
              ℹ️ Importe ChipPix ou OFX para cruzar com os pagamentos registrados na Liquidação. Se bater → ✅. Se não → ⚠️.
            </div>
            <div class="conc-tabs" style="margin-bottom:14px;">
              <button class="conc-tab active" onclick="switchConcSub('chippix',this)">🎰 ChipPix</button>
              <button class="conc-tab" onclick="switchConcSub('ofx',this)">🏦 OFX (Bancos)</button>
              <button class="conc-tab" onclick="switchConcSub('ledger',this)">📒 Ledger</button>
            </div>
            <div id="conc-chippix" class="conc-panel">
              <div id="conc-cp-content"></div>
            </div>
            <div id="conc-ofx" class="conc-panel" style="display:none;">
              <div id="conc-ofx-content"></div>
            </div>
            <div id="conc-ledger" class="conc-panel" style="display:none;">
              <div id="conc-ledger-content"></div>
            </div>
          </div>

          <!-- AJUSTES (Financial Config) -->
          <div class="sub-tab" id="dn-ajustes">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:10px;">
              <div>
                <div style="font-size:.9rem;font-weight:700;color:var(--t1);">🏦 Ajustes</div>
                <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Contas bancárias, formas de pagamento e configurações financeiras do clube</div>
              </div>
            </div>
            <div class="conc-tabs" style="margin-bottom:14px;">
              <button class="conc-tab active" onclick="switchAjustesSub('contas',this)">🏦 Contas Bancárias</button>
              <button class="conc-tab" onclick="switchAjustesSub('formas',this)">💳 Formas de Pagamento</button>
              <button class="conc-tab" onclick="switchAjustesSub('categorias',this)">🏷️ Categorias OFX</button>
            </div>
            <div id="ajustes-panel-contas">
              <div id="conc-banks-content"></div>
            </div>
            <div id="ajustes-panel-formas" style="display:none;">
              <div id="ajustes-formas-content">
                <div class="cs"><div class="ci">💳</div><h3>Formas de pagamento configuradas</h3></div>
              </div>
            </div>
            <div id="ajustes-panel-categorias" style="display:none;">
              <div id="ajustes-categorias-content"></div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /page-clube -->

  </div><!-- /content -->
</div><!-- /main -->

<!-- MODAL PAGAMENTO -->
<div class="mo" id="mPagamento">
  <div class="modal" style="width:480px;">
    <div class="modal-title">💳 Registrar Pagamento</div>
    <div id="mpag-info" style="background:var(--s2);border-radius:9px;padding:12px 14px;margin-bottom:16px;font-size:.82rem;"></div>
    <div class="modal-lbl">Valor pago</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
      <span style="font-size:.8rem;color:var(--t3);font-weight:600;">R$</span>
      <input type="number" step="0.01" id="mpag-valor" placeholder="0,00"
        style="flex:1;background:var(--s2);border:1px solid var(--b2);color:var(--t1);border-radius:8px;padding:9px 12px;font-family:'JetBrains Mono',monospace;font-size:.9rem;">
      <button onclick="setPayFull()" style="background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:8px 12px;border-radius:8px;font-size:.72rem;cursor:pointer;white-space:nowrap;">Valor Total</button>
    </div>
    <div class="modal-lbl">Forma de pagamento</div>
    <div id="mpag-metodos" style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;"></div>
    <div class="modal-lbl">Comprovante <span style="color:var(--t3);font-weight:400;">(opcional)</span></div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <input type="text" id="mpag-comp-txt" placeholder="Chave PIX, ID transação, obs..." 
        style="flex:1;background:var(--s2);border:1px solid var(--b2);color:var(--t1);border-radius:8px;padding:8px 12px;font-size:.8rem;">
      <label style="background:var(--s2);border:1px solid var(--b2);color:var(--t2);padding:8px 12px;border-radius:8px;font-size:.72rem;cursor:pointer;white-space:nowrap;">
        📎 Foto
        <input type="file" accept="image/*" id="mpag-comp-img" style="display:none;" onchange="previewComp(this)">
      </label>
    </div>
    <div id="mpag-comp-preview" style="display:none;margin-bottom:14px;"></div>
    <div class="ma">
      <button class="btn-cancel" onclick="closeM('mPagamento')">Cancelar</button>
      <button class="btn-primary" onclick="confirmarPagamento()">✓ Confirmar Pagamento</button>
    </div>
  </div>
</div>

<!-- MODAL FORMAS DE PAGAMENTO -->
<div class="mo" id="mPayMethods">
  <div class="modal" style="width:400px;">
    <div class="modal-title">⚙️ Formas de Pagamento</div>
    <div id="mpay-list" style="margin-bottom:14px;"></div>
    <div style="display:flex;gap:8px;">
      <input type="text" id="mpay-new" placeholder="Nova forma (ex: Transferência)" 
        style="flex:1;background:var(--s2);border:1px solid var(--b2);color:var(--t1);border-radius:8px;padding:8px 12px;font-size:.8rem;">
      <button class="btn-primary" onclick="addNewPayMethod()" style="padding:8px 14px;font-size:.78rem;">+ Adicionar</button>
    </div>
    <div class="ma" style="margin-top:14px;">
      <button class="btn-cancel" onclick="closeM('mPayMethods')">Fechar</button>
    </div>
  </div>
</div>
<div class="mo" id="mLink">
  <div class="modal">
    <div class="modal-title">🔗 Vincular ao Clube</div>
    <div class="modal-sub">Selecione o clube para este jogador:</div>
    <div class="pi">
      <div class="pi-id" id="ml-id">—</div>
      <div class="pi-nick" id="ml-nick">—</div>
      <div class="pi-agent">Agente: <span id="ml-agent" style="color:var(--t2)">—</span></div>
    </div>
    <div class="modal-lbl">Clube</div>
    <div class="co-grid">
      <div class="co" data-opt="IMPÉRIO" onclick="pickOpt(this)"><span>👑</span> Império</div>
      <div class="co" data-opt="CONFRARIA" onclick="pickOpt(this)"><span>🎯</span> Confraria</div>
      <div class="co" data-opt="3BET" onclick="pickOpt(this)"><span>🃏</span> 3Bet</div>
      <div class="co" data-opt="TGP" onclick="pickOpt(this)"><span>🏆</span> TGP</div>
      <div class="co" data-opt="CH" onclick="pickOpt(this)"><span>⚡</span> CH</div>
    </div>
    <div class="ma">
      <button class="btn-cancel" onclick="closeM('mLink')">Cancelar</button>
      <button class="btn-confirm" onclick="confirmLink()">Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL BULK LINK -->
<div class="mo" id="mBulk">
  <div class="modal" style="width:520px;">
    <div class="modal-title">⚠️ Vincular Não Classificados</div>
    <div class="modal-sub" id="bulkSub">—</div>
    <div id="bulkList" style="max-height:360px;overflow-y:auto;margin-bottom:14px;"></div>
    <div class="ma"><button class="btn-cancel" onclick="closeM('mBulk')">Fechar</button></div>
  </div>
</div>

<!-- HISTORY DRAWER -->
<div class="fin-drawer-overlay" id="finDrawerOverlay" onclick="closeHistoryDrawer()"></div>
<div class="fin-drawer" id="finDrawer">
  <div class="fin-drawer-head">
    <div>
      <div id="fd-title" style="font-weight:700;font-size:.9rem;color:var(--t1);">Histórico</div>
      <div id="fd-subtitle" style="font-size:.68rem;color:var(--t3);margin-top:2px;">—</div>
    </div>
    <button class="fin-drawer-close" onclick="closeHistoryDrawer()">✕</button>
  </div>
  <div class="fin-drawer-body" id="fd-body"></div>
  <div class="fin-drawer-foot" id="fd-foot"></div>
</div>

<!-- PDF PREVIEW MODAL -->
<div class="mo" id="pdf-modal">
  <div class="modal" style="width:720px;padding:0;background:var(--s1);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--b1);">
      <div style="font-weight:700;font-size:.95rem;">📄 Comprovante do Agente</div>
      <div style="display:flex;gap:8px;">
        <button onclick="downloadAgentImage()" class="btn-primary" style="font-size:.78rem;padding:7px 16px;">⬇ Salvar JPG</button>
        <button onclick="closeM('pdf-modal')" class="btn-cancel" style="font-size:.78rem;padding:7px 14px;">✕ Fechar</button>
      </div>
    </div>
    <!-- O documento renderizado fica aqui -->
    <div style="padding:16px;overflow-y:auto;max-height:80vh;">
      <div id="pdf-doc-render"></div>
    </div>
  </div>
</div>

<!-- RESUMO EXPORT MODAL -->
<div class="mo" id="resumo-modal">
  <div class="modal" style="width:880px;max-width:96vw;padding:0;background:var(--s1);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--b1);">
      <div style="font-weight:700;font-size:.95rem;">📤 Resumo do Fechamento</div>
      <div style="display:flex;gap:8px;">
        <button onclick="downloadResumoJPG()" class="btn-primary" style="font-size:.78rem;padding:7px 16px;">⬇ Salvar JPG</button>
        <button onclick="closeM('resumo-modal')" class="btn-cancel" style="font-size:.78rem;padding:7px 14px;">✕ Fechar</button>
      </div>
    </div>
    <div style="padding:16px;overflow-y:auto;max-height:85vh;background:#e5e7eb;">
      <div id="resumo-doc-render" style="display:flex;justify-content:center;"></div>
    </div>
  </div>
</div>

<!-- MODAL EXTRATO DO PAGAMENTO -->
<div class="mo" id="mExtratoPag">
  <div class="modal" style="width:420px;">
    <div class="modal-title">🧾 Extrato do Pagamento</div>
    <div id="mextrato-body"></div>
    <div class="ma" style="margin-top:16px;">
      <button class="btn-cancel" onclick="closeM('mExtratoPag')">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR EXCLUSÃO -->
<div class="mo" id="mConfirmExcluir">
  <div class="modal" style="width:380px;">
    <div class="modal-title" style="color:#ef4444;">⚠️ Confirmar Exclusão</div>
    <div id="mconfirm-body" style="font-size:.84rem;color:var(--t2);margin-bottom:20px;line-height:1.6;"></div>
    <div class="ma">
      <button class="btn-cancel" onclick="closeM('mConfirmExcluir')">Cancelar</button>
      <button id="mconfirm-ok" class="btn-primary" style="background:linear-gradient(135deg,#ef4444,#dc2626);">🗑 Excluir</button>
    </div>
  </div>
</div>

<!-- MODAL CONCILIAÇÃO OFX -->
<div class="mo" id="mOFX">
  <div class="modal" style="width:860px;max-width:96vw;max-height:90vh;display:flex;flex-direction:column;padding:0;overflow:hidden;">

    <!-- Header fixo -->
    <div style="padding:16px 24px 14px;border-bottom:1px solid var(--b1);flex-shrink:0;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="modal-title" style="margin:0;">🏦 Conciliação Bancária — OFX</div>
          <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Vincule lançamentos bancários aos agentes. Tudo fica salvo até você aplicar.</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="display:inline-flex;align-items:center;gap:6px;background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.28);color:#60a5fa;padding:7px 14px;border-radius:8px;cursor:pointer;font-size:.75rem;font-weight:700;">
            ➕ Adicionar OFX
            <input type="file" accept=".ofx,.OFX" multiple onchange="processOFX(this)" style="display:none;">
          </label>
          <button onclick="closeM('mOFX')" style="background:none;border:none;color:var(--t3);font-size:1.2rem;cursor:pointer;line-height:1;padding:4px;">✕</button>
        </div>
      </div>

      <!-- Abas de bancos carregados -->
      <div id="ofx-bank-tabs" style="display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;"></div>
    </div>

    <!-- Área principal: empty state OU tabela -->
    <div id="ofx-empty" style="padding:40px 24px;text-align:center;flex-shrink:0;">
      <div style="width:64px;height:64px;border-radius:14px;background:rgba(59,130,246,.08);border:2px dashed rgba(59,130,246,.25);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 14px;">🏦</div>
      <div style="font-size:.86rem;font-weight:700;color:var(--t1);margin-bottom:6px;">Nenhum extrato carregado</div>
      <div style="font-size:.74rem;color:var(--t3);">Clique em <strong style="color:#60a5fa;">➕ Adicionar OFX</strong> para importar seu extrato bancário.<br>Você pode adicionar extratos de vários bancos ao mesmo tempo.</div>
    </div>

    <div id="ofx-main" style="display:none;flex-direction:column;overflow:hidden;flex:1;min-height:0;">

      <!-- Resumo dos bancos -->
      <div id="ofx-summary" style="padding:10px 24px;background:var(--s2);border-bottom:1px solid var(--b1);display:flex;gap:20px;flex-wrap:wrap;flex-shrink:0;align-items:center;"></div>

      <!-- Filtros -->
      <div style="padding:8px 24px;border-bottom:1px solid var(--b1);display:flex;gap:6px;align-items:center;flex-shrink:0;">
        <span style="font-size:.68rem;color:var(--t3);margin-right:2px;">Mostrar:</span>
        <button class="ofx-filter active" data-f="todos"     onclick="filtrarOFX(this,'todos')">Todos</button>
        <button class="ofx-filter"        data-f="vinculado" onclick="filtrarOFX(this,'vinculado')">✅ Vinculados</button>
        <button class="ofx-filter"        data-f="aplicado"  onclick="filtrarOFX(this,'aplicado')">💳 Aplicados</button>
        <button class="ofx-filter"        data-f="pendente"  onclick="filtrarOFX(this,'pendente')">⏳ Pendentes</button>
        <button class="ofx-filter"        data-f="ignorado"  onclick="filtrarOFX(this,'ignorado')">🚫 Ignorados</button>
        <div style="margin-left:auto;font-size:.7rem;color:var(--t3);" id="ofx-match-count"></div>
      </div>

      <!-- Tabela -->
      <div style="overflow-y:auto;flex:1;padding:0 24px 12px;">
        <table style="width:100%;border-collapse:collapse;margin-top:10px;">
          <thead style="position:sticky;top:0;z-index:2;">
            <tr style="background:var(--s2);">
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Data</th>
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Banco · Descrição</th>
              <th style="padding:7px 10px;text-align:right;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Valor</th>
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);min-width:190px;">Vincular a</th>
              <th style="padding:7px 10px;text-align:center;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Ação</th>
            </tr>
          </thead>
          <tbody id="ofx-tbody"></tbody>
        </table>
      </div>

      <!-- Footer -->
      <div style="padding:12px 24px;border-top:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--s1);">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="font-size:.74rem;color:var(--t3);" id="ofx-footer-info"></div>
          <button onclick="limparOFXAplicados()" style="background:none;border:none;color:var(--t3);font-size:.7rem;cursor:pointer;padding:0;text-decoration:underline;">🗑 Limpar aplicados</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn-cancel" onclick="closeM('mOFX')">Fechar</button>
          <button class="btn-primary" onclick="confirmarConciliacao()" id="ofx-btn-confirmar" disabled style="opacity:.5;cursor:not-allowed;">
            ✅ Aplicar Vinculados
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL CONCILIAÇÃO CHIPPIX -->
<div class="mo" id="mChipPix">
  <div class="modal" style="width:900px;max-width:96vw;max-height:92vh;display:flex;flex-direction:column;padding:0;overflow:hidden;">

    <!-- Header -->
    <div style="padding:16px 24px 12px;border-bottom:1px solid var(--b1);flex-shrink:0;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="modal-title" style="margin:0;color:#34d399;">🎰 Conciliação ChipPix</div>
          <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Importe o extrato Excel do ChipPix. IDs são vinculados automaticamente nas próximas semanas.</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <button onclick="reautolinkCP()" style="display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.18);color:#6ee7b7;padding:7px 12px;border-radius:8px;cursor:pointer;font-size:.72rem;font-weight:600;">
            🔗 Re-vincular por ID
          </button>
          <label style="display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.28);color:#34d399;padding:7px 14px;border-radius:8px;cursor:pointer;font-size:.75rem;font-weight:700;">
            📂 Importar Excel ChipPix
            <input type="file" accept=".xlsx,.xls" onchange="processChipPix(this)" style="display:none;">
          </label>
          <button onclick="closeM('mChipPix')" style="background:none;border:none;color:var(--t3);font-size:1.2rem;cursor:pointer;line-height:1;padding:4px;">✕</button>
        </div>
      </div>
    </div>

    <!-- Info banner sobre lógica -->
    <div style="padding:8px 24px;background:rgba(16,185,129,.04);border-bottom:1px solid rgba(16,185,129,.1);flex-shrink:0;display:flex;gap:24px;flex-wrap:wrap;">
      <div style="font-size:.72rem;color:var(--t3);">📥 <strong style="color:#34d399;">Entrada bruta</strong> = Jogador depositou chips (pagou ao clube)</div>
      <div style="font-size:.72rem;color:var(--t3);">📤 <strong style="color:#f87171;">Saída bruta</strong> = Jogador sacou chips (clube pagou ao jogador)</div>
      <div style="font-size:.72rem;color:var(--t3);">💡 <strong style="color:var(--t2);">Saldo</strong> = Entrada − Saída por ID de jogador</div>
    </div>

    <!-- Empty state -->
    <div id="cp-empty" style="padding:40px 24px;text-align:center;">
      <div style="width:64px;height:64px;border-radius:14px;background:rgba(16,185,129,.08);border:2px dashed rgba(16,185,129,.25);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 14px;">🎰</div>
      <div style="font-size:.86rem;font-weight:700;color:var(--t1);margin-bottom:6px;">Nenhum extrato ChipPix carregado</div>
      <div style="font-size:.74rem;color:var(--t3);">Clique em <strong style="color:#34d399;">📂 Importar Excel ChipPix</strong> para carregar o extrato.<br>Os IDs dos jogadores são vinculados automaticamente após o primeiro mapeamento.</div>
    </div>

    <!-- Área principal -->
    <div id="cp-main" style="display:none;flex-direction:column;overflow:hidden;flex:1;min-height:0;">

      <!-- KPIs resumo -->
      <div id="cp-summary" style="padding:10px 24px;background:var(--s2);border-bottom:1px solid var(--b1);display:flex;gap:22px;flex-wrap:wrap;flex-shrink:0;align-items:center;"></div>

      <!-- Filtros -->
      <div style="padding:8px 24px;border-bottom:1px solid var(--b1);display:flex;gap:6px;align-items:center;flex-shrink:0;flex-wrap:wrap;">
        <span style="font-size:.68rem;color:var(--t3);">Mostrar:</span>
        <button class="cp-filter active" data-f="todos"     onclick="filtrarCP(this,'todos')">Todos</button>
        <button class="cp-filter"        data-f="vinculado" onclick="filtrarCP(this,'vinculado')">✅ Vinculados</button>
        <button class="cp-filter"        data-f="aplicado"  onclick="filtrarCP(this,'aplicado')">💳 Aplicados</button>
        <button class="cp-filter"        data-f="pendente"  onclick="filtrarCP(this,'pendente')">⏳ Pendentes</button>
        <button class="cp-filter"        data-f="ignorado"  onclick="filtrarCP(this,'ignorado')">🚫 Ignorados</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <div style="position:relative;">
            <span style="position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:.72rem;color:var(--t3);pointer-events:none;">🔍</span>
            <input id="cp-search" type="text" placeholder="Buscar por ID ou nome..." oninput="renderCPTable()"
              style="background:var(--s2);border:1px solid var(--b2);color:var(--t1);padding:5px 10px 5px 26px;border-radius:7px;font-size:.72rem;width:200px;outline:none;"
              onfocus="this.style.borderColor='rgba(16,185,129,.5)'" onblur="this.style.borderColor='var(--b2)'">
          </div>
          <div style="font-size:.7rem;color:var(--t3);white-space:nowrap;" id="cp-match-count"></div>
        </div>
      </div>

      <!-- Tabela -->
      <div style="overflow-y:auto;flex:1;padding:0 24px 12px;">
        <table style="width:100%;border-collapse:collapse;margin-top:10px;">
          <thead style="position:sticky;top:0;z-index:2;">
            <tr style="background:var(--s2);">
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">ID ChipPix</th>
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Nome no ChipPix</th>
              <th style="padding:7px 10px;text-align:right;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">📥 Entrada</th>
              <th style="padding:7px 10px;text-align:right;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">📤 Saída</th>
              <th style="padding:7px 10px;text-align:right;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Saldo</th>
              <th style="padding:7px 10px;text-align:left;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);min-width:180px;">Vincular ao jogador</th>
              <th style="padding:7px 10px;text-align:center;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Ação</th>
            </tr>
          </thead>
          <tbody id="cp-tbody"></tbody>
        </table>
      </div>

      <!-- Footer -->
      <div style="padding:12px 24px;border-top:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--s1);">
        <div style="font-size:.74rem;color:var(--t3);" id="cp-footer-info"></div>
        <div style="display:flex;gap:8px;">
          <button class="btn-cancel" onclick="closeM('mChipPix')">Fechar</button>
          <button onclick="resetarChipPixSemana()" title="Apaga os lançamentos ChipPix desta semana para re-aplicar"
            style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);color:#f87171;padding:7px 14px;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;">
            🗑 Limpar lançamentos
          </button>
          <button class="btn-primary" onclick="aplicarChipPix()" id="cp-btn-aplicar" disabled
            style="opacity:.5;cursor:not-allowed;background:linear-gradient(135deg,#10b981,#059669);">
            ✅ Aplicar Vinculados
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="toast"></div>

<!-- MODAL LOCK CHECKLIST -->
<div class="mo" id="mLockChecklist">
  <div class="modal" style="width:560px;max-width:96vw;">
    <div class="modal-title">🔒 Checklist — Lockar Semana</div>
    <div style="font-size:.72rem;color:var(--t3);margin-bottom:14px;">Verifique os itens antes de confirmar o lock. O snapshot será salvo e os saldos carregados na próxima semana.</div>
    <div id="lock-checklist-items" style="margin-bottom:16px;"></div>
    <div id="lock-checklist-warnings" style="margin-bottom:14px;"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;">
      <button class="btn-cancel" onclick="closeM('mLockChecklist')">Cancelar</button>
      <button id="lock-checklist-confirm" class="btn-primary" onclick="confirmLockFromChecklist()" style="font-size:.78rem;">🔒 Confirmar Lock</button>
    </div>
  </div>
</div>

<!-- MODAL CLUB CONFIG -->
<div class="mo" id="mClubConfig">
  <div class="modal" style="width:640px;max-width:96vw;max-height:85vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div>
        <div class="modal-title" style="margin:0;">⚙️ Configurações do Clube</div>
        <div style="font-size:.72rem;color:var(--t3);margin-top:2px;" id="club-config-subtitle">—</div>
      </div>
      <button onclick="closeM('mClubConfig')" style="background:none;border:none;color:var(--t3);font-size:1.2rem;cursor:pointer;">✕</button>
    </div>
    <div id="club-config-content"></div>
  </div>
</div>

<!-- MODAL IMPORT REPORT -->
<div class="mo" id="mImportReport">
  <div class="modal" style="width:640px;max-width:96vw;max-height:85vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div class="modal-title" style="margin:0;">📋 Relatório de Importação</div>
      <button onclick="closeM('mImportReport')" style="background:none;border:none;color:var(--t3);font-size:1.2rem;cursor:pointer;">✕</button>
    </div>
    <div id="import-report-content"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
      <button class="btn-cancel" onclick="closeM('mImportReport')">Cancelar</button>
      <button id="import-report-confirm" class="btn-primary" onclick="confirmImportFromReport()" disabled>✅ Aceitar Importação</button>
    </div>
  </div>
</div>

<!-- ══ MÓDULOS EXTERNOS (carregar antes do script principal) ══ -->
<!-- adapterImport.js: NÃO carregado aqui — código inline no script principal ainda ativo.
     Reintegrar após remover o bloco inline (const GU_TO_BRL / adapterImport / resolveClubeInterno). -->
<script src="dataLayer.js"></script>
<script src="financeEngine.js"></script>

<script>
// ══ SELF-CHECK: Blindagem contra corrupção de fórmulas ══
(function() {
  var FE = window.FinanceEngine;
  var ok = true;
  function check(name, got, expected) {
    if (Math.abs(got - expected) > 0.001) {
      ok = false;
      console.error('[FINANCE-ENGINE] FALHA: ' + name + ' — esperado ' + expected + ', obteve ' + got);
    }
  }
  // Teste 1: saldo=100, in=30 → saldo=70
  check('calcSaldoAtual(100,0,30)', FE.calcSaldoAtual(100, 0, 30), 70);
  // Teste 2: saldo=100, out=30 → saldo=130
  check('calcSaldoAtual(100,0,-30)', FE.calcSaldoAtual(100, 0, -30), 130);
  // Teste 3: pendente = -3833 + 3000 = -833
  check('calcPendente(-3833,3000)', FE.calcPendente(-3833, 3000), -833);
  // Teste 4: calcPlayerResult ganhos=-500 rake=100 pct=10 → -490
  check('calcPlayerResult', FE.calcPlayerResult({ganhos:-500,rake:100}, 10), -490);
  // Teste 5: calcLedgerNet
  var ln = FE.calcLedgerNet([{dir:'in',valor:30},{dir:'out',valor:10}]);
  check('calcLedgerNet.net', ln.net, 20);

  if (!ok) {
    alert('ERRO CRITICO: Formulas do FinanceEngine foram corrompidas!\nO sistema pode calcular valores errados.\nVerifique o console para detalhes.');
  }
})();
</script>

<!-- Módulos extraídos (Passo 3) -->
<script src="js/utils.js"></script>
<script src="js/app-state.js"></script>
<script src="js/app-navigation.js"></script>

<script>
// ══════════════════ IMPORT ══════════════════
const COL_DEFS=[
  {id:'c-id',    lbl:'ID Jogador',     hints:['id jogador','playerid','player id','userid','id do jogador']},
  {id:'c-nick',  lbl:'Nick',           hints:['nick','username','apelido','player name']},
  {id:'c-func',  lbl:'Função',         hints:['função','funcao','role','tipo','function']},
  {id:'c-aid',   lbl:'ID Agente',      hints:['id agente','agentid','agent id','id do agente']},
  {id:'c-aname', lbl:'Nome Agente',    hints:['nome do agente','nome agente','agente','agent name','agent']},
  {id:'c-said',  lbl:'ID Sub-Agente',  hints:['id sub','subagentid','id do sub agente']},
  {id:'c-saname',lbl:'Sub-Agente',     hints:['sub-agente','sub agente','subagente']},
  {id:'c-ganhos',lbl:'Ganhos',         hints:['ganhos','wins','winnings']},
  {id:'c-rake',  lbl:'Rake',           hints:['rake']},
  {id:'c-ggr',   lbl:'Rodeo GGR',      hints:['rodeo','ggr','gross']},
  {id:'c-result',lbl:'Resultado Semana',hints:['resultado','result','net','final']},
];
let rawHeaders=[],rawRows=[];

const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)handleFile(f);});

// ══════════════════ GRAND UNION ADAPTER ══════════════════
const GU_TO_BRL = 5;

function _findHeaderRow(rows){
  for(let i=0;i<Math.min(rows.length,15);i++){
    const cells=(rows[i]||[]).map(c=>String(c||'').trim());
    if(cells.some(c=>c==='Player ID')) return i;
  }
  return -1;
}

function _mapCols(headerRow){
  const map={};
  (headerRow||[]).forEach((cell,idx)=>{
    const name=String(cell||'').trim();
    if(name){
      if(map[name]!==undefined) map[name+':'+idx]=idx;
      else map[name]=idx;
    }
  });
  return map;
}

function _parseNum(raw){
  if(raw==null) return 0;
  if(typeof raw==='number') return isNaN(raw)?0:raw;
  let s=String(raw).trim();
  if(!s||s==='--'||s.toLowerCase()==='none') return 0;
  const isNeg=s.startsWith('(')&&s.endsWith(')');
  if(isNeg) s=s.slice(1,-1);
  const lc=s.lastIndexOf(','),ld=s.lastIndexOf('.');
  if(lc>ld){s=s.replace(/\./g,'').replace(',','.');}else{s=s.replace(/,/g,'');}
  s=s.replace(/[^\d.\-]/g,'');
  const num=parseFloat(s);
  return isNaN(num)?0:(isNeg?-num:num);
}

function resolveClubeInterno(agentName){
  let name=String(agentName||'').toUpperCase().trim();
  name=name.replace(/^AG[\.\s]+/i,'').trim();
  if(!name||name==='NONE') return '?';
  const rules=[
    {prefixes:['AMS','TW','BB'],clube:'IMPÉRIO'},
    {prefixes:['TGP'],          clube:'TGP'},
    {prefixes:['CONFRA'],       clube:'CONFRARIA'},
    {prefixes:['3BET'],         clube:'3BET'},
    {prefixes:['CH'],           clube:'CH'},
  ];
  for(const rule of rules){
    for(const prefix of rule.prefixes){
      if(name.startsWith(prefix)) return rule.clube;
    }
  }
  if(name.includes('TGP')) return 'TGP';
  return '?';
}

function _adapterImportResume(resumeRows){
  if(!resumeRows||resumeRows.length<2) return [];
  const hIdx=_findHeaderRow(resumeRows);
  if(hIdx===-1){console.error('[adapter] Header não encontrado na Resume');return [];}
  const col=_mapCols(resumeRows[hIdx]);
  const C={
    playerId:col['Player ID'], nickName:col['nickName'],
    agentId:col['Agent ID'], agentName:col['Agent Name'],
    subAgentId:col['Sub Agent ID'], subAgentName:col['Sub Agent Name'],
    winnings:col['Winnings'], totalFee:col['Total Fee'],
    rodeioProfit:col['RODEO Total Profit'],
    games:col['Games'], hands:col['Hands'], role:col['Role'],
  };
  if(C.playerId===undefined||C.winnings===undefined||C.totalFee===undefined){
    console.error('[adapter] Colunas obrigatórias ausentes:',C);return [];
  }
  console.log('[adapter] Resume mapeamento:',C);
  const playerLinks    = DataLayer.getPlayerLinks();
  const agentOvr       = DataLayer.getAgentSubclubOvr();
  const ignoredAgents  = DataLayer.getIgnoredAgents();
  const result=[];
  for(let i=hIdx+1;i<resumeRows.length;i++){
    const r=resumeRows[i];
    if(!r||r.length===0) continue;
    const pid=String(r[C.playerId]||'').trim();
    if(!pid||pid.toLowerCase()==='none') continue;

    const aname  = String(r[C.agentName]||'').trim();
    const rawAid = String(r[C.agentId]||'').trim();
    const u      = aname.toUpperCase().trim();

    // isNone: agentName vazio/None/null/undefined OU agentId vazio/0/None
    const isNoneAid  = !rawAid || rawAid==='0' || /^(none|null|undefined)$/i.test(rawAid);
    const isNoneName = !aname  || /^(none|null|undefined)$/i.test(aname);
    const isNone     = isNoneAid || isNoneName;

    const p = {
      id    : pid,
      nick  : String(r[C.nickName]||'').trim(),
      func  : String(r[C.role]||'').trim(),
      aid   : rawAid,
      aname : aname,
      said  : String(r[C.subAgentId]||'').trim(),
      saname: String(r[C.subAgentName]||'').trim(),
      clube : '?',
      ganhos: _parseNum(r[C.winnings])*GU_TO_BRL,
      rake  : _parseNum(r[C.totalFee])*GU_TO_BRL,
      ggr   : C.rodeioProfit!==undefined ? _parseNum(r[C.rodeioProfit])*GU_TO_BRL : 0,
      games : _parseNum(r[C.games]),
      hands : _parseNum(r[C.hands]),
      rakeback: 0,
      // flags de status (não persistidas no saveImport)
      _ignored      : false,
      _missingAgency: false,
      _unknownSubclub: false,
      _autoResolved : false,
    };

    if (ignoredAgents[rawAid]) {
      // Agente explicitamente ignorado — não entra nos fechamentos
      p._ignored = true;

    } else if (isNone) {
      // Jogador sem agência
      const link = playerLinks[pid];
      if (link) {
        // Auto-resolver via pm_playerLink
        p.aid    = link.agentId;
        p.aname  = link.agentName;
        p.clube  = link.subclube;
        p._autoResolved = true;
      } else {
        p._missingAgency = true;
      }

    } else {
      // Jogador com agência — resolver subclube
      const ovr = agentOvr[rawAid];
      if (ovr) {
        p.clube = ovr.subclube;
      } else {
        p.clube = manualLinks[u] || resolveClubeInterno(aname);
      }
      if (p.clube === '?') p._unknownSubclub = true;
    }

    result.push(p);
  }

  // Popular pm_agentsBySubclub para agentes já resolvidos
  result.forEach(p => {
    if (!p._ignored && !p._missingAgency && !p._unknownSubclub && p.clube !== '?' && p.aid && p.aname) {
      DataLayer.saveAgentToSubclub(p.clube, p.aid, p.aname);
    }
  });

  console.log(`[adapter] Resume: ${result.length} jogadores`);
  return result;
}

function _parseStatsBreakdown(statsRows){
  if(!statsRows||statsRows.length<2) return {};
  const hIdx=_findHeaderRow(statsRows);
  if(hIdx===-1) return {};
  const col=_mapCols(statsRows[hIdx]);
  const C={
    playerId:col['Player ID'],
    ringGame:col['Ring Game Total(Local)'],
    mtt:col['MTT Total(Local)'],
    sng:col['SNG Total(Local)'],
    spin:col['SPIN Total(Local)'],
    tlt:col['TLT Total(Local)'],
  };
  if(C.playerId===undefined) return {};
  const map={};
  for(let i=hIdx+1;i<statsRows.length;i++){
    const r=statsRows[i];
    if(!r||r.length===0) continue;
    const pid=String(r[C.playerId]||'').trim();
    if(!pid||pid.toLowerCase()==='none') continue;
    const bd={
      ringGame:C.ringGame!==undefined?_parseNum(r[C.ringGame]):0,
      mtt:C.mtt!==undefined?_parseNum(r[C.mtt]):0,
      sng:C.sng!==undefined?_parseNum(r[C.sng]):0,
      spin:C.spin!==undefined?_parseNum(r[C.spin]):0,
      tlt:C.tlt!==undefined?_parseNum(r[C.tlt]):0,
    };
    bd.total=bd.ringGame+bd.mtt+bd.sng+bd.spin+bd.tlt;
    map[pid]=bd;
  }
  console.log(`[adapter] Statistics: ${Object.keys(map).length} breakdowns`);
  return map;
}

function adapterImport(wb){
  const resumeSheet=wb.Sheets['Grand Union Member Resume'];
  if(!resumeSheet){console.error('[adapter] Aba Resume não encontrada!');return null;}
  const resumeRows=XLSX.utils.sheet_to_json(resumeSheet,{header:1,defval:''});
  const players=_adapterImportResume(resumeRows);

  const statsSheet=wb.Sheets['Grand Union Member Statistics'];
  let breakdown={};
  if(statsSheet){
    const statsRows=XLSX.utils.sheet_to_json(statsSheet,{header:1,defval:''});
    breakdown=_parseStatsBreakdown(statsRows);
  }

  let diffCount=0;
  for(const p of players){
    p.rakeBreakdown=breakdown[p.id]||{ringGame:0,mtt:0,sng:0,spin:0,tlt:0,total:0};
    if(!p._ignored){
      const diff=Math.abs(p.rake-p.rakeBreakdown.total);
      if(diff>0.1&&p.rakeBreakdown.total>0){diffCount++;if(diffCount<=5)console.warn(`[validação] ${p.id} ${p.nick}: Resume=${p.rake.toFixed(2)}, Stats=${p.rakeBreakdown.total.toFixed(2)}`);}
    }
  }
  if(diffCount>0) console.warn(`[validação] ${diffCount} com diferença`);
  else if(Object.keys(breakdown).length>0) console.log('[validação] ✅ Rake Resume × Statistics OK!');

  // Separar grupos para o modal de resolução
  const result = {
    all     : players.filter(p => !p._ignored),
    ignored : players.filter(p => p._ignored),
    missing : players.filter(p => p._missingAgency),
    unknown : players.filter(p => p._unknownSubclub),
    autoRes : players.filter(p => p._autoResolved),
    ok      : players.filter(p => !p._ignored && !p._missingAgency && !p._unknownSubclub),
  };
  console.log(`[adapter] ✅ ${result.all.length} jogadores (${result.ignored.length} ignorados, ${result.missing.length} sem agência, ${result.unknown.length} subclube desconhecido, ${result.autoRes.length} auto-resolvidos)`);
  return result;
}

// ══════════════════ FILE HANDLER ══════════════════
function handleFile(file){
  if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true});

      // ── Detecta Grand Union (Suprema) ──
      const hasResume = !!wb.Sheets['Grand Union Member Resume'];

      if(hasResume){
        // AUTO-IMPORT: Grand Union Suprema
        const result=adapterImport(wb);
        if(!result||!result.all.length){showToast('Nenhum jogador encontrado na aba Resume!','e');return;}

        // Show Import Report before accepting
        showImportReport(result, file.name, (validatedPlayers, fname) => {
          allPlayers = validatedPlayers;
          filteredAll = [...allPlayers];
          DataLayer.saveImport(getWeekKey(), validatedPlayers, fname);

          dz.classList.add('loaded');
          document.getElementById('dropIcon').textContent='✅';
          document.getElementById('dropTitle').textContent=`${fname} — ${validatedPlayers.length} jogadores importados (Grand Union)`;
          document.getElementById('dropSub').textContent='Importação automática via Grand Union Member Resume + Statistics';
          document.getElementById('mapperCard').classList.remove('show');
          document.getElementById('imp-status-file').textContent=fname+' · '+validatedPlayers.length+' jogadores';
          document.getElementById('import-status-badge').style.display='block';

          updateSidebar();
          showDiagnostic(validatedPlayers);
          showToast(`✅ ${validatedPlayers.length} jogadores importados!`);
        });

      } else {
        // FALLBACK: modo antigo com mapper manual
        const ws=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,dateNF:'dd/mm/yyyy'});
        if(json.length<2){showToast('Planilha vazia!','e');return;}
        rawHeaders=json[0].map(h=>String(h||'').trim());
        rawRows=json.slice(1).filter(r=>r.some(c=>c!==undefined&&c!==''));
        dz.classList.add('loaded');
        document.getElementById('dropIcon').textContent='✅';
        document.getElementById('dropTitle').textContent=`${file.name} — ${rawRows.length} linhas detectadas`;
        document.getElementById('dropSub').textContent='Configure as colunas abaixo e clique em "Processar"';
        buildMapper();
      }
      document.getElementById('fileMain').value='';
    }catch(err){showToast('Erro ao ler arquivo: '+err.message,'e');}
  };
  r.readAsArrayBuffer(file);
}

function buildMapper(){
  const grid=document.getElementById('cmGrid');grid.innerHTML='';
  COL_DEFS.forEach(def=>{
    const det=rawHeaders.findIndex(h=>def.hints.some(hint=>h.toLowerCase().includes(hint)));
    const div=document.createElement('div');div.className='cm-field';
    div.innerHTML=`<label>${def.lbl}</label>
      <select id="${def.id}">
        <option value="">— não usar —</option>
        ${rawHeaders.map((h,i)=>`<option value="${i}"${i===det?' selected':''}>${h||'Col '+(i+1)}</option>`).join('')}
      </select>`;
    grid.appendChild(div);
  });
  document.getElementById('mapperCard').classList.add('show');
}

function cv(rowIdx,sid){
  const s=document.getElementById(sid);
  if(!s||s.value==='')return'';
  return rawRows[rowIdx]?.[parseInt(s.value)]??'';
}
function pNum(v){
  if(v===null||v===undefined||v==='') return 0;
  let s = String(v).trim().replace(/[R$\s]/g,'');
  if(!s || s==='None' || s.startsWith('=')) return 0;

  const hasDot   = s.includes('.');
  const hasComma = s.includes(',');

  if(hasDot && hasComma){
    const lastDot   = s.lastIndexOf('.');
    const lastComma = s.lastIndexOf(',');
    if(lastComma > lastDot){
      // Formato BR: 1.234,56
      s = s.replace(/\./g,'').replace(',','.');
    } else {
      // Formato US: 1,234.56
      s = s.replace(/,/g,'');
    }
  } else if(hasComma && !hasDot){
    // Só vírgula: 1234,56
    s = s.replace(',','.');
  }
  // Só ponto ou número inteiro: já está ok (ex: 21758.10 ou -41.15)

  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function processImport(){
  const players=rawRows.map((row,i)=>{
    const aname=String(cv(i,'c-aname')||'').trim();
    return{
      id:String(cv(i,'c-id')||'').trim(),
      nick:String(cv(i,'c-nick')||'').trim(),
      func:String(cv(i,'c-func')||'Jogador').trim(),
      aid:String(cv(i,'c-aid')||'').trim(),
      aname,
      said:String(cv(i,'c-said')||'').trim(),
      saname:String(cv(i,'c-saname')||'').trim(),
      ganhos:pNum(cv(i,'c-ganhos')),
      rake:pNum(cv(i,'c-rake')),
      ggr:pNum(cv(i,'c-ggr')),
      result:pNum(cv(i,'c-result')),
      clube:classify(aname),
      rakeback:0,
    };
  }).filter(p=>p.id||p.nick);

  const fname=document.getElementById('dropTitle').textContent.split('—')[0].trim();

  showImportReport(players, fname, (validatedPlayers, fn) => {
    allPlayers = validatedPlayers;
    filteredAll = [...allPlayers];
    DataLayer.saveImport(getWeekKey(), validatedPlayers, fn);

    document.getElementById('imp-status-file').textContent=fn+' · '+validatedPlayers.length+' jogadores';
    document.getElementById('import-status-badge').style.display='block';

    updateSidebar();
    showDiagnostic(validatedPlayers);
    showToast(`✅ ${validatedPlayers.length} jogadores processados!`);
  });
}

// ── IMPORT VALIDATION ──
let _pendingImportPlayers = null;
let _pendingImportFileName = '';
// Estado do modal de resolução de pendências
let _missingAgencyRows  = [];   // [{player}] — 🔴 NONE sem pm_playerLink
let _unknownSubclubRows = [];   // [{agentId, agentName, count, players[]}] — 🟠 subclube ?
let _autoResolvedCount  = 0;    // jogadores auto-resolvidos via pm_playerLink nesta sessão
let _resolvedNone       = {};   // playerId → {subclube, agentId, agentName}
let _resolvedAgent      = {};   // agentId  → subclube
let _ignoredInSession   = new Set(); // agentIds ignorados nesta sessão

function validateImport(players, fileName){
  const errors = [];
  const warnings = [];
  const idSet = new Set();
  const nickSet = {};

  players.forEach((p, i) => {
    const row = i + 2; // header is row 1

    // ERRORS (block import)
    if(!p.id && !p.nick){
      errors.push({ row, msg: 'Jogador sem ID e sem Nick — impossível identificar', field: 'id/nick' });
    }
    if(!p.id){
      errors.push({ row, msg: 'Player ID vazio: "' + (p.nick||'?') + '"', field: 'id' });
    }
    if(p.id && idSet.has(p.id)){
      errors.push({ row, msg: 'Player ID duplicado: "' + p.id + '" (nick: ' + (p.nick||'?') + ')', field: 'id' });
    }
    if(p.id) idSet.add(p.id);

    // WARNINGS (allow import)
    if(p.nick){
      if(!nickSet[p.nick]) nickSet[p.nick] = [];
      nickSet[p.nick].push(p.id);
    }
    if(Number(p.rake) < 0){
      warnings.push({ row, msg: 'Rake negativo: R$ ' + fV(p.rake, false) + ' para "' + (p.nick||p.id) + '"', field: 'rake' });
    }
    if(p.rake == 0 && (Number(p.ganhos) !== 0)){
      warnings.push({ row, msg: 'Rake = 0 com P/L ≠ 0 para "' + (p.nick||p.id) + '"', field: 'rake' });
    }
    // Warnings de agência/clube só para jogadores não tratados pelo fluxo de resolução
    // (_missingAgency e _unknownSubclub são exibidos como seções bloqueantes no modal)
    if(!p._missingAgency && !p._unknownSubclub && !p._autoResolved && (!p.aname || /^(none|null|undefined)$/i.test(p.aname))){
      warnings.push({ row, msg: '"' + (p.nick||p.id) + '" sem agência definida', field: 'aname' });
    }
    if(!p._unknownSubclub && !p._missingAgency && p.clube === '?'){
      warnings.push({ row, msg: '"' + (p.nick||p.id) + '" — agência "' + (p.aname||'') + '" não classificada', field: 'clube' });
    }
  });

  // Nicks duplicados com IDs diferentes
  Object.entries(nickSet).forEach(([nick, ids]) => {
    if(ids.length > 1){
      warnings.push({ row: 0, msg: 'Nick "' + nick + '" repetido para ' + ids.length + ' IDs diferentes: ' + ids.join(', '), field: 'nick' });
    }
  });

  return { errors, warnings };
}

// ── Helpers do modal de importação ────────────────────────────────────

const _CLR = {'IMPÉRIO':'#f0b429','CONFRARIA':'#10b981','3BET':'#c084fc','TGP':'#fb923c','CH':'#60a5fa'};

// Retorna {agentId: agentName} para um subclube — import atual primeiro, depois histórico
function _getAgentsForSubclub(subclube) {
  const agents = {};
  if (_pendingImportPlayers) {
    _pendingImportPlayers.forEach(p => {
      if (p.clube === subclube && p.aid && p.aname && !p._missingAgency && !p._ignored) {
        agents[String(p.aid)] = p.aname;
      }
    });
  }
  const registry = DataLayer.getAgentsBySubclub()[subclube] || {};
  Object.entries(registry).forEach(([aid, aname]) => { if (!agents[aid]) agents[aid] = aname; });
  return agents;
}

// Atualiza o estado e texto do botão Confirmar
function _updateImportConfirmBtn(hasErrors) {
  const btn = document.getElementById('import-report-confirm');
  if (!btn) return;
  const pendingMissing = _missingAgencyRows.filter(p => !_resolvedNone[p.id]).length;
  const pendingUnknown = _unknownSubclubRows.filter(a =>
    !_resolvedAgent[String(a.agentId)] && !_ignoredInSession.has(String(a.agentId))
  ).length;
  const totalPending = pendingMissing + pendingUnknown;
  if (hasErrors) {
    btn.disabled = true;
    btn.textContent = '🚫 Corrija os erros na planilha';
    btn.style.opacity = '0.4';
  } else if (totalPending > 0) {
    btn.disabled = true;
    btn.textContent = '⏳ Resolva ' + totalPending + ' pendência' + (totalPending > 1 ? 's' : '') + ' para continuar';
    btn.style.opacity = '0.5';
  } else {
    btn.disabled = false;
    btn.textContent = '✅ Confirmar Importação';
    btn.style.opacity = '1';
  }
}

// Handler: usuário escolhe subclube para um jogador NONE
function onNoneSubclubeSelect(playerId, subclube) {
  const agSelect = document.getElementById('ag-sel-' + playerId);
  if (!agSelect) return;
  agSelect.innerHTML = '<option value="">— selecione a agência —</option>';
  const agents = _getAgentsForSubclub(subclube);
  Object.entries(agents).forEach(([aid, aname]) => {
    const opt = document.createElement('option');
    opt.value = aid + '||' + aname;
    opt.textContent = aname;
    agSelect.appendChild(opt);
  });
  agSelect.disabled = false;
  agSelect.dataset.subclube = subclube;
  // Limpar resolução anterior se mudou de subclube
  delete _resolvedNone[playerId];
  _updateImportConfirmBtn(false);
}

// Handler: usuário escolhe agência para um jogador NONE
function onNoneAgenciaSelect(playerId, selectEl) {
  const val = selectEl.value;
  if (!val) { delete _resolvedNone[playerId]; _updateImportConfirmBtn(false); return; }
  const subclube = selectEl.dataset.subclube || '';
  const parts = val.split('||');
  const agentId   = parts[0] || '';
  const agentName = parts[1] || '';
  _resolvedNone[playerId] = { subclube, agentId, agentName };
  // Marcar linha como resolvida visualmente
  const row = document.getElementById('none-row-' + playerId);
  if (row) row.style.opacity = '0.55';
  _updateImportConfirmBtn(false);
}

// Handler: usuário escolhe subclube para um agente desconhecido (🟠)
function onAgentSubclubeSelect(agentId, subclube) {
  if (!subclube) return;
  // Apenas salva em staging — efetivado no "Vincular"
  const vinBtn = document.getElementById('vin-btn-' + agentId);
  if (vinBtn) { vinBtn.disabled = false; vinBtn.dataset.subclube = subclube; }
}

// Handler: Vincular agente desconhecido
function onAgentVincular(agentId, agentName) {
  const sel = document.getElementById('sub-sel-' + agentId);
  const subclube = sel ? sel.value : '';
  if (!subclube) { showToast('Selecione um subclube primeiro', 'e'); return; }
  _resolvedAgent[String(agentId)] = subclube;
  // Feedback visual
  const row = document.getElementById('unk-row-' + agentId);
  if (row) {
    const color = _CLR[subclube] || '#10b981';
    row.style.background = color + '11';
    row.style.borderColor = color + '44';
    const badge = row.querySelector('.unk-status');
    if (badge) { badge.textContent = '✓ ' + subclube; badge.style.color = color; }
    row.querySelectorAll('select,button').forEach(el => el.disabled = true);
  }
  _updateImportConfirmBtn(false);
}

// Handler: Ignorar agente — pede confirmação nativa
function onAgentIgnorar(agentId, agentName) {
  if (!confirm('Ignorar "' + agentName + '"?\n\nJogadores deste agente NÃO entrarão nos fechamentos financeiros. Esta decisão fica salva permanentemente (pode ser revertida na seção "Não Vinculados").')) return;
  _ignoredInSession.add(String(agentId));
  const row = document.getElementById('unk-row-' + agentId);
  if (row) { row.style.opacity = '0.35'; row.style.pointerEvents = 'none'; }
  _updateImportConfirmBtn(false);
}

// ── Bulk para jogadores NONE ───────────────────────────────────────────
let _bulkNoneSelected = new Set();

function toggleNoneSelect(playerId, cb) {
  if (cb.checked) _bulkNoneSelected.add(playerId);
  else _bulkNoneSelected.delete(playerId);
  const bar = document.getElementById('none-bulk-bar');
  if (bar) bar.style.display = _bulkNoneSelected.size >= 2 ? 'flex' : 'none';
  const cnt = document.getElementById('none-bulk-count');
  if (cnt) cnt.textContent = _bulkNoneSelected.size;
}

function applyBulkNone() {
  const subSel = document.getElementById('bulk-none-sub');
  const agSel  = document.getElementById('bulk-none-ag');
  const subclube = subSel ? subSel.value : '';
  const agVal    = agSel  ? agSel.value  : '';
  if (!subclube || !agVal) { showToast('Selecione subclube e agência para o lote', 'e'); return; }
  const parts = agVal.split('||');
  const agentId   = parts[0] || '';
  const agentName = parts[1] || '';
  _bulkNoneSelected.forEach(pid => {
    _resolvedNone[pid] = { subclube, agentId, agentName };
    const row = document.getElementById('none-row-' + pid);
    if (row) row.style.opacity = '0.55';
  });
  _bulkNoneSelected.clear();
  const bar = document.getElementById('none-bulk-bar');
  if (bar) bar.style.display = 'none';
  _updateImportConfirmBtn(false);
}

function onBulkSubclubeChange(subclube) {
  const agSel = document.getElementById('bulk-none-ag');
  if (!agSel) return;
  agSel.innerHTML = '<option value="">— agência —</option>';
  const agents = _getAgentsForSubclub(subclube);
  Object.entries(agents).forEach(([aid, aname]) => {
    const opt = document.createElement('option');
    opt.value = aid + '||' + aname;
    opt.textContent = aname;
    agSel.appendChild(opt);
  });
  agSel.disabled = Object.keys(agents).length === 0;
}

// ── showImportReport ───────────────────────────────────────────────────
function showImportReport(result, fileName, onConfirm) {
  const players = result.all;   // jogadores não-ignorados pelo adapter
  _pendingImportPlayers = players;
  _pendingImportFileName = fileName;
  window._importReportCallback = onConfirm;

  // Popula grupos de estado
  _missingAgencyRows  = result.missing  || [];
  _autoResolvedCount  = (result.autoRes || []).length;
  _resolvedNone       = {};
  _resolvedAgent      = {};
  _ignoredInSession   = new Set();
  _bulkNoneSelected   = new Set();

  // Monta grupos de agentes desconhecidos por agentId
  const unkMap = {};
  (result.unknown || []).forEach(p => {
    const aid = String(p.aid || '');
    if (!unkMap[aid]) unkMap[aid] = { agentId: aid, agentName: p.aname, count: 0 };
    unkMap[aid].count++;
  });
  _unknownSubclubRows = Object.values(unkMap);

  const report    = validateImport(players, fileName);
  const hasErrors = report.errors.length > 0;
  const hasWarnings = report.warnings.length > 0;

  // KPIs
  const clubs = {};
  players.filter(p => !p._missingAgency && !p._unknownSubclub).forEach(p => {
    clubs[p.clube] = (clubs[p.clube] || 0) + 1;
  });
  const totalRake = players.reduce((s,p) => s + (Number(p.rake)||0), 0);
  const totalPL   = players.reduce((s,p) => s + (Number(p.ganhos)||0), 0);

  let html = '';

  // ── KPI bar ──────────────────────────────────────────────────────────
  html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:8px 10px;text-align:center;">';
  html += '<div style="font-size:.48rem;font-weight:700;text-transform:uppercase;color:var(--t3);">Jogadores</div>';
  html += '<div style="font-family:\'JetBrains Mono\',monospace;font-size:1rem;font-weight:800;color:var(--t1);">'+players.length+'</div></div>';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:8px 10px;text-align:center;">';
  html += '<div style="font-size:.48rem;font-weight:700;text-transform:uppercase;color:var(--t3);">Clubes</div>';
  html += '<div style="font-family:\'JetBrains Mono\',monospace;font-size:1rem;font-weight:800;color:var(--t1);">'+Object.keys(clubs).length+'</div></div>';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:8px 10px;text-align:center;">';
  html += '<div style="font-size:.48rem;font-weight:700;text-transform:uppercase;color:var(--t3);">Rake Total</div>';
  html += '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.85rem;font-weight:800;color:#10b981;">'+fV(totalRake,false)+'</div></div>';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:8px 10px;text-align:center;">';
  html += '<div style="font-size:.48rem;font-weight:700;text-transform:uppercase;color:var(--t3);">P/L Total</div>';
  html += '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.85rem;font-weight:800;color:'+clr(totalPL)+';">'+fV(totalPL,false)+'</div></div>';
  html += '</div>';

  // Club badges
  html += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px;">';
  Object.entries(clubs).sort((a,b)=>b[1]-a[1]).forEach(([c,cnt]) => {
    const m = CMETA[c] || {};
    html += '<span style="background:rgba(240,180,41,.08);border:1px solid rgba(240,180,41,.15);color:var(--gold);padding:3px 8px;border-radius:5px;font-size:.6rem;font-weight:600;">'+(m.icon||'')+''+c+' ('+cnt+')</span>';
  });
  html += '</div>';

  // ── 🟢 Auto-resolvidos ───────────────────────────────────────────────
  if (_autoResolvedCount > 0) {
    html += '<div style="background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:10px 14px;margin-bottom:10px;">';
    html += '<div style="font-size:.7rem;font-weight:700;color:#10b981;">🟢 '+_autoResolvedCount+' jogador'+((_autoResolvedCount>1)?'es':'')+' auto-resolvido'+((_autoResolvedCount>1)?'s':'')+' via vínculo salvo</div>';
    html += '<div style="font-size:.58rem;color:var(--t3);margin-top:2px;">Estes jogadores já foram vinculados anteriormente e foram classificados automaticamente.</div>';
    html += '</div>';
  }

  // ── 🔴 Sem agência (bloqueante) ──────────────────────────────────────
  if (_missingAgencyRows.length > 0) {
    html += '<div id="missing-section" style="background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:12px 14px;margin-bottom:10px;">';
    html += '<div style="font-size:.72rem;font-weight:700;color:#ef4444;margin-bottom:8px;">🔴 '+_missingAgencyRows.length+' jogador'+((_missingAgencyRows.length>1)?'es':'')+' sem agência — resolução obrigatória</div>';

    // Barra de bulk (aparece via JS quando ≥2 selecionados)
    html += '<div id="none-bulk-bar" style="display:none;align-items:center;gap:6px;padding:7px 10px;background:rgba(239,68,68,.08);border-radius:6px;margin-bottom:8px;flex-wrap:wrap;">';
    html += '<span style="font-size:.6rem;font-weight:700;color:#ef4444;"><span id="none-bulk-count">0</span> selecionados</span>';
    html += '<select id="bulk-none-sub" onchange="onBulkSubclubeChange(this.value)" style="font-size:.6rem;padding:3px 6px;border-radius:5px;border:1px solid var(--b1);background:var(--s2);color:var(--t1);">';
    html += '<option value="">Subclube...</option>';
    CLUBS.forEach(c => { html += '<option value="'+c+'">'+(CMETA[c]||{}).icon+' '+c+'</option>'; });
    html += '</select>';
    html += '<select id="bulk-none-ag" disabled style="font-size:.6rem;padding:3px 6px;border-radius:5px;border:1px solid var(--b1);background:var(--s2);color:var(--t1);"><option value="">Agência...</option></select>';
    html += '<button onclick="applyBulkNone()" style="font-size:.6rem;padding:3px 10px;border-radius:5px;background:#ef4444;border:none;color:#fff;cursor:pointer;font-weight:700;">Aplicar</button>';
    html += '</div>';

    // Lista de jogadores NONE — layout 2 linhas, sem scroll horizontal
    html += '<div style="max-height:240px;overflow-y:auto;overflow-x:hidden;">';
    _missingAgencyRows.forEach(p => {
      const pid = p.id;
      html += '<div id="none-row-'+pid+'" style="padding:6px 4px;border-bottom:1px solid var(--b1);">';
      // Linha 1: checkbox + ID + nome
      html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">';
      html += '<input type="checkbox" onchange="toggleNoneSelect(\''+pid+'\',this)" style="flex-shrink:0;">';
      html += '<span style="font-family:\'JetBrains Mono\',monospace;font-size:.55rem;color:var(--t3);flex-shrink:0;">'+pid+'</span>';
      html += '<span style="font-size:.67rem;font-weight:600;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+p.nick+'</span>';
      html += '</div>';
      // Linha 2: dropdowns subclube + agência lado a lado
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;padding-left:22px;">';
      html += '<select onchange="onNoneSubclubeSelect(\''+pid+'\',this.value)" style="font-size:.6rem;padding:3px 5px;border-radius:4px;border:1px solid var(--b1);background:var(--s2);color:var(--t1);">';
      html += '<option value="">Subclube...</option>';
      CLUBS.forEach(c => { html += '<option value="'+c+'">'+(CMETA[c]||{}).icon+' '+c+'</option>'; });
      html += '</select>';
      html += '<select id="ag-sel-'+pid+'" disabled onchange="onNoneAgenciaSelect(\''+pid+'\',this)" data-subclube="" style="font-size:.6rem;padding:3px 5px;border-radius:4px;border:1px solid var(--b1);background:var(--s2);color:var(--t1);">';
      html += '<option value="">Agência...</option></select>';
      html += '</div>';
      html += '</div>';
    });
    html += '</div>';
    html += '</div>';
  }

  // ── 🟠 Agentes sem subclube (bloqueante) ─────────────────────────────
  if (_unknownSubclubRows.length > 0) {
    html += '<div id="unknown-section" style="background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.25);border-radius:8px;padding:12px 14px;margin-bottom:10px;">';
    html += '<div style="font-size:.72rem;font-weight:700;color:#f59e0b;margin-bottom:8px;">🟠 '+_unknownSubclubRows.length+' agente'+((_unknownSubclubRows.length>1)?'s':'')+' sem subclube — resolução obrigatória</div>';
    _unknownSubclubRows.forEach(ag => {
      const aid     = String(ag.agentId);
      const safeName= ag.agentName.replace(/'/g,'\\\'');
      html += '<div id="unk-row-'+aid+'" style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid rgba(245,158,11,.1);flex-wrap:wrap;">';
      html += '<div style="min-width:160px;flex:1;">';
      html += '<div style="font-size:.68rem;font-weight:600;color:var(--t1);">'+ag.agentName+'</div>';
      html += '<div style="font-size:.55rem;color:var(--t3);">ID '+aid+' · '+ag.count+' jogador'+(ag.count>1?'es':'')+'</div>';
      html += '</div>';
      html += '<select id="sub-sel-'+aid+'" onchange="onAgentSubclubeSelect(\''+aid+'\',this.value)" style="font-size:.6rem;padding:3px 6px;border-radius:5px;border:1px solid var(--b1);background:var(--s2);color:var(--t1);">';
      html += '<option value="">— subclube —</option>';
      CLUBS.forEach(c => { html += '<option value="'+c+'">'+(CMETA[c]||{}).icon+' '+c+'</option>'; });
      html += '</select>';
      html += '<button id="vin-btn-'+aid+'" onclick="onAgentVincular(\''+aid+'\',\''+safeName+'\')" style="font-size:.6rem;padding:3px 10px;border-radius:5px;background:#f59e0b;border:none;color:#000;cursor:pointer;font-weight:700;">Vincular</button>';
      html += '<button onclick="onAgentIgnorar(\''+aid+'\',\''+safeName+'\')" style="font-size:.6rem;padding:3px 10px;border-radius:5px;background:var(--s2);border:1px solid var(--b1);color:var(--t3);cursor:pointer;">Ignorar</button>';
      html += '<span class="unk-status" style="font-size:.58rem;font-weight:700;min-width:60px;"></span>';
      html += '</div>';
    });
    html += '</div>';
  }

  // ── Erros ────────────────────────────────────────────────────────────
  if (hasErrors) {
    html += '<div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;padding:12px 14px;margin-bottom:10px;">';
    html += '<div style="font-size:.72rem;font-weight:700;color:#ef4444;margin-bottom:8px;">🚫 Erros ('+report.errors.length+') — importação bloqueada</div>';
    report.errors.slice(0, 20).forEach(e => {
      html += '<div style="font-size:.68rem;color:#ef4444;padding:3px 0;border-bottom:1px solid rgba(239,68,68,.08);">';
      html += (e.row ? '<span style="font-family:\'JetBrains Mono\',monospace;color:var(--t3);margin-right:6px;">L'+e.row+'</span>' : '');
      html += e.msg + '</div>';
    });
    if (report.errors.length > 20) html += '<div style="font-size:.6rem;color:var(--t3);padding:4px 0;">... e mais '+(report.errors.length-20)+' erros</div>';
    html += '</div>';
  }

  // ── Avisos ───────────────────────────────────────────────────────────
  if (hasWarnings) {
    html += '<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:8px;padding:12px 14px;margin-bottom:10px;">';
    html += '<div style="font-size:.72rem;font-weight:700;color:#f59e0b;margin-bottom:8px;">⚠️ Avisos ('+report.warnings.length+') — importação permitida</div>';
    report.warnings.slice(0, 20).forEach(w => {
      html += '<div style="font-size:.68rem;color:#f59e0b;padding:3px 0;border-bottom:1px solid rgba(245,158,11,.08);">';
      html += (w.row ? '<span style="font-family:\'JetBrains Mono\',monospace;color:var(--t3);margin-right:6px;">L'+w.row+'</span>' : '');
      html += w.msg + '</div>';
    });
    if (report.warnings.length > 20) html += '<div style="font-size:.6rem;color:var(--t3);padding:4px 0;">... e mais '+(report.warnings.length-20)+' avisos</div>';
    html += '</div>';
  }

  // ── Limpo ────────────────────────────────────────────────────────────
  if (!hasErrors && !hasWarnings && _missingAgencyRows.length === 0 && _unknownSubclubRows.length === 0) {
    html += '<div style="background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.12);border-radius:8px;padding:14px;text-align:center;">';
    html += '<span style="font-size:1.2rem;">✅</span>';
    html += '<div style="font-size:.78rem;font-weight:700;color:#10b981;margin-top:6px;">Nenhum erro, aviso ou pendência. Importação limpa!</div>';
    html += '</div>';
  }

  document.getElementById('import-report-content').innerHTML = html;
  _updateImportConfirmBtn(hasErrors);
  openM('mImportReport');
}

// ── confirmImportFromReport ────────────────────────────────────────────
function confirmImportFromReport() {
  if (!_pendingImportPlayers) return;

  // 1. Persistir vínculos de jogadores NONE (pm_playerLink)
  Object.entries(_resolvedNone).forEach(([pid, link]) => {
    DataLayer.savePlayerLink(pid, link);
    if (link.agentId && link.agentName) {
      DataLayer.saveAgentToSubclub(link.subclube, link.agentId, link.agentName);
    }
  });

  // 2. Persistir overrides de agentes desconhecidos (pm_agentSubclubOvr)
  Object.entries(_resolvedAgent).forEach(([agentId, subclube]) => {
    const ag = _unknownSubclubRows.find(a => String(a.agentId) === String(agentId));
    const agentName = ag ? ag.agentName : '';
    DataLayer.saveAgentSubclubOvr(agentId, { subclube, agentName });
    DataLayer.saveAgentToSubclub(subclube, agentId, agentName);
  });

  // 3. Persistir agentes ignorados (pm_ignoredAgents)
  _ignoredInSession.forEach(agentId => {
    const ag = _unknownSubclubRows.find(a => String(a.agentId) === String(agentId));
    DataLayer.ignoreAgent(agentId, ag ? ag.agentName : '');
  });

  // 4. Aplicar resoluções nos players desta sessão
  _pendingImportPlayers.forEach(p => {
    if (p._missingAgency && _resolvedNone[p.id]) {
      const link = _resolvedNone[p.id];
      p.aid   = link.agentId;
      p.aname = link.agentName;
      p.clube = link.subclube;
      p._missingAgency = false;
    } else if (p._unknownSubclub && _resolvedAgent[String(p.aid)]) {
      p.clube = _resolvedAgent[String(p.aid)];
      p._unknownSubclub = false;
    }
  });

  // 5. Filtrar players de agentes ignorados nesta sessão
  const toImport = _pendingImportPlayers.filter(p =>
    !p._ignored && !_ignoredInSession.has(String(p.aid))
  );

  // 6. Atualizar badge de não vinculados
  checkIgnoredAgents();

  closeM('mImportReport');
  if (window._importReportCallback) window._importReportCallback(toImport, _pendingImportFileName);
  _pendingImportPlayers = null;
}

function showDiagnostic(players){
  // Agrupa agentes únicos e suas classificações
  const agentMap = {};
  players.forEach(p => {
    const key = String(p.aname||'').trim();
    if(!agentMap[key]) agentMap[key] = {clube: p.clube, count: 0};
    agentMap[key].count++;
  });

  const entries = Object.entries(agentMap).sort((a,b)=>{
    // Não classificados primeiro
    if(a[1].clube==='?' && b[1].clube!=='?') return -1;
    if(a[1].clube!=='?' && b[1].clube==='?') return 1;
    return a[0].localeCompare(b[0]);
  });

  const unkAgents = entries.filter(([,v])=>v.clube==='?');
  const okAgents  = entries.filter(([,v])=>v.clube!=='?');

  const panel = document.getElementById('diagPanel');
  const totalUnk = players.filter(p=>p.clube==='?').length;

  panel.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div>
        <div style="font-size:1rem;font-weight:700;">📋 Diagnóstico de Classificação</div>
        <div style="font-size:.8rem;color:var(--t2);margin-top:3px;">${players.length} jogadores · ${okAgents.length} agentes classificados · <span style="color:${unkAgents.length?'var(--red)':'var(--green)'};">${unkAgents.length} agentes não identificados (${totalUnk} jogadores)</span></div>
      </div>
      <button class="btn-primary" style="font-size:.8rem;padding:9px 18px;" onclick="goPage('overview');renderOverview();">
        ✔ Confirmar e Ver Dashboard →
      </button>
    </div>

    ${unkAgents.length > 0 ? `
    <div style="background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.2);border-radius:10px;padding:14px 16px;margin-bottom:16px;">
      <div style="font-size:.8rem;font-weight:700;color:var(--red);margin-bottom:12px;">⚠️ Agentes Não Identificados — Vincule abaixo (todos os jogadores do agente serão classificados juntos)</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${unkAgents.map(([name, info])=>{
          const safeId = 'diag_'+btoa(encodeURIComponent(name)).replace(/[^a-zA-Z0-9]/g,'').slice(0,20);
          return `<div style="background:var(--s2);border:1px solid var(--b2);border-radius:9px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div>
              <span style="font-family:'JetBrains Mono',monospace;color:var(--t1);font-size:.82rem;font-weight:600;">${name||'(sem nome)'}</span>
              <span style="color:var(--t3);font-size:.74rem;margin-left:8px;">${info.count} jogador${info.count!==1?'es':''}</span>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <span style="font-size:.72rem;color:var(--t3);">Vincular a:</span>
              ${CLUBS.map(c=>{const m=CMETA[c];return`<button 
                onclick="diagLink('${name.replace(/'/g,"\\'")}','${c}','${safeId}')"
                id="dlb_${safeId}_${c}"
                style="background:var(--s3);border:1px solid var(--b2);color:var(--t2);padding:4px 11px;border-radius:12px;cursor:pointer;font-size:.74rem;font-family:'Outfit',sans-serif;transition:all .15s"
                onmouseover="this.style.color='var(--gold)';this.style.borderColor='var(--gold)'"
                onmouseout="if(!this.classList.contains('dlb-active')){this.style.color='var(--t2)';this.style.borderColor='var(--b2)'}"
              >${m.icon} ${c}</button>`;}).join('')}
              <span id="dlb_status_${safeId}" style="font-size:.74rem;color:var(--t3);">Pendente</span>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>` : `<div style="background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:.82rem;color:var(--green);">✅ Todos os agentes foram identificados automaticamente!</div>`}

    <div style="background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:14px 16px;">
      <div style="font-size:.76rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:10px;">✅ Agentes Classificados (${okAgents.length})</div>
      <div style="display:flex;flex-wrap:wrap;gap:7px;">
        ${okAgents.map(([name,info])=>{
          const m=CMETA[info.clube]||CMETA['?'];
          return`<div style="background:var(--s3);border-radius:7px;padding:5px 11px;display:flex;align-items:center;gap:6px;font-size:.75rem;">
            <span>${m.icon}</span>
            <span style="color:${m.color};font-weight:600;">${info.clube}</span>
            <span style="color:var(--t2);">${name||'?'}</span>
            <span style="color:var(--t3);">(${info.count})</span>
          </div>`;
        }).join('')}
      </div>
    </div>
  `;
  panel.style.display='block';
  panel.scrollIntoView({behavior:'smooth',block:'start'});
}

function diagLink(agentName, clube, safeId){
  saveManualLink(agentName.toUpperCase().trim(), clube);
  // Visual feedback
  CLUBS.forEach(c=>{
    const btn=document.getElementById(`dlb_${safeId}_${c}`);
    if(!btn)return;
    btn.classList.remove('dlb-active');
    btn.style.background='var(--s3)';btn.style.color='var(--t2)';btn.style.borderColor='var(--b2)';
  });
  const m=CMETA[clube]||{};
  const activeBtn=document.getElementById(`dlb_${safeId}_${clube}`);
  if(activeBtn){activeBtn.classList.add('dlb-active');activeBtn.style.background=`rgba(240,180,41,.15)`;activeBtn.style.color='var(--gold)';activeBtn.style.borderColor='var(--gold)';}
  const st=document.getElementById(`dlb_status_${safeId}`);
  if(st){st.textContent=`✓ ${m.icon} ${clube}`;st.style.color='var(--green)';}
  updateSidebar();
  showToast(`✅ ${agentName} → ${clube}`);
}

function resetImport(){
  rawHeaders=[];rawRows=[];
  dz.classList.remove('loaded');
  document.getElementById('dropIcon').textContent='📊';
  document.getElementById('dropTitle').textContent='Arraste a planilha aqui ou clique para selecionar';
  document.getElementById('dropSub').textContent='Planilha geral com todos os jogadores de todos os clubes';
  document.getElementById('mapperCard').classList.remove('show');
}

// ══════════════════ OVERVIEW ══════════════════
function renderOverview(){
  updateOverviewKPIs();
  const unk=allPlayers.filter(p=>p.clube==='?').length;

  // Club cards
  const grid=document.getElementById('clubsGrid');grid.innerHTML='';
  CLUBS.forEach(c=>{
    const m=CMETA[c]||{};
    const cp=allPlayers.filter(p=>p.clube===c);
    const rake    = sumF(cp,'rake');
    const ganhos  = sumF(cp,'ganhos');
    const ggr     = sumF(cp,'ggr');
    // Resultado clube = soma de resultadoAgente por agente
    const _agMap={};
    cp.forEach(p=>{ const k=p.aname||'(sem agente)'; if(!_agMap[k])_agMap[k]=[]; _agMap[k].push(p); });
    const result = Object.entries(_agMap).reduce((s,[k,pl])=>s+calcAgentResult(k,pl).resultadoAgente,0);
    const unkC    = allPlayers.filter(p=>p.clube==='?').length;
    const card=document.createElement('div');
    card.className=`club-ov-card ${m.cc||''}`;
    const logoHtml = clubLogos[c]
      ? `<img src="${clubLogos[c]}" class="coc-logo">`
      : `<span style="margin-right:6px">${m.icon}</span>`;
    card.innerHTML=`
      <div class="coc-header">
        <div class="coc-name">${logoHtml}${c}</div>
        <span class="coc-count">${cp.length} jogadores</span>
      </div>
      <div class="coc-stats">
        <div class="coc-stat">
          <div class="coc-stat-lbl">Rake Total</div>
          <div class="coc-stat-val" style="color:${m.color}">${cp.length ? fV(rake,false) : '—'}</div>
        </div>
        <div class="coc-stat">
          <div class="coc-stat-lbl">Resultado</div>
          <div class="coc-stat-val" style="color:${clr(result)}">${cp.length ? fV(result,false) : '—'}</div>
        </div>
      </div>
      <div class="coc-action">
        <button class="coc-btn" onclick="goClube('${c}')">Abrir Fechamento →</button>
        ${unkC>0?`<span class="coc-unlinked">⚠ ${unkC} não classificados</span>`:'<span class="coc-unlinked ok">✓ Classificado</span>'}
      </div>`;
    grid.appendChild(card);
  });

  filteredAll=[...allPlayers];
  renderAllTable();
  checkUnlinkedOv();
}

function updateSidebar(){
  document.getElementById('sb-total').textContent=allPlayers.length;
  CLUBS.forEach(c=>{
    const key={'IMPÉRIO':'imp','CONFRARIA':'con','3BET':'3bt','TGP':'tgp','CH':'ch'}[c];
    if(key) document.getElementById('sb-'+key).textContent=allPlayers.filter(p=>p.clube===c).length;
  });
  // Update fech dashboard badge
  if(allPlayers.length){
    const saved = activeClube;
    let totalAberto = 0;
    CLUBS.forEach(c => {
      activeClube = c;
      const setts = calcSettlements();
      setts.forEach(s => {
        const st = getSettlementStatus(s);
        if(st.cls === 'em-aberto') totalAberto++;
      });
    });
    activeClube = saved;
    const badge = document.getElementById('sb-fech-status');
    if(badge){
      if(totalAberto > 0){ badge.textContent = totalAberto; badge.style.background = 'rgba(239,68,68,.15)'; badge.style.color = '#ef4444'; }
      else { badge.textContent = '✓'; badge.style.background = 'rgba(16,185,129,.1)'; badge.style.color = '#10b981'; }
    }
  }
}

// ══════════════════ ALL TABLE ══════════════════
function filterAll(q){
  const s=q.toLowerCase();
  filteredAll=allPlayers.filter(p=>!s||
    (p.id+'').toLowerCase().includes(s)||
    p.nick.toLowerCase().includes(s)||
    p.aname.toLowerCase().includes(s)||
    p.clube.toLowerCase().includes(s));
  renderAllTable();
}

function renderAllTable(){
  renderTableRows('allBody', filteredAll, 'allPgInfo', 'allPgBtns', 'all');
}

// ══════════════════ CLUB TABLE ══════════════════
function filterClub(q){
  const s=q.toLowerCase();
  const base=allPlayers.filter(p=>p.clube===activeClube);
  filteredClub=base.filter(p=>!s||
    (p.id+'').toLowerCase().includes(s)||
    p.nick.toLowerCase().includes(s)||
    p.aname.toLowerCase().includes(s));
  renderClubTable();
}
function filterClubFunc(v){
  const base=allPlayers.filter(p=>p.clube===activeClube);
  filteredClub=base.filter(p=>!v||p.func.toLowerCase().includes(v));
  renderClubTable();
}
function renderClubTable(){
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  document.getElementById('dn-count').textContent=filteredClub.length;
  checkUnlinkedClub();
}

// Estado de agentes expandidos por tabela
const expandedAgents = { all: new Set(), club: new Set() };

// Resultado CALCULADO do jogador = ganhos + rakeback
// Delega para FinanceEngine.calcPlayerResult
function calcResult(p){
  return FinanceEngine.calcPlayerResult(p, getPlayerPctRB(p));
}

// ══ UNIFIED RB CALCULATION ══
// Delega para FinanceEngine.calcAgentRB (puro)
// Wrapper mantém a assinatura original (agKey, players)
function calcAgentRB(agKey, players){
  return FinanceEngine.calcAgentRB(
    players,
    getAgentPctAgente(agKey),
    !!agentDirect[agKey],
    getPlayerPctRB
  );
}

// Resultado do agente = ganhos + RB (unified)
// Delega para FinanceEngine.calcAgentResult (puro)
function calcAgentResult(agKey, players){
  return FinanceEngine.calcAgentResult(
    players,
    getAgentPctAgente(agKey),
    !!agentDirect[agKey],
    getPlayerPctRB
  );
}

// SHARED TABLE RENDERER V2 — financial focus
function renderTableRows(tbodyId, filtered, infoId, btnsId, mode){
  const tbody = document.getElementById(tbodyId);
  const expSet = expandedAgents[mode] || new Set();
  const isClub = mode === 'club';
  const colSpan = isClub ? 9 : 6;

  if(!allPlayers.length || !filtered.length){
    tbody.innerHTML=`<tr><td colspan="${colSpan}"><div class="empty-tbl"><div class="ei">${allPlayers.length?'🔍':'📂'}</div><p>${allPlayers.length?'Nenhum resultado encontrado.':'Importe a planilha primeiro.'}</p></div></td></tr>`;
    document.getElementById(infoId).textContent='0 registros';
    document.getElementById(btnsId).innerHTML='';
    return;
  }

  const finData = isClub ? (getFinData()[finKey()] || {}) : {};

  function getPlayerLedger(playerId){
    return getEntityLedgerNet(makeEntityId('pl', playerId));
  }

  const agentOrder = [];
  const agentMap   = {};
  filtered.forEach(p => {
    const key = p.aname || '(sem agente)';
    if(!agentMap[key]){ agentMap[key]=[]; agentOrder.push(key); }
    agentMap[key].push(p);
  });

  let html = '';
  let totalAPagar = 0, totalAReceber = 0;
  let gtGanhos = 0, gtRake = 0, gtRB = 0, gtSaldoAnt = 0;

  agentOrder.forEach(agKey => {
    const players = agentMap[agKey];
    const isOpen  = expSet.has(agKey);
    const m       = CMETA[players[0].clube] || CMETA['?'];
    const lnk     = players[0].clube==='?' ? `onclick="event.stopPropagation();openLink(${allPlayers.indexOf(players[0])})"` : '';

    const totGanhos = players.reduce((s,p)=>s+(Number(p.ganhos)||0),0);
    const totRake   = players.reduce((s,p)=>s+(Number(p.rake)||0),0);
    const totRB     = calcAgentRB(agKey, players);
    const totResult = totGanhos + totRB;
    gtGanhos += totGanhos; gtRake += totRake; gtRB += totRB;

    // ══════════════════════════════════════════════════
    // FÓRMULAS (aba Jogadores — COM saldo anterior):
    //   resultadoSemana = ganhos + rakeback
    //   pagamento       = saída − entrada  (líquido pago AO jogador pelo clube)
    //   saldoAtual      = saldoAnterior + resultadoSemana − pagamento
    //
    // saldo > 0 → jogador tem a receber   → "A Receber" (verde)
    // saldo < 0 → jogador deve ao clube   → "A Pagar"   (vermelho)
    // ══════════════════════════════════════════════════
    let agPag = 0, agSaldo = 0, agSaldoAnt = 0;
    let agSaldoAntStatus = 'novo';
    if(isClub){
      players.forEach(p => {
        const ledger = getPlayerLedger(p.id);
        agPag += ledger.net;
        const sa = getPlayerSaldoAnterior(p.id);
        agSaldoAnt += sa.value;
        if(sa.status === 'provisorio' && agSaldoAntStatus !== 'provisorio') agSaldoAntStatus = sa.status;
        if(sa.status === 'locked') agSaldoAntStatus = sa.status;
      });
      agSaldo = FinanceEngine.calcSaldoAtual(agSaldoAnt, totResult, agPag);

      if(agSaldo > 0.01)  totalAReceber += agSaldo;
      if(agSaldo < -0.01) totalAPagar   += Math.abs(agSaldo);
      gtSaldoAnt += agSaldoAnt;
    }

    // ── LINHA DA AGÊNCIA ──
    let clubCells = '';
    if(isClub){
      const saldoAntStr = Math.abs(agSaldoAnt) < 0.01 ? '<span style="color:var(--t3);font-size:.68rem;">—</span>'
        : `<span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:${clr(agSaldoAnt)};font-weight:600;">${fV(agSaldoAnt,false)}</span>`;
      const saldoAntBadge = agSaldoAntStatus === 'locked' ? '<span style="font-size:.55rem;color:#10b981;margin-left:3px;vertical-align:super;">✓</span>'
        : agSaldoAntStatus === 'provisorio' ? '<span style="font-size:.55rem;color:var(--gold);margin-left:3px;vertical-align:super;">⚠</span>' : '';
      const pagStr = Math.abs(agPag) > 0.01
        ? `<span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:${agPag>0?'#10b981':'#60a5fa'};font-weight:600;">${fV(agPag,false)}</span>`
        : `<span style="color:var(--t3);font-size:.68rem;">—</span>`;
      const saldoStr = Math.abs(agSaldo) < 0.01 ? '—'
        : `<span style="color:${clr(agSaldo)};font-weight:600;">${fV(agSaldo,false)}</span>`;
      const hasPag = Math.abs(agPag) > 0.01;
      const sitBadge = Math.abs(agSaldo) < 0.01
        ? `<span class="pl2-saldo-badge quitado">🟡 Quitado</span>`
        : hasPag
          ? `<span class="pl2-saldo-badge" style="background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);color:#f59e0b;">🟠 Parcial</span>`
          : agSaldo > 0
            ? `<span class="pl2-saldo-badge" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.15);color:#10b981;">🟢 A Receber</span>`
            : `<span class="pl2-saldo-badge deve">🔴 A Pagar</span>`;
      clubCells = `<td style="text-align:right;">${saldoAntStr}${saldoAntBadge}</td><td style="text-align:right;">${pagStr}</td><td style="text-align:right;font-family:'JetBrains Mono',monospace;">${saldoStr}</td><td>${sitBadge}</td>`;
    }

    html += `<tr class="ag2${isOpen?' open':''}" onclick="toggleAgent('${mode}','${agKey.replace(/'/g,"\\'")}','${tbodyId}','${infoId}','${btnsId}')">
      <td>
        <div class="ag2-name">
          <span class="ag2-toggle">▶</span>
          <span class="ag2-label">${agKey}</span>
          <span class="ag2-count">${players.length}</span>
        </div>
      </td>
      ${!isClub ? `<td><span class="ct ${m.cls}" ${lnk}>${m.icon} ${players[0].clube==='?'?'⚠':players[0].clube}</span></td>` : ''}
      <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:${clr(totGanhos)};font-weight:600;">${fV(totGanhos,false)}</td>
      <td class="v2-subtle" style="text-align:right;font-family:'JetBrains Mono',monospace;">${fV(totRake,false)}</td>
      <td style="text-align:right;font-family:'JetBrains Mono',monospace;color:#a3e635;font-weight:600;">${totRB>0?fV(totRB,false):'—'}</td>
      <td style="text-align:right;"><span class="ag2-resultado ${totResult>0?'pos':totResult<0?'neg':'zero'}">${fV(totResult,false)}</span></td>
      ${clubCells}
    </tr>`;

    // ── LINHAS DOS JOGADORES ──
    players.forEach(p => {
      const rbPct   = getPlayerPctRB(p);
      const rbVal   = (Number(p.rake)||0) * rbPct / 100;
      const pr      = calcResult(p);

      let plClubCells = '';
      if(isClub){
        const ledger = getPlayerLedger(p.id);
        const pagamento = ledger.net;   // ledgerNet via FinanceEngine
        const sa = getPlayerSaldoAnterior(p.id);
        const saldoAnt = sa.value;
        const saldo = FinanceEngine.calcSaldoAtual(saldoAnt, pr, pagamento);

        const saldoAntStr = Math.abs(saldoAnt) < 0.01 ? '<span style="color:var(--t3);font-size:.68rem;">—</span>'
          : `<span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:${clr(saldoAnt)};font-weight:600;">${fV(saldoAnt,false)}</span>`;
        const saBadge = sa.status === 'locked' ? '<span style="font-size:.55rem;color:#10b981;margin-left:3px;vertical-align:super;">✓</span>'
          : sa.status === 'provisorio' ? '<span style="font-size:.55rem;color:var(--gold);margin-left:3px;vertical-align:super;">⚠</span>' : '';
        const pagStr = Math.abs(pagamento) > 0.01
          ? `<span style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:${pagamento>0?'#10b981':'#60a5fa'};font-weight:600;">${fV(pagamento,false)}</span>`
          : `<span style="color:var(--t3);font-size:.68rem;">—</span>`;
        const saldoStr = Math.abs(saldo) < 0.01 ? '—'
          : `<span style="color:${clr(saldo)};font-weight:600;">${fV(saldo,false)}</span>`;
        const hasPag = Math.abs(pagamento) > 0.01;
        const sitBadge = Math.abs(saldo) < 0.01
          ? `<span class="pl2-saldo-badge quitado">🟡 Quitado</span>`
          : hasPag
            ? `<span class="pl2-saldo-badge" style="background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);color:#f59e0b;">🟠 Parcial</span>`
            : saldo > 0
              ? `<span class="pl2-saldo-badge" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.15);color:#10b981;">🟢 A Receber</span>`
              : `<span class="pl2-saldo-badge deve">🔴 A Pagar</span>`;
        plClubCells = `<td style="text-align:right;">${saldoAntStr}${saBadge}</td><td style="text-align:right;">${pagStr}</td><td style="text-align:right;font-family:'JetBrains Mono',monospace;">${saldoStr}</td><td>${sitBadge}</td>`;
      }

      const resClass = pr > 0 ? 'pos' : pr < 0 ? 'neg' : 'zero';

      html += `<tr class="pl2${isOpen?'':' hidden'}" data-agent="${agKey.replace(/"/g,'&quot;')}">
        <td>
          <div class="pl2-nick">${p.nick||'—'}</div>
          <div class="pl2-id">#${p.id||'—'}</div>
        </td>
        ${!isClub ? `<td><span class="ct ${m.cls}" ${lnk}>${m.icon} ${players[0].clube==='?'?'⚠':players[0].clube}</span></td>` : ''}
        <td style="text-align:right;" class="${p.ganhos>0?'vp':p.ganhos<0?'vn':'vz'}">${fV(p.ganhos)}</td>
        <td style="text-align:right;" class="v2-subtle" style="font-family:'JetBrains Mono',monospace;">${fV(p.rake)}</td>
        <td style="text-align:right;">
          <div class="pl2-rb">
            <span class="pl2-rb-pct">${rbPct>0?rbPct+'%':''}</span>
            ${rbVal>0?`<span class="pl2-rb-val">R$ ${fV(rbVal,false)}</span>`:`<span style="color:var(--t3);font-size:.68rem;">—</span>`}
          </div>
        </td>
        <td style="text-align:right;"><span class="pl2-resultado ${resClass}">${fV(pr,false)}</span></td>
        ${plClubCells}
      </tr>`;
    });

    // ── RODAPÉ DA AGÊNCIA ──
    if(isClub){
      const sitBadgeAg = Math.abs(agSaldo) < 0.01
        ? `<span style="color:var(--gold);font-weight:700;">🟡 Quitado</span>`
        : agSaldo < 0
          ? `<span style="color:var(--red);font-weight:700;">🔴 A Pagar ${fV(agSaldo,false)}</span>`
          : `<span style="color:var(--green);font-weight:700;">🟢 A Receber ${fV(agSaldo,false)}</span>`;

      html += `<tr class="ag2-footer${isOpen?'':' hidden'}" data-agent="${agKey.replace(/"/g,'&quot;')}">
        <td colspan="${colSpan}">
          <div class="ag2-summary">
            <div class="ag2-sum-item">
              <div class="ag2-sum-lbl">Rake do Time</div>
              <div class="ag2-sum-val" style="color:var(--green);">${fV(totRake,false)}</div>
            </div>
            <div class="ag2-sum-sep"></div>
            <div class="ag2-sum-item">
              <div class="ag2-sum-lbl">Rakeback</div>
              <div class="ag2-sum-val" style="color:#a3e635;">${totRB>0?fV(totRB,false):'—'}</div>
            </div>
            <div class="ag2-sum-sep"></div>
            <div class="ag2-sum-item">
              <div class="ag2-sum-lbl">Resultado</div>
              <div class="ag2-sum-val" style="color:${clr(totResult)};">${fV(totResult,false)}</div>
            </div>
            <div class="ag2-sum-sep"></div>
            <div class="ag2-sum-item">
              <div class="ag2-sum-lbl">Situação</div>
              <div class="ag2-sum-val">${sitBadgeAg}</div>
            </div>
          </div>
        </td>
      </tr>`;
    }
  });

  // ── TOTAL GERAL ──
  const gtResult = gtGanhos + gtRB;
  html += `<tr class="grand-total-row">
    <td>TOTAL</td>
    ${!isClub ? '<td></td>' : ''}
    <td style="text-align:right;">${fV(gtGanhos,false)}</td>
    <td style="text-align:right;">${fV(gtRake,false)}</td>
    <td style="text-align:right;color:#a3e635;">${fV(gtRB,false)}</td>
    <td style="text-align:right;font-weight:900;font-size:.85rem;">${fV(gtResult,false)}</td>
    ${isClub ? '<td style="text-align:right;font-family:\'JetBrains Mono\',monospace;font-size:.72rem;color:'+clr(gtSaldoAnt)+';font-weight:600;">'+fV(gtSaldoAnt,false)+'</td><td></td><td></td><td style="font-size:.68rem;color:var(--gold);opacity:.7">'+agentOrder.length+' agências · '+filtered.length+' jogadores</td>' : ''}
  </tr>`;

  tbody.innerHTML = html;

  document.getElementById(infoId).textContent =
    `${agentOrder.length} agência${agentOrder.length!==1?'s':''} · ${filtered.length} jogador${filtered.length!==1?'es':''}`;
  document.getElementById(btnsId).innerHTML = '';

  if(isClub) updateV2KPIs(gtGanhos, gtRake, gtRB, gtResult, totalAPagar, totalAReceber);
}

function toggleAgent(mode, agKey, tbodyId, infoId, btnsId){
  const expSet = expandedAgents[mode] || new Set();
  if(expSet.has(agKey)) expSet.delete(agKey);
  else expSet.add(agKey);
  expandedAgents[mode] = expSet;
  renderTableRows(tbodyId, mode==='all'?filteredAll:filteredClub, infoId, btnsId, mode);
}

// Atualiza KPIs executivos da aba Jogadores
function updateV2KPIs(gtGanhos, gtRake, gtRB, gtResult, totalAPagar, totalAReceber){
  const e = id => document.getElementById(id);
  // Jogadores ativos = ganhos ≠ 0 (jogou na semana)
  const ativos = filteredClub.filter(p => Math.abs(Number(p.ganhos)||0) > 0.01).length;
  if(e('v2k-ativos')) e('v2k-ativos').textContent = ativos;
  if(e('v2k-pl')){
    e('v2k-pl').textContent = 'R$ ' + fV(gtGanhos, false);
    e('v2k-pl').style.color = clr(gtGanhos);
  }
  if(e('v2k-rake'))   e('v2k-rake').textContent   = 'R$ ' + fV(gtRake, false);
  if(e('v2k-rb'))     e('v2k-rb').textContent     = gtRB > 0 ? 'R$ ' + fV(gtRB, false) : '—';
  if(e('v2k-resultado')){
    e('v2k-resultado').textContent = 'R$ ' + fV(gtResult, false);
    e('v2k-resultado').style.color = clr(gtResult);
  }
}

// ── ACERTO DIRETO COM JOGADORES ──
// playerDirect[playerId] = true/false
const playerDirect = DataLayer.getPlayerDirect();

// ── ACERTO DIRETO POR AGÊNCIA ──
// agentDirect[agKey] = true → todos os jogadores dessa agência são "diretos"
const agentDirect = DataLayer.getAgentDirect();
function saveAgentDirect(){ DataLayer.saveAgentDirect(agentDirect); }

// Helper: verifica se jogador é "direto" (flag individual OU agência marcada)
function isPlayerDirectSettlement(playerId, agKey){
  if(playerDirect[playerId]) return true;
  if(agKey && agentDirect[agKey]) return true;
  return false;
}

// ── RB POR JOGADOR (override) ──
const playerRB = DataLayer.getPlayerRB();
function savePlayerRB(){ DataLayer.savePlayerRB(playerRB); }

// ── WEEK LOCK / SNAPSHOT SYSTEM ──
const weekLocked     = DataLayer.getWeekLocked();
const rbSnapPlayers  = DataLayer.getRbSnapPlayers();
const rbSnapAgents   = DataLayer.getRbSnapAgents();
const finSnapshot    = DataLayer.getFinSnapshot();
function saveWeekLocked(){   DataLayer.saveWeekLocked(weekLocked); }
function saveRbSnapPlayers(){DataLayer.saveRbSnapPlayers(rbSnapPlayers); }
function saveRbSnapAgents(){ DataLayer.saveRbSnapAgents(rbSnapAgents); }
function saveFinSnapshot(){  DataLayer.saveFinSnapshot(finSnapshot); }

function getWeekKey(){ return weeks[selWeekIdx] || '0'; }

function isWeekLocked(wk){ return !!weekLocked[wk || getWeekKey()]; }

function lockWeekRakeback(wk){
  wk = wk || getWeekKey();
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  const cp = allPlayers.filter(p=>p.clube===activeClube);
  if(!cp.length){ showToast('⚠️ Nenhum jogador importado','e'); return; }

  // Snapshot de players: salva pctEfetivo de cada jogador
  if(!rbSnapPlayers[wk]) rbSnapPlayers[wk] = {};
  cp.forEach(p => {
    rbSnapPlayers[wk][String(p.id)] = getPlayerPctRB(p);
  });

  // Snapshot de agentes: salva pctAgente
  if(!rbSnapAgents[wk]) rbSnapAgents[wk] = {};
  const agNames = [...new Set(cp.map(p=>(p.aname||'').trim()))];
  agNames.forEach(ag => {
    const cfg = agentRB[ag] || {};
    rbSnapAgents[wk][ag] = {
      pctAgente: Number(cfg.pctAgente ?? cfg.pct ?? 0) || 0
    };
  });

  weekLocked[wk] = true;
  saveWeekLocked(); saveRbSnapPlayers(); saveRbSnapAgents();

  // ── Snapshot financeiro: grava saldoFinal de cada entidade ──
  const snapKey = activeClube + '||' + wk;
  const entities = calcFinEntities();
  const balances = {};
  entities.forEach(e => {
    const saldoPrev        = getSaldoAnterior(e.id);
    const resultadoFinal   = -(e.valor);
    const pagamentosLiquido = getMovTotal(e.id);
    const saldoFinal       = saldoPrev + resultadoFinal - pagamentosLiquido;
    balances[e.id] = { saldoFinal, resultadoFinal, pagamentosLiquido, nome: e.nome, tipo: e.tipo };
  });
  finSnapshot[snapKey] = { lockedAt: Date.now(), weekKey: wk, balances };

  // ── Snapshot per-player: grava saldoAtual de cada jogador para carry-forward ──
  const playerBalances = {};
  cp.forEach(p => {
    const rbPct = getPlayerPctRB(p);
    const rbVal = (Number(p.rake)||0) * rbPct / 100;
    const resultado = (Number(p.ganhos)||0) + rbVal;
    // Pagamentos do jogador nesta semana
    const fk = activeClube + '||' + wk;
    const allFinData = getFinData();
    const finWeekData = allFinData[fk] || {};
    let pEntrada = 0, pSaida = 0;
    Object.values(finWeekData).forEach(entity => {
      (entity.historico||[]).forEach(h => {
        if(String(h.cpId||'') === String(p.id)){
          if(h.dir === 'out') pSaida += h.valor || 0;
          else pEntrada += h.valor || 0;
        }
      });
    });
    const pPagamento = pSaida - pEntrada;
    const prevSaldo = getPlayerSaldoAnterior(p.id);
    playerBalances[String(p.id)] = prevSaldo.value + resultado - pPagamento;
  });
  finSnapshot[snapKey].playerBalances = playerBalances;
  saveFinSnapshot();

  // Persistir carry semanal ao lockar (legado)
  DataLayer.persistCarry(activeClube, wk, selWeekIdx, weeks, allPlayers);

  showToast('🔒 Semana lockada — snapshot + carry salvos');
  renderLockButton();
  renderRakebackTab();
  renderClubTable();
  renderAgentClosing();
  updateClubKPIs();
}

function unlockWeekRakeback(wk){
  wk = wk || getWeekKey();
  if(!confirm('⚠️ Desbloquear semana? Os % salvos no snapshot serão mantidos mas não serão mais usados nos cálculos desta semana até novo lock.')) return;
  weekLocked[wk] = false;
  saveWeekLocked();
  showToast('🔓 Semana desbloqueada');
  renderLockButton();
  renderRakebackTab();
  renderClubTable();
  renderAgentClosing();
  updateClubKPIs();
}

// ── LOCK BUTTON NO HEADER (visível em todas as sub-tabs) ──
function renderLockButton(){
  const el = document.getElementById('dc-lock-btn');
  if(!el) return;
  const locked = isWeekLocked();
  if(locked){
    el.innerHTML = `<div style="display:inline-flex;align-items:center;gap:6px;">
      <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:5px 10px;border-radius:7px;font-size:.62rem;font-weight:700;">🔒 LOCKED</span>
      <button onclick="unlockWeekRakeback()" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:5px 10px;border-radius:7px;font-size:.62rem;font-weight:700;cursor:pointer;">🔓 Desbloquear</button>
    </div>`;
  } else {
    el.innerHTML = `<button onclick="openLockChecklist()" style="background:rgba(240,180,41,.08);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:5px 12px;border-radius:7px;font-size:.62rem;font-weight:700;cursor:pointer;">🔒 Lockar Semana</button>`;
  }
  // Also update dc-week LOCKED badge
  const dcw = document.getElementById('dc-week');
  if(dcw){
    dcw.innerHTML = '📅 ' + fWL(weeks[selWeekIdx]) + (locked ? ' <span style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:2px 8px;border-radius:5px;font-size:.62rem;font-weight:700;margin-left:6px;">🔒 LOCKED</span>' : '');
  }
}

// ── LOCK CHECKLIST ──
function openLockChecklist(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  const cp = allPlayers.filter(p=>p.clube===activeClube);
  if(!cp.length){ showToast('⚠️ Nenhum jogador importado','e'); return; }

  const setts = calcSettlements();
  const emAberto = setts.filter(s => { const st = getSettlementStatus(s); return st.cls === 'em-aberto'; });
  const quitados = setts.filter(s => { const st = getSettlementStatus(s); return st.cls === 'quitado'; });
  const comMov = setts.filter(s => getSettlementStatus(s).cls !== 'sem-mov');

  // Check items
  const checks = [];

  // 1. Players imported
  checks.push({ ok: cp.length > 0, label: cp.length + ' jogadores importados', icon: '👥' });

  // 2. RB configured
  const agents = [...new Set(cp.map(p=>(p.aname||'').trim()).filter(Boolean))];
  const agentsWithRB = agents.filter(a => { const cfg = agentRB[a]||{}; return Number(cfg.pctAgente ?? cfg.pct ?? 0) > 0; });
  checks.push({ ok: agentsWithRB.length === agents.length, label: agentsWithRB.length + '/' + agents.length + ' agentes com RB configurado', icon: '💸' });

  // 3. Settlement status
  const totalEntidades = comMov.length;
  checks.push({ ok: quitados.length === totalEntidades, label: quitados.length + '/' + totalEntidades + ' entidades quitadas', icon: '✅' });

  // 4. Em aberto
  checks.push({ ok: emAberto.length === 0, label: emAberto.length === 0 ? 'Nenhum pagamento em aberto' : emAberto.length + ' pagamento(s) em aberto', icon: '💳' });

  // 6. Liga manual entries
  const m = clubManual[activeClube] || {};
  const hasLancamentos = Number(m.compras||0) > 0 || Number(m.security||0) > 0 || Number(m.overlay||0) > 0 || Number(m.outros||0) > 0;
  checks.push({ ok: true, label: hasLancamentos ? 'Lançamentos manuais registrados' : 'Sem lançamentos manuais (OK se não houver)', icon: '📝', neutral: !hasLancamentos });

  // Render
  const el = document.getElementById('lock-checklist-items');
  let html = '';
  checks.forEach(c => {
    const color = c.ok ? '#10b981' : (c.neutral ? '#94a3b8' : '#f59e0b');
    const bg = c.ok ? 'rgba(16,185,129,.06)' : (c.neutral ? 'rgba(148,163,184,.06)' : 'rgba(245,158,11,.06)');
    const border = c.ok ? 'rgba(16,185,129,.12)' : (c.neutral ? 'rgba(148,163,184,.12)' : 'rgba(245,158,11,.15)');
    const check = c.ok ? '✅' : (c.neutral ? '➖' : '⚠️');
    html += '<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:'+bg+';border:1px solid '+border+';border-radius:7px;margin-bottom:5px;">';
    html += '<span style="font-size:.8rem;">'+check+'</span>';
    html += '<span style="font-size:.74rem;color:var(--t1);flex:1;">'+c.icon+' '+c.label+'</span>';
    html += '</div>';
  });
  el.innerHTML = html;

  // Warnings
  const wEl = document.getElementById('lock-checklist-warnings');
  let wHtml = '';
  const hasWarnings = pendentes.length > 0 || parciais.length > 0;
  if(hasWarnings){
    wHtml += '<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:8px;padding:10px 14px;font-size:.72rem;color:#f59e0b;">';
    wHtml += '⚠️ <strong>Atenção:</strong> existem pagamentos em aberto. O lock vai salvar o snapshot com saldos pendentes, que serão carregados como <strong>Saldo Anterior</strong> na próxima semana.';
    wHtml += '</div>';
  } else {
    wHtml += '<div style="background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.12);border-radius:8px;padding:10px 14px;font-size:.72rem;color:#10b981;">';
    wHtml += '✅ Tudo conferido! Pode lockar com segurança.';
    wHtml += '</div>';
  }
  wEl.innerHTML = wHtml;

  // Enable/disable confirm button (always enabled — warnings are advisory)
  const btn = document.getElementById('lock-checklist-confirm');
  if(btn) btn.disabled = false;

  openM('mLockChecklist');
}

function confirmLockFromChecklist(){
  closeM('mLockChecklist');
  lockWeekRakeback();
}
function setPlayerRB(playerId, pct){
  const v = parseFloat(pct);
  if(isNaN(v)) return;
  playerRB[String(playerId)] = v;
  savePlayerRB();
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  renderRakebackTab();
  if(typeof renderAgentClosing==='function') renderAgentClosing();
}
function clearPlayerRB(playerId){
  delete playerRB[String(playerId)];
  savePlayerRB();
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  renderRakebackTab();
  if(typeof renderAgentClosing==='function') renderAgentClosing();
}

function savePlayerDirect(){ DataLayer.savePlayerDirect(playerDirect); }

// Retorna % efetivo de RB do jogador:
// snapshot lockado > override individual > padrão do agente > 0
function getPlayerPctRB(p){
  const wk = getWeekKey();
  // 1) Se semana lockada e snapshot existe, usar snapshot
  if(isWeekLocked(wk) && rbSnapPlayers[wk]){
    const snap = rbSnapPlayers[wk][String(p.id)];
    if(snap !== undefined && snap !== null) return Number(snap) || 0;
  }
  // 2) Override individual do player
  const ov = playerRB[String(p.id)];
  if(ov !== undefined && ov !== null && ov !== '') return Number(ov) || 0;
  // 3) Padrão do agente (pctAgente = RB que cada jogador recebe por padrão)
  const cfg = agentRB[(p.aname||'').trim()] || {};
  return Number(cfg.pctAgente ?? cfg.pct ?? 0) || 0;
}

// Retorna pctAgente efetivo (snapshot > atual)
function getAgentPctAgente(agKey){
  const wk = getWeekKey();
  if(isWeekLocked(wk) && rbSnapAgents[wk] && rbSnapAgents[wk][agKey]){
    return Number(rbSnapAgents[wk][agKey].pctAgente) || 0;
  }
  const cfg = agentRB[agKey] || {};
  return Number(cfg.pctAgente ?? cfg.pct ?? 0) || 0;
}

function togglePlayerDirect(playerId){
  playerDirect[playerId] = !playerDirect[playerId];
  if(!playerDirect[playerId]) delete playerDirect[playerId]; // remove falsy keys
  savePlayerDirect();
  renderClubTable();
  renderRakebackTab();
}

// ── SALDO ANTERIOR POR JOGADOR ──────────────────────────────
// RB% para uma semana específica (pode ser diferente da atual se lockada)
function getPlayerPctRBForWeek(player, weekKey){
  if(isWeekLocked(weekKey) && rbSnapPlayers[weekKey]){
    const snap = rbSnapPlayers[weekKey][String(player.id)];
    if(snap !== undefined && snap !== null) return Number(snap) || 0;
  }
  const ov = playerRB[String(player.id)];
  if(ov !== undefined && ov !== null && ov !== '') return Number(ov) || 0;
  const cfg = agentRB[(player.aname||'').trim()] || {};
  return Number(cfg.pctAgente ?? cfg.pct ?? 0) || 0;
}

// Calcula saldo de um jogador ao FINAL de uma semana (recursivo com snapshot short-circuit)
function getPlayerSaldoAtWeek(playerId, weekIdx){
  if(!activeClube || weekIdx < 0 || !weeks[weekIdx]) return { value: 0, status: 'novo' };

  const weekKey = String(weeks[weekIdx]);
  const snapKey = activeClube + '||' + weekKey;

  // 1) SHORT-CIRCUIT: snapshot lockado com playerBalances
  const snap = finSnapshot[snapKey];
  if(snap && snap.playerBalances && snap.playerBalances[String(playerId)] !== undefined){
    return { value: Number(snap.playerBalances[String(playerId)]) || 0, status: 'locked' };
  }

  // 2) Calcular: saldoAnterior + resultado - pagamento
  const prev = weekIdx > 0 ? getPlayerSaldoAtWeek(playerId, weekIdx - 1) : { value: 0, status: 'novo' };
  const saldoAnterior = prev.value;

  // Carregar dados importados desta semana
  const importData = DataLayer.loadImport(weekKey);
  if(!importData || !importData.players) return { value: saldoAnterior, status: prev.status === 'locked' ? 'locked' : 'provisorio' };

  const player = importData.players.find(p => String(p.id) === String(playerId) && p.clube === activeClube);
  if(!player) return { value: saldoAnterior, status: prev.status === 'locked' ? 'locked' : 'provisorio' };

  // Resultado = ganhos + rakeback
  const rbPct = getPlayerPctRBForWeek(player, weekKey);
  const rbVal = (Number(player.rake)||0) * rbPct / 100;
  const resultado = (Number(player.ganhos)||0) + rbVal;

  // Movimentações do ledger para este jogador nesta semana
  // Coleta todas as entradas do historico que referenciam este playerId
  const fk = activeClube + '||' + weekKey;
  const allFin = getFinData();
  const finWeek = allFin[fk] || {};
  const playerHist = [];
  Object.values(finWeek).forEach(entity => {
    (entity.historico||[]).forEach(h => {
      if(String(h.cpId||'') === String(playerId)) playerHist.push(h);
    });
  });
  // FÓRMULA CANÔNICA: saldoAtual = saldoAnterior + resultado − ledgerNet
  const ledger = FinanceEngine.calcLedgerNet(playerHist);
  const saldo  = FinanceEngine.calcSaldoAtual(saldoAnterior, resultado, ledger.net);
  const status = isWeekLocked(weekKey) ? 'locked' : 'provisorio';

  return { value: saldo, status };
}

// Convenience: saldo anterior = saldo ao final da semana ANTERIOR
function getPlayerSaldoAnterior(playerId){
  if(selWeekIdx <= 0) return { value: 0, status: 'novo' };
  return getPlayerSaldoAtWeek(playerId, selWeekIdx - 1);
}

// ── RAKEBACK TAB ──
// Estado de expand na aba Rakeback
const rbExpandedAgents = new Set();
let _rbSearch = '';
let _rbSearchTimer = null;
let _activeRbTab = 'agencias';

function switchRbTab(tab){
  _activeRbTab = tab;
  const pAg  = document.getElementById('rb-panel-agencias');
  const pDir = document.getElementById('rb-panel-diretos');
  if(pAg)  pAg.style.display = tab === 'agencias' ? '' : 'none';
  if(pDir) pDir.style.display = tab === 'diretos'  ? '' : 'none';
  renderRakebackTab();
}

function setRbSearch(q){
  _rbSearch = q.toLowerCase().trim();
  clearTimeout(_rbSearchTimer);
  _rbSearchTimer = setTimeout(() => {
    const prev = document.activeElement;
    const wasSearch = prev && prev.id === 'rb-search-input';
    const cursorPos = wasSearch ? prev.selectionStart : 0;
    renderRakebackTab();
    if(wasSearch){
      const inp = document.getElementById('rb-search-input');
      if(inp){ inp.focus(); inp.setSelectionRange(cursorPos, cursorPos); }
    }
  }, 200);
}

function toggleRbAgent(agKey){
  if(rbExpandedAgents.has(agKey)) rbExpandedAgents.delete(agKey);
  else rbExpandedAgents.add(agKey);
  renderRakebackTab();
}

function setPlayerRBFromRbTab(playerId, val){
  const v = parseFloat(val);
  if(isNaN(v)) return;
  playerRB[String(playerId)] = v;
  savePlayerRB();
  renderRakebackTab();
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  updateClubKPIs(); updateOverviewKPIs();
}

function clearPlayerRBFromRbTab(playerId){
  delete playerRB[String(playerId)];
  savePlayerRB();
  renderRakebackTab();
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  updateClubKPIs(); updateOverviewKPIs();
}

function renderRakebackTab(){
  if(!activeClube) return;
  const elCommon = document.getElementById('rb-common-area');
  const el  = document.getElementById('rb-summary-content');
  const el2 = document.getElementById('rb-diretos-content');
  if(!elCommon || !el) return;

  const cp = allPlayers.filter(p=>p.clube===activeClube);
  if(!cp.length){
    const empty = '<div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>';
    elCommon.innerHTML = empty;
    el.innerHTML = '';
    if(el2) el2.innerHTML = '';
    return;
  }

  const wk = getWeekKey();
  const wkLocked = isWeekLocked(wk);

  const agentMap = {};
  cp.forEach(p=>{
    const raw = (p.aname||'').trim();
    const k = (!raw || /^(none|null|undefined)$/i.test(raw)) ? '(sem agente)' : raw;
    if(!agentMap[k]) agentMap[k]=[];
    agentMap[k].push(p);
  });

  const rakeGeral = cp.reduce((s,p)=>s+n(p.rake),0);
  let rbTotal = 0;

  // Separate normal vs direct
  const normalAgents = [];
  const directAgents = [];
  Object.entries(agentMap).forEach(([agKey, players])=>{
    const rakeTime = players.reduce((s,p)=>s+n(p.rake),0);
    if(agentDirect[agKey]){
      let agRB = 0;
      const plRows = players.map(p => {
        const pct = getPlayerPctRB(p);
        const rb = (Number(p.rake)||0) * pct / 100;
        agRB += rb;
        return { p, pct, rb };
      });
      rbTotal += agRB;
      directAgents.push({ agKey, players, rakeTime, agRB, plRows });
    } else {
      const pctAgente = getAgentPctAgente(agKey);
      const totalRBag = rakeTime * pctAgente / 100;
      const taxaAg = rakeTime * (getLigaRate('taxaApp') + getLigaRate('taxaLiga'));
      const lucroAg = rakeTime - totalRBag - taxaAg;
      rbTotal += totalRBag;
      normalAgents.push({ agKey, players, rakeTime, pctAgente, totalRBag, lucroAg });
    }
  });

  const taxaRate = getLigaRate('taxaApp') + getLigaRate('taxaLiga');
  const taxaLiga = rakeGeral * taxaRate;
  const lucroLiq = rakeGeral - rbTotal - taxaLiga;

  const card = (icon, lbl, val, color, sub='') =>
    `<div style="background:var(--s1);border:1px solid var(--b1);border-radius:11px;padding:16px 18px;flex:1;min-width:160px;">
      <div style="font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:8px;">${icon} ${lbl}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:800;color:${color};">${fV(val,false)}</div>
      ${sub?`<div style="font-size:.7rem;color:var(--t3);margin-top:4px;">${sub}</div>`:''}
    </div>`;

  const lockBadge = wkLocked
    ? `<span style="display:inline-flex;align-items:center;gap:5px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);color:#ef4444;padding:5px 12px;border-radius:8px;font-size:.72rem;font-weight:700;">🔒 LOCKADA</span>`
    : `<span style="display:inline-flex;align-items:center;gap:5px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:5px 12px;border-radius:8px;font-size:.72rem;font-weight:700;">🔓 Editável</span>`;

  const ths = 'padding:9px 12px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:var(--s2);';

  // Filter (applies to Agências tab only)
  let filtNormal = normalAgents;
  let filtDirect = directAgents;
  if(_rbSearch){
    filtNormal = normalAgents.filter(({agKey, players}) =>
      agKey.toLowerCase().includes(_rbSearch) ||
      players.some(p => (p.nick||'').toLowerCase().includes(_rbSearch) || String(p.id||'').includes(_rbSearch))
    );
    filtDirect = directAgents.filter(({agKey, players}) =>
      agKey.toLowerCase().includes(_rbSearch) ||
      players.some(p => (p.nick||'').toLowerCase().includes(_rbSearch) || String(p.id||'').includes(_rbSearch))
    );
  }

  // ── Helper: player row ──
  function playerRowHtml(p, pct, rb, isPlLocked){
    const hasOv = playerRB[String(p.id)] !== undefined;
    const pSafe = String(p.id).replace(/'/g,"\\'");
    const pInputId = 'rbpl-'+String(p.id).replace(/[^a-zA-Z0-9]/g,'_');
    const pConfirmed = hasOv;
    return `<tr style="border-top:1px solid rgba(255,255,255,.035);">
      <td style="padding:5px 12px 5px 36px;font-size:.77rem;">
        <span style="font-weight:500;">${p.nick||'—'}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--t3);margin-left:5px;">#${p.id||''}</span>
      </td>
      <td style="padding:5px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--green);">${fV(p.rake,false)}</td>
      <td style="padding:5px 12px;text-align:center;">
        ${isPlLocked
          ? '<span style="font-family:\'JetBrains Mono\',monospace;font-size:.74rem;color:'+(hasOv?'#60a5fa':'var(--t2)')+';font-weight:'+(hasOv?'700':'400')+';">'+pct+'%</span>'
          : pConfirmed
            ? '<div style="display:flex;align-items:center;gap:3px;justify-content:center;"><span style="font-family:\'JetBrains Mono\',monospace;font-size:.74rem;color:#60a5fa;font-weight:700;">'+pct+'%</span><button onclick="clearPlayerRBFromRbTab(\''+pSafe+'\')" style="background:var(--s3);border:1px solid var(--b2);color:var(--t3);padding:1px 5px;border-radius:4px;font-size:.55rem;cursor:pointer;" title="Editar">✎</button></div>'
            : '<div style="display:flex;align-items:center;gap:3px;justify-content:center;"><input type="number" min="0" max="100" step="0.1" value="'+pct+'" id="'+pInputId+'" style="width:48px;background:var(--s3);border:1px solid var(--b2);border-radius:5px;padding:3px 5px;color:var(--gold);font-family:\'JetBrains Mono\',monospace;font-size:.72rem;text-align:center;" onkeydown="if(event.key===\'Enter\'){event.preventDefault();confirmPlayerRB(\''+pSafe+'\',\''+pInputId+'\')}"><button onclick="confirmPlayerRB(\''+pSafe+'\',\''+pInputId+'\')" style="background:var(--green-d);border:1px solid rgba(16,185,129,.3);color:var(--green);padding:2px 5px;border-radius:4px;font-size:.6rem;font-weight:700;cursor:pointer;" title="Confirmar">✓</button></div>'}
      </td>
      <td style="padding:5px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.76rem;font-weight:700;color:#a3e635;">${rb>0?fV(rb,false):'—'}</td>
    </tr>`;
  }

  // ── NORMAL AGENT ROWS (sem botão 👤 Direto) ──
  const normalHtml = filtNormal.map(({agKey, players, rakeTime, pctAgente, totalRBag, lucroAg})=>{
    const isOpen = rbExpandedAgents.has(agKey);
    const agSafe = agKey.replace(/'/g,"\\'");
    const agInputId = 'rbag-'+agKey.replace(/[^a-zA-Z0-9]/g,'_');
    const cfg = agentRB[agKey] || {};
    const isConfirmed = !!cfg.locked;
    const isLocked = wkLocked || isConfirmed;

    let html = `<tr style="border-top:1px solid var(--b1);cursor:pointer;${isOpen?'background:rgba(240,180,41,.06);':''}" onclick="toggleRbAgent('${agSafe}')">
      <td style="padding:10px 12px;font-size:.82rem;font-weight:600;">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
          <span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;background:var(--s3);border:1px solid var(--b2);font-size:.6rem;color:var(--gold);transition:transform .2s;${isOpen?'transform:rotate(90deg);':''}flex-shrink:0;">▶</span>
          <span>${agKey}</span>
          <span style="background:var(--s3);border-radius:7px;padding:1px 7px;font-size:.6rem;font-family:'JetBrains Mono',monospace;color:var(--t3);">${players.length}</span>
          ${isConfirmed && !wkLocked ? '<span style="font-size:.5rem;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:1px 5px;border-radius:4px;font-weight:700;">✓ confirmado</span>' : ''}
        </div>
      </td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--green);">${fV(rakeTime,false)}</td>
      <td style="padding:10px 12px;text-align:center;" onclick="event.stopPropagation()">
        ${isLocked
          ? `<div style="display:flex;align-items:center;gap:4px;justify-content:center;">
              <span style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:#c084fc;font-weight:700;">${pctAgente}%</span>
              ${!wkLocked ? `<button onclick="event.stopPropagation();unlockAgentRBFromRbTab('${agSafe}')" style="background:var(--s3);border:1px solid var(--b2);color:var(--t3);padding:1px 5px;border-radius:4px;font-size:.58rem;cursor:pointer;" title="Editar">✎</button>` : ''}
            </div>`
          : `<div style="display:flex;align-items:center;gap:3px;justify-content:center;">
              <input type="number" min="0" max="100" step="0.1" value="${pctAgente}" id="${agInputId}" style="width:52px;background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:4px 6px;color:#c084fc;font-family:'JetBrains Mono',monospace;font-size:.76rem;text-align:center;" onkeydown="if(event.key==='Enter'){event.preventDefault();confirmAgentRB('${agSafe}','${agInputId}')}">
              <button onclick="event.stopPropagation();confirmAgentRB('${agSafe}','${agInputId}')" style="background:var(--green-d);border:1px solid rgba(16,185,129,.3);color:var(--green);padding:2px 6px;border-radius:5px;font-size:.65rem;font-weight:700;cursor:pointer;" title="Confirmar">✓</button>
            </div>`}
      </td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:#c084fc;">${totalRBag>0?fV(totalRBag,false):'—'}</td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:${clr(lucroAg)};">${fV(lucroAg,false)}</td>
    </tr>`;

    if(isOpen){
      const agSafe2 = agSafe;
      html += `<tr><td colspan="5" style="padding:0;background:rgba(255,255,255,.015);">
        <div style="padding:6px 12px 4px 36px;display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Jogadores de ${agKey}</span>
          ${!wkLocked ? `<button onclick="event.stopPropagation();applyPctToAllPlayers('${agSafe2}')" style="background:rgba(240,180,41,.08);border:1px solid rgba(240,180,41,.2);color:var(--gold);padding:3px 10px;border-radius:5px;font-size:.6rem;font-weight:700;cursor:pointer;">Aplicar % a todos</button>` : ''}
        </div>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr>
            <th style="padding:5px 12px 5px 36px;text-align:left;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">Nick</th>
            <th style="padding:5px 12px;text-align:right;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">Rake</th>
            <th style="padding:5px 12px;text-align:center;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">RB %</th>
            <th style="padding:5px 12px;text-align:right;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">RB (R$)</th>
          </tr></thead>
          <tbody>`;
      players.forEach(p => {
        const pct = getPlayerPctRB(p);
        const rb = (Number(p.rake)||0) * pct / 100;
        html += playerRowHtml(p, pct, rb, wkLocked);
      });
      html += `<tr style="border-top:1px solid rgba(240,180,41,.15);background:rgba(240,180,41,.04);">
        <td style="padding:6px 12px 6px 36px;font-size:.7rem;font-weight:700;color:var(--gold);">Subtotal</td>
        <td style="padding:6px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--green);font-weight:700;">${fV(rakeTime,false)}</td>
        <td></td>
        <td style="padding:6px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;color:#c084fc;">${totalRBag>0?fV(totalRBag,false):'—'}</td>
      </tr></tbody></table></td></tr>`;
    }
    return html;
  }).join('');

  // ── DIRECT AGENT ROWS ──
  // ── Totais para cada aba ──
  const nTotalRake  = filtNormal.reduce((s,a) => s + a.rakeTime, 0);
  const nTotalRB    = filtNormal.reduce((s,a) => s + a.totalRBag, 0);
  const nTotalLucro = filtNormal.reduce((s,a) => s + a.lucroAg, 0);
  const dTotalRake  = filtDirect.reduce((s,a) => s + a.rakeTime, 0);
  const dTotalRB    = filtDirect.reduce((s,a) => s + a.agRB, 0);
  const dTotalLucro = filtDirect.reduce((s,a) => s + (a.rakeTime - a.agRB - a.rakeTime * taxaRate), 0);

  const totTd = (v, color) =>
    `<td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:800;color:${color};">${v > 0.001 || v < -0.001 ? fV(v,false) : '—'}</td>`;

  // ══════════════════ ÁREA COMUM (KPIs + busca + tabs) ══════════════════
  elCommon.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
      ${lockBadge}
      <span style="font-size:.7rem;color:var(--t3);">${wk}</span>
    </div>

    ${wkLocked ? `<div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.12);border-radius:8px;padding:9px 14px;margin-bottom:14px;font-size:.74rem;color:#fca5a5;">
      ⚠️ Semana lockada — % congelados. Alterações só afetam semanas futuras.
    </div>` : ''}

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
      ${card('💎','Rake Total', rakeGeral, 'var(--green)', cp.length+' jogadores')}
      ${card('💸','Total Rakeback', rbTotal, '#f0b429', 'Agentes + Diretos')}
      ${card('📊','Lucro Líquido', lucroLiq, clr(lucroLiq), 'Rake − RB − Taxa Liga '+ligaConfig.taxaApp+'%+'+ligaConfig.taxaLiga+'% ('+fV(taxaLiga,false)+')')}
    </div>

    <div style="margin-bottom:10px;">
      <input class="fin-search" type="text" id="rb-search-input" placeholder="Buscar agente ou jogador..." value="${_rbSearch}" oninput="setRbSearch(this.value)" style="width:100%;max-width:300px;">
    </div>
    <div style="display:flex;gap:4px;margin-bottom:14px;border-bottom:1px solid var(--b1);padding-bottom:10px;">
      <button id="rb-tab-agencias" onclick="switchRbTab('agencias')" class="rb-itab ${_activeRbTab==='agencias'?'rb-itab-active':''}">🤝 Agências (${filtNormal.length})</button>
      <button id="rb-tab-diretos" onclick="switchRbTab('diretos')" class="rb-itab ${_activeRbTab==='diretos'?'rb-itab-active':''}">👤 Jogadores (${filtDirect.length})</button>
    </div>
  `;

  // ══════════════════ PANEL: AGÊNCIAS ══════════════════
  el.innerHTML = `
    <div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;">
      ${filtNormal.length ? `<table style="width:100%;border-collapse:collapse;">
        <thead><tr>
          <th style="${ths}text-align:left;">Agente</th>
          <th style="${ths}text-align:right;">Rake</th>
          <th style="${ths}text-align:center;">% RB Agente</th>
          <th style="${ths}text-align:right;">RB Agente</th>
          <th style="${ths}text-align:right;">Lucro Líq.</th>
        </tr></thead>
        <tbody>
          ${normalHtml}
          <tr style="border-top:2px solid var(--b2);background:rgba(240,180,41,.05);">
            <td style="padding:10px 12px;font-size:.72rem;font-weight:800;color:var(--gold);">TOTAL (${filtNormal.length} agentes)</td>
            ${totTd(nTotalRake, 'var(--green)')}
            <td></td>
            ${totTd(nTotalRB, '#c084fc')}
            ${totTd(nTotalLucro, clr(nTotalLucro))}
          </tr>
        </tbody>
      </table>` : `<div style="padding:24px;text-align:center;color:var(--t3);font-size:.78rem;">Nenhum agente nesta seção</div>`}
    </div>
    ${_rbSearch ? `<div style="font-size:.65rem;color:var(--t3);margin-top:6px;text-align:right;">${filtNormal.length} resultado(s)</div>` : ''}
  `;

  // ══════════════════ PANEL: JOGADORES ══════════════════
  if(!el2) return;

  // Select: apenas agências não-diretas
  const nonDirectKeys = Object.keys(agentMap).filter(k => !agentDirect[k]).sort();
  const selectOpts = nonDirectKeys.map(k =>
    `<option value="${k.replace(/"/g,'&quot;')}">${k}</option>`
  ).join('');

  // ── Tabela 5 colunas para agências diretas ──
  const thsD = 'padding:8px 12px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:var(--s2);';

  const directHtml5 = filtDirect.map(({agKey, players, rakeTime, agRB, plRows})=>{
    const isOpen  = rbExpandedAgents.has(agKey);
    const agSafe  = agKey.replace(/'/g,"\\'");
    const agLucro = rakeTime - agRB - rakeTime * taxaRate;

    let html = `<tr style="border-top:1px solid rgba(96,165,250,.1);cursor:pointer;${isOpen?'background:rgba(96,165,250,.05);':''}" onclick="toggleRbAgent('${agSafe}')">
      <td style="padding:10px 12px;font-size:.82rem;font-weight:600;">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
          <span style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;background:var(--s3);border:1px solid var(--b2);font-size:.6rem;color:#60a5fa;transition:transform .2s;${isOpen?'transform:rotate(90deg);':''}flex-shrink:0;">▶</span>
          <span>${agKey}</span>
          <span style="background:var(--s3);border-radius:7px;padding:1px 7px;font-size:.6rem;font-family:'JetBrains Mono',monospace;color:var(--t3);">${players.length}</span>
          <span style="font-size:.5rem;background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:1px 6px;border-radius:4px;font-weight:700;">🔒 DIRETO</span>
          ${!wkLocked ? `<button onclick="event.stopPropagation();unmarkAgentDirect('${agSafe}')" style="background:var(--s3);border:1px solid var(--b2);color:var(--t3);padding:1px 5px;border-radius:4px;font-size:.55rem;cursor:pointer;" title="Voltar para acerto via agente">✎ Remover</button>` : ''}
        </div>
      </td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--green);">${fV(rakeTime,false)}</td>
      <td style="padding:10px 12px;text-align:center;font-size:.62rem;color:var(--t3);font-style:italic;">Individual</td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:#60a5fa;">${agRB>0?fV(agRB,false):'—'}</td>
      <td style="padding:10px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:${clr(agLucro)};">${fV(agLucro,false)}</td>
    </tr>`;

    if(isOpen){
      let subRake=0, subRB=0, subLucro=0;
      const playerRowsHtml = plRows.map(({p, pct, rb})=>{
        const rake  = n(p.rake);
        const lucro = rake - rb - rake * taxaRate;
        subRake  += rake; subRB += rb; subLucro += lucro;
        const hasOv     = playerRB[String(p.id)] !== undefined;
        const pSafe     = String(p.id).replace(/'/g,"\\'");
        const pInputId  = 'rbpld-'+String(p.id).replace(/[^a-zA-Z0-9]/g,'_');
        const pctCell   = wkLocked
          ? `<span style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:${hasOv?'#60a5fa':'var(--t2)'};font-weight:${hasOv?'700':'400'};">${pct}%</span>`
          : hasOv
            ? `<div style="display:flex;align-items:center;gap:3px;justify-content:center;"><span style="font-family:'JetBrains Mono',monospace;font-size:.74rem;color:#60a5fa;font-weight:700;">${pct}%</span><button onclick="clearPlayerRBFromRbTab('${pSafe}')" style="background:var(--s3);border:1px solid var(--b2);color:var(--t3);padding:1px 5px;border-radius:4px;font-size:.55rem;cursor:pointer;" title="Editar">✎</button></div>`
            : `<div style="display:flex;align-items:center;gap:3px;justify-content:center;"><input type="number" min="0" max="100" step="0.1" value="${pct}" id="${pInputId}" style="width:48px;background:var(--s3);border:1px solid var(--b2);border-radius:5px;padding:3px 5px;color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:.72rem;text-align:center;" onkeydown="if(event.key==='Enter'){event.preventDefault();confirmPlayerRB('${pSafe}','${pInputId}')}"><button onclick="confirmPlayerRB('${pSafe}','${pInputId}')" style="background:var(--green-d);border:1px solid rgba(16,185,129,.3);color:var(--green);padding:2px 5px;border-radius:4px;font-size:.6rem;font-weight:700;cursor:pointer;" title="Confirmar">✓</button></div>`;
        return `<tr style="border-top:1px solid rgba(255,255,255,.03);">
          <td style="padding:5px 12px 5px 36px;font-size:.77rem;">
            <span style="font-weight:500;">${p.nick||'—'}</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--t3);margin-left:5px;">#${p.id||''}</span>
          </td>
          <td style="padding:5px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--green);">${rake>0?fV(rake,false):'—'}</td>
          <td style="padding:5px 12px;text-align:center;">${pctCell}</td>
          <td style="padding:5px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;color:#60a5fa;">${rb>0?fV(rb,false):'—'}</td>
          <td style="padding:5px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;color:${clr(lucro)};">${fV(lucro,false)}</td>
        </tr>`;
      }).join('');

      html += `<tr><td colspan="5" style="padding:0;background:rgba(96,165,250,.02);">
        <div style="padding:6px 12px 4px 36px;display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Jogadores diretos de ${agKey}</span>
          ${!wkLocked ? `<button onclick="event.stopPropagation();applyPctToAllPlayers('${agSafe}')" style="background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:3px 10px;border-radius:5px;font-size:.6rem;font-weight:700;cursor:pointer;">Aplicar % a todos</button>` : ''}
        </div>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr>
            <th style="padding:5px 12px 5px 36px;text-align:left;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">Jogador</th>
            <th style="padding:5px 12px;text-align:right;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">Rake</th>
            <th style="padding:5px 12px;text-align:center;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">% RB Jogador</th>
            <th style="padding:5px 12px;text-align:right;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">RB Jogador</th>
            <th style="padding:5px 12px;text-align:right;font-size:.56rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--t3);background:rgba(0,0,0,.12);">Lucro Líq.</th>
          </tr></thead>
          <tbody>
          ${playerRowsHtml}
          <tr style="border-top:1px solid rgba(96,165,250,.2);background:rgba(96,165,250,.04);">
            <td style="padding:6px 12px 6px 36px;font-size:.7rem;font-weight:700;color:#60a5fa;">Subtotal</td>
            <td style="padding:6px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;color:var(--green);font-weight:700;">${fV(subRake,false)}</td>
            <td></td>
            <td style="padding:6px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;color:#60a5fa;">${subRB>0?fV(subRB,false):'—'}</td>
            <td style="padding:6px 12px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.74rem;font-weight:700;color:${clr(subLucro)};">${fV(subLucro,false)}</td>
          </tr>
          </tbody>
        </table>
      </td></tr>`;
    }
    return html;
  }).join('');

  el2.innerHTML = `
    <!-- SEÇÃO: Definir agências diretas -->
    <div style="margin-bottom:20px;">
      <div style="margin-bottom:8px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t2);">📋 Definir Agências Diretas</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <select id="rb-direct-add-sel" style="flex:1;min-width:200px;max-width:340px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:7px;font-size:.76rem;font-family:'Outfit',sans-serif;">
          <option value="">Selecionar agência...</option>
          ${selectOpts}
        </select>
        ${!wkLocked
          ? `<button onclick="addDirectFromSelect()" style="background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.22);color:#60a5fa;padding:7px 16px;border-radius:7px;font-size:.74rem;font-weight:600;cursor:pointer;white-space:nowrap;font-family:'Outfit',sans-serif;">+ Marcar como Direto</button>`
          : ''}
      </div>
      ${nonDirectKeys.length===0 ? '<div style="font-size:.68rem;color:var(--t3);margin-top:8px;">✓ Todas as agências já são diretas.</div>' : ''}
      <div style="font-size:.62rem;color:var(--t3);margin-top:7px;">Agências diretas são fechadas individualmente — cada jogador com seu próprio % de rakeback.</div>
    </div>

    <div style="background:var(--s1);border:1px solid rgba(96,165,250,.15);border-radius:10px;overflow:hidden;">
      ${filtDirect.length ? `<table style="width:100%;border-collapse:collapse;">
        <thead><tr>
          <th style="${thsD}text-align:left;">Agência / Jogador</th>
          <th style="${thsD}text-align:right;">Rake</th>
          <th style="${thsD}text-align:center;">% RB Jogador</th>
          <th style="${thsD}text-align:right;">RB Jogador</th>
          <th style="${thsD}text-align:right;">Lucro Líq.</th>
        </tr></thead>
        <tbody>
          ${directHtml5}
          <tr style="border-top:2px solid rgba(96,165,250,.3);background:rgba(96,165,250,.06);">
            <td style="padding:10px 12px;font-size:.72rem;font-weight:800;color:#60a5fa;">TOTAL (${filtDirect.length} agências)</td>
            ${totTd(dTotalRake, 'var(--green)')}
            <td></td>
            ${totTd(dTotalRB, '#60a5fa')}
            ${totTd(dTotalLucro, clr(dTotalLucro))}
          </tr>
        </tbody>
      </table>` : `<div style="padding:28px;text-align:center;color:var(--t3);font-size:.78rem;">Nenhuma agência marcada como direto.<br><span style="font-size:.65rem;">Use o campo acima para selecionar uma agência.</span></div>`}
    </div>
  `;
}


// Confirma RB% do agente — trava o input
function confirmAgentRB(agKey, inputId){
  const inp = document.getElementById(inputId);
  if(!inp) return;
  const v = parseFloat(inp.value) || 0;
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, pctAgente: v, pct: v, locked: true };
  saveAgentRB();
  renderRakebackTab();
  renderClubTable();
  renderTableRows('allBody', filteredAll, 'allPgInfo', 'allPgBtns', 'all');
  updateClubKPIs(); updateOverviewKPIs();
  if(typeof renderAgentClosing==='function') renderAgentClosing();
  showToast('✅ RB '+agKey+' confirmado: '+v+'%');
}

// Destrava agente para editar novamente
function unlockAgentRBFromRbTab(agKey){
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, locked: false };
  saveAgentRB();
  renderRakebackTab();
  setTimeout(()=>{
    const id = 'rbag-'+agKey.replace(/[^a-zA-Z0-9]/g,'_');
    document.getElementById(id)?.focus();
  },50);
}

// Confirma RB% do jogador — salva override e trava
function confirmPlayerRB(playerId, inputId){
  const inp = document.getElementById(inputId);
  if(!inp) return;
  const v = parseFloat(inp.value) || 0;
  setPlayerRBFromRbTab(playerId, v);
  showToast('✅ RB jogador #'+playerId+' confirmado: '+v+'%');
}

// Aplica % a todos os jogadores de um agente
function applyPctToAllPlayers(agKey){
  const pct = prompt('Definir RB% para todos os jogadores de ' + agKey + ':');
  if(pct === null) return;
  const v = parseFloat(pct);
  if(isNaN(v)) return;
  const cp = allPlayers.filter(p=>p.clube===activeClube && (p.aname||'(sem agente)')===agKey);
  cp.forEach(p=>{ playerRB[String(p.id)] = v; });
  savePlayerRB();
  renderRakebackTab();
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  updateClubKPIs(); updateOverviewKPIs();
  if(typeof renderAgentClosing==='function') renderAgentClosing();
  showToast('✅ '+cp.length+' jogadores atualizados para '+v+'%');
}

// Atualiza % de agente vindo da aba Rakeback
function updateAgentRBFromTab(agKey, field, val){
  const v = parseFloat(val) || 0;
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, pctAgente: v, pct: v };
  saveAgentRB();
  renderRakebackTab();
  renderClubTable();
  updateClubKPIs();
  updateOverviewKPIs();
  if(typeof renderAgentClosing==='function') renderAgentClosing();
}

function setRB(idx,val){
  allPlayers[idx].rakeback=parseFloat(val)||0;
  updateClubKPIs();
  updateOverviewKPIs();
}

function updateRBLive(idx, pct, rake, ganhos, ggr){
  const p   = parseFloat(pct) || 0;
  const rb  = rake * p / 100;
  const res = ganhos + rb + ggr;

  // Atualiza célula Resultado Final
  const resEl = document.getElementById('res-'+idx);
  if(resEl){
    resEl.textContent = fV(res, false);
    resEl.className   = res >= 0 ? 'vp' : 'vn';
    resEl.style.fontWeight = '600';
  }

  // Atualiza célula Rakeback R$
  const rbEl = document.getElementById('rb-val-'+idx);
  if(rbEl){
    rbEl.textContent = rb !== 0 ? 'R$ '+fV(rb,false) : '—';
    rbEl.style.color = rb > 0 ? '#a3e635' : rb < 0 ? '#f87171' : 'var(--t3)';
  }

  // Atualiza valor no objeto para uso imediato
  if(allPlayers[idx]) allPlayers[idx].rakeback = p;
}

function previewRB(idx, pct, rake){
  const rb = rake * (parseFloat(pct)||0) / 100;
  const el = document.getElementById('rb-prev-'+idx);
  if(el) el.textContent = rb > 0 ? '= R$ '+fV(rb,false) : '';
}

function lockRB(idx, playerId){
  const inp = document.getElementById('rb-player-'+idx);
  const val = inp ? parseFloat(inp.value)||0 : getPlayerPctRB(allPlayers[idx]);
  if(playerId){
    playerRB[String(playerId)] = val;
    savePlayerRB();
  }
  allPlayers[idx].rakeback = val;
  allPlayers[idx].rbLocked = true;
  updateClubKPIs();
  updateOverviewKPIs();
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
}

function unlockRB(idx){
  allPlayers[idx].rbLocked = false;
  renderTableRows('allBody',  filteredAll,  'allPgInfo',  'allPgBtns',  'all');
  renderTableRows('clubBody', filteredClub, 'clubPgInfo', 'clubPgBtns', 'club');
}
// ══════════════════ LOGOS DOS CLUBES ══════════════════
// clubLogos: { IMPÉRIO: 'data:image/...', ... }
const clubLogos = DataLayer.getClubLogos();

function saveLogos(){ DataLayer.saveClubLogos(clubLogos); }

function getLogoEl(clube, size=28, radius=7){
  const logo = clubLogos[clube];
  const m    = CMETA[clube]||{};
  if(logo) return `<img src="${logo}" style="width:${size}px;height:${size}px;border-radius:${radius}px;object-fit:cover;vertical-align:middle;">`;
  return `<span style="font-size:${Math.round(size*.55)}px;line-height:1">${m.icon||'♠'}</span>`;
}

function renderConfigPage(){
  // ── Liga Config Grid ──
  const grid = document.getElementById('liga-config-grid');
  if(grid){
    const taxes = [
      { key: 'taxaApp', label: 'Taxa Aplicativo', desc: 'Sobre o Rake Gerado', icon: '📱' },
      { key: 'taxaLiga', label: 'Taxa Liga', desc: 'Sobre o Rake Gerado', icon: '🏆' },
      { key: 'taxaRodeoGGR', label: 'Taxa Rodeio GGR', desc: 'Sobre o GGR (se > 0)', icon: '🤠' },
      { key: 'taxaRodeoApp', label: 'Taxa Rodeio App', desc: 'Sobre o GGR (se > 0)', icon: '📲' }
    ];
    grid.innerHTML = taxes.map(t => {
      const val = ligaConfig[t.key] || 0;
      const isDefault = val === LIGA_DEFAULTS[t.key];
      return `<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;">
          <span style="font-size:.85rem;">${t.icon}</span>
          <div>
            <div style="font-size:.72rem;font-weight:700;color:var(--t1);">${t.label}</div>
            <div style="font-size:.52rem;color:var(--t3);">${t.desc}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <input type="number" step="0.5" min="0" max="100" value="${val}"
            onchange="setLigaRate('${t.key}',this.value)"
            style="width:65px;background:var(--s1);border:1px solid var(--b1);color:var(--t1);padding:6px 8px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:.82rem;text-align:center;">
          <span style="font-size:.78rem;color:var(--t2);font-weight:600;">%</span>
          ${!isDefault ? '<span style="font-size:.48rem;color:var(--gold);margin-left:auto;">editado</span>' : ''}
        </div>
      </div>`;
    }).join('');
  }

  // ── Club Logos ──
  const list = document.getElementById('config-clubs-list');
  if(!list) return;
  list.innerHTML = CLUBS.map(c => {
    const m    = CMETA[c]||{};
    const logo = clubLogos[c];
    const hasLogo = !!logo;
    return `<div class="cfg-card">
      <div class="cfg-logo-preview" id="cfg-preview-${c}">
        ${hasLogo
          ? `<img src="${logo}" alt="${c}">`
          : `<span>${m.icon||'♠'}</span>`}
      </div>
      <div class="cfg-info">
        <div class="cfg-name">${m.icon} ${c}</div>
        <div class="cfg-sub">${hasLogo ? '✅ Logo personalizada carregada' : 'Usando emoji padrão — clique em "Carregar Logo" para personalizar'}</div>
      </div>
      <div class="cfg-actions">
        <input type="file" accept="image/*" class="cfg-input" id="cfg-inp-${c}" onchange="handleLogoUpload('${c}', this)">
        <button class="cfg-upload-btn" onclick="document.getElementById('cfg-inp-${c}').click()">
          ${hasLogo ? '🔄 Trocar Logo' : '📁 Carregar Logo'}
        </button>
        ${hasLogo ? `<button class="cfg-remove-btn" onclick="removeLogo('${c}')">✕ Remover</button>` : ''}
      </div>
    </div>`;
  }).join('');

  // Backup info
  renderBackupInfo();
}

function setLigaRate(key, val){
  ligaConfig[key] = parseFloat(val) || 0;
  saveLigaConfig();
  showToast('✅ '+key+' → '+ligaConfig[key]+'%');
}

function resetLigaConfig(){
  if(!confirm('Resetar todas as taxas para os valores padrão?')) return;
  ligaConfig = { ...LIGA_DEFAULTS };
  saveLigaConfig();
  renderConfigPage();
  showToast('↻ Taxas resetadas para o padrão');
}

function handleLogoUpload(clube, input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 2*1024*1024){ showToast('⚠️ Imagem muito grande (máx 2MB)'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    clubLogos[clube] = e.target.result;
    saveLogos();
    applyLogosEverywhere();
    renderConfigPage();
    showToast(`✅ Logo do ${clube} atualizada!`);
  };
  reader.readAsDataURL(file);
}

function removeLogo(clube){
  delete clubLogos[clube];
  saveLogos();
  applyLogosEverywhere();
  renderConfigPage();
  showToast(`Logo do ${clube} removida`);
}

// ══════════════════ CLUB CONFIG MODAL ══════════════════

function openClubConfig(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  const cp = allPlayers.filter(p=>p.clube===activeClube);
  document.getElementById('club-config-subtitle').textContent = activeClube + ' · ' + cp.length + ' jogadores';

  const agents = [...new Set(cp.map(p=>(p.aname||'').trim()).filter(Boolean).filter(a=>!/^(none|null|undefined)$/i.test(a)))];

  let html = '';

  // ── Agents section ──
  html += '<div style="margin-bottom:18px;">';
  html += '<div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:8px;">🤝 Agentes ('+agents.length+')</div>';

  if(!agents.length){
    html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:14px;font-size:.74rem;color:var(--t3);">Nenhum agente encontrado nos dados importados.</div>';
  } else {
    html += '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;">';
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<thead><tr>';
    const ths = 'padding:8px 10px;font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);background:var(--s2);';
    html += '<th style="'+ths+'text-align:left;">Agente</th>';
    html += '<th style="'+ths+'text-align:center;">Jogadores</th>';
    html += '<th style="'+ths+'text-align:center;">Liquidação</th>';
    html += '<th style="'+ths+'text-align:center;">RB %</th>';
    html += '</tr></thead><tbody>';

    agents.forEach(ag => {
      const players = cp.filter(p=>(p.aname||'').trim()===ag);
      const cfg = agentRB[ag] || {};
      const pct = Number(cfg.pctAgente ?? cfg.pct ?? 0) || 0;
      const isDirect = !!agentDirect[ag];
      const agE = ag.replace(/'/g,"\\'");

      html += '<tr style="border-bottom:1px solid var(--b1);">';
      html += '<td style="padding:8px 10px;font-weight:600;font-size:.76rem;color:var(--t1);">'+ag+'</td>';
      html += '<td style="padding:8px 10px;text-align:center;font-size:.74rem;color:var(--t2);">'+players.length+'</td>';

      // Liquidation type toggle
      html += '<td style="padding:6px 10px;text-align:center;">';
      html += '<div style="display:inline-flex;border-radius:6px;overflow:hidden;border:1px solid var(--b1);">';
      html += '<button onclick="setCfgLiqType(\''+agE+'\',false)" style="padding:3px 8px;font-size:.52rem;font-weight:700;cursor:pointer;border:none;';
      html += isDirect ? 'background:var(--s2);color:var(--t3);' : 'background:rgba(240,180,41,.1);color:var(--gold);';
      html += '">🤝 Agente</button>';
      html += '<button onclick="setCfgLiqType(\''+agE+'\',true)" style="padding:3px 8px;font-size:.52rem;font-weight:700;cursor:pointer;border:none;border-left:1px solid var(--b1);';
      html += isDirect ? 'background:rgba(96,165,250,.1);color:#60a5fa;' : 'background:var(--s2);color:var(--t3);';
      html += '">👤 Direto</button>';
      html += '</div></td>';

      // RB% input
      html += '<td style="padding:6px 10px;text-align:center;">';
      html += '<input type="number" step="0.5" min="0" max="100" value="'+pct+'" onchange="setCfgAgentRB(\''+agE+'\',this.value)" style="width:55px;background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:4px 6px;border-radius:5px;font-family:\'JetBrains Mono\',monospace;font-size:.72rem;text-align:center;">';
      html += '<span style="font-size:.6rem;color:var(--t3);margin-left:2px;">%</span>';
      html += '</td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';
  }
  html += '</div>';

  // ── Direct Players section ──
  const directPlayers = cp.filter(p => playerDirect[p.id]);
  html += '<div style="margin-bottom:18px;">';
  html += '<div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:8px;">👤 Jogadores Diretos ('+directPlayers.length+')</div>';
  if(directPlayers.length){
    html += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
    directPlayers.forEach(p => {
      html += '<span style="background:rgba(96,165,250,.08);border:1px solid rgba(96,165,250,.15);color:#60a5fa;padding:3px 8px;border-radius:5px;font-size:.6rem;font-weight:600;">'+p.nick+'</span>';
    });
    html += '</div>';
  } else {
    html += '<div style="font-size:.72rem;color:var(--t3);">Nenhum — marque jogadores como "Direto" na aba Jogadores.</div>';
  }
  html += '</div>';

  // ── Payment Methods section ──
  const methods = DataLayer.getPayMethodsAlt();
  html += '<div style="margin-bottom:18px;">';
  html += '<div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:8px;">💳 Formas de Pagamento ('+methods.length+')</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:6px;">';
  methods.forEach(m => {
    html += '<span style="background:var(--s2);border:1px solid var(--b1);padding:4px 10px;border-radius:5px;font-size:.68rem;color:var(--t1);">'+m+'</span>';
  });
  html += '</div>';
  html += '<div style="font-size:.6rem;color:var(--t3);">Gerencie em Financeiro → Ajustes → Formas de Pagamento</div>';
  html += '</div>';

  // ── Summary ──
  html += '<div style="background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.12);border-radius:8px;padding:10px 14px;font-size:.7rem;color:rgba(240,180,41,.7);">';
  html += '💡 Alterações são salvas automaticamente.';
  html += '</div>';

  document.getElementById('club-config-content').innerHTML = html;
  openM('mClubConfig');
}

function setCfgLiqType(agKey, isDirect){
  if(isDirect) agentDirect[agKey] = true;
  else delete agentDirect[agKey];
  saveAgentDirect();
  openClubConfig(); // re-render
  showToast(isDirect ? '👤 '+agKey+' → liquidação direta' : '🤝 '+agKey+' → liquidação por agente');
}

function setCfgAgentRB(agKey, val){
  const v = parseFloat(val) || 0;
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, pctAgente: v, pct: v };
  saveAgentRB();
  showToast('💸 '+agKey+' → RB '+v+'%');
}

function applyLogosEverywhere(){
  // 1. Sidebar — nav items dos clubes
  const sbMap = {'IMPÉRIO':'imp','CONFRARIA':'con','3BET':'3bt','TGP':'tgp','CH':'ch'};
  CLUBS.forEach(c => {
    const key  = sbMap[c];
    const nav  = document.getElementById('nav-'+key);
    if(!nav) return;
    const logo = clubLogos[c];
    const m    = CMETA[c]||{};
    const ni   = nav.querySelector('.ni');
    if(ni){
      if(logo) ni.innerHTML = `<img src="${logo}" class="ni-logo">`;
      else     ni.textContent = m.icon||'♠';
    }
  });

  // 2. Club header (dc-icon) — se clube ativo estiver aberto
  if(activeClube){
    const icon = document.getElementById('dc-icon');
    if(icon){
      const logo = clubLogos[activeClube];
      const m    = CMETA[activeClube]||{};
      if(logo) icon.innerHTML = `<img src="${logo}" style="width:100%;height:100%;object-fit:cover;border-radius:9px;">`;
      else     icon.textContent = m.icon||'♠';
    }
  }

  // 3. Overview cards — re-render
  if(document.getElementById('clubsGrid').children.length > 0) renderOverview();
}

// ══════════════════ FECHAMENTOS (LIQUIDAÇÃO) ══════════════════

let _fechTab = 'agentes';
let _fechSubTab = 'pagar'; // 'pagar' | 'receber'
let _fechFilter = 'todos';
let _fechSearch = '';
let _fechSort = 'pendente_desc';
let _fechSearchTimer = null;

function setFechFilter(f){ _fechFilter = f; renderFechamentos(); }
function setFechSort(s){ _fechSort = s; renderFechamentos(); }
function setFechSearch(q){
  _fechSearch = q.toLowerCase().trim();
  clearTimeout(_fechSearchTimer);
  _fechSearchTimer = setTimeout(() => {
    const prev = document.activeElement;
    const wasSrch = prev && prev.id === 'fech-search';
    const pos = wasSrch ? prev.selectionStart : 0;
    renderFechamentos();
    if(wasSrch){ const inp = document.getElementById('fech-search'); if(inp){ inp.focus(); inp.setSelectionRange(pos,pos); } }
  }, 200);
}
function switchFechTab(tab){ _fechTab = tab; _fechSubTab = 'pagar'; renderFechamentos(); }
function switchFechSubTab(t){ _fechSubTab = t; _fechFilter = 'todos'; renderFechamentos(); }

let _activeCompTab = 'agencias';
function switchCompTab(tab){ _activeCompTab = tab; renderAgentClosing(); }

function calcSettlements(){
  if(!activeClube) return [];
  const cp = allPlayers.filter(p=>p.clube===activeClube);
  if(!cp.length) return [];

  const settlements = [];

  // ── AGENTES ──
  const agentMap = {};
  cp.forEach(p => {
    const raw = (p.aname||'').trim();
    const k = (!raw || /^(none|null|undefined)$/i.test(raw)) ? '(sem agente)' : raw;
    if(!agentMap[k]) agentMap[k] = [];
    agentMap[k].push(p);
  });

  Object.entries(agentMap).forEach(([agKey, allPlayersInAgent]) => {
    if(agentDirect[agKey]) return;
    const players = allPlayersInAgent.filter(p => !playerDirect[p.id]);
    if(!players.length) return;

    const ganhosTotal = players.reduce((s,p) => s + (Number(p.ganhos)||0), 0);
    const rakeTotal = players.reduce((s,p) => s + (Number(p.rake)||0), 0);
    const rbAg = calcAgentRB(agKey, players);
    const avista = !!(agentRB[agKey]||{}).avista;
    const resultadoSemana = ganhosTotal + rbAg;

    const entityId = makeEntityId('ag', agKey);
    const saldoAnterior = getSaldoAnterior(entityId);
    const saStatus = Math.abs(saldoAnterior) > 0.01 ? 'locked' : 'novo';

    const ledger = getEntityLedgerNet(entityId);
    const pago = ledger.net;
    const totalDevido = saldoAnterior + resultadoSemana;
    const pendente = FinanceEngine.calcPendente(totalDevido, pago);

    settlements.push({
      id: entityId, tipo: 'agente', nome: agKey,
      jogadores: players.length, saldoAnterior, saStatus,
      resultadoSemana, totalDevido, pago, pendente,
      entradas: ledger.entradas, saidas: ledger.saidas,
      _players: players
    });
  });

  // ── JOGADORES DIRETOS ──
  cp.filter(p => isPlayerDirectSettlement(p.id, (p.aname||'').trim())).forEach(p => {
    const resultadoSemana = FinanceEngine.calcPlayerResult(p, getPlayerPctRB(p));
    const entityId = makeEntityId('pl', p.id||p.nick);
    const saldoAnterior = getSaldoAnterior(entityId);
    const saStatus = Math.abs(saldoAnterior) > 0.01 ? 'locked' : 'novo';
    const ledger = getEntityLedgerNet(entityId);
    const pago = ledger.net;
    const totalDevido = saldoAnterior + resultadoSemana;
    const pendente = FinanceEngine.calcPendente(totalDevido, pago);
    const agRaw = (p.aname||'').trim();
    const agName = (!agRaw || /^(none|null|undefined)$/i.test(agRaw)) ? '' : agRaw;

    settlements.push({
      id: entityId, tipo: 'direto', nome: p.nick || String(p.id),
      agencia: agName, jogadores: 1,
      saldoAnterior, saStatus,
      resultadoSemana, totalDevido, pago, pendente,
      entradas: ledger.entradas, saidas: ledger.saidas
    });
  });

  return settlements;
}

function getSettlementStatus(s){
  if(Math.abs(s.totalDevido) < 0.01 && Math.abs(s.pago) < 0.01)
    return { label: 'Sem Mov.', cls: 'sem-mov', bg: 'rgba(148,163,184,.08)', border: 'rgba(148,163,184,.15)', color: '#94a3b8' };
  if(Math.abs(s.pendente) < 0.01)
    return { label: 'Quitado', cls: 'quitado', bg: 'rgba(16,185,129,.08)', border: 'rgba(16,185,129,.15)', color: '#10b981' };
  // Crédito: pagou a mais — pendente tem sinal oposto ao totalDevido
  if(Math.abs(s.totalDevido) > 0.01 && (
    (s.totalDevido > 0 && s.pendente < -0.01) ||
    (s.totalDevido < 0 && s.pendente > 0.01)
  ))
    return { label: 'Crédito', cls: 'credito', bg: 'rgba(168,139,250,.08)', border: 'rgba(168,139,250,.15)', color: '#a78bfa' };
  return { label: 'Em Aberto', cls: 'em-aberto', bg: 'rgba(239,68,68,.08)', border: 'rgba(239,68,68,.15)', color: '#ef4444' };
}

function renderFechamentos(){
  const container = document.getElementById('fech-full-content');
  if(!container) return;
  const all = calcSettlements();
  if(!all.length){
    container.innerHTML = '<div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>';
    return;
  }

  const agentes = all.filter(s => s.tipo === 'agente');
  const diretos  = all.filter(s => s.tipo === 'direto');

  // ── KPI calculations ──
  const cntSemMov  = all.filter(e => getSettlementStatus(e).cls === 'sem-mov').length;
  const cntQuitado = all.filter(e => { const c = getSettlementStatus(e).cls; return c === 'quitado' || c === 'credito'; }).length;
  const baseCount  = all.length - cntSemMov;
  const progresso  = baseCount > 0 ? Math.round(cntQuitado / baseCount * 100) : 0;
  const aPagarTot  = all.reduce((s,e) => s + (e.pendente < -0.01 ? Math.abs(e.pendente) : 0), 0);
  const aReceberTot= all.reduce((s,e) => s + (e.pendente > 0.01 ? e.pendente : 0), 0);
  const saldoLiq   = aReceberTot - aPagarTot;
  const totalMov   = all.reduce((s,e) => s + Math.abs(e.pago), 0);

  // ── Split by totalDevido in current tab (before filter/search) ──
  const tabData    = _fechTab === 'agentes' ? agentes : diretos;
  const secPagar   = tabData.filter(s => s.totalDevido < -0.01);
  const secReceber = tabData.filter(s => s.totalDevido > 0.01);

  // ── Active sub-tab + filter/search/sort ──
  const subData = _fechSubTab === 'pagar' ? secPagar : secReceber;
  let items = subData.map(s => ({ ...s, _st: getSettlementStatus(s) }));
  if(_fechFilter !== 'todos') items = items.filter(s => s._st.cls === _fechFilter);
  if(_fechSearch) items = items.filter(s => s.nome.toLowerCase().includes(_fechSearch) || (s.agencia||'').toLowerCase().includes(_fechSearch));
  items.sort((a,b) => {
    if(_fechSort === 'pendente_desc') return a.pendente - b.pendente;
    if(_fechSort === 'pendente_asc')  return b.pendente - a.pendente;
    if(_fechSort === 'resultado')     return a.resultadoSemana - b.resultadoSemana;
    if(_fechSort === 'nome')          return a.nome.localeCompare(b.nome);
    const so = {'em-aberto':0, credito:1, quitado:2, 'sem-mov':3};
    return (so[a._st.cls]||5) - (so[b._st.cls]||5);
  });

  // Filter counts (active sub-tab, unfiltered)
  const fC = { todos: subData.length, 'em-aberto': 0, credito: 0, quitado: 0 };
  subData.map(s => ({ ...s, _st: getSettlementStatus(s) }))
    .forEach(s => { if(fC[s._st.cls] !== undefined) fC[s._st.cls]++; });

  // ── Helpers ──
  function kC(icon,lbl,val,color,sub){
    return '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid '+color+';min-width:0;">'
      +'<div style="font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:3px;">'+icon+' '+lbl+'</div>'
      +'<div style="font-family:\'JetBrains Mono\',monospace;font-size:.92rem;font-weight:800;color:'+color+';">'+val+'</div>'
      +(sub?'<div style="font-size:.48rem;color:var(--t3);margin-top:2px;">'+sub+'</div>':'')
      +'</div>';
  }
  function chipBtn(f,label,count){
    const active = _fechFilter === f;
    return '<button onclick="setFechFilter(\''+f+'\')" style="background:'+(active?'rgba(240,180,41,.1)':'var(--s2)')+';border:1px solid '+(active?'rgba(240,180,41,.3)':'var(--b1)')+';color:'+(active?'var(--gold)':'var(--t2)')+';padding:4px 10px;border-radius:6px;font-size:.6rem;font-weight:'+(active?'700':'500')+';cursor:pointer;white-space:nowrap;">'+label+' <span style="opacity:.5;font-size:.52rem;">'+count+'</span></button>';
  }

  let html = '';
  const isAg  = _fechTab === 'agentes';
  const ths   = 'padding:9px 8px;font-size:.52rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);background:var(--s2);white-space:nowrap;';
  const rs    = 'padding:7px 8px;font-family:\'JetBrains Mono\',monospace;font-size:.7rem;border-bottom:1px solid var(--b1);';
  const trs   = 'padding:9px 8px;font-family:\'JetBrains Mono\',monospace;font-size:.7rem;font-weight:800;';
  let rowIdx  = 0;

  // ── KPIs ──
  const progressHtml =
    '<div style="display:flex;align-items:center;gap:5px;margin-top:6px;">'
    +'<div style="flex:1;height:4px;background:var(--b1);border-radius:2px;overflow:hidden;">'
    +'<div style="height:100%;width:'+progresso+'%;background:#10b981;border-radius:2px;transition:width .4s;"></div></div>'
    +'<span style="font-size:.48rem;color:#10b981;font-weight:700;white-space:nowrap;">'+progresso+'%</span>'
    +'</div>';

  html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-bottom:14px;">';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid #10b981;min-width:0;">'
    +'<div style="font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:3px;">✅ Progresso</div>'
    +'<div style="font-family:\'JetBrains Mono\',monospace;font-size:.92rem;font-weight:800;color:#10b981;">'+cntQuitado+' de '+baseCount+'</div>'
    +'<div style="font-size:.48rem;color:var(--t3);margin-top:1px;">quitados</div>'
    +progressHtml+'</div>';
  html += kC('📤','A Pagar',      aPagarTot  > 0.01 ? 'R$ '+fV(aPagarTot,false)  : '—', '#ef4444', secPagar.length  +' entidade'+(secPagar.length!==1?'s':''));
  html += kC('📥','A Receber',    aReceberTot> 0.01 ? 'R$ '+fV(aReceberTot,false) : '—', '#10b981', secReceber.length+' entidade'+(secReceber.length!==1?'s':''));
  html += kC('⚖️','Saldo Líquido','R$ '+fV(saldoLiq,false), clr(saldoLiq), saldoLiq>0?'favorável ao clube':saldoLiq<0?'favorável a agentes':'zerado');
  html += kC('💰','Movimentado',   totalMov   > 0.01 ? 'R$ '+fV(totalMov,false)   : '—', '#60a5fa', 'total já pago/recebido');
  html += '</div>';

  // ── Main tabs + controls ──
  html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;">';
  html += '<button class="fin-stab '+(_fechTab==='agentes'?'active':'')+'" onclick="switchFechTab(\'agentes\')">🤝 Agências ('+agentes.length+')</button>';
  html += '<button class="fin-stab '+(_fechTab==='diretos'?'active':'')+'" onclick="switchFechTab(\'diretos\')">👤 Jogadores ('+diretos.length+')</button>';
  html += '<div style="flex:1;"></div>';
  html += '<input type="text" id="fech-search" value="'+_fechSearch+'" oninput="setFechSearch(this.value)" placeholder="🔍 Buscar..." style="background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:5px 10px;border-radius:6px;font-size:.72rem;width:170px;">';
  html += '<select onchange="setFechSort(this.value)" style="background:var(--s2);border:1px solid var(--b1);color:var(--t2);padding:5px 8px;border-radius:6px;font-size:.6rem;cursor:pointer;">';
  html += '<option value="pendente_desc"'+(_fechSort==='pendente_desc'?' selected':'')+'>↓ Maior devedor</option>';
  html += '<option value="pendente_asc"'+(_fechSort==='pendente_asc'?' selected':'')+'>↑ Maior credor</option>';
  html += '<option value="resultado"'+(_fechSort==='resultado'?' selected':'')+'>Resultado</option>';
  html += '<option value="nome"'+(_fechSort==='nome'?' selected':'')+'>Nome A-Z</option>';
  html += '<option value="status"'+(_fechSort==='status'?' selected':'')+'>Status</option>';
  html += '</select>';
  html += '</div>';

  // ── Sub-tabs A Pagar / A Receber ──
  html += '<div style="display:flex;gap:4px;margin-bottom:10px;">';
  html += '<button class="rb-itab '+(_fechSubTab==='pagar'?'rb-itab-active':'')+'" onclick="switchFechSubTab(\'pagar\')" style="'+(_fechSubTab==='pagar'?'color:#ef4444;border-color:rgba(239,68,68,.35);':'')+'">📤 A Pagar ('+secPagar.length+')</button>';
  html += '<button class="rb-itab '+(_fechSubTab==='receber'?'rb-itab-active':'')+'" onclick="switchFechSubTab(\'receber\')" style="'+(_fechSubTab==='receber'?'color:#10b981;border-color:rgba(16,185,129,.35);':'')+'">📥 A Receber ('+secReceber.length+')</button>';
  html += '</div>';

  // Filter chips
  html += '<div style="display:flex;gap:5px;margin-bottom:14px;">';
  html += chipBtn('todos',     'Todos',       fC.todos);
  html += chipBtn('em-aberto', '⏳ Em Aberto', fC['em-aberto']);
  html += chipBtn('credito',   '🔄 Crédito',  fC.credito);
  html += chipBtn('quitado',   '✅ Quitado',   fC.quitado);
  html += '</div>';

  // ── Section renderer ──
  function renderSection(sectionItems, label, accentClr, bgClr, colLabel){
    if(!sectionItems.length) return '';
    let h = '';

    // Section header bar
    const secPend = sectionItems.reduce((s,e) => {
      const cls = getSettlementStatus(e).cls;
      return s + (cls === 'em-aberto' ? Math.abs(e.pendente) : 0);
    }, 0);
    h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:7px 12px;background:'+bgClr+';border-radius:8px;border-left:3px solid '+accentClr+';">'
      +'<span style="font-size:.65rem;font-weight:800;color:'+accentClr+';">'+label+' ('+sectionItems.length+')</span>'
      +(secPend > 0.01 ? '<span style="font-size:.6rem;color:var(--t3);margin-left:auto;">em aberto: R$ '+fV(secPend,false)+'</span>' : '')
      +'</div>';

    h += '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;margin-bottom:16px;">';
    h += '<table style="width:100%;border-collapse:collapse;table-layout:fixed;">';
    h += '<colgroup><col style="width:22%;"><col style="width:12%;"><col style="width:10%;"><col style="width:13%;"><col style="width:10%;"><col style="width:11%;"><col style="width:10%;"><col style="width:12%;"></colgroup>';
    h += '<thead><tr>';
    h += '<th style="'+ths+'text-align:left;">Agente</th>';
    h += '<th style="'+ths+'text-align:right;">Resultado Semana</th>';
    h += '<th style="'+ths+'text-align:right;">Saldo Ant.</th>';
    h += '<th style="'+ths+'text-align:right;">'+colLabel+'</th>';
    h += '<th style="'+ths+'text-align:right;">Total Pago</th>';
    h += '<th style="'+ths+'text-align:right;">Em Aberto</th>';
    h += '<th style="'+ths+'text-align:center;">Status</th>';
    h += '<th style="'+ths+'text-align:center;">Ação</th>';
    h += '</tr></thead><tbody>';

    let gtRes=0, gtSA=0, gtDev=0, gtPago=0, gtPend=0;
    sectionItems.forEach(s => {
      const st = s._st;
      const saBadge = s.saStatus==='locked'
        ? '<span style="font-size:.48rem;color:#10b981;vertical-align:super;margin-left:1px;">✓</span>'
        : s.saStatus==='provisorio'
          ? '<span style="font-size:.48rem;color:var(--gold);vertical-align:super;margin-left:1px;">⚠</span>' : '';

      gtRes+=s.resultadoSemana; gtSA+=s.saldoAnterior; gtDev+=s.totalDevido; gtPago+=s.pago; gtPend+=s.pendente;

      // Action button with amount
      let actionBtn = '';
      if(st.cls === 'sem-mov') actionBtn = '<span style="color:var(--t3);font-size:.6rem;">—</span>';
      else if(st.cls === 'quitado') actionBtn = '<span style="color:#10b981;font-size:.68rem;font-weight:700;">✓ Quitado</span>';
      else if(st.cls === 'credito'){
        const amt = fV(s.pendente,false);
        actionBtn = '<span style="display:inline-block;background:rgba(168,139,250,.1);border:1px solid rgba(168,139,250,.2);color:#a78bfa;padding:4px 7px;border-radius:5px;font-size:.52rem;font-weight:700;white-space:nowrap;">🔄 Crédito R$ '+amt+'</span>';
      } else {
        const sid = s.id.replace(/'/g,"\\'");
        const amt = fV(s.pendente,false);
        if(s.pendente < -0.01)
          actionBtn = '<button onclick="abrirPagFechamento(\''+sid+'\')" style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:4px 7px;border-radius:5px;font-size:.52rem;font-weight:700;cursor:pointer;white-space:nowrap;">💳 Pagar R$ '+amt+'</button>';
        else
          actionBtn = '<button onclick="abrirPagFechamento(\''+sid+'\')" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:4px 7px;border-radius:5px;font-size:.52rem;font-weight:700;cursor:pointer;white-space:nowrap;">💰 Receber R$ '+amt+'</button>';
      }

      // Entity cell
      h += '<tr style="border-bottom:1px solid var(--b1);" id="fech-row-'+rowIdx+'">';
      if(isAg && s._players && s._players.length > 0){
        h += '<td style="padding:7px 8px;border-bottom:1px solid var(--b1);overflow:hidden;cursor:pointer;" onclick="toggleFechAccordion('+rowIdx+')">'
          +'<div style="display:flex;align-items:center;gap:4px;">'
          +'<span id="fech-chevron-'+rowIdx+'" style="font-size:.55rem;color:var(--t3);transition:transform .2s;">▶</span>'
          +'<div style="flex:1;min-width:0;">'
          +'<div style="font-weight:600;font-size:.74rem;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+s.nome+'</div>'
          +'<div style="font-size:.5rem;color:var(--t3);">'+s._players.length+' jogadores</div>'
          +'</div></div></td>';
      } else {
        const subLbl = isAg ? 'Agente' : 'Direto'+(s.agencia?' · '+s.agencia:'');
        h += '<td style="padding:7px 8px;border-bottom:1px solid var(--b1);overflow:hidden;">'
          +'<div style="font-weight:600;font-size:.74rem;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+s.nome+'</div>'
          +'<div style="font-size:.52rem;color:var(--t3);">'+subLbl+'</div></td>';
      }
      h += '<td style="'+rs+'text-align:right;color:'+clr(s.resultadoSemana)+';">'+fV(s.resultadoSemana,false)+'</td>';
      h += '<td style="'+rs+'text-align:right;color:'+clr(s.saldoAnterior)+';">'+(Math.abs(s.saldoAnterior)>0.01?fV(s.saldoAnterior,false):'—')+saBadge+'</td>';
      h += '<td style="'+rs+'text-align:right;font-weight:700;color:'+accentClr+';">'+(Math.abs(s.totalDevido)>0.01?fV(s.totalDevido,false):'—')+'</td>';
      h += '<td style="'+rs+'text-align:right;color:'+(Math.abs(s.pago)>0.01?clr(s.pago):'var(--t3)')+';">'+(Math.abs(s.pago)>0.01?fV(s.pago,false):'—')+'</td>';
      const _emAbVal = st.cls === 'credito'
        ? fV(s.pendente, false)
        : Math.abs(s.pendente) > 0.01 ? fV(s.pendente, false) : '—';
      h += '<td style="'+rs+'text-align:right;font-weight:700;color:'+st.color+';">'+_emAbVal+'</td>';
      h += '<td style="padding:7px 4px;text-align:center;border-bottom:1px solid var(--b1);"><span style="display:inline-block;background:'+st.bg+';border:1px solid '+st.border+';color:'+st.color+';padding:2px 6px;border-radius:5px;font-size:.52rem;font-weight:700;white-space:nowrap;">'+st.label+'</span></td>';
      h += '<td style="padding:6px 4px;text-align:center;border-bottom:1px solid var(--b1);">'+actionBtn+'</td>';
      h += '</tr>';

      // Accordion — histórico de pagamentos
      if(isAg && s._players && s._players.length > 0){
        const _allData = getFinData();
        const _hist = (_allData[finKey()]?.[s.id]?.historico || [])
          .slice().sort((a,b) => (a.ts||0) - (b.ts||0));
        let _histHtml = '';
        if(!_hist.length){
          _histHtml = '<div style="padding:8px 0;font-size:.7rem;color:var(--t3);font-style:italic;">Nenhum pagamento registrado.</div>';
        } else {
          _hist.forEach(h2 => {
            const _dt = new Date(h2.ts||0);
            const _ds = _dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
            const _isIn = h2.dir === 'in';
            const _clr  = _isIn ? '#10b981' : '#60a5fa';
            const _sgn  = _isIn ? '+' : '−';
            _histHtml += '<div style="display:flex;align-items:center;gap:10px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04);">'
              +'<span style="font-size:.62rem;color:var(--t3);min-width:46px;">'+_ds+'</span>'
              +'<span style="font-size:.62rem;color:var(--t3);flex:1;">'+((h2.origem||h2.metodo||'—')+(h2.comp?' · '+h2.comp:''))+'</span>'
              +'<span style="font-family:\'JetBrains Mono\',monospace;font-size:.7rem;font-weight:700;color:'+_clr+';">'+_sgn+' R$ '+fV(h2.valor,false)+'</span>'
              +'</div>';
          });
        }
        const _totalPago = s.pago;
        const _stAcc     = getSettlementStatus(s);
        const _isCredito = _stAcc.cls === 'credito';
        const _emAbertoAmt = s.pendente;
        const _emAbertoLbl = _isCredito ? '🔄 Crédito' : '⏳ Em Aberto';
        const _emAbertoClr = _isCredito ? '#a78bfa'    : '#ef4444';
        const _emAbertoBg  = _isCredito ? 'rgba(168,139,250,.06)' : 'rgba(239,68,68,.06)';
        const _emAbertoBrd = _isCredito ? 'rgba(168,139,250,.12)' : 'rgba(239,68,68,.12)';
        const _emAbertoStr = _isCredito
          ? 'R$ '+fV(_emAbertoAmt,false)+' a devolver'
          : (Math.abs(_emAbertoAmt)>0.01?'R$ '+fV(_emAbertoAmt,false):'✓ Zerado');
        h += '<tr id="fech-accordion-'+rowIdx+'" style="display:none;">';
        h += '<td colspan="8" style="padding:0;background:var(--s2);border-bottom:1px solid var(--b1);">';
        h += '<div style="padding:8px 16px 10px 28px;">'
          +'<div style="font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:8px;">📋 Histórico de Pagamentos</div>'
          +_histHtml
          +'<div style="display:flex;gap:10px;margin-top:10px;padding-top:8px;border-top:1px solid var(--b1);">'
          +'<div style="flex:1;background:'+(_totalPago>=0?'rgba(16,185,129,.06)':'rgba(239,68,68,.06)')+';border:1px solid '+(_totalPago>=0?'rgba(16,185,129,.12)':'rgba(239,68,68,.12)')+';border-radius:7px;padding:7px 12px;">'
          +'<div style="font-size:.5rem;color:var(--t3);margin-bottom:2px;">✅ Total Pago</div>'
          +'<div style="font-family:\'JetBrains Mono\',monospace;font-size:.8rem;font-weight:700;color:'+clr(_totalPago)+';">'+(Math.abs(_totalPago)>0.01?fV(_totalPago,false):'—')+'</div></div>'
          +'<div style="flex:1;background:'+_emAbertoBg+';border:1px solid '+_emAbertoBrd+';border-radius:7px;padding:7px 12px;">'
          +'<div style="font-size:.5rem;color:var(--t3);margin-bottom:2px;">'+_emAbertoLbl+'</div>'
          +'<div style="font-family:\'JetBrains Mono\',monospace;font-size:.8rem;font-weight:700;color:'+_emAbertoClr+';">'+_emAbertoStr+'</div></div>'
          +'</div></div></td></tr>';
      }

      rowIdx++;
    });

    // Section total row
    h += '<tr style="background:var(--s2);">';
    h += '<td style="padding:9px 8px;font-weight:800;font-size:.74rem;color:var(--t1);">TOTAL</td>';
    h += '<td style="'+trs+'text-align:right;color:'+clr(gtRes)+';">'+fV(gtRes,false)+'</td>';
    h += '<td style="'+trs+'text-align:right;color:'+clr(gtSA)+';">'+(Math.abs(gtSA)>0.01?fV(gtSA,false):'—')+'</td>';
    h += '<td style="'+trs+'text-align:right;color:'+accentClr+';">'+(Math.abs(gtDev)>0.01?fV(gtDev,false):'—')+'</td>';
    h += '<td style="'+trs+'text-align:right;color:'+clr(gtPago)+';">'+(Math.abs(gtPago)>0.01?fV(gtPago,false):'—')+'</td>';
    h += '<td style="'+trs+'text-align:right;color:'+(Math.abs(gtPend)>0.01?'var(--red)':'#10b981')+';">'+(Math.abs(gtPend)>0.01?fV(gtPend,false):'✓ Zerado')+'</td>';
    h += '<td colspan="2" style="padding:9px 8px;text-align:center;font-size:.52rem;color:var(--t3);">'+sectionItems.length+' entidade'+(sectionItems.length!==1?'s':'')+'</td>';
    h += '</tr>';
    h += '</tbody></table></div>';
    return h;
  }

  // ── Render active sub-tab ──
  if(!subData.length){
    html += '<div class="cs" style="padding:30px;"><div class="ci">✅</div><h3>Sem entidades nesta seção</h3><p style="color:var(--t3);font-size:.78rem;">Troque a sub-aba ou verifique os dados.</p></div>';
  } else if(!items.length){
    html += '<div class="cs" style="padding:30px;"><div class="ci">🔍</div><h3>Nenhuma entidade encontrada</h3><p style="color:var(--t3);font-size:.78rem;">Ajuste filtros ou busca</p></div>';
  } else {
    const subLabel  = _fechSubTab === 'pagar' ? '📤 A Pagar'   : '📥 A Receber';
    const subColor  = _fechSubTab === 'pagar' ? '#ef4444'       : '#10b981';
    const subBg     = _fechSubTab === 'pagar' ? 'rgba(239,68,68,.04)' : 'rgba(16,185,129,.04)';
    const subColLbl = _fechSubTab === 'pagar' ? 'Total Devido'  : 'Total a Receber';
    html += renderSection(items, subLabel, subColor, subBg, subColLbl);
  }

  container.innerHTML = html;
}

function abrirPagFechamento(entityId){
  abrirModalPagamento(entityId);
}

function toggleFechAccordion(idx){
  const row = document.getElementById('fech-accordion-'+idx);
  const chevron = document.getElementById('fech-chevron-'+idx);
  if(!row) return;
  const open = row.style.display !== 'none';
  row.style.display = open ? 'none' : '';
  if(chevron) chevron.style.transform = open ? '' : 'rotate(90deg)';
}

function toggleAgentDirect(agKey){
  if(agentDirect[agKey]){
    unmarkAgentDirect(agKey);
  } else {
    markAgentDirect(agKey);
  }
}

function addDirectFromSelect(){
  const sel = document.getElementById('rb-direct-add-sel');
  if(!sel || !sel.value) return;
  markAgentDirect(sel.value);
}

function markAgentDirect(agKey){
  showConfirmModal(
    '👤 Marcar como Direto',
    `Marcar <strong>${agKey}</strong> como acerto direto?<br><br><span style="font-size:.75rem;color:var(--t3);">Os jogadores desta agência serão fechados individualmente, cada um com seu próprio % de RB.</span>`,
    () => {
      agentDirect[agKey] = true;
      saveAgentDirect();
      showToast('👤 ' + agKey + ' → acerto direto (jogadores individuais)');
      renderRakebackTab();
      renderFechamentos();
      if(typeof renderAgentClosing==='function') renderAgentClosing();
    }
  );
}

function unmarkAgentDirect(agKey){
  showConfirmModal(
    '🤝 Remover Acerto Direto',
    `Tem certeza que quer remover <strong>${agKey}</strong> do acerto direto?<br><br><span style="font-size:.75rem;color:var(--t3);">Voltará ao fechamento via agente, com % único para toda a agência.</span>`,
    () => {
      delete agentDirect[agKey];
      saveAgentDirect();
      showToast('🤝 ' + agKey + ' voltou para acerto via agente');
      renderRakebackTab();
      renderFechamentos();
      if(typeof renderAgentClosing==='function') renderAgentClosing();
    }
  );
}
// ══════════════════ LANÇAMENTOS (OVERLAY + PER-CLUB) ══════════════════
let overlayGlobal = DataLayer.getOverlay();
let overlayClubes = DataLayer.getOverlayClubes();
const clubManual  = DataLayer.getClubManual();

function saveOverlay(){ DataLayer.saveOverlay(overlayGlobal); }
function saveOverlayClubes(){ DataLayer.saveOverlayClubes(overlayClubes); }
function saveClubManual(){ DataLayer.saveClubManual(clubManual); }

function getOverlayClubesList(){ return overlayClubes || [...CLUBS]; }
function getOverlayPerClub(clube){
  clube = clube || activeClube;
  const sel = getOverlayClubesList();
  if(!sel.length || overlayGlobal === 0) return 0;
  if(clube && !sel.includes(clube)) return 0;
  return overlayGlobal / sel.length;
}

// Lançamentos page
function renderLancamentos(){
  const el = document.getElementById('lancamentos-content');
  if(!el) return;
  if(!CLUBS.length || !allPlayers.length){
    el.innerHTML='<div class="cs"><div class="ci">📝</div><h3>Lançamentos</h3><p>Importe a planilha primeiro.</p></div>';
    return;
  }
  const wkLock = isWeekLocked();
  const sel = getOverlayClubesList();
  const perClub = sel.length > 0 && overlayGlobal !== 0 ? overlayGlobal / sel.length : 0;

  // Overlay club checkboxes
  const clubChecks = CLUBS.map(c=>{
    const m = CMETA[c]||{};
    const checked = sel.includes(c) ? 'checked' : '';
    return `<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:${sel.includes(c)?'rgba(59,130,246,.06)':'var(--s2)'};border:1px solid ${sel.includes(c)?'rgba(59,130,246,.2)':'var(--b1)'};border-radius:7px;cursor:pointer;flex:1;min-width:110px;">
      <input type="checkbox" ${checked} ${wkLock?'disabled':''} onchange="_toggleOverlayClub('${c.replace(/'/g,"\\'")}',this.checked)" style="accent-color:#60a5fa;">
      <span style="font-size:.75rem;font-weight:600;color:var(--t1);">${m.icon||''} ${c}</span>
      ${sel.includes(c) && overlayGlobal !== 0 ? '<span style="margin-left:auto;font-family:\'JetBrains Mono\',monospace;font-size:.7rem;font-weight:700;color:#60a5fa;">'+fmtV(perClub)+'</span>' : ''}
    </label>`;
  }).join('');

  // Per-club table rows
  const tblRows = CLUBS.map(c=>{
    const m = CMETA[c]||{};
    const e = getLigaClubEntry(c);
    const cid = c.replace(/'/g,"\\'");
    const locked = e._locked || wkLock;
    const rowTotal = (sel.includes(c)?perClub:0)+(e.compras||0)+(e.security||0)+(e.outros||0);

    if(locked){
      // LOCKED ROW — read-only values + Alterar button
      const valStyle = 'font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:600;';
      const valClr = v => v!==0 ? (v<0?'#ef4444':'#10b981') : 'var(--t3)';
      return `<tr style="border-bottom:1px solid var(--b1);background:rgba(16,185,129,.02);">
        <td style="padding:10px 14px;font-weight:600;font-size:.8rem;white-space:nowrap;"><span style="margin-right:5px;">${m.icon||'♠'}</span>${c}</td>
        <td style="padding:8px 10px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:${sel.includes(c)?'#60a5fa':'var(--t3)'};">${sel.includes(c)?fmtV(perClub):'—'}</td>
        <td style="padding:8px 10px;text-align:center;${valStyle}color:${valClr(e.compras)};">${e.compras?fmtV(e.compras):'—'}</td>
        <td style="padding:8px 10px;text-align:center;${valStyle}color:${valClr(e.security)};">${e.security?fmtV(e.security):'—'}</td>
        <td style="padding:8px 10px;text-align:center;${valStyle}color:${valClr(e.outros)};">${e.outros?fmtV(e.outros):'—'}</td>
        <td style="padding:8px 10px;font-size:.72rem;color:var(--t2);">${e.obs||'—'}</td>
        <td style="padding:10px 14px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:${clr(rowTotal)};" id="lanc-total-${c.replace(/\s/g,'_')}">${fmtV(rowTotal)}</td>
        <td style="padding:8px 10px;text-align:center;">
          ${wkLock ? '<span style="font-size:.6rem;color:var(--t3);">🔒</span>' :
          '<button onclick="_unlockLancRow(\''+cid+'\')" style="background:var(--s3);border:1px solid var(--b2);color:var(--t2);padding:4px 10px;border-radius:6px;font-size:.62rem;font-weight:600;cursor:pointer;white-space:nowrap;">✎ Alterar</button>'}
        </td>
      </tr>`;
    } else {
      // EDITABLE ROW — inputs + OK button
      const inpStyle = 'width:100%;text-align:right;font-size:.78rem;padding:7px 10px;';
      return `<tr style="border-bottom:1px solid var(--b1);">
        <td style="padding:10px 14px;font-weight:600;font-size:.8rem;white-space:nowrap;"><span style="margin-right:5px;">${m.icon||'♠'}</span>${c}</td>
        <td style="padding:8px 10px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:${sel.includes(c)?'#60a5fa':'var(--t3)'};">${sel.includes(c)?fmtV(perClub):'—'}</td>
        <td style="padding:6px 10px;"><input class="rs-inp" type="number" step="0.01" value="${e.compras||''}"
          oninput="saveLigaClubEntry('${cid}','compras',parseFloat(this.value)||0);_refreshLancTotals()" style="${inpStyle}" placeholder="0"></td>
        <td style="padding:6px 10px;"><input class="rs-inp" type="number" step="0.01" value="${e.security||''}"
          oninput="saveLigaClubEntry('${cid}','security',parseFloat(this.value)||0);_refreshLancTotals()" style="${inpStyle}" placeholder="0"></td>
        <td style="padding:6px 10px;"><input class="rs-inp" type="number" step="0.01" value="${e.outros||''}"
          oninput="saveLigaClubEntry('${cid}','outros',parseFloat(this.value)||0);_refreshLancTotals()" style="${inpStyle}" placeholder="0"></td>
        <td style="padding:6px 10px;"><input class="rs-inp" type="text" value="${(e.obs||'').replace(/"/g,'&quot;')}"
          oninput="saveLigaClubEntry('${cid}','obs',this.value)" style="width:100%;font-size:.74rem;padding:7px 10px;" placeholder="—"></td>
        <td style="padding:10px 14px;text-align:right;font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;" id="lanc-total-${c.replace(/\s/g,'_')}">${fmtV(rowTotal)}</td>
        <td style="padding:8px 10px;text-align:center;">
          <button onclick="_lockLancRow('${cid}')" style="background:var(--green-d);border:1px solid rgba(16,185,129,.3);color:var(--green);padding:5px 12px;border-radius:6px;font-size:.65rem;font-weight:700;cursor:pointer;white-space:nowrap;">✓ OK</button>
        </td>
      </tr>`;
    }
  }).join('');

  // Grand totals
  let gOverlay=0, gCompras=0, gSecurity=0, gOutros=0;
  CLUBS.forEach(c=>{
    const e = getLigaClubEntry(c);
    if(sel.includes(c)) gOverlay += perClub;
    gCompras += (e.compras||0);
    gSecurity += (e.security||0);
    gOutros += (e.outros||0);
  });
  const gTotal = gOverlay + gCompras + gSecurity + gOutros;

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div>
        <div style="font-size:1rem;font-weight:800;color:var(--t1);">📝 Lançamentos</div>
        <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Overlay global + ajustes manuais por clube · Semana selecionada</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="font-size:.68rem;color:var(--t3);background:var(--s2);border:1px solid var(--b1);padding:5px 12px;border-radius:6px;">
          📅 ${weeks[selWeekIdx] ? fWL(weeks[selWeekIdx]) : '—'}
        </div>
        ${wkLock ? '<span style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:4px 10px;border-radius:6px;font-size:.65rem;font-weight:700;">🔒 Semana Consolidada</span>' : ''}
      </div>
    </div>

    <!-- OVERLAY GLOBAL -->
    <div style="background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15);border-radius:10px;padding:18px 20px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-size:.82rem;font-weight:700;color:#60a5fa;">🎲 Overlay Global</div>
          <div style="font-size:.62rem;color:var(--t3);margin-top:2px;">Valor total dividido entre os clubes selecionados abaixo</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:.72rem;color:var(--t3);">R$</span>
          <input class="rs-inp" type="number" step="0.01" id="lanc-overlay-global" value="${overlayGlobal||''}" ${wkLock?'disabled style="opacity:.6;"':''}
            oninput="_updateLancOverlay()" style="width:130px;text-align:right;font-size:.9rem;font-weight:700;" placeholder="0">
        </div>
      </div>
      <div style="font-size:.62rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:8px;">Aplicar a:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        ${clubChecks}
      </div>
      ${sel.length > 0 && overlayGlobal !== 0 ? '<div style="margin-top:10px;text-align:center;font-size:.68rem;color:var(--t3);">'+fmtV(overlayGlobal)+' ÷ '+sel.length+' clubes = <strong style="color:#60a5fa;">'+fmtV(perClub)+' por clube</strong></div>' : ''}
    </div>

    <!-- TABELA POR CLUBE -->
    <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📋 Lançamentos por Clube</div>
    <div style="border:1px solid var(--b1);border-radius:10px;">
      <table style="width:100%;border-collapse:collapse;table-layout:fixed;">
        <colgroup>
          <col style="width:12%;">
          <col style="width:11%;">
          <col style="width:14%;">
          <col style="width:14%;">
          <col style="width:14%;">
          <col style="width:14%;">
          <col style="width:11%;">
          <col style="width:10%;">
        </colgroup>
        <thead>
          <tr style="background:var(--s2);border-bottom:2px solid var(--b1);">
            <th style="padding:11px 14px;text-align:left;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Clube</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:#60a5fa;font-weight:700;">Overlay</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Compras</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Security</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Outros</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Obs.</th>
            <th style="padding:11px 14px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--gold);font-weight:700;">Total</th>
            <th style="padding:11px 10px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Ação</th>
          </tr>
        </thead>
        <tbody>
          ${tblRows}
          <tr style="background:var(--s2);border-top:2px solid var(--gold);font-weight:800;">
            <td style="padding:12px 14px;color:var(--gold);font-size:.8rem;">TOTAIS</td>
            <td style="text-align:center;padding:12px 10px;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:#60a5fa;">${fmtV(gOverlay)}</td>
            <td style="text-align:center;padding:12px 10px;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:${clr(gCompras)};" id="lanc-tot-compras">${fmtV(gCompras)}</td>
            <td style="text-align:center;padding:12px 10px;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:${clr(gSecurity)};" id="lanc-tot-security">${fmtV(gSecurity)}</td>
            <td style="text-align:center;padding:12px 10px;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:${clr(gOutros)};" id="lanc-tot-outros">${fmtV(gOutros)}</td>
            <td></td>
            <td style="text-align:right;padding:12px 14px;font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:800;color:${clr(gTotal)};" id="lanc-grand-total">${fmtV(gTotal)}</td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="margin-top:10px;font-size:.62rem;color:var(--t3);text-align:center;">
      💡 Valores salvos automaticamente. Usados no Liga de cada clube e no Liga — Consolidado.
    </div>
  `;
}

function _updateLancOverlay(){
  const val = parseFloat(document.getElementById('lanc-overlay-global')?.value) || 0;
  overlayGlobal = val;
  saveOverlay();
  renderLancamentos();
}

function _toggleOverlayClub(clube, checked){
  let sel = getOverlayClubesList();
  if(checked && !sel.includes(clube)) sel.push(clube);
  if(!checked) sel = sel.filter(c=>c!==clube);
  overlayClubes = sel;
  saveOverlayClubes();
  renderLancamentos();
}

function _refreshLancTotals(){
  // Quick inline update without full re-render
  const sel = getOverlayClubesList();
  const perClub = sel.length > 0 && overlayGlobal !== 0 ? overlayGlobal / sel.length : 0;
  let gCompras=0, gSecurity=0, gOutros=0, gOverlay=0;
  CLUBS.forEach(c=>{
    const e = getLigaClubEntry(c);
    const ov = sel.includes(c) ? perClub : 0;
    if(sel.includes(c)) gOverlay += perClub;
    gCompras += (e.compras||0); gSecurity += (e.security||0); gOutros += (e.outros||0);
    const tot = ov + (e.compras||0) + (e.security||0) + (e.outros||0);
    const td = document.getElementById('lanc-total-'+c.replace(/\s/g,'_'));
    if(td){ td.textContent = fmtV(tot); td.style.color = clr(tot); }
  });
  const gTotal = gOverlay + gCompras + gSecurity + gOutros;
  const tc = document.getElementById('lanc-tot-compras'); if(tc) tc.textContent = fmtV(gCompras);
  const ts = document.getElementById('lanc-tot-security'); if(ts) ts.textContent = fmtV(gSecurity);
  const to = document.getElementById('lanc-tot-outros'); if(to) to.textContent = fmtV(gOutros);
  const gt = document.getElementById('lanc-grand-total'); if(gt){ gt.textContent = fmtV(gTotal); gt.style.color = clr(gTotal); }
}

// Legacy stubs
function calcOverlay(){}
function lockCompras(){}
function unlockCompras(){}
function _lockResumoField(){}
function _unlockResumoField(){}
function getManual(){ return {}; }
function getLigaLanc(wk){ 
  const clubes = {};
  CLUBS.forEach(c=>{ clubes[c] = getLigaClubEntry(c); });
  return { overlayGlobal, clubes };
}
function saveManualInputs(){}
function loadManualInputs(){ renderResumo(); }

function updateClubKPIs(){
  if(!activeClube) return;
  renderResumo();
}

function calcFinal(){
  if(!activeClube) return;
  _renderResumoResult();
}

function _renderResumoResult(){
  const box = document.getElementById('rs-result-box');
  if(!box) return;
  const n = calcLigaNumbers();
  if(!n) return;
  const dirColor = clr(n.totalLiga);
  const dirIcon  = n.totalLiga >= 0 ? '🟢' : '🔴';
  box.innerHTML = `
    <div class="rs-final-box">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:rgba(240,180,41,.7);margin-bottom:6px;">ACERTO TOTAL LIGA</div>
          <div style="font-size:.74rem;color:rgba(240,180,41,.55);font-family:'JetBrains Mono',monospace;">Resultado Clube + Taxas + Lançamentos</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:1.85rem;font-weight:800;letter-spacing:-1px;color:${dirColor};">${fmtV(n.totalLiga)}</div>
          <div style="font-size:.72rem;color:${dirColor};margin-top:2px;">${dirIcon} ${n.direcao}</div>
        </div>
      </div>
    </div>`;
}

// ═══ RENDER RESUMO (club operational result — no Liga adjustments) ═══
function renderResumo(){
  const el = document.getElementById('resumo-content');
  if(!el) return;
  if(!activeClube || !allPlayers.filter(p=>p.clube===activeClube).length){
    el.innerHTML='<div class="cs"><div class="ci">📋</div><h3>Importe a planilha primeiro</h3></div>';
    return;
  }

  const n = calcLigaNumbers();
  if(!n){ el.innerHTML='<div class="cs"><div class="ci">⚠️</div><h3>Sem dados</h3></div>'; return; }

  const taxRow = (label, sub, val) =>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1);border-radius:7px;margin-bottom:4px;">'
    + '<div style="font-size:.72rem;color:var(--t2);">'+label+(sub?' <span style="font-size:.58rem;color:var(--t3);">'+sub+'</span>':'')+'</div>'
    + '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:600;color:#ef4444;">'+fmtV(val)+'</div></div>';

  const readOnlyRow = (label, sub, val) =>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;">'
    + '<div style="font-size:.76rem;font-weight:600;color:var(--t1);">'+label+(sub?'<div style="font-size:.55rem;color:var(--t3);font-weight:400;">'+sub+'</div>':'')+'</div>'
    + '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.85rem;font-weight:700;color:'+(val!==0?clr(val):'var(--t3)')+';">'+(val!==0?fmtV(val):'—')+'</div></div>';

  const sel = getOverlayClubesList();
  const ativosR = n.cp.filter(p => Math.abs(Number(p.ganhos)||0) > 0.01).length;

  el.innerHTML = `
    <!-- KPI Strip -->
    <div class="kpi-row" style="margin-bottom:18px;grid-template-columns:repeat(5,1fr);">
      <div class="km g"><div class="km-lbl">Jogadores Ativos</div><div class="km-val g">${ativosR}</div></div>
      <div class="km" style="border-top:2px solid var(--blue);">
        <div class="km-lbl">Profit/Loss<div style="font-size:.55rem;color:var(--t3);font-weight:400;">ganhos e perdas</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.profitLoss)};">${fV(n.profitLoss,false)}</div>
      </div>
      <div class="km gr"><div class="km-lbl">Rake Gerado</div><div class="km-val gr">${fV(n.rakeGerado,false)}</div></div>
      <div class="km" style="border-top:2px solid #a78bfa;">
        <div class="km-lbl">GGR Rodeo P/L</div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.ggrRodeo)};">${fV(n.ggrRodeo,false)}</div>
      </div>
      <div class="km" style="border-top:2px solid var(--gold);">
        <div class="km-lbl">Resultado do Clube<div style="font-size:.55rem;color:var(--t3);font-weight:400;">P/L + Rake + GGR</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:${clr(n.resultadoClube)};">${fV(n.resultadoClube,false)}</div>
      </div>
    </div>

    <!-- Two columns -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;">
      <!-- LEFT: Taxas automáticas -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📊 Taxas Automáticas</div>
        ${taxRow('Taxa Aplicativo', ligaConfig.taxaApp+'% do Rake', n.taxaApp)}
        ${taxRow('Taxa Liga', ligaConfig.taxaLiga+'% do Rake', n.taxaLiga)}
        ${n.ggrRodeo > 0 ? taxRow('Taxa Rodeo GGR', ligaConfig.taxaRodeoGGR+'% do GGR', n.taxaRodeoGGR) : '<div style="padding:7px 14px;font-size:.72rem;color:var(--t3);margin-bottom:4px;">Taxa Rodeo GGR — <em>GGR ≤ 0, não incide</em></div>'}
        ${n.ggrRodeo > 0 ? taxRow('Taxa Rodeo App', ligaConfig.taxaRodeoApp+'% do GGR', n.taxaRodeoApp) : '<div style="padding:7px 14px;font-size:.72rem;color:var(--t3);margin-bottom:4px;">Taxa Rodeo App — <em>GGR ≤ 0, não incide</em></div>'}
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;margin-top:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;">
          <div style="font-size:.72rem;font-weight:700;color:#ef4444;">Total Taxas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:#ef4444;">${fmtV(n.totalTaxas)}</div>
        </div>
      </div>

      <!-- RIGHT: Lançamentos (read-only, from Lançamentos page) -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📝 Lançamentos <span style="font-weight:400;">(editáveis em Lançamentos)</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:#60a5fa;">Overlay (parte do clube)<div style="font-size:.55rem;color:var(--t3);font-weight:400;">${fmtV(overlayGlobal)} ÷ ${sel.length} clubes</div></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.overlay)};">${n.overlay !== 0 ? fmtV(n.overlay) : '—'}</div>
        </div>
        ${readOnlyRow('Compras','',n.compras)}
        ${readOnlyRow('Security','',n.security)}
        ${readOnlyRow('Outros','',n.outros)}
      </div>
    </div>

    <!-- RESULTADO FINAL -->
    <div id="rs-result-box"></div>
  `;

  _renderResumoResult();
}
// ── Estado Detalhamento ──
let _detSearch = '';
let _detSearchTimer = null;
let _detExpanded = {};

function filterDet(q){
  _detSearch = q.toLowerCase().trim();
  clearTimeout(_detSearchTimer);
  _detSearchTimer = setTimeout(() => {
    const prev = document.activeElement;
    const wasSrch = prev && prev.id === 'det-search';
    const pos = wasSrch ? prev.selectionStart : 0;
    renderDetalhamento();
    if(wasSrch){ const inp = document.getElementById('det-search'); if(inp){ inp.focus(); inp.setSelectionRange(pos,pos); } }
  }, 200);
}

function toggleDetAgent(agKey){
  _detExpanded[agKey] = !_detExpanded[agKey];
  renderDetalhamento();
}

function exportDet(){
  if(!activeClube) return;
  const cp = allPlayers.filter(p => p.clube === activeClube);
  if(!cp.length) return;
  const rows = [['Agência','ID Agente','Jogador','ID Jogador','Ganhos','Rake','Rodeo GGR','Resultado Final']];
  const agMap = {};
  cp.forEach(p => { const k = p.aname||'(sem agente)'; if(!agMap[k]) agMap[k]=[]; agMap[k].push(p); });
  Object.entries(agMap).forEach(([ag, players]) => {
    players.forEach(p => {
      const res = (Number(p.ganhos)||0) + (Number(p.rake)||0) + (Number(p.ggr)||0);
      rows.push([ag, p.aid||'', p.nick||p.id||'', p.id||'', Number(p.ganhos)||0, Number(p.rake)||0, Number(p.ggr)||0, res]);
    });
  });
  const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
  a.download = 'detalhamento.csv';
  a.click();
}

function renderDetalhamento(){
  const el = document.getElementById('det-content');
  if(!el) return;
  if(!activeClube || !allPlayers.filter(p => p.clube === activeClube).length){
    el.innerHTML = '<div class="cs"><div class="ci">🔍</div><h3>Importe a planilha primeiro</h3></div>';
    return;
  }

  const cp = allPlayers.filter(p => p.clube === activeClube);

  // Agrupar por agente
  const agOrder = [], agMap = {};
  cp.forEach(p => {
    const k = p.aname || '(sem agente)';
    if(!agMap[k]){ agMap[k] = { aid: p.aid||'', players: [] }; agOrder.push(k); }
    agMap[k].players.push(p);
  });

  // Filtro de busca
  const q = _detSearch;
  const filteredOrder = agOrder.filter(ag =>
    !q || ag.toLowerCase().includes(q) ||
    agMap[ag].players.some(p => (p.nick||'').toLowerCase().includes(q) || String(p.id||'').includes(q))
  );

  // Totais globais
  const totGanhos = cp.reduce((s,p) => s + (Number(p.ganhos)||0), 0);
  const totRake   = cp.reduce((s,p) => s + (Number(p.rake)||0), 0);
  const totGGR    = cp.reduce((s,p) => s + (Number(p.ggr)||0), 0);
  const totRes    = totGanhos + totRake + totGGR;
  // KPI helpers
  const kpiS = 'background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;border-top:2px solid ';
  const kpiL = 'font-size:.52rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-bottom:4px;';
  const kpiV = "font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:800;";

  // Tabela helpers — estilos base fornecidos pela classe .tbl
  const thS  = '';
  const tdS  = '';
  const mono = "font-weight:600;";

  let rowsHtml = '';
  filteredOrder.forEach(ag => {
    const { aid, players } = agMap[ag];
    const agGanhos = players.reduce((s,p) => s + (Number(p.ganhos)||0), 0);
    const agRake   = players.reduce((s,p) => s + (Number(p.rake)||0), 0);
    const agGGR    = players.reduce((s,p) => s + (Number(p.ggr)||0), 0);
    const agRes    = agGanhos + agRake + agGGR;
    const isOpen   = !!_detExpanded[ag];
    const agSafe   = ag.replace(/'/g,"\\'");

    // Linha de agente
    rowsHtml += `<tr style="cursor:pointer;background:var(--s2);border-bottom:1px solid var(--b1);" onclick="toggleDetAgent('${agSafe}')">
      <td style="${tdS}font-weight:700;color:var(--t1);">
        <span style="display:inline-flex;align-items:center;gap:5px;">
          <span style="font-size:.6rem;opacity:.5;">${isOpen?'▲':'▶'}</span>
          🤝 ${ag}
          <span style="font-size:.56rem;color:var(--t3);font-weight:400;">(${players.length} jog.)</span>
        </span>
      </td>
      <td style="${tdS}color:var(--t3);${mono}">${aid||'—'}</td>
      <td style="${tdS}text-align:right;${mono}color:${clr(agGanhos)};">${fV(agGanhos,false)}</td>
      <td style="${tdS}text-align:right;${mono}color:var(--green);">${agRake > 0.001 ? fV(agRake,false) : '—'}</td>
      <td style="${tdS}text-align:right;${mono}color:#a78bfa;">${Math.abs(agGGR) > 0.001 ? fV(agGGR,false) : '—'}</td>
      <td style="${tdS}text-align:right;${mono}color:${clr(agRes)};font-weight:800;">${fV(agRes,false)}</td>
    </tr>`;

    // Sub-linhas de jogadores (quando expandido)
    if(isOpen){
      players.forEach((p, pi) => {
        const pGanhos = Number(p.ganhos)||0;
        const pRake   = Number(p.rake)||0;
        const pGGR    = Number(p.ggr)||0;
        const pRes    = pGanhos + pRake + pGGR;
        const bg      = pi % 2 ? 'rgba(255,255,255,.015)' : 'transparent';
        rowsHtml += `<tr style="background:${bg};border-bottom:1px solid rgba(255,255,255,.04);">
          <td style="${tdS}padding-left:28px;color:var(--t2);">👤 ${p.nick||p.id||'—'}</td>
          <td style="${tdS}color:var(--t3);${mono}">${p.id||'—'}</td>
          <td style="${tdS}text-align:right;${mono}color:${clr(pGanhos)};">${fV(pGanhos,false)}</td>
          <td style="${tdS}text-align:right;${mono}color:var(--green);">${pRake > 0.001 ? fV(pRake,false) : '—'}</td>
          <td style="${tdS}text-align:right;${mono}color:#a78bfa;">${Math.abs(pGGR) > 0.001 ? fV(pGGR,false) : '—'}</td>
          <td style="${tdS}text-align:right;${mono}color:${clr(pRes)};">${fV(pRes,false)}</td>
        </tr>`;
      });
    }
  });

  // Linha de total
  rowsHtml += `<tr style="background:rgba(240,180,41,.05);border-top:2px solid rgba(240,180,41,.2);">
    <td style="${tdS}font-weight:800;color:var(--gold);" colspan="2">TOTAL</td>
    <td style="${tdS}text-align:right;${mono}color:${clr(totGanhos)};font-weight:800;">${fV(totGanhos,false)}</td>
    <td style="${tdS}text-align:right;${mono}color:var(--green);font-weight:800;">${fV(totRake,false)}</td>
    <td style="${tdS}text-align:right;${mono}color:#a78bfa;font-weight:800;">${Math.abs(totGGR) > 0.001 ? fV(totGGR,false) : '—'}</td>
    <td style="${tdS}text-align:right;${mono}color:${clr(totRes)};font-weight:800;">${fV(totRes,false)}</td>
  </tr>`;

  el.innerHTML = `
    <!-- KPIs -->
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
      <div style="${kpiS}var(--blue)">
        <div style="${kpiL}">👥 Jogadores Ativos</div>
        <div style="${kpiV}color:var(--t1);">${cp.filter(p => Math.abs(Number(p.ganhos)||0) > 0.01).length}</div>
      </div>
      <div style="${kpiS}var(--gold)">
        <div style="${kpiL}">📈 Profit / Loss</div>
        <div style="${kpiV}color:${clr(totGanhos)};">${fV(totGanhos,false)}</div>
      </div>
      <div style="${kpiS}var(--green)">
        <div style="${kpiL}">💎 Rake Gerado</div>
        <div style="${kpiV}color:var(--green);">${fV(totRake,false)}</div>
      </div>
      <div style="${kpiS}${clr(totRes)}">
        <div style="${kpiL}">📊 Resultado Final</div>
        <div style="${kpiV}color:${clr(totRes)};">${fV(totRes,false)}</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" style="margin-bottom:12px;">
      <div class="tl">
        <input class="search-box" type="text" id="det-search" placeholder="🔍 Buscar agente ou jogador..." value="${_detSearch}" oninput="filterDet(this.value)">
      </div>
      <div class="tr">
        <button class="btn-sm" onclick="exportDet()">⬇ Exportar CSV</button>
      </div>
    </div>

    <!-- Tabela -->
    <div class="tw">
      <table class="tbl" style="min-width:960px;">
        <thead><tr>
          <th>Agência / Jogador</th>
          <th>ID Agente</th>
          <th style="text-align:right;">Ganhos</th>
          <th style="text-align:right;">Rake</th>
          <th style="text-align:right;">Rodeo GGR</th>
          <th style="text-align:right;">Resultado Final</th>
        </tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
    </div>
    ${filteredOrder.length === 0 ? '<div class="cs" style="padding:30px;"><div class="ci">🔍</div><h3>Nenhum resultado</h3></div>' : ''}
  `;
}

function updateOverviewKPIs(){
  const total     = allPlayers.length;
  const totGanhos = sumF(allPlayers,'ganhos');
  const totRake   = sumF(allPlayers,'rake');
  const totGGR    = sumF(allPlayers,'ggr');
  // Resultado = soma de resultadoAgente por agente
  const _agMap={};
  allPlayers.forEach(p=>{ const k=p.aname||'(sem agente)'; if(!_agMap[k])_agMap[k]=[]; _agMap[k].push(p); });
  const totResult = Object.entries(_agMap).reduce((s,[k,pl])=>s+calcAgentResult(k,pl).resultadoAgente,0);
  const rb        = Object.entries(_agMap).reduce((s,[k,pl])=> s + calcAgentRB(k, pl), 0);
  const unk       = allPlayers.filter(p=>p.clube==='?').length;
  document.getElementById('ov-total').textContent = total;
  document.getElementById('ov-rake').textContent  = total ? fV(totRake,false)   : '—';
  document.getElementById('ov-rb').textContent    = total ? fV(rb,false)        : '—';
  document.getElementById('ov-unk').textContent   = unk;
}

// ══════════════════ EXPORTAR RESUMO DO CLUBE ══════════════════
function exportResumoJPG(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  const n = calcLigaNumbers();
  if(!n){ showToast('⚠️ Nenhum jogador neste clube','e'); return; }

  const m       = CMETA[activeClube]||{};
  const week    = weeks[selWeekIdx] ? fWL(weeks[selWeekIdx]) : '—';
  const { cp, profitLoss:totGanhos, rakeGerado:totRake, ggrRodeo:totGGR, resultadoClube:totResult, taxaApp, taxaLiga, taxaRodeoGGR, taxaRodeoApp, totalTaxas, overlay, compras, security, outros, totalLiga:resultado } = n;

  const logoHtml = clubLogos[activeClube]
    ? `<img src="${clubLogos[activeClube]}" style="width:52px;height:52px;border-radius:12px;object-fit:cover;">`
    : `<div style="width:52px;height:52px;border-radius:12px;background:#1e2538;display:flex;align-items:center;justify-content:center;font-size:1.8rem;">${m.icon}</div>`;

  const fmtV = v => (v<0?'-':'')+'R$ '+fV(Math.abs(v),false);
  const clrPos = '#10b981', clrNeg = '#ef4444', clrNeu = '#6b7280';
  const clr = v => v>0?clrPos:v<0?clrNeg:clrNeu;

  // KPI card helper
  const kpi = (lbl, val, valColor, borderColor) =>
    `<div style="flex:1;background:#f8fafc;border-radius:10px;padding:14px 16px;border-top:3px solid ${borderColor};">
      <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#9ca3af;margin-bottom:8px;">${lbl}</div>
      <div style="font-family:'Courier New',monospace;font-size:1rem;font-weight:800;color:${valColor};">${val}</div>
    </div>`;

  // Row helper para coluna esquerda
  const calcRow = (lbl, sub, val, valColor) =>
    `<div style="display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #e5e7eb;border-radius:9px;padding:11px 14px;margin-bottom:8px;">
      <div>
        <div style="font-size:.82rem;font-weight:600;color:#111;">${lbl}</div>
        ${sub?`<div style="font-size:.67rem;color:#9ca3af;margin-top:2px;">${sub}</div>`:''}
      </div>
      <div style="font-family:'Courier New',monospace;font-size:.88rem;font-weight:700;color:${valColor};">${val}</div>
    </div>`;

  // Row helper para coluna direita (manual)
  const manualRow = (lbl, val, valColor) =>
    `<div style="display:flex;align-items:center;justify-content:space-between;background:#f8fafc;border:1px solid #e5e7eb;border-radius:9px;padding:11px 14px;margin-bottom:8px;">
      <div style="font-size:.82rem;font-weight:600;color:#111;">${lbl}</div>
      <div style="font-family:'Courier New',monospace;font-size:.88rem;font-weight:700;color:${valColor};">${val}</div>
    </div>`;

  // Breakdown badges
  const breakdownItems = [
    {lbl:'Resultado do Clube (P/L+Rake+GGR)', val:totResult},
    {lbl:'Taxa App (8%)',                val:-taxaApp},
    {lbl:'Taxa Liga (10%)',              val:-taxaLiga},
    ...(taxaRodeoGGR!==0?[{lbl:'Taxa Rodeo GGR (12%)', val:-taxaRodeoGGR}]:[]),
    ...(taxaRodeoApp!==0?[{lbl:'Taxa Rodeo App (18%)', val:-taxaRodeoApp}]:[]),
    ...(overlay!==0   ?[{lbl:'Overlay (÷'+getOverlayClubesList().length+')',  val:overlay}]:[]),
    ...(compras!==0   ?[{lbl:'Compras',            val:compras}]:[]),
    ...(security!==0  ?[{lbl:'Security',           val:security}]:[]),
    ...(outros!==0    ?[{lbl:'Outros',             val:outros}]:[]),
  ];
  const badges = breakdownItems.map(i=>
    `<div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:6px 11px;display:inline-flex;align-items:center;gap:6px;font-size:.7rem;">
      <span style="color:#9ca3af;font-weight:600;">${i.lbl}</span>
      <span style="font-family:'Courier New',monospace;font-weight:700;color:${clr(i.val)};">${fmtV(i.val)}</span>
    </div>`
  ).join('');

  const html = `<div id="resumo-capture" style="background:#fff;font-family:'Outfit','Segoe UI',sans-serif;padding:32px 32px 28px;width:820px;color:#111;box-sizing:border-box;">

  <!-- HEADER -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding-bottom:18px;border-bottom:2px solid #f0b429;">
    <div style="display:flex;align-items:center;gap:14px;">
      ${logoHtml}
      <div>
        <div style="font-size:1.3rem;font-weight:800;letter-spacing:-.5px;color:#111;">${activeClube}</div>
        <div style="font-size:.75rem;color:#9ca3af;margin-top:3px;font-family:'Courier New',monospace;">📅 ${week}</div>
      </div>
    </div>
    <div style="text-align:right;">
      <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#f0b429;">PokerManager</div>
      <div style="font-size:.72rem;color:#9ca3af;margin-top:3px;">Fechamento Semanal</div>
    </div>
  </div>

  <!-- KPI ROW -->
  <div style="display:flex;gap:10px;margin-bottom:22px;">
    ${kpi('Jogadores', cp.length, '#111', '#10b981')}
    ${kpi('Rake Total', fmtV(totRake), clrPos, '#10b981')}
    ${kpi('GGR Rodeo', fmtV(totGGR), clr(totGGR), '#a78bfa')}
    ${kpi('Profit/Loss', fmtV(totGanhos), clr(totGanhos), '#3b82f6')}
    ${kpi('Resultado do Clube', fmtV(totResult), clr(totResult), '#f0b429')}
  </div>

  <!-- DOIS COLUNAS -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">

    <!-- ESQUERDA: calculados -->
    <div>
      <div style="font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#9ca3af;margin-bottom:10px;">📊 Valores Calculados Automaticamente</div>
      ${calcRow('Rake Gerado', '', fmtV(totRake), clrPos)}
      ${calcRow('Taxa de Aplicativo', ligaConfig.taxaApp+'% do Rake Gerado', fmtV(-taxaApp), clrNeg)}
      ${calcRow('Taxa da Liga', ligaConfig.taxaLiga+'% do Rake Gerado', fmtV(-taxaLiga), clrNeg)}
      ${calcRow('Taxa Rodeo GGR', ligaConfig.taxaRodeoGGR+'% do GGR (só se positivo)', taxaRodeoGGR>0?fmtV(-taxaRodeoGGR):'R$ 0,00 (GGR negativo)', taxaRodeoGGR>0?clrNeg:clrNeu)}
      ${calcRow('Taxa Rodeo App', ligaConfig.taxaRodeoApp+'% do GGR (só se positivo)', taxaRodeoApp>0?fmtV(-taxaRodeoApp):'R$ 0,00 (GGR negativo)', taxaRodeoApp>0?clrNeg:clrNeu)}
    </div>

    <!-- DIREITA: manuais -->
    <div>
      <div style="font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#9ca3af;margin-bottom:10px;">✏️ Lançamentos Manuais</div>
      <div style="display:flex;align-items:center;justify-content:space-between;background:#eff6ff;border:1px solid #bfdbfe;border-radius:9px;padding:11px 14px;margin-bottom:8px;">
        <div>
          <div style="font-size:.82rem;font-weight:600;color:#3b82f6;">Overlay (parte do clube)</div>
          <div style="font-size:.67rem;color:#93c5fd;margin-top:2px;">Valor global ÷ ${getOverlayClubesList().length} clubes</div>
        </div>
        <div style="font-family:'Courier New',monospace;font-size:.88rem;font-weight:700;color:#3b82f6;">${overlay!==0?fmtV(overlay):'—'}</div>
      </div>
      ${manualRow('Compras', compras!==0?fmtV(compras):'R$ 0,00', clr(compras))}
      ${manualRow('Security', security!==0?fmtV(security):'R$ 0,00', clr(security))}
      ${manualRow('Outros',  outros!==0 ?fmtV(outros) :'R$ 0,00', clr(outros))}
    </div>
  </div>

  <!-- RESULTADO FINAL -->
  <div style="background:${resultado>=0?'#f0fdf8':'#fff5f5'};border:2px solid ${resultado>=0?'rgba(16,185,129,.3)':'rgba(239,68,68,.3)'};border-radius:14px;padding:20px 22px;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:14px;">
      <div>
        <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:${resultado>=0?'#059669':'#dc2626'};">Acerto Total Liga</div>
        <div style="font-size:.72rem;color:#9ca3af;font-family:'Courier New',monospace;margin-top:4px;">Resultado Clube + Taxas + Lançamentos</div>
      </div>
      <div style="text-align:right;">
        <div style="font-family:'Courier New',monospace;font-size:1.7rem;font-weight:900;color:${resultado>=0?clrPos:clrNeg};">${fmtV(resultado)}</div>
        <div style="font-size:.7rem;color:${resultado>=0?clrPos:clrNeg};margin-top:3px;">${resultado>=0?'🟢 Liga deve pagar ao Império':'🔴 Império deve pagar à Liga'}</div>
      </div>
    </div>
    <!-- Breakdown badges -->
    <div style="display:flex;flex-wrap:wrap;gap:7px;padding-top:14px;border-top:1px solid ${resultado>=0?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)'};">
      ${badges}
      <div style="background:#fff8e6;border:1px solid #f0b429;border-radius:8px;padding:6px 11px;display:inline-flex;align-items:center;gap:6px;font-size:.7rem;margin-left:auto;">
        <span style="color:#d97706;font-weight:700;">= ACERTO LIGA</span>
        <span style="font-family:'Courier New',monospace;font-weight:800;color:${clr(resultado)};font-size:.8rem;">${fmtV(resultado)}</span>
      </div>
    </div>
  </div>

  <!-- RODAPÉ -->
  <div style="margin-top:18px;text-align:center;font-size:.63rem;color:#d1d5db;">
    Gerado por PokerManager · ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}
  </div>
</div>`;

  // Insere no modal e abre
  document.getElementById('resumo-doc-render').innerHTML = html;
  document.getElementById('resumo-modal').classList.add('open');
}

function downloadResumoJPG(){
  const el = document.getElementById('resumo-capture');
  if(!el || typeof html2canvas==='undefined'){ showToast('⚠️ Biblioteca não disponível'); return; }
  showToast('📸 Gerando imagem...');
  html2canvas(el, {scale:2, backgroundColor:'#ffffff', useCORS:true, logging:false}).then(canvas=>{
    const link = document.createElement('a');
    link.download = `resumo_${activeClube}_${weeks[selWeekIdx]||'semana'}.jpg`;
    link.href = canvas.toDataURL('image/jpeg', 0.95);
    link.click();
    showToast('✅ Resumo salvo como JPG!');
  });
}

// ══════════════════ RESUMO FINANCEIRO ══════════════════

// ══ FONTE ÚNICA DA FÓRMULA DO CLUBE ══
// Delega para FinanceEngine.calcClubKPIs (puro)
function calcClubNumbers(clube){
  clube = clube || activeClube;
  if(!clube) return null;
  const cp = allPlayers.filter(p=>p.clube===clube);
  if(!cp.length) return null;
  const kpis = FinanceEngine.calcClubKPIs(cp, ligaConfig, calcAgentRB);
  return { cp, ...kpis };
}

function calcResultadoClube(){ return calcClubNumbers()?.resultado || 0; }

// ══════════════════ DRE — DEMONSTRAÇÃO DE RESULTADO ══════════════════
function calcDREData(){
  const n = calcClubNumbers();
  if(!n) return null;

  // 1. Receita Bruta
  const rakeGerado   = n.totRake || 0;
  const ggrRodeo     = n.totGGR  || 0;
  const totalReceita = rakeGerado + ggrRodeo;

  // 2. Custos Operacionais — RB separado por tipo
  const cp = n.cp;
  const agMap = {};
  cp.forEach(p=>{ const k=(p.aname||'').trim()||'(sem agente)'; if(!agMap[k]) agMap[k]=[]; agMap[k].push(p); });
  let rbAgentes = 0, rbDiretos = 0;
  Object.entries(agMap).forEach(([agKey,pls])=>{
    const rb = calcAgentRB(agKey, pls);
    if(agentDirect[agKey]) rbDiretos += rb; else rbAgentes += rb;
  });
  const totalCustos = rbAgentes + rbDiretos;

  // 3. Resultado Operacional
  const resultadoOperacional = totalReceita - totalCustos;

  // 4. Taxas da Liga (calcLigaNumbers retorna negativos — converter para absoluto)
  const ln = calcLigaNumbers();
  const taxaApp      = Math.abs(ln?.taxaApp      || 0);
  const taxaLiga     = Math.abs(ln?.taxaLiga     || 0);
  const taxaRodeoGGR = Math.abs(ln?.taxaRodeoGGR || 0);
  const taxaRodeoApp = Math.abs(ln?.taxaRodeoApp || 0);
  const totalTaxas   = taxaApp + taxaLiga + taxaRodeoGGR + taxaRodeoApp;

  // 5. Despesas OFX (categoria='despesas', status='aplicado')
  const sess = getOFXSessao();
  const despesasBySubcat = {};
  let totalDespesas = 0;
  sess.filter(t=>t.categoria==='despesas' && t.status==='aplicado').forEach(t=>{
    const sub = t.subcategoria || 'outros';
    despesasBySubcat[sub] = (despesasBySubcat[sub]||0) + Math.abs(t.valor);
    totalDespesas += Math.abs(t.valor);
  });

  // 6. Lançamentos manuais
  const m        = clubManual[activeClube] || {};
  const overlay  = parseLancVal(m,'overlay') || getOverlayPerClub(activeClube);
  const compras  = parseLancVal(m,'compras');
  const security = parseLancVal(m,'security');
  const outros   = parseLancVal(m,'outros');
  const lancItems = [
    { label:'Overlay',  val: overlay  ? -Math.abs(overlay)  : 0, skip: !overlay   },
    { label:'Compras',  val: compras  ? -Math.abs(compras)  : 0, skip: !compras   },
    { label:'Security', val: security,                            skip: !security  },
    { label:'Outros',   val: outros,                              skip: !outros    },
  ];
  const totalLancamentos = lancItems.reduce((s,x)=>s+x.val, 0);

  // 7. Resultado Líquido
  const resultadoLiquido = resultadoOperacional - totalTaxas - totalDespesas + totalLancamentos;

  // 8. Acerto Liga
  const acertoLiga    = ln?.totalLiga  || 0;
  const acertoDirecao = ln?.direcao    || '';

  return {
    rakeGerado, ggrRodeo, totalReceita,
    rbAgentes, rbDiretos, totalCustos,
    resultadoOperacional,
    taxaApp, taxaLiga, taxaRodeoGGR, taxaRodeoApp, totalTaxas,
    despesasBySubcat, totalDespesas,
    lancItems, totalLancamentos,
    resultadoLiquido,
    acertoLiga, acertoDirecao,
    hasRodeo: ggrRodeo > 0,
  };
}

function toggleDRE(section){
  _dreExpanded[section] = !_dreExpanded[section];
  renderResultadoClube();
}

// ══════════════════ RESULTADO DO CLUBE (P&L) ══════════════════

function renderResultadoClube(){
  const el = document.getElementById('resultado-clube-content');
  if(!el) return;
  const d = calcDREData();
  if(!d){
    el.innerHTML = '<div class="cs"><div class="ci">📊</div><h3>Importe a planilha primeiro</h3><p style="color:var(--t3);font-size:.78rem;">O DRE é calculado com base nos dados da semana importada.</p></div>';
    return;
  }

  // ── Helper: bloco colapsável ─────────────────────────────────
  function _dreBlock(icon, title, valor, section, detalheRows){
    const exp = _dreExpanded[section];
    const corV = clr(valor);
    let h = `<div onclick="toggleDRE('${section}')" style="display:flex;align-items:center;justify-content:space-between;padding:13px 18px;cursor:pointer;border-bottom:1px solid var(--b1);user-select:none;" onmouseenter="this.style.background='rgba(255,255,255,.022)'" onmouseleave="this.style.background=''">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:.88rem;">${icon}</span>
        <span style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t2);">${title}</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:800;color:${corV};">R$ ${fV(valor,false)}</span>
        <span style="font-size:.56rem;color:var(--t3);min-width:10px;">${exp?'▼':'▶'}</span>
      </div>
    </div>`;
    if(exp){
      h += '<div style="background:rgba(255,255,255,.01);">';
      detalheRows.forEach(r=>{
        if(r.skip) return;
        const rc = clr(r.val);
        h += `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 18px 7px 44px;border-bottom:1px solid rgba(255,255,255,.03);">
          <span style="font-size:.7rem;color:var(--t3);">${r.label}</span>
          <span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:${rc};">R$ ${fV(r.val,false)}</span>
        </div>`;
      });
      if(detalheRows.every(r=>r.skip)){
        h += `<div style="padding:8px 18px 8px 44px;font-size:.68rem;color:var(--t3);">Nenhum item registrado</div>`;
      }
      h += '</div>';
    }
    return h;
  }

  // ── Helper: linha de resultado fixa (sem colapso) ────────────
  function _dreResultRow(icon, title, valor, accent){
    const cor   = accent || clr(valor);
    const bg    = accent ? 'rgba(255,255,255,.03)' : valor>0?'rgba(16,185,129,.06)':valor<0?'rgba(239,68,68,.06)':'rgba(255,255,255,.02)';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:15px 18px;background:${bg};border-bottom:1px solid var(--b1);">
      <span style="font-size:.74rem;font-weight:700;color:var(--t1);">${icon} ${title}</span>
      <span style="font-family:'JetBrains Mono',monospace;font-size:.92rem;font-weight:800;color:${cor};">R$ ${fV(valor,false)}</span>
    </div>`;
  }

  // ── KPI strip ─────────────────────────────────────────────────
  function _kpi(label, valor, color, sub){
    return `<div style="background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:12px 14px;border-top:2px solid ${color};">
      <div style="font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);margin-bottom:4px;">${label}</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:800;color:${color};">R$ ${fV(valor,false)}</div>
      ${sub?`<div style="font-size:.48rem;color:var(--t3);margin-top:2px;">${sub}</div>`:''}
    </div>`;
  }

  const acertoColor = clr(d.acertoLiga);

  let html = '';

  // KPI strip
  html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px;">';
  html += _kpi('📈 Receita Bruta',      d.totalReceita,       '#60a5fa',  d.rakeGerado>0?`Rake R$ ${fV(d.rakeGerado,false)}`:'');
  html += _kpi('📉 Custos (RB)',        -d.totalCustos,       '#f87171',  d.totalCustos>0?`${((d.totalCustos/d.totalReceita)*100||0).toFixed(1)}% da receita`:'');
  html += _kpi('💰 Res. Operacional',   d.resultadoOperacional, clr(d.resultadoOperacional), '');
  html += _kpi('✅ Res. Líquido',       d.resultadoLiquido,   clr(d.resultadoLiquido), '');
  html += _kpi('🏆 Acerto Liga',        d.acertoLiga,         acertoColor, d.acertoDirecao?d.acertoDirecao.replace('Império',activeClube):'');
  html += '</div>';

  // DRE Card colapsável
  html += `<div style="background:var(--s1);border:1px solid var(--b1);border-radius:12px;overflow:hidden;margin-bottom:14px;">`;

  // Cabeçalho
  const wkLabel = typeof fWL === 'function' ? fWL(weeks[selWeekIdx]||'0') : (weeks[selWeekIdx]||'—');
  html += `<div style="padding:13px 18px;border-bottom:1px solid var(--b1);background:var(--s2);display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div style="font-size:.78rem;font-weight:700;color:var(--t1);">📊 DRE — ${activeClube}</div>
      <div style="font-size:.6rem;color:var(--t3);margin-top:1px;">Semana ${wkLabel}</div>
    </div>
    <div style="font-size:.62rem;color:var(--t3);">${d.hasRodeo?'🎲 Com Rodeo GGR':''}</div>
  </div>`;

  // 1. Receita Bruta
  html += _dreBlock('📈','Receita Bruta', d.totalReceita, 'receita', [
    { label:'Rake Gerado',  val: d.rakeGerado, skip: false },
    { label:'Rodeo GGR',   val: d.ggrRodeo,   skip: !d.hasRodeo },
  ]);

  // 2. Custos Operacionais
  html += _dreBlock('📉','Custos Operacionais', -d.totalCustos, 'custos', [
    { label:'Rakeback Agentes',           val: -d.rbAgentes, skip: d.rbAgentes < 0.01 },
    { label:'Rakeback Jogadores Diretos', val: -d.rbDiretos,  skip: d.rbDiretos  < 0.01 },
    { label:'Total Rakeback',             val: -d.totalCustos, skip: d.rbAgentes >= 0.01 && d.rbDiretos >= 0.01 },
  ]);

  // Resultado Operacional — fixo
  html += _dreResultRow('💰','Resultado Operacional', d.resultadoOperacional);

  // 3. Taxas da Liga
  html += _dreBlock('📉','Taxas da Liga', -d.totalTaxas, 'taxas', [
    { label:`Taxa Aplicativo (${ligaConfig.taxaApp}%)`,     val: -d.taxaApp,       skip: d.taxaApp < 0.01 },
    { label:`Taxa Liga (${ligaConfig.taxaLiga}%)`,           val: -d.taxaLiga,      skip: d.taxaLiga < 0.01 },
    { label:`Taxa Rodeo GGR (${ligaConfig.taxaRodeoGGR}%)`, val: -d.taxaRodeoGGR,  skip: !d.hasRodeo },
    { label:`Taxa Rodeo App (${ligaConfig.taxaRodeoApp}%)`, val: -d.taxaRodeoApp,  skip: !d.hasRodeo },
  ]);

  // 4. Despesas OFX
  const detalheDesp = Object.entries(d.despesasBySubcat).map(([sub,val])=>({
    label: sub.charAt(0).toUpperCase()+sub.slice(1), val: -val, skip: false
  }));
  if(!detalheDesp.length) detalheDesp.push({ label:'Nenhuma despesa OFX aplicada — importe e aplique transações OFX na categoria Despesas', val:0, skip:false });
  html += _dreBlock('📉','Despesas', -d.totalDespesas, 'despesas', detalheDesp);

  // 5. Lançamentos
  const lancRows = d.lancItems.map(x=>({...x, skip: x.skip || Math.abs(x.val)<0.01}));
  html += _dreBlock('📊','Lançamentos', d.totalLancamentos, 'lancamentos', lancRows.length?lancRows:[{label:'Nenhum lançamento registrado',val:0,skip:false}]);

  // Resultado Líquido — fixo
  html += _dreResultRow('✅','Resultado Líquido', d.resultadoLiquido);

  // Acerto Liga — fixo, bloco especial
  html += `<div style="padding:14px 18px;background:${d.acertoLiga>=0?'rgba(16,185,129,.04)':'rgba(239,68,68,.04)'};">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-size:.72rem;font-weight:700;color:var(--t2);">🏆 Acerto Liga</div>
        <div style="font-size:.6rem;color:var(--t3);margin-top:2px;">${d.acertoDirecao.replace('Império',activeClube)||'—'}</div>
      </div>
      <span style="font-family:'JetBrains Mono',monospace;font-size:.92rem;font-weight:800;color:${acertoColor};">R$ ${fV(d.acertoLiga,false)}</span>
    </div>
  </div>`;

  html += '</div>'; // fecha DRE card

  // Rodapé resumo
  const n = calcClubNumbers();
  html += `<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 14px;font-size:.66rem;color:var(--t3);">
    ${n.cp.length} jogadores · Rake R$ ${fV(n.totRake,false)} · RB R$ ${fV(n.totRB,false)} (${((n.totRB/n.totRake*100)||0).toFixed(1)}% médio) · Despesas OFX: ${Object.keys(d.despesasBySubcat).length} categoria(s)
  </div>`;

  el.innerHTML = html;
}

function parseLancVal(m, key){ return Number(m[key]) || 0; }

// ════════════════════════════════════════════════════════════
// ═══  CAMADA 3: CONSOLIDAÇÃO LIGA  ════════════════════════
// ════════════════════════════════════════════════════════════

function getLigaClubEntry(clube){
  const m = clubManual[clube] || {};
  return { compras: m.compras||0, security: m.security||0, outros: m.outros||0, obs: m.obs||'', _locked: !!m._locked };
}

function saveLigaClubEntry(clube, field, val){
  if(!clubManual[clube]) clubManual[clube] = {};
  clubManual[clube][field] = val;
  saveClubManual();
}

function _lockLancRow(clube){
  if(!clubManual[clube]) clubManual[clube] = {};
  clubManual[clube]._locked = true;
  saveClubManual();
  renderLancamentos();
}

function _unlockLancRow(clube){
  if(!clubManual[clube]) clubManual[clube] = {};
  clubManual[clube]._locked = false;
  saveClubManual();
  renderLancamentos();
}

// Per-club calc (used by Resumo)
function calcLigaNumbers(clube){
  clube = clube || activeClube;
  if(!clube) return null;
  const cp = allPlayers.filter(p=>p.clube===clube);
  if(!cp.length) return null;
  const e = getLigaClubEntry(clube);
  const profitLoss = sumF(cp,'ganhos');
  const rakeGerado = sumF(cp,'rake');
  const ggrRodeo   = sumF(cp,'ggr');
  const resultadoClube = profitLoss + rakeGerado + ggrRodeo;
  const taxaApp      = -(rakeGerado * getLigaRate('taxaApp'));
  const taxaLiga     = -(rakeGerado * getLigaRate('taxaLiga'));
  const taxaRodeoGGR = ggrRodeo > 0 ? -(ggrRodeo * getLigaRate('taxaRodeoGGR')) : 0;
  const taxaRodeoApp = ggrRodeo > 0 ? -(ggrRodeo * getLigaRate('taxaRodeoApp')) : 0;
  const totalTaxas   = taxaApp + taxaLiga + taxaRodeoGGR + taxaRodeoApp;
  const compras  = e.compras;
  const overlay  = getOverlayPerClub(clube);
  const security = e.security;
  const outros   = e.outros;
  const totalManual = compras + overlay + security + outros;
  const totalLiga = resultadoClube + totalTaxas + totalManual;
  const direcao = totalLiga >= 0 ? 'Liga deve pagar ao Império' : 'Império deve pagar à Liga';
  return { profitLoss, rakeGerado, ggrRodeo, resultadoClube, taxaApp, taxaLiga, taxaRodeoGGR, taxaRodeoApp, totalTaxas, compras, overlay, security, outros, totalManual, totalLiga, direcao, cp };
}

// Per-club Liga view (inside club detail)
function renderLiga(){
  const el = document.getElementById('liga-content');
  if(!el) return;
  if(!activeClube || !allPlayers.filter(p=>p.clube===activeClube).length){
    el.innerHTML='<div class="cs"><div class="ci">🏆</div><h3>Importe a planilha primeiro</h3><p>A Consolidação Liga calcula o acerto com base nos dados operacionais.</p></div>';
    return;
  }

  const n = calcLigaNumbers();
  if(!n){ el.innerHTML='<div class="cs"><div class="ci">⚠️</div><h3>Sem dados</h3></div>'; return; }

  const taxRow = (label, sub, val) =>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1);border-radius:7px;margin-bottom:4px;">'
    + '<div style="font-size:.72rem;color:var(--t2);">'+label+(sub?' <span style="font-size:.58rem;color:var(--t3);">'+sub+'</span>':'')+'</div>'
    + '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:600;color:#ef4444;">'+fmtV(val)+'</div></div>';

  const readOnlyRow = (label, sub, val, color) =>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;">'
    + '<div style="font-size:.76rem;font-weight:600;color:var(--t1);">'+label+(sub?'<div style="font-size:.55rem;color:var(--t3);font-weight:400;">'+sub+'</div>':'')+'</div>'
    + '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.85rem;font-weight:700;color:'+(color||clr(val))+';">'+(val!==0?fmtV(val):'R$ 0,00')+'</div></div>';

  const sel = getOverlayClubesList();

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div>
        <div style="font-size:.9rem;font-weight:700;color:var(--t1);">🏆 Consolidação Liga</div>
        <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Acerto semanal com a liga — sem rakeback</div>
      </div>
    </div>

    <!-- KPI Strip -->
    <div class="kpi-row" style="margin-bottom:18px;grid-template-columns:repeat(4,1fr);">
      <div class="km" style="border-top:2px solid var(--blue);">
        <div class="km-lbl">Profit/Loss<div style="font-size:.55rem;color:var(--t3);font-weight:400;">ganhos e perdas</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.profitLoss)};">${fV(n.profitLoss,false)}</div>
      </div>
      <div class="km gr"><div class="km-lbl">Rake Gerado</div><div class="km-val gr">${fV(n.rakeGerado,false)}</div></div>
      <div class="km" style="border-top:2px solid #a78bfa;">
        <div class="km-lbl">GGR Rodeo P/L</div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.ggrRodeo)};">${fV(n.ggrRodeo,false)}</div>
      </div>
      <div class="km" style="border-top:2px solid var(--gold);">
        <div class="km-lbl">Resultado do Clube<div style="font-size:.55rem;color:var(--t3);font-weight:400;">P/L + Rake + GGR</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:${clr(n.resultadoClube)};">${fV(n.resultadoClube,false)}</div>
      </div>
    </div>

    <!-- Two columns -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;">
      <!-- LEFT: Taxas automáticas -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📊 Taxas Automáticas</div>
        ${taxRow('Taxa Aplicativo', ligaConfig.taxaApp+'% do Rake', n.taxaApp)}
        ${taxRow('Taxa Liga', ligaConfig.taxaLiga+'% do Rake', n.taxaLiga)}
        ${n.ggrRodeo > 0 ? taxRow('Taxa Rodeo GGR', ligaConfig.taxaRodeoGGR+'% do GGR', n.taxaRodeoGGR) : '<div style="padding:7px 14px;font-size:.72rem;color:var(--t3);margin-bottom:4px;">Taxa Rodeo GGR — <em>GGR ≤ 0, não incide</em></div>'}
        ${n.ggrRodeo > 0 ? taxRow('Taxa Rodeo App', ligaConfig.taxaRodeoApp+'% do GGR', n.taxaRodeoApp) : '<div style="padding:7px 14px;font-size:.72rem;color:var(--t3);margin-bottom:4px;">Taxa Rodeo App — <em>GGR ≤ 0, não incide</em></div>'}
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;margin-top:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;">
          <div style="font-size:.72rem;font-weight:700;color:#ef4444;">Total Taxas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:#ef4444;">${fmtV(n.totalTaxas)}</div>
        </div>
      </div>

      <!-- RIGHT: Lançamentos (read-only, from Lançamentos page) -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📝 Lançamentos <span style="font-weight:400;">(editáveis em Lançamentos)</span></div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:#60a5fa;">Overlay (parte do clube)<div style="font-size:.55rem;color:var(--t3);font-weight:400;">${fmtV(overlayGlobal)} ÷ ${sel.length} clubes</div></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.overlay)};">${n.overlay !== 0 ? fmtV(n.overlay) : '—'}</div>
        </div>
        ${readOnlyRow('Compras','Vem do Lançamento',n.compras)}
        ${readOnlyRow('Security','',n.security)}
        ${readOnlyRow('Outros','',n.outros)}
      </div>
    </div>

    <!-- RESULTADO FINAL LIGA -->
    <div id="liga-result-box"></div>
  `;

  _renderLigaResult();
}


function _renderLigaResult(){
  const box = document.getElementById('liga-result-box');
  if(!box) return;
  const n = calcLigaNumbers();
  if(!n) return;
  const dirColor = clr(n.totalLiga);
  const dirIcon  = n.totalLiga >= 0 ? '🟢' : '🔴';

  box.innerHTML = `
    <div class="rs-final-box">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:rgba(240,180,41,.7);margin-bottom:6px;">ACERTO TOTAL LIGA</div>
          <div style="font-size:.74rem;color:rgba(240,180,41,.55);font-family:'JetBrains Mono',monospace;">Resultado Clube + Taxas + Overlay + Compras + Security + Outros</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:1.85rem;font-weight:800;letter-spacing:-1px;color:${dirColor};">${fmtV(n.totalLiga)}</div>
          <div style="font-size:.72rem;color:${dirColor};margin-top:2px;">${dirIcon} ${n.direcao}</div>
        </div>
      </div>
    </div>
  `;
}

// ══════════════════ FECHAMENTO POR CLUBE (DASHBOARD) ══════════════════

function renderFechDash(){
  const el = document.getElementById('fech-dash-content');
  if(!el) return;
  if(!allPlayers.length){
    el.innerHTML='<div class="cs"><div class="ci">💼</div><h3>Fechamento por Clube</h3><p>Importe a planilha primeiro.</p></div>';
    return;
  }

  const savedClub = activeClube;
  const clubData = [];

  CLUBS.forEach(c => {
    activeClube = c;
    const setts = calcSettlements();
    const aPagar   = setts.reduce((s,e) => s + (e.pendente < -0.01 ? Math.abs(e.pendente) : 0), 0);
    const aReceber = setts.reduce((s,e) => s + (e.pendente > 0.01 ? e.pendente : 0), 0);
    const pago     = setts.reduce((s,e) => s + Math.abs(e.pago), 0);
    const totalEnt = setts.length;
    const comMov   = setts.filter(e => Math.abs(e.totalDevido) > 0.01 || Math.abs(e.pago) > 0.01).length;
    const quitados  = setts.filter(e => getSettlementStatus(e).cls === 'quitado').length;
    const emAberto  = setts.filter(e => getSettlementStatus(e).cls === 'em-aberto').length;

    let status, stColor, stBg, stBorder;
    if(comMov === 0){
      status = 'Sem Mov.'; stColor = '#94a3b8'; stBg = 'rgba(148,163,184,.08)'; stBorder = 'rgba(148,163,184,.15)';
    } else if(quitados === comMov){
      status = '✅ Quitado'; stColor = '#10b981'; stBg = 'rgba(16,185,129,.08)'; stBorder = 'rgba(16,185,129,.15)';
    } else {
      status = '⏳ Em Aberto'; stColor = '#ef4444'; stBg = 'rgba(239,68,68,.08)'; stBorder = 'rgba(239,68,68,.15)';
    }

    clubData.push({ clube: c, setts, aPagar, aReceber, pago, totalEnt, comMov, quitados, emAberto, status, stColor, stBg, stBorder });
  });

  activeClube = savedClub;

  // Globals
  const gPagar   = clubData.reduce((s,d) => s + d.aPagar, 0);
  const gReceber = clubData.reduce((s,d) => s + d.aReceber, 0);
  const gNet     = gReceber - gPagar;
  const gPago    = clubData.reduce((s,d) => s + d.pago, 0);
  const gEnt     = clubData.reduce((s,d) => s + d.totalEnt, 0);
  const gQuit    = clubData.reduce((s,d) => s + d.quitados, 0);
  const gPend    = clubData.reduce((s,d) => s + d.pendentes, 0);
  const gParc    = clubData.reduce((s,d) => s + d.parciais, 0);

  const meta = CMETA;

  let html = '';

  // Header
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">';
  html += '<div>';
  html += '<div style="font-size:1rem;font-weight:700;color:var(--t1);">💼 Fechamento por Clube</div>';
  html += '<div style="font-size:.75rem;color:var(--t3);margin-top:3px;">Visão geral da liquidação de todos os clubes</div>';
  html += '</div>';
  html += '<div style="display:flex;align-items:center;gap:10px;">';
  html += '<div style="background:var(--s2);border:1px solid var(--b1);padding:6px 12px;border-radius:8px;font-size:.72rem;color:var(--t2);">📊 '+gEnt+' entidades · '+gQuit+' quitadas · '+gPend+' pendentes</div>';
  html += '</div>';
  html += '</div>';

  // KPI strip
  html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:18px;">';
  function kC(icon,lbl,val,color,sub){
    return '<div style="background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:11px 12px;border-top:2px solid '+color+';min-width:0;">'
      +'<div style="font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--t3);margin-bottom:3px;">'+icon+' '+lbl+'</div>'
      +'<div style="font-family:\'JetBrains Mono\',monospace;font-size:.95rem;font-weight:800;color:'+color+';">'+val+'</div>'
      +(sub?'<div style="font-size:.48rem;color:var(--t3);margin-top:2px;">'+sub+'</div>':'')
      +'</div>';
  }
  html += kC('📤','A Pagar', gPagar > 0.01 ? fmtV(gPagar) : '—', '#ef4444', gPend+' pendentes');
  html += kC('📥','A Receber', gReceber > 0.01 ? fmtV(gReceber) : '—', '#10b981', '');
  html += kC('📊','Net', fmtV(gNet), clr(gNet), gNet > 0 ? 'saldo positivo' : gNet < 0 ? 'saldo negativo' : 'zerado');
  html += kC('💰','Movimentado', gPago > 0.01 ? fmtV(gPago) : '—', '#60a5fa', gParc+' parciais');
  html += kC('✅','Quitados', gQuit+'/'+gEnt, '#10b981', (gEnt>0?((gQuit/gEnt*100).toFixed(0)+'%'):''));
  html += '</div>';

  // Club cards (one card per club)
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;margin-bottom:16px;">';

  clubData.forEach(d => {
    const m = meta[d.clube] || {};
    const logo = clubLogos[d.clube];
    const net = d.aReceber - d.aPagar;
    const pctQuit = d.comMov > 0 ? (d.quitados/d.comMov*100).toFixed(0) : 0;
    const barW = d.comMov > 0 ? (d.quitados/d.comMov*100) : 0;

    html += '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;cursor:pointer;transition:border-color .15s;" onmouseenter="this.style.borderColor=\'rgba(240,180,41,.4)\'" onmouseleave="this.style.borderColor=\'var(--b1)\'" onclick="goClube(\''+d.clube+'\')">';

    // Club header
    html += '<div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--b1);background:var(--s2);">';
    if(logo) html += '<div style="width:32px;height:32px;border-radius:7px;overflow:hidden;flex-shrink:0;"><img src="'+logo+'" style="width:100%;height:100%;object-fit:cover;"></div>';
    else html += '<div style="width:32px;height:32px;border-radius:7px;background:var(--s3);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">'+(m.icon||'♠')+'</div>';
    html += '<div style="flex:1;min-width:0;">';
    html += '<div style="font-weight:700;font-size:.82rem;color:var(--t1);">'+d.clube+'</div>';
    html += '<div style="font-size:.6rem;color:var(--t3);">'+d.totalEnt+' entidades · '+d.comMov+' com movimento</div>';
    html += '</div>';
    html += '<span style="display:inline-block;background:'+d.stBg+';border:1px solid '+d.stBorder+';color:'+d.stColor+';padding:3px 8px;border-radius:5px;font-size:.55rem;font-weight:700;">'+d.status+'</span>';
    html += '</div>';

    // Financial summary
    html += '<div style="padding:12px 16px;">';

    // Row: A Pagar | A Receber | Net
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">';
    html += '<div><div style="font-size:.48rem;text-transform:uppercase;color:var(--t3);font-weight:600;letter-spacing:.4px;">A Pagar</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:700;color:#ef4444;">'+(d.aPagar>0.01?fmtV(d.aPagar):'—')+'</div></div>';
    html += '<div><div style="font-size:.48rem;text-transform:uppercase;color:var(--t3);font-weight:600;letter-spacing:.4px;">A Receber</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:700;color:#10b981;">'+(d.aReceber>0.01?fmtV(d.aReceber):'—')+'</div></div>';
    html += '<div><div style="font-size:.48rem;text-transform:uppercase;color:var(--t3);font-weight:600;letter-spacing:.4px;">Pago</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:700;color:#60a5fa;">'+(d.pago>0.01?fmtV(d.pago):'—')+'</div></div>';
    html += '</div>';

    // Progress bar
    html += '<div style="margin-top:4px;">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:.52rem;color:var(--t3);">Progresso</span><span style="font-size:.52rem;color:var(--t2);font-weight:600;">'+d.quitados+'/'+d.comMov+' quitados ('+pctQuit+'%)</span></div>';
    html += '<div style="background:var(--s3);border-radius:4px;height:6px;overflow:hidden;">';
    html += '<div style="background:linear-gradient(90deg,#10b981,#34d399);height:100%;width:'+barW+'%;border-radius:4px;transition:width .3s;"></div>';
    html += '</div>';
    html += '</div>';

    html += '</div>'; // padding
    html += '</div>'; // card
  });

  html += '</div>'; // grid

  // Summary table
  html += '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;">';
  html += '<table style="width:100%;border-collapse:collapse;">';
  const ths = 'padding:10px 12px;font-size:.52rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);background:var(--s2);white-space:nowrap;';
  html += '<thead><tr>';
  html += '<th style="'+ths+'text-align:left;">Clube</th>';
  html += '<th style="'+ths+'text-align:center;">Entidades</th>';
  html += '<th style="'+ths+'text-align:right;">A Pagar</th>';
  html += '<th style="'+ths+'text-align:right;">A Receber</th>';
  html += '<th style="'+ths+'text-align:right;">Pago</th>';
  html += '<th style="'+ths+'text-align:center;">Quitados</th>';
  html += '<th style="'+ths+'text-align:center;">Status</th>';
  html += '<th style="'+ths+'text-align:center;">Ação</th>';
  html += '</tr></thead><tbody>';

  clubData.forEach(d => {
    const rs = 'padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.75rem;border-bottom:1px solid var(--b1);';
    html += '<tr style="cursor:pointer;border-bottom:1px solid var(--b1);" onclick="goClube(\''+d.clube+'\')">';
    html += '<td style="padding:10px 12px;font-weight:600;font-size:.8rem;color:var(--t1);border-bottom:1px solid var(--b1);">'+d.clube+'</td>';
    html += '<td style="'+rs+'text-align:center;color:var(--t2);">'+d.totalEnt+'</td>';
    html += '<td style="'+rs+'text-align:right;color:#ef4444;">'+(d.aPagar>0.01?fmtV(d.aPagar):'—')+'</td>';
    html += '<td style="'+rs+'text-align:right;color:#10b981;">'+(d.aReceber>0.01?fmtV(d.aReceber):'—')+'</td>';
    html += '<td style="'+rs+'text-align:right;color:#60a5fa;">'+(d.pago>0.01?fmtV(d.pago):'—')+'</td>';
    html += '<td style="'+rs+'text-align:center;color:var(--t2);">'+d.quitados+'/'+d.comMov+'</td>';
    html += '<td style="padding:10px 8px;text-align:center;border-bottom:1px solid var(--b1);"><span style="display:inline-block;background:'+d.stBg+';border:1px solid '+d.stBorder+';color:'+d.stColor+';padding:2px 7px;border-radius:5px;font-size:.52rem;font-weight:700;">'+d.status+'</span></td>';
    html += '<td style="padding:10px 8px;text-align:center;border-bottom:1px solid var(--b1);"><button onclick="event.stopPropagation();goClube(\''+d.clube+'\')" style="background:var(--gold-d);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:4px 10px;border-radius:5px;font-size:.56rem;font-weight:700;cursor:pointer;">Abrir →</button></td>';
    html += '</tr>';
  });

  // Total
  const trs = 'padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.75rem;font-weight:800;';
  html += '<tr style="background:var(--s2);">';
  html += '<td style="padding:10px 12px;font-weight:800;font-size:.8rem;color:var(--t1);">TOTAL</td>';
  html += '<td style="'+trs+'text-align:center;color:var(--t2);">'+gEnt+'</td>';
  html += '<td style="'+trs+'text-align:right;color:#ef4444;">'+(gPagar>0.01?fmtV(gPagar):'—')+'</td>';
  html += '<td style="'+trs+'text-align:right;color:#10b981;">'+(gReceber>0.01?fmtV(gReceber):'—')+'</td>';
  html += '<td style="'+trs+'text-align:right;color:#60a5fa;">'+(gPago>0.01?fmtV(gPago):'—')+'</td>';
  html += '<td style="'+trs+'text-align:center;color:var(--t2);">'+gQuit+'/'+gEnt+'</td>';
  html += '<td colspan="2" style="padding:10px 12px;text-align:center;font-size:.52rem;color:var(--t3);">'+CLUBS.length+' clubes</td>';
  html += '</tr>';

  html += '</tbody></table></div>';

  el.innerHTML = html;

  // Update sidebar badge
  const badge = document.getElementById('sb-fech-status');
  if(badge){
    if(gPend > 0){ badge.textContent = gPend; badge.style.background = 'rgba(239,68,68,.15)'; badge.style.color = '#ef4444'; }
    else if(gParc > 0){ badge.textContent = gParc; badge.style.background = 'rgba(251,191,36,.12)'; badge.style.color = '#f59e0b'; }
    else { badge.textContent = '✓'; badge.style.background = 'rgba(16,185,129,.1)'; badge.style.color = '#10b981'; }
  }
}

// ══════════════════ CAIXA GERAL (GLOBAL) ══════════════════

function renderCaixaGlobal(){
  const el = document.getElementById('caixa-global-content');
  if(!el) return;
  if(!allPlayers.length){
    el.innerHTML='<div class="cs"><div class="ci">🏦</div><h3>Caixa Geral</h3><p>Importe a planilha primeiro.</p></div>';
    return;
  }

  const allData = getFinData();
  let totalEntradas = 0, totalSaidas = 0;
  const perClub = {};

  // Aggregate ledger across all clubs and weeks
  CLUBS.forEach(c => {
    perClub[c] = { entradas: 0, saidas: 0 };
    // For each week with data
    Object.keys(allData).forEach(key => {
      if(!key.startsWith(c+'||')) return;
      const weekData = allData[key];
      Object.values(weekData).forEach(entity => {
        (entity.historico||[]).forEach(h => {
          const val = Math.abs(h.valor||0);
          if(h.dir === 'in'){ perClub[c].entradas += val; totalEntradas += val; }
          else { perClub[c].saidas += val; totalSaidas += val; }
        });
      });
    });
  });

  const net = totalEntradas - totalSaidas;

  let html = '<div style="margin-bottom:16px;">';
  html += '<div style="font-size:1rem;font-weight:700;color:var(--t1);margin-bottom:4px;">🏦 Caixa Geral</div>';
  html += '<div style="font-size:.75rem;color:var(--t3);">Posição de caixa consolidada da operação</div>';
  html += '</div>';

  // KPI cards
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">';
  html += '<div class="km" style="border-top:2px solid #10b981;"><div class="km-lbl">📥 Total Entradas</div><div class="km-val" style="font-family:\'JetBrains Mono\',monospace;color:#10b981;">'+fmtV(totalEntradas)+'</div></div>';
  html += '<div class="km" style="border-top:2px solid #ef4444;"><div class="km-lbl">📤 Total Saídas</div><div class="km-val" style="font-family:\'JetBrains Mono\',monospace;color:#ef4444;">'+fmtV(totalSaidas)+'</div></div>';
  html += '<div class="km" style="border-top:2px solid '+clr(net)+';"><div class="km-lbl">💰 Saldo Net</div><div class="km-val" style="font-family:\'JetBrains Mono\',monospace;color:'+clr(net)+';">'+fmtV(net)+'</div></div>';
  html += '</div>';

  // Per-club breakdown
  html += '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;overflow:hidden;">';
  html += '<table style="width:100%;border-collapse:collapse;">';
  html += '<thead><tr>';
  const ths = 'padding:10px 12px;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--t3);background:var(--s2);';
  html += '<th style="'+ths+'text-align:left;">Clube</th>';
  html += '<th style="'+ths+'text-align:right;">Entradas</th>';
  html += '<th style="'+ths+'text-align:right;">Saídas</th>';
  html += '<th style="'+ths+'text-align:right;">Net</th>';
  html += '</tr></thead><tbody>';

  CLUBS.forEach(c => {
    const d = perClub[c];
    const n = d.entradas - d.saidas;
    const rs = 'padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.78rem;border-bottom:1px solid var(--b1);';
    html += '<tr>';
    html += '<td style="padding:10px 12px;font-weight:600;font-size:.8rem;color:var(--t1);border-bottom:1px solid var(--b1);">'+c+'</td>';
    html += '<td style="'+rs+'text-align:right;color:#10b981;">'+fmtV(d.entradas)+'</td>';
    html += '<td style="'+rs+'text-align:right;color:#ef4444;">'+fmtV(d.saidas)+'</td>';
    html += '<td style="'+rs+'text-align:right;font-weight:700;color:'+clr(n)+';">'+fmtV(n)+'</td>';
    html += '</tr>';
  });

  // Total
  html += '<tr style="background:var(--s2);">';
  html += '<td style="padding:10px 12px;font-weight:800;font-size:.8rem;color:var(--t1);">TOTAL</td>';
  html += '<td style="padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:800;text-align:right;color:#10b981;">'+fmtV(totalEntradas)+'</td>';
  html += '<td style="padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:800;text-align:right;color:#ef4444;">'+fmtV(totalSaidas)+'</td>';
  html += '<td style="padding:10px 12px;font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:800;text-align:right;color:'+clr(net)+';">'+fmtV(net)+'</td>';
  html += '</tr>';
  html += '</tbody></table></div>';

  el.innerHTML = html;
}

// ════════════════════════════════════════════════════════════
// ═══  LIGA CONSOLIDADO (GLOBAL — ALL CLUBS)  ═════════════
// ════════════════════════════════════════════════════════════

function calcLigaGlobal(){
  if(!CLUBS.length || !allPlayers.length) return null;

  let totPL=0, totRake=0, totGGR=0, totResultado=0;
  let totTaxaApp=0, totTaxaLiga=0, totRodeoGGR=0, totRodeoApp=0, totTaxas=0;
  const clubRows = [];

  CLUBS.forEach(c=>{
    const cp = allPlayers.filter(p=>p.clube===c);
    if(!cp.length) return;
    const pl   = sumF(cp,'ganhos');
    const rake = sumF(cp,'rake');
    const ggr  = sumF(cp,'ggr');
    const resultado = pl + rake + ggr;

    // Taxas — App/Liga sobre rake, Rodeo só se GGR do clube > 0
    const tApp  = rake * getLigaRate('taxaApp');
    const tLiga = rake * getLigaRate('taxaLiga');
    const tRGGR = ggr > 0 ? ggr * getLigaRate('taxaRodeoGGR') : 0;
    const tRApp = ggr > 0 ? ggr * getLigaRate('taxaRodeoApp') : 0;
    const taxas = tApp + tLiga + tRGGR + tRApp;

    // Per-club manual adjustments (from Lançamentos)
    const e = getLigaClubEntry(c);
    const overlayClub = getOverlayPerClub(c);
    const ajustes = (e.compras||0) + (e.security||0) + (e.outros||0) + overlayClub;
    const acerto = resultado - taxas + ajustes;

    totPL += pl; totRake += rake; totGGR += ggr; totResultado += resultado;
    totTaxaApp += tApp; totTaxaLiga += tLiga; totRodeoGGR += tRGGR; totRodeoApp += tRApp;
    totTaxas += taxas;

    clubRows.push({ clube:c, pl, rake, ggr, resultado, taxas, ajustes, acerto, cp:cp.length,
      tApp, tLiga, tRGGR, tRApp, overlayClub, compras:e.compras||0, security:e.security||0, outros:e.outros||0 });
  });

  // Totals come entirely from per-club rows (Lançamentos is the single source of truth)
  const totalAjustes = clubRows.reduce((s,r)=>s+r.ajustes,0);
  const totalLiga = totResultado - totTaxas + totalAjustes;
  const direcao = totalLiga >= 0 ? 'Liga deve pagar ao Império' : 'Império deve pagar à Liga';

  return {
    totPL, totRake, totGGR, totResultado,
    totTaxaApp, totTaxaLiga, totRodeoGGR, totRodeoApp, totTaxas,
    totalAjustes, totalLiga, direcao, clubRows
  };
}

function renderLigaGlobal(){
  const el = document.getElementById('liga-global-content');
  if(!el) return;
  if(!CLUBS.length || !allPlayers.length){
    el.innerHTML='<div class="cs"><div class="ci">🏆</div><h3>Liga — Consolidado</h3><p>Importe a planilha primeiro.</p></div>';
    return;
  }
  const n = calcLigaGlobal();
  if(!n){ el.innerHTML='<div class="cs"><div class="ci">⚠️</div><h3>Sem dados</h3></div>'; return; }

  const wkLock = isWeekLocked();

  const taxRow = (label, sub, val) =>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 14px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.1);border-radius:7px;margin-bottom:4px;">'
    + '<div style="font-size:.72rem;color:var(--t2);">'+label+(sub?' <span style="font-size:.58rem;color:var(--t3);">'+sub+'</span>':'')+'</div>'
    + '<div style="font-family:\'JetBrains Mono\',monospace;font-size:.78rem;font-weight:600;color:#ef4444;">'+fmtV(-val)+'</div></div>';

  // Club table rows
  const tblRows = n.clubRows.map(r=>{
    const m = CMETA[r.clube]||{};
    return `<tr style="border-bottom:1px solid var(--b1);">
      <td style="padding:10px 12px;font-weight:600;font-size:.78rem;white-space:nowrap;"><span style="margin-right:4px;">${m.icon||'♠'}</span>${r.clube}</td>
      <td style="text-align:center;color:var(--t3);font-size:.72rem;padding:10px 6px;">${r.cp}</td>
      <td style="text-align:right;color:${clr(r.pl)};font-family:'JetBrains Mono',monospace;font-size:.76rem;padding:10px 12px;">${fmtV(r.pl)}</td>
      <td style="text-align:right;color:#10b981;font-family:'JetBrains Mono',monospace;font-size:.76rem;padding:10px 12px;">${fmtV(r.rake)}</td>
      <td style="text-align:right;color:${clr(r.ggr)};font-family:'JetBrains Mono',monospace;font-size:.76rem;padding:10px 12px;">${fmtV(r.ggr)}</td>
      <td style="text-align:right;color:${clr(r.resultado)};font-family:'JetBrains Mono',monospace;font-size:.76rem;font-weight:700;padding:10px 12px;">${fmtV(r.resultado)}</td>
      <td style="text-align:right;color:#ef4444;font-family:'JetBrains Mono',monospace;font-size:.76rem;padding:10px 12px;">${fmtV(-r.taxas)}</td>
      <td style="text-align:right;color:${clr(r.ajustes)};font-family:'JetBrains Mono',monospace;font-size:.76rem;padding:10px 12px;">${fmtV(r.ajustes)}</td>
      <td style="text-align:right;color:${clr(r.acerto)};font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:800;padding:10px 12px;">${fmtV(r.acerto)}</td>
    </tr>`;
  }).join('');

  const sumAcerto = n.clubRows.reduce((s,r)=>s+r.acerto,0);

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div>
        <div style="font-size:1rem;font-weight:800;color:var(--t1);">🏆 Liga — Consolidado</div>
        <div style="font-size:.72rem;color:var(--t3);margin-top:2px;">Acerto global da liga · Todos os clubes · Sem rakeback</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="font-size:.68rem;color:var(--t3);background:var(--s2);border:1px solid var(--b1);padding:5px 12px;border-radius:6px;">
          📅 ${weeks[selWeekIdx] ? fWL(weeks[selWeekIdx]) : '—'} ${wkLock ? '🔒' : ''}
        </div>
        <button class="btn-sm" onclick="exportLigaGlobalCSV()" style="font-size:.68rem;">⬇ CSV</button>
      </div>
    </div>

    <!-- KPI Strip -->
    <div class="kpi-row" style="margin-bottom:18px;grid-template-columns:repeat(5,1fr);">
      <div class="km" style="border-top:2px solid var(--blue);">
        <div class="km-lbl">Profit/Loss<div style="font-size:.55rem;color:var(--t3);font-weight:400;">todos os clubes</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.totPL)};">${fV(n.totPL,false)}</div>
      </div>
      <div class="km gr"><div class="km-lbl">Rake Total</div><div class="km-val gr">${fV(n.totRake,false)}</div></div>
      <div class="km" style="border-top:2px solid #a78bfa;">
        <div class="km-lbl">GGR Rodeo</div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:${clr(n.totGGR)};">${fV(n.totGGR,false)}</div>
      </div>
      <div class="km" style="border-top:2px solid var(--gold);">
        <div class="km-lbl">Resultado Clubes<div style="font-size:.55rem;color:var(--t3);font-weight:400;">Σ (P/L + Rake + GGR)</div></div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:${clr(n.totResultado)};">${fV(n.totResultado,false)}</div>
      </div>
      <div class="km" style="border-top:2px solid #ef4444;">
        <div class="km-lbl">Total Taxas</div>
        <div class="km-val" style="font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:#ef4444;">${fmtV(-n.totTaxas)}</div>
      </div>
    </div>

    <!-- Two columns: Taxas + Lançamentos Manuais -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px;">
      <!-- LEFT: Taxas automáticas -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📊 Taxas Automáticas</div>
        ${taxRow('Taxa Aplicativo', ligaConfig.taxaApp+'% do Rake', n.totTaxaApp)}
        ${taxRow('Taxa Liga', ligaConfig.taxaLiga+'% do Rake', n.totTaxaLiga)}
        ${taxRow('Taxa Rodeo GGR', ligaConfig.taxaRodeoGGR+'% do GGR (por clube se GGR>0)', n.totRodeoGGR)}
        ${taxRow('Taxa Rodeo App', ligaConfig.taxaRodeoApp+'% do GGR (por clube se GGR>0)', n.totRodeoApp)}
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;margin-top:6px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;">
          <div style="font-size:.72rem;font-weight:700;color:#ef4444;">Total Taxas</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:#ef4444;">${fmtV(-n.totTaxas)}</div>
        </div>
      </div>

      <!-- RIGHT: Resumo dos Lançamentos (read-only, vem da pág. Lançamentos) -->
      <div>
        <div style="font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin-bottom:10px;">📝 Lançamentos <span style="font-weight:400;">(editáveis em Lançamentos)</span></div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:#60a5fa;">Overlay Global<div style="font-size:.55rem;color:var(--t3);font-weight:400;">${fmtV(overlayGlobal)} ÷ ${getOverlayClubesList().length} clubes</div></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.clubRows.reduce((s,r)=>s+r.overlayClub,0))};">${fmtV(n.clubRows.reduce((s,r)=>s+r.overlayClub,0))}</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:var(--t1);">Compras <span style="font-size:.55rem;color:var(--t3);font-weight:400;">Σ clubes</span></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.clubRows.reduce((s,r)=>s+r.compras,0))};">${fmtV(n.clubRows.reduce((s,r)=>s+r.compras,0))}</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:var(--t1);">Security <span style="font-size:.55rem;color:var(--t3);font-weight:400;">Σ clubes</span></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.clubRows.reduce((s,r)=>s+r.security,0))};">${fmtV(n.clubRows.reduce((s,r)=>s+r.security,0))}</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;margin-bottom:5px;">
          <div style="font-size:.76rem;font-weight:600;color:var(--t1);">Outros <span style="font-size:.55rem;color:var(--t3);font-weight:400;">Σ clubes</span></div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.clubRows.reduce((s,r)=>s+r.outros,0))};">${fmtV(n.clubRows.reduce((s,r)=>s+r.outros,0))}</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:9px 14px;margin-top:6px;background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.15);border-radius:8px;">
          <div style="font-size:.72rem;font-weight:700;color:var(--gold);">Total Ajustes</div>
          <div style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${clr(n.totalAjustes)};">${fmtV(n.totalAjustes)}</div>
        </div>
      </div>
    </div>

    <!-- ACERTO TOTAL LIGA (GLOBAL) -->
    <div id="lg-result-box"></div>

    <!-- TABELA POR CLUBE -->
    <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--t3);margin:20px 0 10px;">📋 Detalhamento por Clube</div>
    <div style="overflow-x:auto;border:1px solid var(--b1);border-radius:10px;">
      <table style="width:100%;border-collapse:collapse;font-size:.76rem;">
        <thead>
          <tr style="background:var(--s2);border-bottom:2px solid var(--b1);">
            <th style="padding:10px 12px;text-align:left;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Clube</th>
            <th style="padding:10px 6px;text-align:center;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Jog.</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">P/L</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Rake</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">GGR</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Resultado</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Taxas</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Ajustes</th>
            <th style="padding:10px 12px;text-align:right;font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);font-weight:700;">Acerto Liga</th>
          </tr>
        </thead>
        <tbody>
          ${tblRows}
          <tr style="background:var(--s2);border-top:2px solid var(--gold);font-weight:800;">
            <td style="padding:10px 12px;color:var(--gold);">TOTAL</td>
            <td style="text-align:center;padding:10px 6px;color:var(--t2);">${allPlayers.length}</td>
            <td style="text-align:right;padding:10px 12px;color:${clr(n.totPL)};font-family:'JetBrains Mono',monospace;">${fmtV(n.totPL)}</td>
            <td style="text-align:right;padding:10px 12px;color:#10b981;font-family:'JetBrains Mono',monospace;">${fmtV(n.totRake)}</td>
            <td style="text-align:right;padding:10px 12px;color:${clr(n.totGGR)};font-family:'JetBrains Mono',monospace;">${fmtV(n.totGGR)}</td>
            <td style="text-align:right;padding:10px 12px;color:${clr(n.totResultado)};font-family:'JetBrains Mono',monospace;">${fmtV(n.totResultado)}</td>
            <td style="text-align:right;padding:10px 12px;color:#ef4444;font-family:'JetBrains Mono',monospace;">${fmtV(-n.totTaxas)}</td>
            <td style="text-align:right;padding:10px 12px;color:${clr(n.totalAjustes)};font-family:'JetBrains Mono',monospace;">${fmtV(n.totalAjustes)}</td>
            <td style="text-align:right;padding:10px 12px;color:${clr(sumAcerto)};font-family:'JetBrains Mono',monospace;font-size:.85rem;">${fmtV(sumAcerto)}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Detalhamento de taxas por clube (collapsible) -->
    <details style="margin-top:12px;">
      <summary style="font-size:.7rem;font-weight:600;color:var(--t3);cursor:pointer;padding:6px 0;">📊 Detalhamento de taxas por clube</summary>
      <div style="margin-top:8px;overflow-x:auto;border:1px solid var(--b1);border-radius:8px;">
        <table style="width:100%;border-collapse:collapse;font-size:.72rem;">
          <thead>
            <tr style="background:var(--s2);border-bottom:1px solid var(--b1);">
              <th style="padding:8px 12px;text-align:left;font-size:.6rem;text-transform:uppercase;color:var(--t3);">Clube</th>
              <th style="padding:8px 10px;text-align:right;font-size:.6rem;text-transform:uppercase;color:var(--t3);">App 8%</th>
              <th style="padding:8px 10px;text-align:right;font-size:.6rem;text-transform:uppercase;color:var(--t3);">Liga 10%</th>
              <th style="padding:8px 10px;text-align:right;font-size:.6rem;text-transform:uppercase;color:var(--t3);">Rodeo GGR 12%</th>
              <th style="padding:8px 10px;text-align:right;font-size:.6rem;text-transform:uppercase;color:var(--t3);">Rodeo App 18%</th>
              <th style="padding:8px 10px;text-align:right;font-size:.6rem;text-transform:uppercase;color:var(--t3);font-weight:700;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${n.clubRows.map(r=>{
              const m=CMETA[r.clube]||{};
              return '<tr style="border-bottom:1px solid var(--b1);">'
                +'<td style="padding:6px 12px;font-weight:600;">'+(m.icon||'')+' '+r.clube+'</td>'
                +'<td style="text-align:right;padding:6px 10px;color:#ef4444;font-family:\'JetBrains Mono\',monospace;">'+fmtV(-r.tApp)+'</td>'
                +'<td style="text-align:right;padding:6px 10px;color:#ef4444;font-family:\'JetBrains Mono\',monospace;">'+fmtV(-r.tLiga)+'</td>'
                +'<td style="text-align:right;padding:6px 10px;color:'+(r.tRGGR>0?'#ef4444':'var(--t3)')+';font-family:\'JetBrains Mono\',monospace;">'+(r.tRGGR>0?fmtV(-r.tRGGR):'—')+'</td>'
                +'<td style="text-align:right;padding:6px 10px;color:'+(r.tRApp>0?'#ef4444':'var(--t3)')+';font-family:\'JetBrains Mono\',monospace;">'+(r.tRApp>0?fmtV(-r.tRApp):'—')+'</td>'
                +'<td style="text-align:right;padding:6px 10px;color:#ef4444;font-family:\'JetBrains Mono\',monospace;font-weight:700;">'+fmtV(-r.taxas)+'</td>'
                +'</tr>';
            }).join('')}
          </tbody>
        </table>
      </div>
    </details>
  `;

  _renderLGResult();
}

function _renderLGResult(){
  const box = document.getElementById('lg-result-box');
  if(!box) return;
  const n = calcLigaGlobal();
  if(!n) return;
  const dirColor = clr(n.totalLiga);
  const dirIcon = n.totalLiga >= 0 ? '🟢' : '🔴';

  box.innerHTML = `
    <div class="rs-final-box">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:rgba(240,180,41,.7);margin-bottom:6px;">ACERTO TOTAL LIGA (GLOBAL)</div>
          <div style="font-size:.74rem;color:rgba(240,180,41,.55);font-family:'JetBrains Mono',monospace;">Σ Resultados − Σ Taxas + Lançamentos</div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:1.85rem;font-weight:800;letter-spacing:-1px;color:${dirColor};">${fmtV(n.totalLiga)}</div>
          <div style="font-size:.72rem;color:${dirColor};margin-top:2px;">${dirIcon} ${n.direcao}</div>
        </div>
      </div>
    </div>
  `;
}

function exportLigaGlobalCSV(){
  const n = calcLigaGlobal();
  if(!n){ showToast('Sem dados para exportar','e'); return; }
  const fN = v => (v||0).toFixed(2).replace('.',',');
  const week = weeks[selWeekIdx] ? fWL(weeks[selWeekIdx]) : 'sem-semana';
  let csv = 'Clube;Jogadores;P/L;Rake;GGR;Resultado;Taxa App;Taxa Liga;Rodeo GGR;Rodeo App;Total Taxas;Ajustes;Acerto Liga\n';
  n.clubRows.forEach(r=>{
    csv += [r.clube, r.cp, fN(r.pl), fN(r.rake), fN(r.ggr), fN(r.resultado),
      fN(-r.tApp), fN(-r.tLiga), fN(-r.tRGGR), fN(-r.tRApp), fN(-r.taxas),
      fN(r.ajustes), fN(r.acerto)].join(';') + '\n';
  });
  const sumAc = n.clubRows.reduce((s,r)=>s+r.acerto,0);
  csv += ['TOTAL', allPlayers.length, fN(n.totPL), fN(n.totRake), fN(n.totGGR), fN(n.totResultado),
    fN(-n.totTaxaApp), fN(-n.totTaxaLiga), fN(-n.totRodeoGGR), fN(-n.totRodeoApp), fN(-n.totTaxas),
    fN(n.totalAjustes), fN(sumAc)].join(';') + '\n';
  csv += '\n';
  const totOverlay = n.clubRows.reduce((s,r)=>s+r.overlayClub,0);
  const totCompras = n.clubRows.reduce((s,r)=>s+r.compras,0);
  const totSecurity = n.clubRows.reduce((s,r)=>s+r.security,0);
  const totOutros = n.clubRows.reduce((s,r)=>s+r.outros,0);
  csv += 'Lançamentos;Overlay;'+fN(totOverlay)+';Compras;'+fN(totCompras)+';Security;'+fN(totSecurity)+';Outros;'+fN(totOutros)+'\n';
  csv += 'ACERTO TOTAL LIGA (GLOBAL);'+fN(n.totalLiga)+';'+n.direcao+'\n';

  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'liga-consolidado-'+week.replace(/[^a-zA-Z0-9]/g,'-')+'.csv';
  a.click();
  showToast('📥 CSV exportado');
}

// ════════════════════════════════════════════════════════════
// ══════════════════ FINANCEIRO ══════════════════

function getFinData(){ return DataLayer.getFinData(); }
function saveFinData(d){ DataLayer.saveFinData(d); }
function getPayMethods(){ return DataLayer.getPayMethods(); }
function savePayMethods(arr){ DataLayer.savePayMethods(arr); }

function finKey(){ return activeClube + '||' + (weeks[selWeekIdx]||'0'); }

// ── Helpers matemáticos (rbValor e resPlayer ficam no HTML) ──
function rbValor(rakeGerado, pct){ return n(rakeGerado) * (n(pct)/100); }
function resPlayer(ganhos, rakeGerado, pctPlayer, ajustes){
  // GGR (ajustes/rodeio) é receita do CLUBE, não entra no acerto com agentes
  return n(ganhos) + rbValor(rakeGerado, pctPlayer);
}

function calcFinEntities(){
  if(!activeClube) return [];
  const cp   = allPlayers.filter(p=>p.clube===activeClube);
  const week = weeks[selWeekIdx]||'0';
  const entities = [];

  // AGENTES
  const agentMap = {};
  cp.forEach(p=>{
    const raw = (p.aname||'').trim();
    const k = (!raw || /^(none|null|undefined)$/i.test(raw)) ? '(sem agente)' : raw;
    if(!agentMap[k]) agentMap[k]=[];
    agentMap[k].push(p);
  });

  Object.entries(agentMap).forEach(([agKey, allPlInAgent])=>{
    // Se agência inteira é "direto", pula do agrupamento por agente
    if(agentDirect[agKey]) return;
    // Filtra jogadores com flag individual de "direto"
    const players = allPlInAgent.filter(p => !playerDirect[p.id]);
    if(!players.length) return;

    const ganhosTime  = players.reduce((s,p)=>s+n(p.ganhos),0);
    const ajustesTime = players.reduce((s,p)=>s+n(p.ggr),0);
    const rakeTime    = players.reduce((s,p)=>s+n(p.rake),0);

    const cfg        = agentRB[agKey] || {};
    const pctAgente  = getAgentPctAgente(agKey); // snapshot-aware
    const avista     = !!cfg.avista;

    const rbAgente   = calcAgentRB(agKey, players);

    // Resultado do time: cada player com seu % efetivo (override > padrão agente)
    const totalResPlayers = players.reduce((s,p)=>{
      const pct = getPlayerPctRB(p);
      return s + resPlayer(p.ganhos, p.rake, pct, p.ggr);
    }, 0);

    // % efetivo informativo (média ponderada)
    const rbPlTotal = players.reduce((s,p)=>s+(Number(p.rake)||0)*getPlayerPctRB(p)/100, 0);
    const pctPlayer = rakeTime > 0 ? (rbPlTotal / rakeTime * 100) : 0;

    const resultadoFinal = ganhosTime + rbAgente;
    const valor = -resultadoFinal;

    entities.push({
      id: makeEntityId('ag', agKey),
      tipo: 'agente', nome: agKey,
      ganhos: ganhosTime, ggr: ajustesTime, rakeGerado: rakeTime,
      pctAgente, pctPlayer, rbAgente,
      resultadoFinal, valor,
      semana: week, clube: activeClube,
      // compatibilidade legada
      rake: rakeTime, pct: pctAgente, rbVal: rbAgente, avista
    });
  });

  // JOGADORES DIRETOS (flag individual + agências marcadas como "direto")
  cp.filter(p => isPlayerDirectSettlement(p.id, (p.aname||'').trim())).forEach(p=>{
    const pctP   = getPlayerPctRB(p);
    const rbP    = rbValor(p.rake, pctP);
    const res    = resPlayer(p.ganhos, p.rake, pctP, p.ggr);
    entities.push({
      id: makeEntityId('pl', p.id||p.nick),
      tipo: 'jogador', nome: p.nick||p.id,
      ganhos: n(p.ganhos), ggr: n(p.ggr), rakeGerado: n(p.rake),
      pctAgente: pctP, pctPlayer: pctP, rbAgente: rbP,
      resultadoFinal: res, valor: -res,
      semana: week, clube: activeClube,
      rake: n(p.rake), pct: pctP, rbVal: rbP, avista: false
    });
  });

  return entities;
}

// ── getSaldoAnterior: delega para DataLayer.getSaldoAnterior ──
// Hierarquia: pm_saldo_prev → pm_finSnapshot → pm_fin.saldoAberto (legado)
function getSaldoAnterior(entityId){
  return DataLayer.getSaldoAnterior(
    entityId,
    activeClube,
    weeks[selWeekIdx],
    selWeekIdx,
    weeks
  );
}

// ── Carry automático: Fechar Semana Financeiro ──────────────────
// getPrevMap/savePrevMap removidos — acesso ao pm_saldo_prev
// agora centralizado em DataLayer.getSaldoAnterior / DataLayer.setCarryForEntity

function fecharSemanaFinanceiro(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  const entities = calcFinEntities();
  if(!entities.length){ showToast('⚠️ Importe dados primeiro','e'); return; }

  const currentWeek = weeks[selWeekIdx];
  const nextIdx     = selWeekIdx + 1;
  const nextWeek    = weeks[nextIdx];

  if(!nextWeek){
    showToast('⚠️ Não há semana seguinte para propagar o carry','e');
    return;
  }

  if(!confirm('Fechar semana financeiro?\n\nIsso vai salvar o saldo de cada entidade como carry para a próxima semana ('+fWL(nextWeek)+').\n\nNão altera dados anteriores.')) return;

  let cnt = 0;

  entities.forEach(e => {
    const saldoPrev  = getSaldoAnterior(e.id);
    const ledger     = getEntityLedgerNet(e.id);
    const resultSem  = -(e.valor);
    // FÓRMULA CANÔNICA: saldoAtual = saldoAnterior + resultado − ledgerNet
    const saldoAtual = FinanceEngine.calcSaldoAtual(saldoPrev, resultSem, ledger.net);

    if(Math.abs(saldoAtual) > 0.01){
      DataLayer.setCarryForEntity(e.id, activeClube, nextWeek, saldoAtual);
      cnt++;
    }
  });

  showToast('✅ Semana financeira fechada — '+cnt+' saldo'+(cnt!==1?'s':'')+' propagado'+(cnt!==1?'s':'')+' para '+fWL(nextWeek));
  renderFinanceiro();
}

// ── Helpers centrais de movimentação ──────────────────────────
// dir: "in"  = jogador/agente PAGOU ao clube   (soma +)
//      "out" = clube PAGOU ao jogador/agente   (soma −)

function addMov(entityId, valor, metodo, dir, extra){
  const allData = getFinData();
  const key = finKey();
  if(!allData[key]) allData[key] = {};
  if(!allData[key][entityId]) allData[key][entityId] = { historico:[], saldoAberto:0 };
  allData[key][entityId].historico.push({
    valor, metodo, dir,
    source: extra?.source || 'manual',
    conciliado: extra?.conciliado || false,
    ts: Date.now(),
    ...extra
  });
  saveFinData(allData);
}

function getMovTotal(entityId){
  // Delegado para getEntityLedgerNet (função canônica)
  return getEntityLedgerNet(entityId).net;
}

// ── getEntityLedgerNet: delega para FinanceEngine.calcLedgerNet ──
// Retorna { entradas, saidas, net } para uma entidade na semana ativa
function getEntityLedgerNet(entityId){
  const allData = getFinData();
  const key = finKey();
  const hist = allData[key]?.[entityId]?.historico || [];
  const result = FinanceEngine.calcLedgerNet(hist);
  if (window.DEBUG_FINANCE) console.log('[ledger] ' + entityId + ' entradas=' + result.entradas + ' saidas=' + result.saidas + ' net=' + result.net);
  return result;
}

function getTotalPago(entityId){
  const allData = getFinData();
  const key = finKey();
  const ent  = allData[key]?.[entityId];
  if(!ent || !ent.historico) return 0;
  return FinanceEngine.calcLedgerNet(ent.historico).net;
}

function setSaldoAberto(entityId, saldo){
  const allData = getFinData();
  const key     = finKey();
  if(!allData[key]) allData[key] = {};
  if(!allData[key][entityId]) allData[key][entityId] = { historico: [], saldoAberto: 0 };
  allData[key][entityId].saldoAberto = saldo;
  saveFinData(allData);
}

let _finModalEntity = null;

let _finFilter = 'todos';
let _finSearch = '';
let _finSort = 'devedores'; // devedores | credores | nome | status
let _activeFinTab = 'agencias';
function switchFinTab(tab){ _activeFinTab = tab; renderFinanceiro(); }

function setFinFilter(filter){
  _finFilter = filter;
  renderFinanceiro();
}

// getEntityStatus — delega para FinanceEngine.determineStatus
// Usa FÓRMULA CANÔNICA: saldoAt = saldoAnterior + resultado − ledgerNet
function getEntityStatus(e){
  const saldoPrev  = getSaldoAnterior(e.id);
  const resultSem  = -(e.valor);   // e.valor = -resultado
  const ledger     = getEntityLedgerNet(e.id);
  const saldoAt    = FinanceEngine.calcSaldoAtual(saldoPrev, resultSem, ledger.net);

  // historico para contagem de pagamentos
  const allData = getFinData();
  const hist = allData[finKey()]?.[e.id]?.historico || [];
  const status = FinanceEngine.determineStatus(saldoAt, hist);
  if (window.DEBUG_FINANCE) console.log('[status] ' + e.id + ' saldoPrev=' + saldoPrev + ' resultSem=' + resultSem + ' ledgerNet=' + ledger.net + ' saldoAt=' + saldoAt + ' → ' + status);
  return status;
}


let _finSearchTimer = null;
function setFinSearch(q){
  _finSearch = q.toLowerCase().trim();
  clearTimeout(_finSearchTimer);
  _finSearchTimer = setTimeout(() => {
    const prev = document.activeElement;
    const wasSearch = prev && prev.classList.contains('fin-search');
    const cursorPos = wasSearch ? prev.selectionStart : 0;
    renderFinanceiro();
    if(wasSearch){
      const inp = document.querySelector('.fin-search');
      if(inp){ inp.focus(); inp.setSelectionRange(cursorPos, cursorPos); }
    }
  }, 200);
}

// ════════════════════════════════════════════════════════════
// computeFinanceKPIs()
//   Profit/Loss       = Σ ganhos de todos os jogadores do clube
//   Rakeback Distrib. = Σ (rake_i × pctRB_i / 100) — snapshot-aware
//   Recebido Semana   = Σ mov dir="in"  (entradas no ledger)
//   Pago Semana       = Σ mov dir="out" (saídas no ledger, sempre positivo)
//   Saldo Final       = SaldoAnterior_Líq + (P/L + RB) + (Recebido − Pago)
// ════════════════════════════════════════════════════════════
function computeFinanceKPIs(){
  if(!activeClube) return { profitLoss:0, rakeback:0, recebido:0, pago:0, saldoAnteriorLiq:0, saldoFinal:0, badge:'quitado' };

  const cp = allPlayers.filter(p => p.clube === activeClube);

  // 1) Profit / Loss = soma dos ganhos brutos (perspectiva do clube)
  const profitLoss = cp.reduce((s,p) => s + (Number(p.ganhos)||0), 0);

  // 2) Rakeback Distribuído = soma de RB Agente por agente
  const agMap = {};
  cp.forEach(p => { const k = (p.aname||'').trim()||'(sem agente)'; if(!agMap[k]) agMap[k]=[]; agMap[k].push(p); });
  const rakeback = Object.entries(agMap).reduce((s,[agKey,pls]) => s + calcAgentRB(agKey, pls), 0);

  // 3 e 4) Recebido / Pago via getEntityLedgerNet (fonte única)
  const entities = calcFinEntities();
  let recebido = 0, pago = 0, saldoAnteriorLiq = 0, ledgerNetTotal = 0;
  entities.forEach(e => {
    const ledger = getEntityLedgerNet(e.id);
    recebido       += ledger.entradas;
    pago           += ledger.saidas;
    ledgerNetTotal += ledger.net;
    saldoAnteriorLiq += getSaldoAnterior(e.id);
  });

  // FÓRMULA CANÔNICA: saldoFinal = saldoAnterior + resultadoSemana − ledgerNet
  const saldoFinal = FinanceEngine.calcSaldoAtual(saldoAnteriorLiq, profitLoss + rakeback, ledgerNetTotal);

  const badge = Math.abs(saldoFinal) < 0.01 ? 'quitado'
    : saldoFinal > 0 ? 'receber' : 'pagar';

  return { profitLoss, rakeback, recebido, pago, saldoAnteriorLiq, saldoFinal, badge };
}

// ── Staged panel for Financeiro (Pendentes de Aplicação) ──────
function _renderStagedPanel(){
  const staged = getWeekStaged();
  const pending = staged.filter(s=>s.status==='staged');
  if(!pending.length) return '';

  const entities = calcFinEntities();
  const wkLock = isWeekLocked();
  const totalIn  = pending.filter(s=>s.dir==='in').reduce((s,x)=>s+x.amount,0);
  const totalOut = pending.filter(s=>s.dir==='out').reduce((s,x)=>s+x.amount,0);

  let rows = pending.map(s=>{
    const e = entities.find(x=>x.id===s.entityId);
    const nome = e ? e.nome : s.entityId;
    const ico = s.dir==='in' ? '↓' : '↑';
    const dirCls = s.dir==='in' ? 'color:#10b981;' : 'color:#60a5fa;';
    const dirTxt = s.dir==='in' ? 'Entrada' : 'Saída';
    const metIco = s.method==='chippix' ? '🎰' : s.method==='ofx' ? '🏦' : '📝';
    const sid = s.id.replace(/'/g,"\\'");
    const dt = new Date(s.createdAt);
    const datStr = dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}) + ' ' + dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});

    const btns = wkLock
      ? '<span style="color:var(--t3);font-size:.65rem;">🔒</span>'
      : '<button class="btn-sm" onclick="applyStagedAndRefresh(\''+sid+'\')" style="font-size:.62rem;background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.25);color:#10b981;padding:3px 8px;">✓ Aplicar</button>'
      + '<button class="btn-sm" onclick="openEditStaged(\''+sid+'\')" style="font-size:.62rem;background:rgba(96,165,250,.1);border-color:rgba(96,165,250,.25);color:#60a5fa;padding:3px 8px;">✏️</button>'
      + '<button class="btn-sm" onclick="rejectStagedAndRefresh(\''+sid+'\')" style="font-size:.62rem;background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.25);color:#ef4444;padding:3px 8px;">✕</button>';

    return '<tr>'
      + '<td><div style="font-weight:600;font-size:.76rem;">'+nome+'</div><div style="font-size:.6rem;color:var(--t3);">'+datStr+'</div></td>'
      + '<td style="text-align:center;"><span class="fd-dir '+(s.dir==='out'?'out':'in')+'" style="display:inline-flex;width:22px;height:22px;align-items:center;justify-content:center;border-radius:6px;font-size:.72rem;">'+ico+'</span><div style="font-size:.55rem;'+dirCls+'">'+dirTxt+'</div></td>'
      + '<td style="text-align:right;font-family:\'JetBrains Mono\',monospace;font-weight:700;'+dirCls+'font-size:.8rem;">'+(s.dir==='in'?'+':'-')+'R$ '+fV(s.amount,false)+'</td>'
      + '<td style="text-align:left;font-family:inherit;">'+metIco+' <span style="font-size:.65rem;color:var(--t3);">'+s.method+'</span></td>'
      + '<td style="max-width:180px;font-size:.62rem;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left;font-family:inherit;">'+s.description+'</td>'
      + '<td style="text-align:right;"><div style="display:flex;gap:4px;justify-content:flex-end;">'+btns+'</div></td>'
      + '</tr>';
  }).join('');

  return '<div style="background:rgba(251,191,36,.04);border:1px solid rgba(251,191,36,.15);border-radius:10px;padding:14px 16px;margin-bottom:14px;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
    + '<div style="font-size:.78rem;font-weight:700;color:#fbbf24;">📌 Pendentes de Aplicação <span style="font-weight:400;font-size:.66rem;color:var(--t3);">('+pending.length+')</span></div>'
    + '<div style="display:flex;align-items:center;gap:8px;">'
    + '<span style="font-size:.62rem;color:#10b981;">▲ R$ '+fV(totalIn,false)+'</span>'
    + '<span style="font-size:.62rem;color:#60a5fa;">▼ R$ '+fV(totalOut,false)+'</span>'
    + (wkLock ? '' : '<button class="btn-sm" onclick="applyAllStaged()" style="font-size:.62rem;background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.25);color:#10b981;padding:4px 10px;">✅ Aplicar Todos ('+pending.length+')</button>')
    + '</div></div>'
    + '<table class="tbl" style="margin:0;"><thead><tr>'
    + '<th>Entidade</th><th style="text-align:center;">Dir</th><th style="text-align:right;">Valor</th><th>Método</th><th>Descrição</th><th style="text-align:right;">Ações</th>'
    + '</tr></thead><tbody>'+rows+'</tbody></table>'
    + '</div>';
}

function applyStagedAndRefresh(stagedId){
  if(applyStagedMovement(stagedId)){
    showToast('✅ Lançamento aplicado ao ledger');
    renderFinanceiro();
    renderAgentClosing();
    if(typeof renderConcChipPix==='function') renderConcChipPix();
  }
}

function rejectStagedAndRefresh(stagedId){
  if(!confirm('Rejeitar este lançamento?\nEle não será aplicado ao ledger.')) return;
  rejectStagedMovement(stagedId);
  showToast('🚫 Lançamento rejeitado');
  renderFinanceiro();
  if(typeof renderConcChipPix==='function') renderConcChipPix();
}

function openEditStaged(stagedId){
  const all = getStaged();
  const sm = all.find(s=>s.id===stagedId);
  if(!sm) return;

  const entities = calcFinEntities();
  const entOpts = entities.map(e=>'<option value="'+e.id+'" '+(e.id===sm.entityId?'selected':'')+'>'+e.nome+'</option>').join('');

  const content = '<div style="display:flex;flex-direction:column;gap:12px;">'
    + '<div><label style="font-size:.68rem;color:var(--t3);display:block;margin-bottom:4px;">Entidade</label>'
    + '<select id="stg-edit-ent" class="conc-entity-sel" style="width:100%;font-size:.76rem;">'+entOpts+'</select></div>'
    + '<div style="display:flex;gap:10px;">'
    + '<div style="flex:1;"><label style="font-size:.68rem;color:var(--t3);display:block;margin-bottom:4px;">Direção</label>'
    + '<select id="stg-edit-dir" class="conc-entity-sel" style="width:100%;font-size:.76rem;">'
    + '<option value="in" '+(sm.dir==='in'?'selected':'')+'>↓ Entrada</option>'
    + '<option value="out" '+(sm.dir==='out'?'selected':'')+'>↑ Saída</option></select></div>'
    + '<div style="flex:1;"><label style="font-size:.68rem;color:var(--t3);display:block;margin-bottom:4px;">Valor (R$)</label>'
    + '<input id="stg-edit-val" type="number" step="0.01" value="'+sm.amount.toFixed(2)+'" style="width:100%;background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:8px;font-size:.76rem;"></div></div>'
    + '<div><label style="font-size:.68rem;color:var(--t3);display:block;margin-bottom:4px;">Descrição</label>'
    + '<input id="stg-edit-desc" type="text" value="'+sm.description.replace(/"/g,'&quot;')+'" style="width:100%;background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:7px 10px;border-radius:8px;font-size:.76rem;"></div>'
    + '</div>';

  window._editStagedId = stagedId;
  document.getElementById('mextrato-body').innerHTML = content;
  document.querySelector('#mExtratoPag .modal-title').textContent = '✏️ Editar Lançamento Pendente';
  document.querySelector('#mExtratoPag .ma').innerHTML = '<button class="btn-primary" onclick="saveEditStaged()">💾 Salvar</button> <button class="btn-cancel" onclick="closeM(\'mExtratoPag\')">Cancelar</button>';
  openM('mExtratoPag');
}

function saveEditStaged(){
  const sid = window._editStagedId;
  if(!sid) return;
  editStagedMovement(sid, {
    entityId: document.getElementById('stg-edit-ent').value,
    dir: document.getElementById('stg-edit-dir').value,
    amount: parseFloat(document.getElementById('stg-edit-val').value)||0,
    description: document.getElementById('stg-edit-desc').value
  });
  closeM('mExtratoPag');
  showToast('✏️ Lançamento editado');
  renderFinanceiro();
}

function renderFinanceiro(){
  const el = document.getElementById('fin-content');
  if(!el) return;
  const entities = calcFinEntities();
  if(!entities.length){
    el.innerHTML='<div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3><p>Configure agentes na aba Comprovantes e marque jogadores como Acerto Direto na aba Jogadores.</p></div>';
    return;
  }

  const allData = getFinData();
  const key = finKey();

  // ── Compute all entity data ──
  const rows = entities.map(e => {
    const saldoPrev  = getSaldoAnterior(e.id);
    const ledger     = getEntityLedgerNet(e.id);
    const movTotal   = ledger.net;
    const resultSem  = -(e.valor);
    const saldoAt    = FinanceEngine.calcSaldoAtual(saldoPrev, resultSem, movTotal);
    const status     = getEntityStatus(e);
    const hist       = allData[key]?.[e.id]?.historico || [];
    return { ...e, saldoPrev, movTotal, resultSem, saldoAt, status, hist, entradas: ledger.entradas, saidas: ledger.saidas };
  }).filter(r => r.status !== 'neutro');

  // ── KPIs via computeFinanceKPIs() ──
  const kpi = computeFinanceKPIs();

  // ── Split por tipo ──
  const agentRows  = rows.filter(r => r.tipo === 'agente');
  const playerRows = rows.filter(r => r.tipo !== 'agente');
  const tabRows    = _activeFinTab === 'agencias' ? agentRows : playerRows;

  // ── Filter & sort ──
  let filtered = tabRows;
  if(_finFilter !== 'todos') filtered = filtered.filter(r => r.status === _finFilter);
  if(_finSearch) filtered = filtered.filter(r => r.nome.toLowerCase().includes(_finSearch));

  // Sort: most negative first by default
  filtered.sort((a,b) => {
    if(_finSort === 'devedores') return a.saldoAt - b.saldoAt;
    if(_finSort === 'credores')  return b.saldoAt - a.saldoAt;
    if(_finSort === 'nome')      return a.nome.localeCompare(b.nome);
    const so = {aberto:0, parcial:1, pago:2};
    return (so[a.status]||0) - (so[b.status]||0);
  });

  const countByStatus = { todos: tabRows.length, aberto:0, parcial:0, pago:0 };
  tabRows.forEach(r => { if(countByStatus[r.status] !== undefined) countByStatus[r.status]++; });

  // Badge do saldo final
  const badgeMap = {
    receber: { txt:'A RECEBER', bg:'rgba(16,185,129,.1)', border:'rgba(16,185,129,.25)', color:'#10b981' },
    pagar:   { txt:'A PAGAR',   bg:'rgba(239,68,68,.1)',  border:'rgba(239,68,68,.25)',  color:'#ef4444' },
    quitado: { txt:'QUITADO',   bg:'rgba(240,180,41,.1)', border:'rgba(240,180,41,.25)', color:'var(--gold)' }
  };
  const bdg = badgeMap[kpi.badge] || badgeMap.quitado;

  el.innerHTML = `
    <!-- KPI Strip -->
    <div class="fkpi-strip">
      <div class="fkpi ${kpi.profitLoss > 0 ? 'green' : kpi.profitLoss < 0 ? 'red' : ''}">
        <div class="fkpi-lbl"><span style="font-size:.7rem;">📊</span> Profit / Loss</div>
        <div class="fkpi-val" style="color:${clr(kpi.profitLoss)};">R$ ${fV(kpi.profitLoss,false)}</div>
        <div class="fkpi-sub">Σ Percas e ganhos</div>
      </div>
      <div class="fkpi purple">
        <div class="fkpi-lbl"><span style="font-size:.7rem;">💸</span> Rakeback Distribuído</div>
        <div class="fkpi-val" style="color:#a78bfa;">${kpi.rakeback > 0.01 ? 'R$ '+fV(kpi.rakeback,false) : '—'}</div>
        <div class="fkpi-sub">Σ RB Agentes</div>
      </div>
      <div class="fkpi blue">
        <div class="fkpi-lbl"><span style="font-size:.7rem;">📥</span> Recebido na Semana (+)</div>
        <div class="fkpi-val" style="color:#60a5fa;">${kpi.recebido > 0.01 ? 'R$ '+fV(kpi.recebido,false) : '—'}</div>
        <div class="fkpi-sub">Σ Entradas</div>
      </div>
      <div class="fkpi red">
        <div class="fkpi-lbl"><span style="font-size:.7rem;">📤</span> Pago na Semana (−)</div>
        <div class="fkpi-val" style="color:#ef4444;">${kpi.pago > 0.01 ? '−R$ '+fV(kpi.pago,false) : '—'}</div>
        <div class="fkpi-sub">Σ Saídas</div>
      </div>
      <div class="fkpi gold" style="border-color:${bdg.border};">
        <div class="fkpi-lbl"><span style="font-size:.7rem;">🏦</span> Saldo Final</div>
        <div class="fkpi-val" style="color:${bdg.color};">R$ ${fV(kpi.saldoFinal,false)}</div>
        <div class="fkpi-sub" style="margin-top:5px;">
          <span style="display:inline-block;background:${bdg.bg};border:1px solid ${bdg.border};color:${bdg.color};padding:2px 8px;border-radius:5px;font-size:.58rem;font-weight:800;letter-spacing:.5px;">
            ${bdg.txt}
          </span>
          ${Math.abs(kpi.saldoAnteriorLiq) > 0.01
            ? `<span style="font-size:.55rem;color:var(--t3);margin-left:6px;">carry: R$ ${fV(kpi.saldoAnteriorLiq,false)}</span>`
            : ''}
        </div>
        <div class="fkpi-sub" style="margin-top:2px;font-size:.54rem;color:var(--t3);">
          Liquidação (Carry + Semana Atual)
        </div>
      </div>
    </div>

    <!-- Staged / Pendentes Panel -->
    ${_renderStagedPanel()}

    <!-- Sub-tabs Agências | Jogadores -->
    <div style="display:flex;gap:4px;margin-bottom:12px;border-bottom:1px solid var(--b1);padding-bottom:10px;">
      <button class="rb-itab ${_activeFinTab==='agencias'?'rb-itab-active':''}" onclick="switchFinTab('agencias')">🤝 Agências (${agentRows.length})</button>
      <button class="rb-itab ${_activeFinTab==='jogadores'?'rb-itab-active':''}" onclick="switchFinTab('jogadores')">👤 Jogadores (${playerRows.length})</button>
    </div>

    <!-- Controls -->
    <div style="background:rgba(240,180,41,.05);border:1px solid rgba(240,180,41,.12);border-radius:8px;padding:9px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
      <span style="font-size:.72rem;color:var(--gold);">💼 Pagamentos e acertos agora ficam na aba <strong>Fechamentos</strong></span>
      <button onclick="document.querySelectorAll('.dn-item').forEach((i,idx)=>{if(i.textContent.includes('Liquidação')){i.click();}});" style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:4px 10px;border-radius:6px;font-size:.62rem;font-weight:700;cursor:pointer;">Ir para Liquidação →</button>
    </div>
    <div class="fin-controls">
      <input class="fin-search" type="text" placeholder="Buscar agente..." value="${_finSearch}" oninput="setFinSearch(this.value)">
      <div style="flex:1;"></div>
      <div style="display:flex;gap:5px;">
        <button class="fin-filter-btn ${_finFilter==='todos'?'active':''}" data-filter="todos" onclick="setFinFilter('todos')">Todos <span style="opacity:.5;font-size:.6rem;">${countByStatus.todos}</span></button>
        <button class="fin-filter-btn ${_finFilter==='aberto'?'active':''}" data-filter="aberto" onclick="setFinFilter('aberto')">⏳ Aberto <span style="opacity:.5;font-size:.6rem;">${countByStatus.aberto}</span></button>
        <button class="fin-filter-btn ${_finFilter==='parcial'?'active':''}" data-filter="parcial" onclick="setFinFilter('parcial')">◑ Parcial <span style="opacity:.5;font-size:.6rem;">${countByStatus.parcial}</span></button>
        <button class="fin-filter-btn ${_finFilter==='pago'?'active':''}" data-filter="pago" onclick="setFinFilter('pago')">✅ Quitado <span style="opacity:.5;font-size:.6rem;">${countByStatus.pago}</span></button>
      </div>
    </div>

    <!-- Table -->
    ${filtered.length ? `
    <div class="tw">
    <table class="tbl">
      <thead><tr>
        <th>Agente</th>
        <th style="text-align:right;">Profit/Loss</th>
        <th style="text-align:right;">RB Total</th>
        <th style="text-align:right;">Resultado Final</th>
        <th style="text-align:right;">Pagamentos</th>
        <th style="text-align:right;">Saldo Anterior (Carry)</th>
        <th style="text-align:right;">Saldo</th>
        <th style="text-align:center;">Status</th>
        <th style="text-align:center;">Ações</th>
      </tr></thead>
      <tbody>
        ${filtered.map(r => _renderFinRow(r)).join('')}
      </tbody>
    </table>
    </div>
    <div style="font-size:.65rem;color:var(--t3);margin-top:8px;text-align:right;">${filtered.length} entidade${filtered.length!==1?'s':''} exibida${filtered.length!==1?'s':''}</div>
    ` : `
    <div class="cs" style="padding:40px;">
      <div class="ci">🔍</div>
      <h3>Nenhuma entidade encontrada</h3>
      <p style="color:var(--t3);font-size:.8rem;">Ajuste os filtros ou busca</p>
    </div>`}
  `;
}

function _renderFinRow(r){
  // ── Entity label ──
  const isAgent  = r.tipo === 'agente';
  const rawName  = (r.nome || '').trim();
  const isSemAg  = isAgent && (!rawName || /^(sem agente|\(sem agente\)|none|null|undefined)$/i.test(rawName));
  const ico      = isAgent ? (isSemAg ? '👤' : '🤝') : '👤';
  const icoCls   = isAgent ? (isSemAg ? 'pl' : 'ag') : 'pl';
  const dispNome = isSemAg ? 'Diretos (Sem Agente)' : rawName;
  const subTxt   = isAgent
    ? `Rake ${fV(r.rakeGerado||r.rake,false)} · RB ${r.pctAgente}%`
    : 'Jogador direto';

  // ── Derived columns ──
  // P/L = ganhos agregados (para avista o resultado é apenas RB)
  const profitLoss  = r.ganhos || 0;
  // RB Total = resultSem - ganhos (não-avista) ou resultSem inteiro (avista)
  const rbTotal     = r.avista ? r.resultSem : (r.resultSem - (r.ganhos || 0));
  // Resultado Final = P/L + RB = resultSem (sempre)
  const resultFinal = r.resultSem;
  // Pagamentos = movTotal líquido
  const pagLiq      = r.movTotal;
  // Saldo = saldoPrev + resultFinal + pagamentos (= saldoAt)
  const saldo       = r.saldoAt;

  // ── Colors ──
  const plCor  = clr(profitLoss);
  const rbCor  = Math.abs(rbTotal) < 0.01 ? 'var(--t3)' : '#a78bfa';
  const rfCor  = clr(resultFinal);
  const pgCor  = Math.abs(pagLiq) < 0.01 ? 'var(--t3)' : pagLiq > 0 ? '#10b981' : '#60a5fa';
  const sdCor  = clr(saldo);

  // ── Status pill ──
  const pillMap = { aberto: '⏳ Em Aberto', parcial: '◑ Parcial', pago: '✅ Quitado' };
  const pill = `<span class="fin-pill ${r.status}">${pillMap[r.status]||'—'}</span>`;

  // ── Actions (read-only: history only) ──
  const idSafe = r.id.replace(/'/g,"\\'");
  let actBtns = `<button class="fa-hist" onclick="openHistoryDrawer('${idSafe}')" title="Histórico">📋</button>`;

  const rowCls = r.status === 'pago' ? ' class="fin-pago"' : '';

  return `<tr${rowCls} data-status="${r.status}" data-entity="${r.id}">
    <td>
      <div class="fin-ent">
        <div class="fin-ent-ico ${icoCls}">${ico}</div>
        <div>
          <div class="fin-ent-name">${dispNome}${!isAgent ? '<span style="font-size:.48rem;background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:1px 5px;border-radius:3px;font-weight:700;margin-left:4px;">DIRETO</span>' : ''}</div>
          <div class="fin-ent-sub">${subTxt}</div>
        </div>
      </div>
    </td>
    <td style="text-align:right;color:${plCor};font-weight:700;">${fV(profitLoss,false)}</td>
    <td style="text-align:right;color:${rbCor};font-weight:700;">${Math.abs(rbTotal)>0.01 ? fV(rbTotal,false) : '—'}</td>
    <td style="text-align:right;color:${rfCor};font-weight:800;">${fV(resultFinal,false)}</td>
    <td style="text-align:right;color:${pgCor};font-weight:700;">${Math.abs(pagLiq)>0.01 ? fV(pagLiq,false) : '—'}</td>
    <td style="text-align:right;color:${clr(r.saldoPrev)};font-weight:700;">${Math.abs(r.saldoPrev)>0.01 ? fV(r.saldoPrev,false) : '—'}</td>
    <td style="text-align:right;color:${sdCor};font-weight:800;">${Math.abs(saldo)<0.01 ? '0,00' : fV(saldo,false)}</td>
    <td style="text-align:center;">${pill}</td>
    <td style="text-align:center;"><div class="fin-act">${actBtns}</div></td>
  </tr>`;
}

// ── History Drawer ──
function openHistoryDrawer(entityId){
  const entities = calcFinEntities();
  const e = entities.find(x => x.id === entityId);
  if(!e) return;

  const saldoPrev = getSaldoAnterior(entityId);
  const ledger    = getEntityLedgerNet(entityId);
  const movTotal  = ledger.net;
  const resultSem = -(e.valor);
  const saldoAt   = saldoPrev + resultSem + movTotal;
  const allData   = getFinData();
  const key       = finKey();
  const hist      = allData[key]?.[entityId]?.historico || [];
  const entradas  = ledger.entradas;
  const saidas    = ledger.saidas;

  const ico = e.tipo === 'agente' ? '🤝' : '👤';
  document.getElementById('fd-title').textContent = `${ico} ${e.nome}`;
  document.getElementById('fd-subtitle').textContent = `Semana ${weeks[selWeekIdx] ? fWL(weeks[selWeekIdx]) : '—'}`;

  const idSafe = entityId.replace(/'/g,"\\'");

  document.getElementById('fd-body').innerHTML = `
    <!-- Summary boxes -->
    <div class="fd-summary"${Math.abs(saldoPrev)>0.01?' style="grid-template-columns:repeat(4,1fr);"':''}>
      ${Math.abs(saldoPrev)>0.01?`<div class="fd-box" style="border-left:2px solid #f59e0b;">
        <div class="fd-box-lbl">Saldo Anterior</div>
        <div class="fd-box-val" style="color:#f59e0b;">${fV(saldoPrev,false)}</div>
      </div>`:''}
      <div class="fd-box">
        <div class="fd-box-lbl">Resultado</div>
        <div class="fd-box-val" style="color:${clr(resultSem)};">${fV(resultSem,false)}</div>
      </div>
      <div class="fd-box">
        <div class="fd-box-lbl">Mov. Líquida</div>
        <div class="fd-box-val" style="color:${movTotal>0?'#10b981':movTotal<0?'#ef4444':'var(--t3)'};">${Math.abs(movTotal)>0.01?fV(movTotal,false):'—'}</div>
      </div>
      <div class="fd-box">
        <div class="fd-box-lbl">Saldo Atual</div>
        <div class="fd-box-val" style="color:${clr(saldoAt)};">${Math.abs(saldoAt)<0.01?'✅ 0,00':fV(saldoAt,false)}</div>
      </div>
    </div>
    ${Math.abs(saldoPrev) > 0.01 ? `<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:.68rem;color:#fbbf24;">
      ⚠️ Carry de semana lockada anterior: <strong>R$ ${fV(saldoPrev,false)}</strong>
      <span style="color:var(--t3);margin-left:4px;">(${saldoPrev > 0 ? 'clube deve receber' : 'clube deve pagar'})</span>
    </div>` : ''}

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);">Lançamentos (${hist.length})</div>
      <div style="display:flex;gap:6px;font-size:.62rem;color:var(--t3);">
        <span style="color:#10b981;">▲ ${fV(entradas,false)}</span>
        <span>·</span>
        <span style="color:#60a5fa;">▼ ${fV(saidas,false)}</span>
      </div>
    </div>

    ${hist.length ? hist.map((h,i) => {
      const isOut = h.dir === 'out';
      const dt = new Date(h.ts);
      const dataStr = dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}) + ' ' + dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
      const temComp = h.comp && h.comp.length > 0;
      const ehFoto = temComp && h.comp.startsWith('data:image');
      return `<div class="fd-item">
        <div class="fd-dir ${isOut?'out':'in'}">${isOut?'↑':'↓'}</div>
        <div class="fd-info">
          <div class="fd-metodo">${h.metodo}${temComp && !ehFoto ? ' · <span style="color:var(--t3);font-weight:400;font-size:.62rem;">'+h.comp.substring(0,30)+'</span>' : ''}${ehFoto ? ' · <span style="color:var(--t3);font-weight:400;font-size:.62rem;">📷 foto</span>' : ''}</div>
          <div class="fd-meta">${dataStr}${h.obs ? ' · '+h.obs : ''}</div>
        </div>
        <div class="fd-val" style="color:${isOut?'#60a5fa':'#10b981'};">${isOut?'−':'+'}${fV(h.valor,false)}</div>
        <div class="fd-actions">
          ${ehFoto ? `<button onclick="verExtratoPag('${idSafe}',${i})" title="Ver comprovante">🧾</button>` : ''}
          <button onclick="confirmarExcluirPag('${idSafe}',${i},'${e.nome.replace(/'/g,"\\'")}',${h.valor})" title="Excluir">✕</button>
        </div>
      </div>`;
    }).join('') : '<div class="fd-empty">Nenhum lançamento registrado</div>'}
  `;

  // Footer: read-only — link to Fechamentos for actions
  const status = getEntityStatus(e);
  if(status !== 'pago'){
    document.getElementById('fd-foot').innerHTML = `
      <button onclick="closeHistoryDrawer();document.querySelectorAll('.dn-item').forEach(i=>{if(i.textContent.includes('Liquidação'))i.click();});" style="width:100%;background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:10px;border-radius:8px;font-weight:700;font-size:.78rem;cursor:pointer;">💼 Acertar via Liquidação</button>`;
  } else {
    document.getElementById('fd-foot').innerHTML = `<div style="text-align:center;font-size:.78rem;color:#10b981;font-weight:700;">✅ Quitado</div>`;
  }

  document.getElementById('finDrawerOverlay').classList.add('open');
  document.getElementById('finDrawer').classList.add('open');
}

function closeHistoryDrawer(){
  document.getElementById('finDrawerOverlay').classList.remove('open');
  document.getElementById('finDrawer').classList.remove('open');
}

function abrirModalPagamento(entityId, dirOverride){
  const entities = calcFinEntities();
  const e = entities.find(x=>x.id===entityId);
  if(!e) return;
  _finModalEntity = e;

  const saldoPrev      = getSaldoAnterior(entityId);
  const movTotal       = getMovTotal(entityId);
  const resultadoSem   = -(e.valor);
  const saldoAt        = FinanceEngine.calcSaldoAtual(saldoPrev, resultadoSem, movTotal);
  const restante       = Math.abs(saldoAt);

  // Direção: usa override se fornecido, senão auto-detecta
  const dir = dirOverride || (saldoAt > 0 ? 'out' : 'in');
  window._finPayDir = dir;

  const isOut = dir === 'out';
  const tituloModal = isOut ? '💳 Registrar Pagamento' : '💰 Registrar Recebimento';
  const btnLabel    = isOut ? '✓ Confirmar Pagamento' : '✓ Confirmar Recebimento';

  document.querySelector('#mPagamento .modal-title').textContent = tituloModal;
  document.querySelector('#mPagamento .btn-primary').textContent = btnLabel;

  document.getElementById('mpag-info').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;font-size:.88rem;">${e.tipo==='agente'?'🤝':'👤'} ${e.nome}</div>
        <div style="font-size:.72rem;color:var(--t3);margin-top:3px;">Semana: ${weeks[selWeekIdx]?fWL(weeks[selWeekIdx]):'—'}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:.68rem;color:var(--t3);">Restante</div>
        <div style="font-family:'JetBrains Mono',monospace;font-weight:800;color:${isOut?'#60a5fa':'#ef4444'};font-size:1rem;">R$ ${fV(restante,false)}</div>
      </div>
    </div>
    ${Math.abs(saldoPrev)>0.01?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--b1);font-size:.72rem;color:var(--t3);">
      ⚠️ Inclui saldo anterior: <strong style="color:var(--gold)">R$ ${fV(saldoPrev,false)}</strong>
    </div>`:''}`;

  document.getElementById('mpag-valor').value = '';
  document.getElementById('mpag-comp-txt').value = '';
  document.getElementById('mpag-comp-preview').style.display = 'none';
  document.getElementById('mpag-comp-preview').innerHTML = '';
  window._finCompImg = null;
  window._finPayMetodo = null;

  const methods = getPayMethods();
  document.getElementById('mpag-metodos').innerHTML = methods.map(m=>
    '<button class="fin-metodo-btn" onclick="selectPayMetodo(this,\''+m+'\')">'+m+'</button>'
  ).join('');

  document.getElementById('mPagamento').classList.add('open');
}

function selectPayMetodo(btn, metodo){
  document.querySelectorAll('#mpag-metodos .fin-metodo-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  window._finPayMetodo = metodo;
}

function setPayFull(){
  if(!_finModalEntity) return;
  const saldoPrev = getSaldoAnterior(_finModalEntity.id);
  const movTotal  = getMovTotal(_finModalEntity.id);
  const saldoAt   = FinanceEngine.calcSaldoAtual(saldoPrev, -(_finModalEntity.valor), movTotal);
  document.getElementById('mpag-valor').value = Math.abs(saldoAt).toFixed(2);
}

function previewComp(input){
  if(!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    window._finCompImg = ev.target.result;
    const prev = document.getElementById('mpag-comp-preview');
    prev.style.display='block';
    prev.innerHTML='<img src="'+ev.target.result+'" style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid var(--b2);">';
  };
  reader.readAsDataURL(input.files[0]);
}

function confirmarPagamento(){
  if(!_finModalEntity){ showToast('⚠️ Erro interno','e'); return; }
  const val = parseFloat(document.getElementById('mpag-valor').value);
  if(!val || val<=0){ showToast('⚠️ Informe um valor válido','e'); return; }
  if(!window._finPayMetodo){ showToast('⚠️ Selecione a forma de pagamento','e'); return; }

  const comp = window._finCompImg || document.getElementById('mpag-comp-txt').value || '';
  const allData = getFinData();
  const key = finKey();
  if(!allData[key]) allData[key] = {};
  if(!allData[key][_finModalEntity.id]) allData[key][_finModalEntity.id] = { historico:[] };

  // Usa direção explícita definida ao abrir o modal
  const dir = window._finPayDir || 'in';

  allData[key][_finModalEntity.id].historico.push({
    valor: val, metodo: window._finPayMetodo, dir, comp, ts: Date.now(),
    source: 'fechamento', conciliado: false
  });

  const saldoPrev       = getSaldoAnterior(_finModalEntity.id);
  const resultadoSemana = -(_finModalEntity.valor);
  const movTotal        = getMovTotal(_finModalEntity.id);
  allData[key][_finModalEntity.id].saldoAberto = saldoPrev + resultadoSemana - movTotal;

  saveFinData(allData);
  closeM('mPagamento');
  showToast(dir === 'out' ? '✅ Pagamento registrado!' : '✅ Recebimento registrado!');
  renderFinanceiro();
  renderAgentClosing();
  if(document.getElementById('dn-fechamentos')?.classList.contains('active')) renderFechamentos();
  renderClubTable();
}

function verExtratoPag(entityId, idx){
  const allData = getFinData();
  const key = finKey();
  const h = allData[key]?.[entityId]?.historico?.[idx];
  if(!h) return;

  const entities = calcFinEntities();
  const e = entities.find(x=>x.id===entityId);
  const nome = e ? e.nome : entityId;
  const tipo = e ? (e.tipo==='agente'?'🤝 Agente':'👤 Jogador') : '';

  const dt = new Date(h.ts);
  const dataFmt = dt.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const horaFmt = dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

  const ehFoto = h.comp && h.comp.startsWith('data:image');
  const temTxt = h.comp && !ehFoto && h.comp.length > 0;

  document.getElementById('mextrato-body').innerHTML = `
    <div style="background:var(--s2);border-radius:10px;padding:14px 16px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--b1);">
        <div style="width:38px;height:38px;border-radius:9px;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.2);display:flex;align-items:center;justify-content:center;font-size:1rem;">✅</div>
        <div>
          <div style="font-weight:700;font-size:.88rem;">${tipo} ${nome}</div>
          <div style="font-size:.68rem;color:var(--t3);margin-top:2px;">${weeks[selWeekIdx]?fWL(weeks[selWeekIdx]):'—'}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Valor Pago</div>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:800;color:#10b981;font-size:1.1rem;margin-top:3px;">R$ ${fV(h.valor,false)}</div>
        </div>
        <div>
          <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Forma</div>
          <div style="margin-top:4px;"><span style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:3px 10px;border-radius:6px;font-size:.78rem;font-weight:700;">${h.metodo}</span></div>
        </div>
        <div>
          <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Data</div>
          <div style="font-size:.78rem;color:var(--t1);margin-top:3px;">${dataFmt}</div>
        </div>
        <div>
          <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);">Hora</div>
          <div style="font-size:.78rem;color:var(--t1);margin-top:3px;">🕐 ${horaFmt}</div>
        </div>
      </div>
      ${temTxt?`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--b1);">
        <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:5px;">📎 Comprovante</div>
        <div style="font-size:.8rem;color:var(--t2);word-break:break-all;">${h.comp}</div>
      </div>`:''}
    </div>
    ${ehFoto?`
    <div>
      <div style="font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:8px;">📷 Foto do Comprovante</div>
      <img src="${h.comp}" style="width:100%;border-radius:10px;border:1px solid var(--b1);display:block;">
    </div>`:''}
  `;
  document.getElementById('mExtratoPag').classList.add('open');
}

function confirmarExcluirPag(entityId, idx, nome, valor){
  document.getElementById('mconfirm-body').innerHTML =
    `Tem certeza que deseja excluir o pagamento de <strong style="color:#10b981;">R$ ${fV(valor,false)}</strong> de <strong>${nome}</strong>?
    <br><br><span style="font-size:.78rem;color:var(--t3);">Esta ação não pode ser desfeita.</span>`;

  const btn = document.getElementById('mconfirm-ok');
  // Remove listeners anteriores clonando o botão
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  newBtn.addEventListener('click', ()=>{
    closeM('mConfirmExcluir');
    excluirPagamento(entityId, idx);
  });
  document.getElementById('mConfirmExcluir').classList.add('open');
}

function excluirPagamento(entityId, idx){
  const allData = getFinData();
  const key = finKey();
  if(!allData[key]?.[entityId]?.historico) return;
  allData[key][entityId].historico.splice(idx,1);

  const entities  = calcFinEntities();
  const e         = entities.find(x=>x.id===entityId);
  const saldoPrev = getSaldoAnterior(entityId);
  if(e){
    const resultado = -(e.valor);
    const ledger = FinanceEngine.calcLedgerNet(allData[key][entityId].historico);
    const saldoAberto = saldoPrev + resultado - ledger.net;
    allData[key][entityId].saldoAberto = Math.abs(saldoAberto) < 0.01 ? 0 : saldoAberto;
  }
  saveFinData(allData);
  renderFinanceiro();
  renderAgentClosing(); // sincroniza fechamento de agentes
}

function addPaymentMethod(){
  const methods = getPayMethods();
  document.getElementById('mpay-list').innerHTML = methods.map((m,i)=>
    '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--s2);border-radius:8px;margin-bottom:6px;">'
    +'<span style="font-size:.82rem;font-weight:600;">'+m+'</span>'
    +(i<3?'<span style="font-size:.68rem;color:var(--t3);">padrão</span>'
        :'<button onclick="removePayMethod('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:.8rem;">✕</button>')
    +'</div>'
  ).join('');
  document.getElementById('mpay-new').value='';
  document.getElementById('mPayMethods').classList.add('open');
}

function addNewPayMethod(){
  const val = document.getElementById('mpay-new').value.trim();
  if(!val){ showToast('⚠️ Digite um nome','e'); return; }
  const methods = getPayMethods();
  if(methods.includes(val)){ showToast('⚠️ Já existe','e'); return; }
  methods.push(val);
  savePayMethods(methods);
  showToast('✅ Forma adicionada!');
  addPaymentMethod();
}

function removePayMethod(idx){
  const methods = getPayMethods();
  methods.splice(idx,1);
  savePayMethods(methods);
  addPaymentMethod();
}


// ══════════════════ CONCILIAÇÃO OFX ══════════════════

// Mapeamento persistido: descrição normalizada → entityId
function getOFXMap(){ return DataLayer.getOFXMap(); }
function saveOFXMap(m){ DataLayer.saveOFXMap(m); }

// Sessão OFX: persiste por clube+semana, sobrevive a fechar o modal
function ofxSessaoKey(){ return 'pm_ofx||'+(activeClube||'')+'||'+(weeks[selWeekIdx]||'0'); }
function getOFXSessao(){ return DataLayer.getOFXSessao(ofxSessaoKey()); }
function saveOFXSessao(arr){ DataLayer.saveOFXSessao(ofxSessaoKey(), arr); }

// ── Categorias personalizadas ─────────────────────────────
function getTransactionCategories(){
  try{
    const saved = DataLayer.getTransactionCategories() || [];
    const defIds=DEFAULT_CATS.map(c=>c.id);
    const extras=(Array.isArray(saved) ? saved : []).filter(c=>!defIds.includes(c.id));
    return [...DEFAULT_CATS,...extras];
  }catch(e){ return [...DEFAULT_CATS]; }
}
function saveTransactionCategories(cats){
  DataLayer.saveTransactionCategories(cats.filter(c=>c.deletable));
}

// ── Opções de entidade por categoria ──────────────────────
function getOFXEntityOptions(categoria){
  const entities=calcFinEntities();
  const cp=allPlayers.filter(p=>p.clube===activeClube);

  // Mapa: nome agente → p.aid (ID numérico da plataforma)
  const agPlatId={};
  cp.forEach(p=>{
    const an=(p.aname||'').trim();
    const aid=(p.aid||'').trim();
    if(an && aid && aid!=='0') agPlatId[an]=aid;
  });

  function enrich(e){
    if(e.tipo==='agente'){
      return {...e, platformId: agPlatId[e.nome]||''};
    }
    if(e.tipo==='jogador'){
      // encontra o jogador pelo entityId gerado
      const rawPl=cp.find(p=>makeEntityId('pl',p.id||p.nick)===e.id);
      return {...e, platformId: rawPl ? (rawPl.id||'') : ''};
    }
    return {...e, platformId:''};
  }

  switch(categoria){
    case 'agentes':   return entities.filter(e=>e.tipo==='agente').map(enrich);
    case 'jogadores': return entities.filter(e=>e.tipo==='jogador').map(enrich);
    case 'clubes':    return CLUBS.filter(c=>c!==activeClube).map(c=>({id:'_clube_'+c,nome:c,tipo:'clube',platformId:''}));
    case 'outros':    return entities.map(enrich);
    default:          return [];
  }
}

// ── Auto-categorização por memo ───────────────────────────
function autoCategorizarOFX(tx){
  const m=normalizeMemo(tx.memo);
  const blank={categoria:null,entityId:null,entityLabel:null,subcategoria:null,fornecedor:null,platformId:null};
  if(!m) return blank;

  // 1. Memo map salvo
  const map=getOFXMap();
  if(map[m]){
    const saved=map[m];
    if(typeof saved==='string') return {...blank,categoria:'agentes',entityId:saved,entityLabel:null};
    return {...blank,...saved};
  }

  const cp=allPlayers.filter(p=>p.clube===activeClube);

  // 2. Match por ID numérico da plataforma: agente (p.aid)
  const seen=new Set();
  for(const p of cp){
    const aid=(p.aid||'').trim();
    const an=(p.aname||'').trim();
    if(!aid||aid==='0'||!an||seen.has(aid)) continue;
    seen.add(aid);
    if(m.includes(aid)){
      return {...blank,categoria:'agentes',entityId:makeEntityId('ag',an),entityLabel:an,platformId:aid};
    }
  }

  // 3. Match por ID numérico da plataforma: jogador (p.id)
  for(const p of cp){
    const pid=(p.id||'').trim();
    if(!pid) continue;
    if(m.includes(pid)){
      const eid=makeEntityId('pl',p.id||p.nick);
      return {...blank,categoria:'jogadores',entityId:eid,entityLabel:p.nick||p.id,platformId:pid};
    }
  }

  // 4. Match fuzzy por nome
  const entities=calcFinEntities();
  for(const e of entities){
    const norm=(e.nome||'').toLowerCase().replace(/[^a-z0-9]/g,'').substr(0,30);
    if(norm&&m.includes(norm)) return {...blank,categoria:e.tipo==='agente'?'agentes':'jogadores',entityId:e.id,entityLabel:e.nome};
  }

  // 5. Match por nome de clube
  for(const c of CLUBS){
    const norm=c.toLowerCase().replace(/[^a-z0-9]/g,'');
    if(norm&&m.includes(norm)) return {...blank,categoria:'clubes',entityId:'_clube_'+c,entityLabel:c};
  }

  return blank;
}

// ── Normalização backward-compat de transação ─────────────
function normTx(t){
  if(!t.status){
    if(t.aplicado)       t.status='aplicado';
    else if(t.ignorado)  t.status='ignorado';
    else if(t.entityId)  t.status='vinculado';
    else                 t.status='pendente';
  }
  if(!t.dir) t.dir = (t.valor||0) >= 0 ? 'in' : 'out';
  if(!t.categoria && t.entityId){
    // legado: tinha entityId mas sem categoria → assume agentes
    t.categoria='agentes';
  }
  return t;
}

let _ofxFilterAtual = 'todos'; // legado (modal antigo)
let _ofxFilter    = 'todos';  // novo: 'todos'|'pendente'|'vinculado'|'aplicado'|'ignorado'|catId
let _ofxSearch    = '';
let _ofxCatFilter = null;     // categoria para filtro adicional
let _dreExpanded  = { receita:false, custos:false, taxas:false, despesas:false, lancamentos:false };

function abrirImportOFX(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  _ofxFilterAtual = 'todos';
  document.querySelectorAll('.ofx-filter').forEach(b=>b.classList.toggle('active',b.dataset.f==='todos'));
  document.getElementById('mOFX').classList.add('open');
  renderOFXModal();
}

// Abre modal e re-renderiza ao trocar de semana/clube
function renderOFXModal(){
  const txns  = getOFXSessao();
  const empty = document.getElementById('ofx-empty');
  const main  = document.getElementById('ofx-main');
  if(!txns.length){
    empty.style.display='block'; main.style.display='none';
    document.getElementById('ofx-bank-tabs').innerHTML='';
    return;
  }
  empty.style.display='none'; main.style.display='flex';

  // Abas dos bancos
  const bancos = [...new Set(txns.map(t=>t.banco))];
  document.getElementById('ofx-bank-tabs').innerHTML = bancos.map(b=>`
    <div class="ofx-bank-tab">
      🏦 ${b}
      <span style="background:rgba(59,130,246,.15);color:#60a5fa;padding:1px 6px;border-radius:10px;font-size:.62rem;">${txns.filter(t=>t.banco===b).length}</span>
      <button class="ofx-tab-x" onclick="removerBancoOFX('${b.replace(/'/g,"\\'")}')">✕</button>
    </div>`).join('');

  renderOFXTable();
}

function processOFX(input){
  const files = Array.from(input.files);
  if(!files.length) return;
  const existentes = getOFXSessao();
  const fitidsExist = new Set(existentes.map(t=>t.fitid));
  let totalNovos = 0;

  const lerArquivo = file => new Promise(resolve=>{
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const nomeArq = file.name.replace(/\.ofx$/i,'').replace(/_/g,' ');
        const novos   = parseOFX(e.target.result, nomeArq, fitidsExist);
        novos.forEach(t=>fitidsExist.add(t.fitid));
        totalNovos += novos.length;
        existentes.push(...novos);
      }catch(err){ showToast('❌ Erro em '+file.name+': '+err.message,'e'); }
      resolve();
    };
    reader.readAsText(file,'latin1');
  });

  Promise.all(files.map(lerArquivo)).then(()=>{
    saveOFXSessao(existentes);
    input.value=''; // permite re-upload do mesmo arquivo
    showToast(`✅ ${totalNovos} transaç${totalNovos===1?'ão':'ões'} importada${totalNovos===1?'':'s'}`);
    renderOFXModal();
    // Atualiza aba OFX da Conciliação (se ativa)
    const concOfxEl=document.getElementById('conc-ofx-content');
    if(concOfxEl) renderConcOFX();
  });
}

function removerBancoOFX(banco){
  saveOFXSessao(getOFXSessao().filter(t=>t.banco!==banco));
  renderOFXModal();
  showToast(`🗑 Extrato "${banco}" removido`);
}

function limparOFXAplicados(){
  saveOFXSessao(getOFXSessao().filter(t=>!t.aplicado));
  renderOFXModal();
  showToast('🗑 Transações aplicadas removidas');
}

function parseOFX(raw, nomeArq, fitidsExist){
  const txns  = [];
  const blocos= raw.match(/<STMTTRN[\s\S]*?<\/STMTTRN>|<STMTTRN>([\s\S]*?)(?=<STMTTRN>|<\/BANKTRANLIST>)/gi)||[];
  const bankM = raw.match(/<(?:FI>[\s\S]*?<ORG>|ORG>)([^<\r\n]+)/i);
  const banco = bankM ? bankM[1].trim() : nomeArq;

  blocos.forEach(bloco=>{
    const get = tag=>{ const m=bloco.match(new RegExp('<'+tag+'>([^<\\r\\n]+)','i')); return m?m[1].trim():''; };
    const fitid = get('FITID');
    const valor = parseFloat(get('TRNAMT').replace(',','.'));
    const memo  = get('MEMO')||get('NAME')||'';
    const dtRaw = get('DTPOSTED');
    if(isNaN(valor)||valor===0) return;
    if(fitidsExist?.has(fitid)) return; // dedup cross-arquivo
    const y=dtRaw.substr(0,4),mo=dtRaw.substr(4,2),d=dtRaw.substr(6,2);
    const dt = new Date(`${y}-${mo}-${d}`).getTime();
    const rawTx = { fitid, dt, memo, valor, banco };
    const dir   = valor >= 0 ? 'in' : 'out';
    const ac    = autoCategorizarOFX(rawTx);
    const status = ac.entityId ? 'vinculado' : 'pendente';
    txns.push({ fitid, dt, memo, valor, banco, dir,
      categoria:    ac.categoria    || null,
      entityId:     ac.entityId     || null,
      entityLabel:  ac.entityLabel  || null,
      platformId:   ac.platformId   || null,
      subcategoria: ac.subcategoria || null,
      fornecedor:   ac.fornecedor   || null,
      status, movementId: null,
      ignorado: false, aplicado: false });
  });
  return txns.sort((a,b)=>b.dt-a.dt);
}

function normalizeMemo(memo){
  return (memo||'').toLowerCase().replace(/[^a-z0-9]/g,'').substr(0,30);
}

function renderOFXTable(){
  const txns    = getOFXSessao();
  const entities= calcFinEntities();
  const f       = _ofxFilterAtual;

  const total  = txns.length;
  const vinc   = txns.filter(t=>t.entityId&&!t.ignorado&&!t.aplicado).length;
  const aplic  = txns.filter(t=>t.aplicado).length;
  const pend   = txns.filter(t=>!t.entityId&&!t.ignorado&&!t.aplicado).length;
  const entrou = txns.filter(t=>t.valor>0&&!t.ignorado).reduce((s,t)=>s+t.valor,0);

  document.getElementById('ofx-summary').innerHTML=`
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">Transações</div><div style="font-weight:800;color:var(--t1);font-size:.82rem;">${total}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">Entradas</div><div style="font-weight:800;color:#10b981;font-size:.82rem;">R$ ${fV(entrou,false)}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">✅ Vinculados</div><div style="font-weight:800;color:#10b981;font-size:.82rem;">${vinc}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">💳 Aplicados</div><div style="font-weight:800;color:#818cf8;font-size:.82rem;">${aplic}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">⏳ Pendentes</div><div style="font-weight:800;color:#fb923c;font-size:.82rem;">${pend}</div></div>`;

  const opts=`<option value="">— Selecionar —</option>
    <optgroup label="🤝 Agentes">${entities.filter(e=>e.tipo==='agente').map(e=>`<option value="${e.id}">${e.nome}</option>`).join('')}</optgroup>
    <optgroup label="👤 Jogadores Diretos">${entities.filter(e=>e.tipo==='jogador').map(e=>`<option value="${e.id}">${e.nome}</option>`).join('')}</optgroup>`;

  const vis = txns.filter(t=>{
    if(f==='vinculado') return t.entityId&&!t.ignorado&&!t.aplicado;
    if(f==='aplicado')  return t.aplicado;
    if(f==='pendente')  return !t.entityId&&!t.ignorado&&!t.aplicado;
    if(f==='ignorado')  return t.ignorado;
    return true;
  });

  const tbody=document.getElementById('ofx-tbody');
  if(!vis.length){
    tbody.innerHTML=`<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--t3);font-size:.8rem;">Nenhuma transação nesta categoria</td></tr>`;
  } else {
    tbody.innerHTML=vis.map(t=>{
      const idx   = txns.indexOf(t);
      const corVal= t.valor>0?'#10b981':'#ef4444';
      const sinal = t.valor>0?'+':'−';
      const dtFmt = new Date(t.dt).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
      const clsRow= t.aplicado?'aplicado':t.ignorado?'ignorado':'';
      let badge;
      if(t.aplicado)      badge='<span class="ofx-badge-aplic">💳 Aplicado</span>';
      else if(t.ignorado) badge='<span class="ofx-badge-ign">🚫 Ignorado</span>';
      else if(t.entityId) badge=`<span class="ofx-badge-vinc">✅ ${entities.find(e=>e.id===t.entityId)?.nome||t.entityId}</span>`;
      else                badge='<span class="ofx-badge-pend">⏳ Pendente</span>';
      const bancoTag=`<span style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.15);color:#60a5fa;padding:1px 6px;border-radius:4px;font-size:.62rem;font-weight:600;margin-right:5px;">${t.banco}</span>`;
      const optsSel=opts.replace(`value="${t.entityId||''}"`,`value="${t.entityId||''}" selected`);
      return `<tr class="ofx-row ${clsRow}">
        <td style="color:var(--t3);white-space:nowrap;font-size:.73rem;">${dtFmt}</td>
        <td>
          <div style="display:flex;align-items:center;flex-wrap:wrap;gap:3px;margin-bottom:3px;">${bancoTag}<span style="font-weight:600;color:var(--t1);font-size:.76rem;">${t.memo||'(sem descrição)'}</span></div>
          <div>${badge}</div>
        </td>
        <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:700;color:${corVal};white-space:nowrap;font-size:.8rem;">R$ ${fV(t.valor,false)}</td>
        <td>${t.ignorado||t.aplicado
          ?`<span style="color:var(--t3);font-size:.7rem;">—</span>`
          :`<select class="ofx-entity-select" onchange="vincularOFX(${idx},this.value)">${optsSel}</select>`}
        </td>
        <td style="text-align:center;">${t.aplicado
          ?`<span style="font-size:.68rem;color:var(--t3);">✓</span>`
          :t.ignorado
            ?`<button class="ofx-btn-ign" onclick="ignorarOFX(${idx},false)" title="Desfazer">↩</button>`
            :`<button class="ofx-btn-ign" onclick="ignorarOFX(${idx},true)" title="Ignorar">🚫</button>`}
        </td>
      </tr>`;
    }).join('');
  }

  const prontos=txns.filter(t=>t.entityId&&!t.ignorado&&!t.aplicado&&t.valor>0);
  document.getElementById('ofx-match-count').textContent=`${vinc} vinculados · ${aplic} aplicados · ${pend} pendentes`;
  document.getElementById('ofx-footer-info').textContent=prontos.length
    ?`${prontos.length} pronto${prontos.length!==1?'s':''} · R$ ${fV(prontos.reduce((s,t)=>s+t.valor,0),false)}`
    :'Vincule transações para aplicar';
  const btn=document.getElementById('ofx-btn-confirmar');
  btn.disabled=prontos.length===0;
  btn.style.opacity=prontos.length?'1':'.5';
  btn.style.cursor=prontos.length?'pointer':'not-allowed';
}

function vincularOFX(idx, entityId){
  const txns=getOFXSessao();
  txns[idx].entityId=entityId||null;
  if(entityId){
    const map=getOFXMap();
    const key=normalizeMemo(txns[idx].memo);
    if(key){map[key]=entityId;saveOFXMap(map);}
  }
  saveOFXSessao(txns); // persiste imediatamente
  renderOFXTable();
}

function ignorarOFX(idx, ignorar){
  const txns=getOFXSessao();
  txns[idx].ignorado=ignorar;
  if(ignorar) txns[idx].entityId=null;
  saveOFXSessao(txns);
  renderOFXTable();
}

function filtrarOFX(btn, filtro){
  _ofxFilterAtual=filtro;
  document.querySelectorAll('.ofx-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderOFXTable();
}

function confirmarConciliacao(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const txns=getOFXSessao();
  let staged=0, dups=0;

  txns.forEach((t,idx)=>{
    if(!t.entityId||t.ignorado||t.aplicado||t.valor<=0) return;

    const result = createStagedMovement({
      weekKey:     weeks[selWeekIdx] || '0',
      clube:       activeClube,
      entityId:    t.entityId,
      dir:         'in',
      amount:      t.valor,
      method:      'ofx',
      bankId:      t.banco || null,
      externalId:  t.fitid || null,
      date:        t.dt || Date.now(),
      description: 'OFX · '+(t.memo||'PIX')+' · '+fV(t.valor,false)
    });

    if(result.ok){
      txns[idx].aplicado = true;
      txns[idx].stagedId = result.staged.id;
      staged++;
    } else if(result.reason === 'duplicate'){
      txns[idx].aplicado = true;
      dups++;
    }
  });

  saveOFXSessao(txns);
  renderOFXTable();
  renderFinanceiro();
  if(staged>0)
    showToast('📌 '+staged+' lançamento'+(staged!==1?'s':'')+' OFX enviado'+(staged!==1?'s':'')+' para Pendentes'+(dups?' ('+dups+' dup)':''));
  else if(dups>0)
    showToast('ℹ️ Todos já existiam (anti-dup)');
  else
    showToast('⚠️ Nenhum registro enviado','e');
}


// ══════════════════ OFX — NOVO FLUXO ══════════════════════

// ── Aplicar transação individual diretamente ao ledger ────
function aplicarOFX(fitid){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  const t=normTx(sess[idx]);
  if(t.status==='aplicado'){ showToast('ℹ️ Já aplicado'); return; }

  // Determinar entityId efetivo
  let eid=t.entityId;
  if(!eid){
    if(t.categoria==='liga')          eid='_liga';
    else if(t.categoria==='despesas') eid='_despesa_'+(t.subcategoria||'outros');
    else{ showToast('⚠️ Vincule a transação antes de aplicar','e'); return; }
  }

  const result=createMovement({
    weekKey:     weeks[selWeekIdx]||'0',
    clube:       activeClube,
    entityId:    eid,
    dir:         t.dir||'in',
    amount:      Math.abs(t.valor),
    method:      'ofx',
    externalId:  'ofx_'+t.fitid,
    date:        t.dt||Date.now(),
    description: t.memo+(t.fornecedor?' · '+t.fornecedor:'')
  });

  if(result.ok){
    sess[idx].status    = 'aplicado';
    sess[idx].aplicado  = true;
    sess[idx].movementId= result.movement?.id||null;
    // Memorizar no memo-map
    if(t.categoria){
      const map=getOFXMap();
      map[normalizeMemo(t.memo)]={
        categoria:t.categoria, entityId:t.entityId,
        entityLabel:t.entityLabel, platformId:t.platformId||null,
        subcategoria:t.subcategoria, fornecedor:t.fornecedor
      };
      saveOFXMap(map);
    }
    saveOFXSessao(sess);
    renderConcOFX();
    renderFechamentos();
    showToast('✅ Transação aplicada ao Ledger');
  } else {
    showToast('⚠️ '+result.msg,'e');
  }
}

// ── Reverter transação já aplicada ────────────────────────
function reverterOFX(fitid){
  if(isWeekLocked()){ showToast('🔒 Semana lockada — não é possível reverter','e'); return; }
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  const t=normTx(sess[idx]);
  if(t.status!=='aplicado'){ showToast('ℹ️ Transação não está aplicada'); return; }

  // Remover via movementId ou busca por externalId
  const mvId=t.movementId;
  if(mvId){
    deleteMovement(mvId);
  } else {
    // fallback: busca por externalId
    const mvs=getMovements();
    const mv=mvs.find(m=>m.externalId==='ofx_'+fitid);
    if(mv) deleteMovement(mv.id);
  }

  sess[idx].status    = 'vinculado';
  sess[idx].aplicado  = false;
  sess[idx].movementId= null;
  saveOFXSessao(sess);
  renderConcOFX();
  renderFechamentos();
  showToast('↩ Transação revertida');
}

// ── Helpers inline para a tabela OFX ─────────────────────
function ofxSetCategoria(fitid, catId){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].categoria   = catId||null;
  // Limpar entidade se categoria mudou (contexto diferente)
  sess[idx].entityId    = null;
  sess[idx].entityLabel = null;
  sess[idx].subcategoria= null;
  sess[idx].fornecedor  = null;
  if(sess[idx].status==='vinculado') sess[idx].status='pendente';
  saveOFXSessao(sess);
  renderConcOFX();
}

function ofxSetEntity(fitid, entityId, entityLabel, platformId){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].entityId    = entityId||null;
  sess[idx].entityLabel = entityLabel||null;
  sess[idx].platformId  = platformId||null;
  sess[idx].status      = entityId ? 'vinculado' : 'pendente';
  saveOFXSessao(sess);
  renderConcOFX();
}

function ofxSetSub(fitid, subcategoria){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].subcategoria=subcategoria||null;
  // despesas: status = vinculado mesmo sem entityId
  if(sess[idx].categoria==='despesas'||sess[idx].categoria==='liga')
    sess[idx].status='vinculado';
  saveOFXSessao(sess);
  renderConcOFX();
}

function ofxSetFornecedor(fitid, v){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].fornecedor=v||null;
  saveOFXSessao(sess);
  // Não re-renderiza a tabela inteira (campo texto — perde foco)
}

function ofxIgnorar(fitid){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].status  = 'ignorado';
  sess[idx].ignorado= true;
  saveOFXSessao(sess);
  renderConcOFX();
}

function ofxRestaurar(fitid){
  const sess=getOFXSessao();
  const idx=sess.findIndex(t=>t.fitid===fitid);
  if(idx===-1) return;
  normTx(sess[idx]);
  sess[idx].status  = sess[idx].entityId ? 'vinculado' : 'pendente';
  sess[idx].ignorado= false;
  saveOFXSessao(sess);
  renderConcOFX();
}

function ofxAplicarTodos(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const sess=getOFXSessao().map(normTx);
  const prontos=sess.filter(t=>t.status==='vinculado');
  if(!prontos.length){ showToast('⚠️ Nenhuma transação vinculada para aplicar','e'); return; }
  let ok=0, dups=0, erros=0;
  prontos.forEach(t=>{
    let eid=t.entityId;
    if(!eid){
      if(t.categoria==='liga')          eid='_liga';
      else if(t.categoria==='despesas') eid='_despesa_'+(t.subcategoria||'outros');
      else{ erros++; return; }
    }
    const result=createMovement({
      weekKey:weeks[selWeekIdx]||'0', clube:activeClube,
      entityId:eid, dir:t.dir||'in', amount:Math.abs(t.valor),
      method:'ofx', externalId:'ofx_'+t.fitid, date:t.dt||Date.now(),
      description:t.memo+(t.fornecedor?' · '+t.fornecedor:'')
    });
    if(result.ok){
      t.status='aplicado'; t.aplicado=true; t.movementId=result.movement?.id||null;
      if(t.categoria){
        const map=getOFXMap();
        map[normalizeMemo(t.memo)]={categoria:t.categoria,entityId:t.entityId,entityLabel:t.entityLabel,platformId:t.platformId||null,subcategoria:t.subcategoria,fornecedor:t.fornecedor};
        saveOFXMap(map);
      }
      ok++;
    } else if(result.reason==='duplicate'){ t.status='aplicado'; t.aplicado=true; dups++; }
    else erros++;
  });
  saveOFXSessao(sess);
  renderConcOFX();
  renderFechamentos();
  if(ok>0) showToast('✅ '+ok+' transaç'+(ok===1?'ão':'ões')+' aplicada'+(ok===1?'':'s')+(dups?' ('+dups+' dup)':''));
  else if(dups>0) showToast('ℹ️ Todas já existiam (anti-dup)');
  else showToast('⚠️ Nenhuma aplicada — verifique vínculos','e');
}

// ── OFX Entity Picker (dropdown pesquisável) ─────────────
let _ofxPickerFitid   = null;
let _ofxPickerOptions = [];

function ensureOFXPicker(){
  if(document.getElementById('ofx-entity-picker')) return;
  const d=document.createElement('div');
  d.id='ofx-entity-picker';
  d.style.cssText='position:fixed;display:none;background:var(--s2);border:1px solid var(--b2);border-radius:9px;z-index:99999;min-width:290px;max-width:380px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.5);';
  d.innerHTML=`
    <div style="padding:8px 8px 4px;">
      <input id="ofx-ep-search" placeholder="🔍 Buscar ID ou nome..." autocomplete="off"
        style="width:100%;background:var(--s1);border:1px solid var(--b1);color:var(--t1);border-radius:6px;padding:6px 10px;font-size:.72rem;box-sizing:border-box;outline:none;"
        oninput="ofxPickerFilter(this.value)">
    </div>
    <div id="ofx-ep-list" style="max-height:240px;overflow-y:auto;padding:4px;"></div>`;
  document.body.appendChild(d);
  // Fechar ao clicar fora
  document.addEventListener('click', function(e){
    const p=document.getElementById('ofx-entity-picker');
    if(p&&p.style.display!=='none'&&!p.contains(e.target)) ofxClosePicker();
  }, true);
}

function ofxOpenEntityPicker(fitid, catId, btnEl){
  ensureOFXPicker();
  _ofxPickerFitid   = fitid;
  _ofxPickerOptions = getOFXEntityOptions(catId);
  const searchEl=document.getElementById('ofx-ep-search');
  if(searchEl) searchEl.value='';
  ofxPickerFilter('');
  const picker=document.getElementById('ofx-entity-picker');
  picker.style.display='block';
  // Posicionar próximo ao botão
  const rect=btnEl.getBoundingClientRect();
  const pw=340;
  let left=rect.left, top=rect.bottom+4;
  if(left+pw>window.innerWidth) left=window.innerWidth-pw-8;
  if(top+280>window.innerHeight) top=rect.top-284;
  picker.style.left=Math.max(4,left)+'px';
  picker.style.top=Math.max(4,top)+'px';
  setTimeout(()=>{ document.getElementById('ofx-ep-search')?.focus(); }, 40);
}

function ofxPickerFilter(q){
  const lq=(q||'').toLowerCase();
  const opts=_ofxPickerOptions.filter(e=>
    !lq ||
    (e.nome||'').toLowerCase().includes(lq) ||
    (e.platformId||'').includes(lq)
  );
  const list=document.getElementById('ofx-ep-list');
  if(!list) return;
  if(!opts.length){
    list.innerHTML='<div style="padding:14px;text-align:center;font-size:.72rem;color:var(--t3);">Nenhum resultado</div>';
    return;
  }
  list.innerHTML=opts.map(e=>{
    const fid=(_ofxPickerFitid||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const eid=(e.id||'').replace(/'/g,"\\'");
    const eln=(e.nome||'').replace(/'/g,"\\'");
    const pid=(e.platformId||'').replace(/'/g,"\\'");
    const icon=e.tipo==='agente'?'🤝':e.tipo==='clube'?'🔄':'🎮';
    const platDisplay=e.platformId||'—';
    return `<div onclick="ofxPickerSelect('${fid}','${eid}','${eln}','${pid}')"
      style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;border:1px solid transparent;"
      onmouseenter="this.style.background='rgba(255,255,255,.06)';this.style.borderColor='rgba(255,255,255,.06)'"
      onmouseleave="this.style.background='transparent';this.style.borderColor='transparent'">
      <span style="font-size:.82rem;flex-shrink:0;">${icon}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:.76rem;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.nome}</div>
        <div style="font-size:.64rem;color:var(--t3);font-family:'JetBrains Mono',monospace;margin-top:2px;">${platDisplay}</div>
      </div>
    </div>`;
  }).join('');
}

function ofxPickerSelect(fitid, entityId, entityLabel, platformId){
  ofxSetEntity(fitid, entityId, entityLabel, platformId);
  ofxClosePicker();
}

function ofxClosePicker(){
  const p=document.getElementById('ofx-entity-picker');
  if(p) p.style.display='none';
  _ofxPickerFitid=null;
}

// ══════════════════ CONCILIAÇÃO CHIPPIX ══════════════════

// Mapeamento persistido: chipPixId → entityId
function getCPMap(){ return DataLayer.getCPMap(); }
function saveCPMap(m){ DataLayer.saveCPMap(m); }

// Sessão ChipPix: persiste por clube+semana
function cpSessaoKey(){ return 'pm_cp||'+(activeClube||'')+'||'+(weeks[selWeekIdx]||'0'); }
function getCPSessao(){ return DataLayer.getCPSessao(cpSessaoKey()); }
function saveCPSessao(arr){ DataLayer.saveCPSessao(cpSessaoKey(), arr); }

let _cpFilterAtual = 'todos';

function abrirChipPix(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro','e'); return; }
  _cpFilterAtual = 'todos';
  document.querySelectorAll('.cp-filter').forEach(b=>b.classList.toggle('active',b.dataset.f==='todos'));
  document.getElementById('mChipPix').classList.add('open');
  setTimeout(()=>{ const s=document.getElementById('cp-search'); if(s) s.value=''; },50);
  renderCPModal();
}

function renderCPModal(){
  const rows  = getCPSessao();
  const empty = document.getElementById('cp-empty');
  const main  = document.getElementById('cp-main');
  if(!rows.length){
    empty.style.display='block'; main.style.display='none';
    return;
  }
  empty.style.display='none'; main.style.display='flex';
  renderCPTable();
}

function processChipPix(input){
  if(isWeekLocked()){ showToast('🔒 Semana lockada — não é possível importar','e'); input.value=''; return; }
  const file = input.files[0];
  if(!file) return;

  // Usa SheetJS (XLSX) disponível via CDN no artifact
  if(typeof XLSX === 'undefined'){
    // Carrega SheetJS dinamicamente se não disponível
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    s.onload = () => lerExcelCP(file);
    s.onerror = () => showToast('❌ Não foi possível carregar leitor de Excel. Verifique sua conexão.','e');
    document.head.appendChild(s);
  } else {
    lerExcelCP(file);
  }
  input.value='';
}

// ── Smart ID matching for ChipPix ──
// Handles cases like ChipPix "1610051AG" vs GU spreadsheet "1610051"
// Strategy: exact → numeric prefix → contains
function _cpFindPlayerMatch(idJog, clubePlayers){
  const cpId = String(idJog||'').trim();
  if(!cpId) return null;

  // 1) Exact match on p.id or p.aid
  let pl = clubePlayers.find(p=>{
    const idStr  = String(p.id ||'').trim();
    const aidStr = String(p.aid||'').trim();
    return (idStr && idStr === cpId) || (aidStr && aidStr === cpId);
  });
  if(pl) return pl;

  // 2) Numeric prefix match: extract leading digits from ChipPix ID
  //    e.g. "1610051AG" → "1610051", then match against p.id "1610051"
  const cpNumPrefix = cpId.match(/^(\d+)/);
  if(cpNumPrefix && cpNumPrefix[1].length >= 4){
    const numPart = cpNumPrefix[1];
    pl = clubePlayers.find(p=>{
      const idStr  = String(p.id ||'').trim();
      const aidStr = String(p.aid||'').trim();
      return (idStr && idStr === numPart) || (aidStr && aidStr === numPart);
    });
    if(pl) return pl;
  }

  // 3) Reverse: player ID contains ChipPix ID or vice-versa (min 5 chars)
  if(cpId.length >= 5){
    pl = clubePlayers.find(p=>{
      const idStr  = String(p.id ||'').trim();
      const aidStr = String(p.aid||'').trim();
      return (idStr.length >= 5 && (idStr.includes(cpId) || cpId.includes(idStr)))
          || (aidStr.length >= 5 && (aidStr.includes(cpId) || cpId.includes(aidStr)));
    });
    if(pl) return pl;
  }

  return null;
}

function lerExcelCP(file){
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb   = XLSX.read(e.target.result, { type:'array' });
      // Busca aba Operações (ou pega a primeira)
      const sheetName = wb.SheetNames.find(n=>n.toLowerCase().includes('opera')) || wb.SheetNames[0];
      const ws   = wb.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });

      if(data.length < 2){ showToast('⚠️ Planilha vazia ou formato inválido','e'); return; }

      // Cabeçalho esperado: Data, Tipo, Finalidade, Entrada bruta, Saida bruta, Entrada liquida, Saida liquida, Integrante, Taxa, Id Jogador, ...
      const header = data[0].map(h=>String(h).toLowerCase().trim());
      const iData  = 0;  // col Data
      const iTipo  = header.findIndex(h=>h==='tipo');
      const iEnt   = header.findIndex(h=>h.includes('entrada bruta'));
      const iSai   = header.findIndex(h=>h.includes('saida bruta') || h.includes('saída bruta'));
      const iTaxa  = header.findIndex(h=>h.includes('taxa'));
      const iNome  = header.findIndex(h=>h==='integrante');
      const iId    = header.findIndex(h=>h.includes('id jogador'));

      if(iId===-1){ showToast('❌ Coluna "Id Jogador" não encontrada. Verifique o arquivo.','e'); return; }

      // Agrupa por Id Jogador
      const grupos = {};
      for(let i=1;i<data.length;i++){
        const row  = data[i];
        const idJog= String(row[iId]).trim();
        if(!idJog || idJog==='' || idJog==='0') continue;

        const ent  = parseFloat(String(row[iEnt]).replace(',','.')) || 0;
        const sai  = parseFloat(String(row[iSai]).replace(',','.')) || 0;
        const taxa = parseFloat(String(row[iTaxa]).replace(',','.')) || 0;
        const nome = String(row[iNome]).trim();
        const data_= String(row[iData]).substring(0,10);

        if(!grupos[idJog]) grupos[idJog] = { idJog, nome, entrada:0, saida:0, taxa:0, txns:0, datas:[] };
        grupos[idJog].nome     = nome || grupos[idJog].nome;
        grupos[idJog].entrada += ent;
        grupos[idJog].saida   += sai;
        grupos[idJog].taxa    += taxa;
        grupos[idJog].txns++;
        if(data_ && !grupos[idJog].datas.includes(data_)) grupos[idJog].datas.push(data_);
      }

      // Auto-vinculação: cruza idJog com p.id dos jogadores do clube
      // Matching inteligente: exato → prefixo numérico → contém
      const clubePlayers = allPlayers.filter(p=>p.clube===activeClube);
      const map = getCPMap();

      const sessao = Object.values(grupos).map(g=>{
        // 1º: mapeamento manual salvo (mais confiável)
        let entityId = map[g.idJog] || null;

        // 2º: cruza com p.id OU p.aid (ID do aplicativo) dos jogadores do clube
        if(!entityId){
          const pl = _cpFindPlayerMatch(g.idJog, clubePlayers);
          if(pl){
            const agKey = (pl.aname||'(sem agente)').trim();
            const agId  = makeEntityId('ag', agKey);
            entityId = `pl_${pl.id}|${agId}`;
            map[g.idJog] = entityId; // salva pro próximo import
          }
        }

        return { ...g, saldo: g.entrada-g.saida, entityId, ignorado:false, aplicado:false };
      }).sort((a,b)=>b.entrada-a.entrada);

      saveCPMap(map);

      if(!sessao.length){ showToast('⚠️ Nenhum jogador encontrado no arquivo','e'); return; }

      saveCPSessao(sessao);
      const autoVinc = sessao.filter(r=>r.entityId).length;
      const pendentes = sessao.length - autoVinc;
      showToast(`✅ ${sessao.length} jogadores · ${autoVinc} auto-vinculados${pendentes>0?' · ⏳ '+pendentes+' pendentes':' · Tudo vinculado!'}`);
      // Abre direto no filtro de pendentes se tiver, senão todos
      if(pendentes>0 && autoVinc>0){
        _cpFilterAtual='pendente';
        document.querySelectorAll('.cp-filter').forEach(b=>b.classList.toggle('active',b.dataset.f==='pendente'));
      }
      renderCPModal();
    } catch(err){
      console.error(err);
      showToast('❌ Erro ao ler planilha: '+err.message,'e');
    }
  };
  reader.readAsArrayBuffer(file);
}

function renderCPTable(){
  const rows    = getCPSessao();
  const entities= calcFinEntities();
  const f       = _cpFilterAtual;

  const total  = rows.length;
  const vinc   = rows.filter(r=>r.entityId&&!r.ignorado&&!r.aplicado).length;
  const aplic  = rows.filter(r=>r.aplicado).length;
  const pend   = rows.filter(r=>!r.entityId&&!r.ignorado&&!r.aplicado).length;
  const entTot = rows.filter(r=>!r.ignorado).reduce((s,r)=>s+r.entrada,0);
  const saiTot = rows.filter(r=>!r.ignorado).reduce((s,r)=>s+r.saida,0);

  document.getElementById('cp-summary').innerHTML=`
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">Jogadores</div><div style="font-weight:800;color:var(--t1);font-size:.82rem;">${total}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">📥 Total Entrada</div><div style="font-weight:800;color:#10b981;font-size:.82rem;">R$ ${fV(entTot,false)}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">📤 Total Saída</div><div style="font-weight:800;color:#f87171;font-size:.82rem;">R$ ${fV(saiTot,false)}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">💰 Saldo Líquido</div><div style="font-weight:800;color:${clr(entTot-saiTot)};font-size:.82rem;">R$ ${fV(entTot-saiTot,false)}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">✅ Vinculados</div><div style="font-weight:800;color:#10b981;font-size:.82rem;">${vinc}</div></div>
    <div><div style="font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:2px;">⏳ Pendentes</div><div style="font-weight:800;color:#fb923c;font-size:.82rem;">${pend}</div></div>`;

  // Monta dropdown com TODOS os jogadores do clube, agrupados por agente
  const cpPlayers = allPlayers.filter(p=>p.clube===activeClube);
  const agentGroups = {};
  cpPlayers.forEach(p=>{
    const ag = p.aname||'(sem agente)';
    if(!agentGroups[ag]) agentGroups[ag]=[];
    agentGroups[ag].push(p);
  });
  // Adiciona também jogadores diretos como grupo próprio
  const opts=`<option value="">— Selecionar jogador —</option>
    ${Object.entries(agentGroups).map(([agKey,players])=>
      `<optgroup label="🤝 ${agKey}">
        ${players.map(p=>`<option value="pl_${p.id}|${makeEntityId('ag',agKey)}">${p.nick||p.id} (ID: ${p.id})</option>`).join('')}
      </optgroup>`
    ).join('')}`;

  const busca = (document.getElementById('cp-search')?.value||'').toLowerCase().trim();

  const vis = rows.filter(r=>{
    if(f==='vinculado') return r.entityId&&!r.ignorado&&!r.aplicado;
    if(f==='aplicado')  return r.aplicado;
    if(f==='pendente')  return !r.entityId&&!r.ignorado&&!r.aplicado;
    if(f==='ignorado')  return r.ignorado;
    return true;
  }).filter(r=>{
    if(!busca) return true;
    return String(r.idJog).includes(busca) || r.nome.toLowerCase().includes(busca);
  });

  const tbody=document.getElementById('cp-tbody');
  if(!vis.length){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--t3);font-size:.8rem;">Nenhum jogador nesta categoria</td></tr>`;
  } else {
    tbody.innerHTML=vis.map(r=>{
      const idx   = rows.indexOf(r);
      const saldo = r.entrada - r.saida;
      const corSaldo= clr(saldo);
      const clsRow= r.aplicado?'aplicado':r.ignorado?'ignorado':'';

      let badge;
      if(r.aplicado)      badge='<span class="cp-badge-aplic">💳 Aplicado</span>';
      else if(r.ignorado) badge='<span class="cp-badge-ign">🚫 Ignorado</span>';
      else if(r.entityId) {
        // entityId formato: "pl_PLAYERID|ag_AGENTID" ou legado sem pipe
        const [plPart] = r.entityId.split('|');
        const plId = plPart.replace('pl_','');
        const pl = cpPlayers.find(p=>p.id===plId);
        badge=`<span class="cp-badge-vinc">✅ ${pl?pl.nick||pl.id:r.entityId}</span>`;
      }
      else                badge='<span class="cp-badge-pend">⏳ Pendente</span>';

      const txnsLabel=`${r.txns} op${r.txns!==1?'s':''}`;
      const dSorted = r.datas.slice().sort();
      const periodoLabel = dSorted.length ? dSorted[0].substring(5)+' → '+dSorted[dSorted.length-1].substring(5) : '';

      // Label do vinculado atual
      let vinculadoLabel = '— Selecionar jogador —';
      if(r.entityId){
        const [plPart] = r.entityId.split('|');
        const plId = plPart.replace('pl_','');
        const pl = cpPlayers.find(p=>p.id===plId);
        vinculadoLabel = pl ? `${pl.nick||pl.id} (ID: ${pl.id})` : r.entityId;
      }

      return `<tr class="cp-row ${clsRow}">
        <td>
          <div style="font-family:'JetBrains Mono',monospace;font-weight:700;color:#60a5fa;font-size:.8rem;">${r.idJog}</div>
          <div style="font-size:.65rem;color:var(--t3);">${txnsLabel}${periodoLabel?' · '+periodoLabel:''}</div>
        </td>
        <td>
          <div style="font-weight:600;color:var(--t2);font-size:.76rem;">${r.nome}</div>
          <div style="margin-top:2px;">${badge}</div>
        </td>
        <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:600;color:#10b981;font-size:.8rem;">+R$ ${fV(r.entrada,false)}</td>
        <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:600;color:${r.saida>0?'#f87171':'var(--t3)'};font-size:.8rem;">${r.saida>0?'-R$ '+fV(r.saida,false):'—'}</td>
        <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:800;color:${corSaldo};font-size:.82rem;">R$ ${fV(saldo,false)}</td>
        <td style="min-width:200px;">
          ${r.ignorado||r.aplicado
            ? `<span style="color:var(--t3);font-size:.7rem;">—</span>`
            : `<div class="cp-dd" id="cpdd-${idx}">
                <div class="cp-dd-trigger ${r.entityId?'':'empty'}" onclick="toggleCPDD(${idx})" style="${r.entityId?'color:#10b981;border-color:rgba(16,185,129,.3);':''}">
                  <span>${vinculadoLabel}</span>
                  <span style="color:var(--t3);font-size:.65rem;flex-shrink:0;">▾</span>
                </div>
                <div class="cp-dd-panel" id="cpdd-panel-${idx}">
                  <input class="cp-dd-input" type="text" placeholder="🔍  Buscar por ID ou nome..." 
                    oninput="filterCPDD(${idx},this.value)" onkeydown="navCPDD(event,${idx})">
                  <div class="cp-dd-list" id="cpdd-list-${idx}"></div>
                </div>
              </div>`
          }
        </td>
        <td style="text-align:center;">${r.aplicado
          ?`<span style="font-size:.68rem;color:#818cf8;">✓</span>`
          :r.ignorado
            ?`<button class="cp-btn-ign" onclick="ignorarCP(${idx},false)">↩</button>`
            :`<button class="cp-btn-ign" onclick="ignorarCP(${idx},true)" title="Ignorar">🚫</button>`}
        </td>
      </tr>`;
    }).join('');
  }

  const prontos=rows.filter(r=>r.entityId&&!r.ignorado&&!r.aplicado);
  document.getElementById('cp-match-count').textContent=`${vinc} vinculados · ${aplic} aplicados · ${pend} pendentes`;
  document.getElementById('cp-footer-info').textContent=prontos.length
    ?`${prontos.length} pronto${prontos.length!==1?'s':''} · Saldo: R$ ${fV(prontos.reduce((s,r)=>s+(r.entrada-r.saida),0),false)}`
    :'Vincule ao menos um jogador para aplicar';
  const btn=document.getElementById('cp-btn-aplicar');
  btn.disabled=prontos.length===0;
  btn.style.opacity=prontos.length?'1':'.5';
  btn.style.cursor=prontos.length?'pointer':'not-allowed';
}

// ── Dropdown customizado ChipPix ──
let _cpDDOpen = null; // índice do dropdown aberto atualmente

function toggleCPDD(idx){
  const panel = document.getElementById(`cpdd-panel-${idx}`);
  if(!panel) return;
  const isOpen = panel.classList.contains('open');
  // Fecha todos os outros
  closeCPDDs();
  if(!isOpen){
    panel.classList.add('open');
    document.getElementById(`cpdd-${idx}`)?.querySelector('.cp-dd-trigger')?.classList.add('active');
    _cpDDOpen = idx;
    filterCPDD(idx,''); // popula a lista completa
    setTimeout(()=> panel.querySelector('.cp-dd-input')?.focus(), 50);
  }
}

function closeCPDDs(){
  document.querySelectorAll('.cp-dd-panel.open').forEach(p=>p.classList.remove('open'));
  document.querySelectorAll('.cp-dd-trigger.active').forEach(t=>t.classList.remove('active'));
  _cpDDOpen = null;
}

// Fecha ao clicar fora
document.addEventListener('click', e=>{
  if(_cpDDOpen !== null && !e.target.closest('.cp-dd')) closeCPDDs();
});

function filterCPDD(idx, query){
  const list = document.getElementById(`cpdd-list-${idx}`);
  if(!list) return;
  const q = query.toLowerCase().trim();
  const clubePlayers = allPlayers.filter(p=>p.clube===activeClube);
  const agentGroups = {};
  clubePlayers.forEach(p=>{
    const ag = p.aname||'(sem agente)';
    if(!agentGroups[ag]) agentGroups[ag]=[];
    agentGroups[ag].push(p);
  });

  let html = '';
  let total = 0;
  Object.entries(agentGroups).forEach(([agKey, players])=>{
    const filtered = players.filter(p=>{
      if(!q) return true;
      return String(p.id).includes(q) || (p.nick||'').toLowerCase().includes(q);
    });
    if(!filtered.length) return;
    const agId = makeEntityId('ag', agKey);
    html += `<div class="cp-dd-group">🤝 ${agKey}</div>`;
    filtered.forEach(p=>{
      const val = `pl_${p.id}|${agId}`;
      const idStr = String(p.id);
      const nick  = p.nick||p.id;
      // Highlight match
      const hiId   = q && idStr.includes(q)   ? idStr.replace(q,`<mark>${q}</mark>`)   : idStr;
      const hiNick = q && nick.toLowerCase().includes(q) ? nick.replace(new RegExp(q,'gi'),m=>`<mark>${m}</mark>`) : nick;
      html += `<div class="cp-dd-item" onclick="selecionarCPItem(${idx},'${val}','${nick.replace(/'/g,"\\'")} (ID: ${p.id})')" 
        title="${nick} — ID: ${p.id}">${hiNick} <span style="color:var(--t3);font-size:.65rem;">(${hiId})</span></div>`;
      total++;
    });
  });

  if(!total) html = '<div class="cp-dd-empty">Nenhum jogador encontrado</div>';
  list.innerHTML = html;
}

function selecionarCPItem(idx, entityId, label){
  // Atualiza o trigger visualmente
  const trigger = document.querySelector(`#cpdd-${idx} .cp-dd-trigger span`);
  if(trigger){ trigger.textContent = label; }
  const dd = document.getElementById(`cpdd-${idx}`);
  if(dd){
    dd.querySelector('.cp-dd-trigger').style.color = '#10b981';
    dd.querySelector('.cp-dd-trigger').style.borderColor = 'rgba(16,185,129,.3)';
  }
  closeCPDDs();
  vincularCP(idx, entityId);
}

function navCPDD(e, idx){
  const list  = document.getElementById(`cpdd-list-${idx}`);
  if(!list) return;
  const items = list.querySelectorAll('.cp-dd-item');
  const cur   = list.querySelector('.cp-dd-item.focused');
  if(e.key==='Escape'){ closeCPDDs(); return; }
  if(e.key==='Enter' && cur){ cur.click(); return; }
  if(e.key==='ArrowDown'||e.key==='ArrowUp'){
    e.preventDefault();
    const arr = Array.from(items);
    let ni = e.key==='ArrowDown' ? 0 : arr.length-1;
    if(cur){ cur.classList.remove('focused'); ni = arr.indexOf(cur)+(e.key==='ArrowDown'?1:-1); }
    ni = Math.max(0, Math.min(arr.length-1, ni));
    arr[ni]?.classList.add('focused');
    arr[ni]?.scrollIntoView({block:'nearest'});
  }
}

function reautolinkCP(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows = getCPSessao();
  if(!rows.length){ showToast('⚠️ Importe um arquivo ChipPix primeiro','e'); return; }
  const clubePlayers = allPlayers.filter(p=>p.clube===activeClube);
  const map = getCPMap();
  let linked=0, alreadyLinked=0, notFound=0;

  rows.forEach((r,i)=>{
    if(r.aplicado) return;
    if(r.entityId){ alreadyLinked++; return; }
    const pl = _cpFindPlayerMatch(r.idJog, clubePlayers);
    if(pl){
      const agKey = (pl.aname||'(sem agente)').trim();
      const agId  = makeEntityId('ag', agKey);
      const entityId = `pl_${pl.id}|${agId}`;
      rows[i].entityId = entityId;
      map[r.idJog]     = entityId;
      linked++;
    } else {
      notFound++;
    }
  });

  saveCPMap(map);
  saveCPSessao(rows);
  renderCPTable();

  const parts = [];
  if(linked)       parts.push(`✅ ${linked} vinculados agora`);
  if(alreadyLinked)parts.push(`${alreadyLinked} já estavam vinculados`);
  if(notFound)     parts.push(`⏳ ${notFound} não encontrados — vincule manualmente`);
  showToast(parts.join(' · '));

  // Se ainda tem pendentes, abre filtro de pendentes
  if(notFound>0) filtrarCP(document.querySelector('.cp-filter[data-f="pendente"]'),'pendente');
}


function vincularCP(idx, entityId){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows=getCPSessao();
  rows[idx].entityId=entityId||null;
  if(entityId){
    const map=getCPMap();
    map[rows[idx].idJog]=entityId;
    saveCPMap(map);
  }
  saveCPSessao(rows);
  renderCPTable();
}

function ignorarCP(idx, ignorar){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows=getCPSessao();
  // If unignoring and it had a linkedMovementId, remove the movement
  if(!ignorar && rows[idx].linkedMovementId){
    deleteMovement(rows[idx].linkedMovementId);
    rows[idx].linkedMovementId = null;
  }
  rows[idx].ignorado=ignorar;
  if(ignorar){ rows[idx].entityId=null; rows[idx].locked=false; rows[idx].aplicado=false; }
  saveCPSessao(rows);
  renderCPTable();
}

function filtrarCP(btn, filtro){
  _cpFilterAtual=filtro;
  document.querySelectorAll('.cp-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCPTable();
}

function aplicarChipPix(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows = getCPSessao();
  let staged = 0, dups = 0;

  rows.forEach((r,idx)=>{
    if(!r.entityId||r.ignorado||r.aplicado) return;
    if(r.entrada < 0.01 && r.saida < 0.01) return;

    const eid = _cpResolveEntityId(r);
    if(!eid) return;

    const saldoLiq = r.entrada - r.saida;
    const dir      = saldoLiq >= 0 ? 'in' : 'out';
    const valorLiq = Math.abs(saldoLiq);
    if(valorLiq < 0.01) return;

    const plPart = r.entityId.split('|')[0];
    const plId   = plPart.replace(/^pl_/,'');
    const pl     = allPlayers.find(p=> String(p.id).trim()===String(plId).trim() && p.clube===activeClube);
    const plNome = pl ? (pl.nick||pl.id) : r.nome;

    const result = createMovement({
      weekKey:     weeks[selWeekIdx] || '0',
      clube:       activeClube,
      entityId:    eid,
      dir,
      amount:      valorLiq,
      method:      'chippix',
      externalId:  'cp_'+r.idJog,
      date:        Date.now(),
      description: 'ChipPix · '+plNome+' · ent '+fV(r.entrada,false)+' − saí '+fV(r.saida,false)
    });

    if(result.ok){
      rows[idx].aplicado = true;
      staged++;
    } else if(result.reason === 'duplicate'){
      rows[idx].aplicado = true;
      dups++;
    }
  });

  saveCPSessao(rows);
  closeM('mChipPix');
  renderCPTable();
  renderFinanceiro();
  renderFechamentos();
  if(typeof renderConcChipPix === 'function') renderConcChipPix();
  if(staged>0)
    showToast('✅ '+staged+' pagamento'+(staged!==1?'s':'')+' aplicado'+(staged!==1?'s':'')+' na Liquidação');
  else if(dups>0)
    showToast('ℹ️ Todos já existiam (anti-dup)');
  else
    showToast('⚠️ Nenhum registro enviado — verifique se os jogadores estão vinculados','e');
}


function resetarChipPixSemana(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  if(!confirm('Apagar todos os lançamentos ChipPix desta semana?\nIsso remove de pm_staged + pm_movements + pm_fin.\nOs vínculos serão mantidos.')) return;

  const wk = weeks[selWeekIdx]||'0';

  // 1) Remove ChipPix staged
  let stg = getStaged();
  stg = stg.filter(s=>!(s.method==='chippix' && s.weekKey===wk && s.clube===activeClube));
  saveStaged(stg);

  // 2) Remove ChipPix movements from pm_movements
  let mvs = getMovements();
  mvs = mvs.filter(m=>!(m.method==='chippix' && m.weekKey===wk && m.clube===activeClube));
  saveMovements(mvs);

  // 3) Remove ChipPix entries from pm_fin
  const allData = getFinData();
  const key     = finKey();
  if(allData[key]){
    Object.keys(allData[key]).forEach(eid=>{
      allData[key][eid].historico = (allData[key][eid].historico||[]).filter(h=>h.origem !== 'ChipPix');
    });
    saveFinData(allData);
  }

  // 4) Reset session flags (keep entityId for re-apply)
  const rows = getCPSessao().map(r=>({...r, aplicado:false, linkedMovementId:null, stagedId:null}));
  saveCPSessao(rows);
  renderCPTable();
  renderFinanceiro();
  renderAgentClosing();
  if(typeof renderConcChipPix === 'function') renderConcChipPix();
  showToast('🗑 Lançamentos ChipPix apagados de todos os ledgers');
}


// ══════════════════════════════════════════════════════════════
// ═══  MÓDULO CONCILIAÇÃO  ════════════════════════════════════
// ══════════════════════════════════════════════════════════════

// ── Sub-tab switching ─────────────────────────────────────────
let _finActiveSub  = 'liquidacao';
let _concActiveSub = 'chippix';



function switchConcSub(tab, btn){
  _concActiveSub = tab;
  document.querySelectorAll('#dn-conciliacao .conc-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['chippix','ofx','ledger'].forEach(t=>{
    const el = document.getElementById('conc-'+t);
    if(el) el.style.display = t===tab ? '' : 'none';
  });
  renderConciliacao();
}

function renderConciliacao(){
  if(!activeClube) return;
  if(_concActiveSub === 'chippix') renderConcChipPix();
  else if(_concActiveSub === 'ofx') renderConcOFX();
  else if(_concActiveSub === 'banks') { _concActiveSub='chippix'; renderConcChipPix(); }
  else if(_concActiveSub === 'ledger') renderConcLedger();
}

function switchAjustesSub(tab, btn){
  document.querySelectorAll('#dn-ajustes .conc-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ajustes-panel-contas').style.display      = tab==='contas'      ? '' : 'none';
  document.getElementById('ajustes-panel-formas').style.display      = tab==='formas'      ? '' : 'none';
  document.getElementById('ajustes-panel-categorias').style.display  = tab==='categorias'  ? '' : 'none';
  if(tab==='contas')      renderConcBanks();
  if(tab==='formas')      renderAjustesFormas();
  if(tab==='categorias')  renderCategorias();
}

function renderAjustes(){
  if(!activeClube) return;
  renderConcBanks();
  renderAjustesFormas();
}

function renderAjustesFormas(){
  const el = document.getElementById('ajustes-formas-content');
  if(!el) return;
  const methods = DataLayer.getPayMethodsAlt();
  let html = '<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:16px;">';
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">';
  html += '<div style="font-size:.8rem;font-weight:700;color:var(--t1);">💳 Formas de Pagamento</div>';
  html += '<button onclick="addPaymentMethod()" style="background:var(--gold-d);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:5px 12px;border-radius:6px;font-size:.68rem;font-weight:600;cursor:pointer;">+ Adicionar</button>';
  html += '</div>';
  methods.forEach((m,i) => {
    html += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--s2);border:1px solid var(--b1);border-radius:6px;margin-bottom:6px;">';
    html += '<span style="font-size:.78rem;color:var(--t1);font-weight:500;">'+m+'</span>';
    html += '<button onclick="removePaymentMethod('+i+')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.7rem;">✕</button>';
    html += '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

function removePaymentMethod(idx){
  const methods = DataLayer.getPayMethodsAlt();
  const removed = methods.splice(idx,1);
  DataLayer.savePayMethodsAlt(methods);
  showToast('✕ Removido: '+removed[0]);
  renderAjustesFormas();
}

// ── Categorias OFX (CRUD) ────────────────────────────────────
function renderCategorias(){
  const el=document.getElementById('ajustes-categorias-content');
  if(!el) return;
  const cats=getTransactionCategories();

  let html='<div style="background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:16px;">';
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">';
  html+='<div style="font-size:.8rem;font-weight:700;color:var(--t1);">🏷️ Categorias de Transação OFX</div></div>';
  html+='<div style="font-size:.65rem;color:var(--t3);margin-bottom:12px;">Categorias padrão do sistema não podem ser excluídas. Adicione categorias personalizadas abaixo.</div>';

  cats.forEach((c,i)=>{
    html+=`<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--s2);border:1px solid var(--b1);border-radius:7px;margin-bottom:6px;">
      <span style="font-size:1rem;">${c.icon}</span>
      <div style="flex:1;">
        <div style="font-size:.76rem;color:var(--t1);font-weight:600;">${c.label}</div>
        <div style="font-size:.6rem;color:${c.color};margin-top:1px;">ID: ${c.id}</div>
      </div>
      ${!c.deletable
        ?'<span style="background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.15);color:#94a3b8;padding:2px 8px;border-radius:4px;font-size:.58rem;font-weight:600;">Sistema</span>'
        :`<button onclick="removerCategoria('${c.id}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.72rem;" title="Excluir">✕</button>`
      }
    </div>`;
  });

  html+=`<div style="border-top:1px solid var(--b1);margin-top:14px;padding-top:14px;">
    <div style="font-size:.7rem;font-weight:600;color:var(--t2);margin-bottom:10px;">➕ Nova Categoria</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:120px;">
        <div style="font-size:.6rem;color:var(--t3);margin-bottom:3px;">Nome</div>
        <input type="text" id="ajcat-nome" placeholder="Ex: Saque..." maxlength="30"
          style="width:100%;background:var(--s2);border:1px solid var(--b2);color:var(--t1);border-radius:6px;padding:7px 10px;font-size:.74rem;box-sizing:border-box;">
      </div>
      <div>
        <div style="font-size:.6rem;color:var(--t3);margin-bottom:3px;">Ícone</div>
        <input type="text" id="ajcat-icon" value="📋" maxlength="2"
          style="width:52px;background:var(--s2);border:1px solid var(--b2);color:var(--t1);border-radius:6px;padding:7px;font-size:.9rem;text-align:center;">
      </div>
      <div>
        <div style="font-size:.6rem;color:var(--t3);margin-bottom:3px;">Cor</div>
        <input type="color" id="ajcat-cor" value="#94a3b8"
          style="width:42px;height:34px;border:1px solid var(--b2);border-radius:6px;cursor:pointer;background:var(--s2);">
      </div>
      <button onclick="adicionarCategoria()" style="background:var(--gold-d);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:7px 16px;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;white-space:nowrap;">Adicionar</button>
    </div>
  </div>`;
  html+='</div>';
  el.innerHTML=html;
}

function adicionarCategoria(){
  const nome=(document.getElementById('ajcat-nome')?.value||'').trim();
  const icon=(document.getElementById('ajcat-icon')?.value||'📋').trim();
  const cor =(document.getElementById('ajcat-cor')?.value||'#94a3b8');
  if(!nome){ showToast('⚠️ Informe o nome da categoria','e'); return; }
  const cats=getTransactionCategories();
  const id='cat_'+nome.toLowerCase().replace(/[^a-z0-9]/g,'_').substr(0,20)+'_'+Date.now().toString(36).substr(-3);
  if(cats.find(c=>c.id===id||c.label.toLowerCase()===nome.toLowerCase())){
    showToast('⚠️ Categoria já existe','e'); return;
  }
  cats.push({ id, label:nome, color:cor, icon:icon||'📋', deletable:true });
  saveTransactionCategories(cats);
  showToast('✅ Categoria "'+nome+'" adicionada');
  renderCategorias();
}

function removerCategoria(id){
  const cats=getTransactionCategories();
  const cat=cats.find(c=>c.id===id);
  if(!cat||!cat.deletable){ showToast('⚠️ Categoria do sistema não pode ser removida','e'); return; }
  if(!confirm('Remover categoria "'+cat.label+'"?')) return;
  saveTransactionCategories(cats.filter(c=>c.id!==id));
  showToast('🗑 Categoria removida');
  renderCategorias();
}

// ── 1. Bank Accounts (CRUD) ──────────────────────────────────
function getBankAccounts(){ return DataLayer.getBankAccounts(); }
function saveBankAccounts(arr){ DataLayer.saveBankAccounts(arr); }

function addBankAccount(){
  const nome = prompt('Nome da conta (ex: Itaú - Clube):');
  if(!nome || !nome.trim()) return;
  const banco = prompt('Banco (ex: Itaú, Sicoob, Inter):') || nome;
  const accs = getBankAccounts();
  const id = nome.trim().toLowerCase().replace(/[^a-z0-9]/g,'_') + '_' + Date.now().toString(36);
  const isDefault = accs.length === 0;
  accs.push({ id, nome: nome.trim(), banco: banco.trim(), apelido: nome.trim(), ativo: true, isDefault });
  saveBankAccounts(accs);
  renderConcBanks();
  showToast(`✅ Conta "${nome.trim()}" adicionada`);
}

function removeBankAccount(id){
  if(!confirm('Remover esta conta bancária?')) return;
  let accs = getBankAccounts().filter(a=>a.id !== id);
  if(accs.length && !accs.some(a=>a.isDefault)) accs[0].isDefault = true;
  saveBankAccounts(accs);
  renderConcBanks();
  showToast('🗑 Conta removida');
}

function setDefaultBank(id){
  const accs = getBankAccounts();
  accs.forEach(a => a.isDefault = (a.id === id));
  saveBankAccounts(accs);
  renderConcBanks();
}

function renderConcBanks(){
  const accs = getBankAccounts();
  const el = document.getElementById('conc-banks-content');
  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-size:.82rem;font-weight:700;color:var(--t1);">⚙️ Contas Bancárias</div>
      <button class="conc-btn conc-btn-link" onclick="addBankAccount()">➕ Nova Conta</button>
    </div>
    ${accs.length ? accs.map(a=>`
      <div class="bank-card">
        <div>
          <div class="bank-name">🏦 ${a.nome}${a.isDefault ? '<span class="bank-default">PADRÃO</span>' : ''}</div>
          <div class="bank-info">Banco: ${a.banco} · ID: ${a.id}</div>
        </div>
        <div class="bank-actions">
          ${!a.isDefault ? `<button onclick="setDefaultBank('${a.id}')">⭐ Padrão</button>` : ''}
          <button onclick="removeBankAccount('${a.id}')" style="color:#ef4444;">✕</button>
        </div>
      </div>
    `).join('') : `
      <div class="cs" style="padding:30px;">
        <div class="ci">🏦</div>
        <h3>Nenhuma conta cadastrada</h3>
        <p style="color:var(--t3);font-size:.78rem;">Cadastre ao menos uma conta para importar OFX.</p>
      </div>
    `}
  `;
}

// ── 2. Movements Ledger ──────────────────────────────────────
function getMovements(){ return DataLayer.getMovements(); }
function saveMovements(arr){ DataLayer.saveMovements(arr); }

function getWeekMovements(weekKey, clube){
  const wk = weekKey || (weeks[selWeekIdx]||'0');
  const cl = clube || activeClube;
  return getMovements().filter(m => m.weekKey === wk && m.clube === cl);
}

function getEntityMovTotal(entityId, weekKey, clube){
  const mvs = getWeekMovements(weekKey, clube);
  return mvs.filter(m=>m.entityId===entityId).reduce((s,m)=> s + (m.dir==='in' ? m.amount : -m.amount), 0);
}

// Anti-duplicate: check method+externalId
function isDuplicateMovement(method, externalId, weekKey, clube){
  if(!externalId) return false; // no externalId = can't check
  const mvs = getWeekMovements(weekKey, clube);
  return mvs.some(m => m.method === method && m.externalId === externalId);
}

// Heuristic warn: same amount + close date + same entity
function findPossibleDuplicate(amount, entityId, dateTs, weekKey, clube){
  const mvs = getWeekMovements(weekKey, clube);
  const TWO_MIN = 2 * 60 * 1000;
  return mvs.find(m =>
    m.entityId === entityId &&
    Math.abs(m.amount - amount) < 0.01 &&
    Math.abs((m.date||0) - dateTs) < TWO_MIN
  );
}

function createMovement(data){
  const {weekKey, entityId, dir, amount, method, bankId, externalId, date, description, clube} = data;
  const wk = weekKey || (weeks[selWeekIdx]||'0');
  const cl = clube || activeClube;

  // Anti-dup by externalId
  if(externalId && isDuplicateMovement(method, externalId, wk, cl)){
    return { ok:false, reason:'duplicate', msg:`Movimento duplicado (${method}:${externalId})` };
  }

  // Heuristic warn (no externalId)
  if(!externalId){
    const dup = findPossibleDuplicate(amount, entityId, date||Date.now(), wk, cl);
    if(dup) return { ok:false, reason:'possible_dup', existing:dup, msg:'Possível duplicata detectada' };
  }

  const mvs = getMovements();
  const mv = {
    id: 'mv_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2,4),
    weekKey: wk,
    clube: cl,
    entityId,
    dir,
    amount: Math.abs(amount),
    method: method || 'manual',
    bankId: bankId || null,
    externalId: externalId || null,
    date: date || Date.now(),
    description: description || '',
    createdAt: Date.now()
  };
  mvs.push(mv);
  saveMovements(mvs);

  // Also write to pm_fin ledger for backward compat with Liquidação
  syncMovementToLedger(mv);

  return { ok:true, movement:mv };
}

function syncMovementToLedger(mv){
  const allData = getFinData();
  const key = mv.clube + '||' + mv.weekKey;
  if(!allData[key]) allData[key] = {};
  if(!allData[key][mv.entityId]) allData[key][mv.entityId] = { historico:[], saldoAberto:0 };

  // Dedup in ledger
  const extKey = mv.method + '_' + (mv.externalId || mv.id);
  if(allData[key][mv.entityId].historico.some(h=>h.fitid === extKey)) return;

  allData[key][mv.entityId].historico.push({
    valor: mv.amount,
    metodo: mv.method === 'chippix' ? 'ChipPix' : mv.method === 'ofx' ? 'PIX' : mv.description || 'Manual',
    dir: mv.dir,
    comp: mv.description,
    ts: mv.date || Date.now(),
    source: 'staging', conciliado: true,
    fitid: extKey,
    origem: mv.method === 'chippix' ? 'ChipPix' : mv.method === 'ofx' ? 'OFX' : 'Manual',
    banco: mv.bankId || '',
    mvId: mv.id
  });

  // Recalc saldoAberto
  const entities = calcFinEntities();
  const e = entities.find(x=>x.id === mv.entityId);
  const sp = getSaldoAnterior(mv.entityId);
  const ledger = FinanceEngine.calcLedgerNet(allData[key][mv.entityId].historico || []);
  allData[key][mv.entityId].saldoAberto = sp + (e ? -(e.valor) : 0) - ledger.net;

  saveFinData(allData);
}

function deleteMovement(mvId){
  let mvs = getMovements();
  const mv = mvs.find(m=>m.id === mvId);
  if(!mv) return;
  mvs = mvs.filter(m=>m.id !== mvId);
  saveMovements(mvs);

  // Also remove from pm_fin ledger
  const allData = getFinData();
  const key = mv.clube + '||' + mv.weekKey;
  if(allData[key]?.[mv.entityId]){
    allData[key][mv.entityId].historico = (allData[key][mv.entityId].historico||[]).filter(h=>h.mvId !== mvId);

    // Recalc saldoAberto com fórmula canônica (mesmo padrão de syncMovementToLedger/remExtratoPag)
    const entities = calcFinEntities();
    const e = entities.find(x => x.id === mv.entityId);
    const sp = getSaldoAnterior(mv.entityId);
    const ledger = FinanceEngine.calcLedgerNet(allData[key][mv.entityId].historico || []);
    const saldo = FinanceEngine.calcSaldoAtual(sp, (e ? -(e.valor) : 0), ledger.net);
    allData[key][mv.entityId].saldoAberto = Math.abs(saldo) < 0.01 ? 0 : saldo;

    saveFinData(allData);
  }
}

// ════════════════════════════════════════════════════════════
// ═══  STAGING LAYER (pré-lançamento)  ═════════════════════
// ════════════════════════════════════════════════════════════
// stagedMovements = items pending confirmation in Financeiro.
// Only after "Aplicar" do they become real movements.
// ════════════════════════════════════════════════════════════

function getStaged(){ return DataLayer.getStaged(); }
function saveStaged(arr){ DataLayer.saveStaged(arr); }

function getWeekStaged(weekKey, clube){
  const wk = weekKey || (weeks[selWeekIdx]||'0');
  const cl = clube || activeClube;
  return getStaged().filter(s => s.weekKey === wk && s.clube === cl);
}

// Anti-dup: check BOTH staged + movements
function isDuplicateStagedOrMov(method, externalId, weekKey, clube){
  if(!externalId) return false;
  const wk = weekKey || (weeks[selWeekIdx]||'0');
  const cl = clube || activeClube;
  // Check movements
  if(isDuplicateMovement(method, externalId, wk, cl)) return 'movement';
  // Check staged (non-rejected)
  const staged = getWeekStaged(wk, cl);
  if(staged.some(s => s.method === method && s.externalId === externalId && s.status !== 'rejected'))
    return 'staged';
  return false;
}

function createStagedMovement(data){
  const {weekKey, entityId, dir, amount, method, bankId, externalId, date, description, clube, cpId} = data;
  const wk = weekKey || (weeks[selWeekIdx]||'0');
  const cl = clube || activeClube;

  // Anti-dup: check both staged + movements
  const dupCheck = isDuplicateStagedOrMov(method, externalId, wk, cl);
  if(dupCheck){
    return { ok:false, reason:'duplicate', where:dupCheck, msg:'Duplicado detectado ('+dupCheck+'): '+method+':'+externalId };
  }

  const all = getStaged();
  const sm = {
    id: 'stg_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2,4),
    weekKey: wk,
    clube: cl,
    entityId,
    dir,
    amount: Math.abs(amount),
    method: method || 'manual',
    bankId: bankId || null,
    externalId: externalId || null,
    date: date || Date.now(),
    description: description || '',
    cpId: cpId || null,
    status: 'staged',
    appliedMovementId: null,
    createdAt: Date.now()
  };
  all.push(sm);
  saveStaged(all);
  return { ok:true, staged:sm };
}

function applyStagedMovement(stagedId){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return false; }
  const all = getStaged();
  const sm = all.find(s=>s.id===stagedId);
  if(!sm || sm.status !== 'staged'){ showToast('⚠️ Item não encontrado ou já processado','e'); return false; }

  // Create real movement via createMovement pipeline
  const result = createMovement({
    weekKey: sm.weekKey,
    clube: sm.clube,
    entityId: sm.entityId,
    dir: sm.dir,
    amount: sm.amount,
    method: sm.method,
    bankId: sm.bankId,
    externalId: sm.externalId,
    date: sm.date,
    description: sm.description
  });

  if(result.ok){
    sm.status = 'applied';
    sm.appliedMovementId = result.movement.id;
    saveStaged(all);

    // Sync CP session flag if ChipPix
    if(sm.method === 'chippix' && sm.cpId){
      const rows = getCPSessao();
      const cpRow = rows.find(r=>r.idJog === sm.cpId);
      if(cpRow){
        cpRow.aplicado = true;
        cpRow.linkedMovementId = result.movement.id;
        saveCPSessao(rows);
      }
    }
    return true;
  } else {
    // Duplicate in movements — mark as applied anyway (data integrity)
    if(result.reason === 'duplicate'){
      sm.status = 'applied';
      saveStaged(all);
    }
    showToast('⚠️ '+result.msg,'e');
    return false;
  }
}

function rejectStagedMovement(stagedId){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const all = getStaged();
  const sm = all.find(s=>s.id===stagedId);
  if(!sm || sm.status !== 'staged') return;
  sm.status = 'rejected';
  saveStaged(all);

  // Unlink from CP session if ChipPix
  if(sm.method === 'chippix' && sm.cpId){
    const rows = getCPSessao();
    const cpRow = rows.find(r=>r.idJog === sm.cpId);
    if(cpRow){
      cpRow.aplicado = false;
      cpRow.locked = false;
      cpRow.linkedMovementId = null;
      cpRow.stagedId = null;
      saveCPSessao(rows);
    }
  }
}

function editStagedMovement(stagedId, changes){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const all = getStaged();
  const sm = all.find(s=>s.id===stagedId);
  if(!sm || sm.status !== 'staged') return;
  if(changes.entityId !== undefined) sm.entityId = changes.entityId;
  if(changes.dir !== undefined) sm.dir = changes.dir;
  if(changes.amount !== undefined) sm.amount = Math.abs(changes.amount);
  if(changes.description !== undefined) sm.description = changes.description;
  saveStaged(all);
}

function applyAllStaged(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const staged = getWeekStaged();
  const pending = staged.filter(s=>s.status==='staged');
  if(!pending.length){ showToast('⚠️ Nenhum item pendente','e'); return; }
  if(!confirm('Aplicar todos os '+pending.length+' lançamentos pendentes?\n\nIsso criará movimentos reais no ledger.')) return;

  let ok=0, fail=0;
  pending.forEach(s=>{
    if(applyStagedMovement(s.id)) ok++;
    else fail++;
  });
  renderFinanceiro();
  renderAgentClosing();
  if(typeof renderConcChipPix==='function') renderConcChipPix();
  showToast('✅ '+ok+' aplicado'+(ok!==1?'s':'')+(fail ? ' · '+fail+' falha'+(fail!==1?'s':'') : ''));
}

// ── 3. Inline ChipPix Rendering ──────────────────────────────
let _concCPFilter = 'todos';
let _concCPSearch = '';

function renderConcChipPix(){
  const el = document.getElementById('conc-cp-content');
  if(!activeClube){ el.innerHTML='<div class="cs"><div class="ci">📂</div><h3>Abra um clube</h3></div>'; return; }

  const rows = getCPSessao();
  const cpPlayers = allPlayers.filter(p=>p.clube===activeClube);

  if(!rows.length){
    el.innerHTML=`
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-size:.82rem;font-weight:700;color:var(--t1);">🎰 Conciliação ChipPix</div>
        <label class="conc-btn conc-btn-link" style="cursor:pointer;">
          📂 Importar ChipPix
          <input type="file" accept=".xlsx,.xls,.csv" onchange="processChipPix(this);setTimeout(renderConcChipPix,500);" style="display:none;">
        </label>
      </div>
      <div class="cs" style="padding:30px;">
        <div class="ci">🎰</div>
        <h3>Nenhum extrato ChipPix carregado</h3>
        <p style="color:var(--t3);font-size:.78rem;">Importe a planilha ChipPix para vincular jogadores automaticamente.</p>
      </div>`;
    return;
  }

  // ── Counts ──
  const vinc   = rows.filter(r=>r.entityId&&!r.ignorado&&!r.aplicado&&!r.locked).length;
  const aplic  = rows.filter(r=>r.aplicado).length;
  const pend   = rows.filter(r=>!r.entityId&&!r.ignorado&&!r.aplicado).length;
  const ign    = rows.filter(r=>r.ignorado).length;
  const locked = rows.filter(r=>r.locked&&!r.aplicado).length;
  const active = rows.filter(r=>!r.ignorado);

  // ── Financial KPIs ──
  const entTot     = active.reduce((s,r)=>s+r.entrada,0);
  const saiTot     = active.reduce((s,r)=>s+r.saida,0);
  const impactoLiq = entTot - saiTot;
  const conciliado = active.filter(r=>r.aplicado).reduce((s,r)=>s+(r.entrada-r.saida),0);
  const pendVal    = active.filter(r=>!r.aplicado).reduce((s,r)=>s+(r.entrada-r.saida),0);

  // Count staging status for applied items
  const weekStaged = getWeekStaged();
  const stagedPending = active.filter(r=>r.aplicado && r.stagedId && weekStaged.some(s=>s.id===r.stagedId&&s.status==='staged')).length;
  const stagedApplied = aplic - stagedPending;

  // ── Lock enforcement ──
  const weekLock   = isWeekLocked();  // FULL lock: week locked = no changes at all
  const hasLocked  = locked > 0 || aplic > 0;
  const disableAll = weekLock;  // week lock overrides everything
  const disImport  = (disableAll || hasLocked) ? 'disabled style="opacity:.4;pointer-events:none;"' : '';
  const disAutoV   = (disableAll || hasLocked) ? 'disabled style="opacity:.4;pointer-events:none;"' : '';
  const disAll     = disableAll ? 'disabled style="opacity:.4;pointer-events:none;"' : '';

  // ── Player dropdown options grouped by agent ──
  const agentGroups = {};
  cpPlayers.forEach(p=>{
    const raw = (p.aname||'').trim();
    const ag = (!raw || /^(none|null|undefined)$/i.test(raw)) ? '(sem agente)' : raw;
    if(!agentGroups[ag]) agentGroups[ag]=[];
    agentGroups[ag].push(p);
  });
  const playerOpts = Object.entries(agentGroups).map(([agKey,players])=>
    '<optgroup label="🤝 '+agKey+'">'
      + players.map(p=>'<option value="pl_'+p.id+'|'+makeEntityId('ag',agKey)+'">'+(p.nick||p.id)+' (ID: '+p.id+')</option>').join('')
    + '</optgroup>'
  ).join('');

  // ── Filter ──
  const q = _concCPSearch.toLowerCase().trim();
  const vis = rows.map((r,i)=>({...r,_idx:i})).filter(r=>{
    if(_concCPFilter==='vinculado') { if(!(r.entityId&&!r.ignorado&&!r.aplicado&&!r.locked)) return false; }
    else if(_concCPFilter==='locked') { if(!(r.locked&&!r.aplicado)) return false; }
    else if(_concCPFilter==='aplicado') { if(!r.aplicado) return false; }
    else if(_concCPFilter==='pendente') { if(!(!r.entityId&&!r.ignorado&&!r.aplicado)) return false; }
    else if(_concCPFilter==='ignorado') { if(!r.ignorado) return false; }
    if(q){
      return String(r.idJog).toLowerCase().includes(q) || (r.nome||'').toLowerCase().includes(q);
    }
    return true;
  });

  const fBtn = (f,lbl,cnt) => '<button class="fin-filter-btn '+(_concCPFilter===f?'active':'')+'" onclick="_concCPFilter=\''+f+'\';renderConcChipPix();">'+lbl+' <span style="opacity:.5;font-size:.6rem;">'+cnt+'</span></button>';

  // ── Dedup check via fitid in ledger ──
  const allData = getFinData();
  const fKey = finKey();

  el.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div style="font-size:.82rem;font-weight:700;color:var(--t1);">🎰 Conciliação ChipPix</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <label class="conc-btn conc-btn-link" style="cursor:pointer;" ${disImport}>
          📂 Importar
          <input type="file" accept=".xlsx,.xls,.csv" onchange="processChipPix(this);setTimeout(renderConcChipPix,500);" style="display:none;" ${hasLocked?'disabled':''}>
        </label>
        <button class="conc-btn conc-btn-link" onclick="reautolinkCP();setTimeout(renderConcChipPix,200);" ${disAutoV}>🔗 Auto-vincular</button>
        ${!disableAll && vinc > 0 ? '<button class="conc-btn" style="background:rgba(240,180,41,.1);border-color:rgba(240,180,41,.25);color:var(--gold);" onclick="lockAllConcCP()">🔒 Lockar ('+vinc+')</button>' : ''}
        ${!disableAll && locked > 0 ? '<button class="conc-btn" style="background:rgba(129,140,248,.1);border-color:rgba(129,140,248,.25);color:#818cf8;" onclick="aplicarChipPixConc()">📌 Enviar Pendentes ('+locked+')</button>' : ''}
        <button class="conc-btn conc-btn-ign" onclick="clearAllConcCPBindings()" title="Limpar todas vinculações" ${disAll}>🗑 Limpar</button>
      </div>
    </div>

    <!-- Financial Impact KPIs -->
    <div class="conc-summary">
      <div class="cs-box"><div class="cs-lbl">Jogadores</div><div class="cs-val">${rows.length}</div></div>
      <div class="cs-box"><div class="cs-lbl">📥 Entradas</div><div class="cs-val" style="color:#10b981;">R$ ${fV(entTot,false)}</div></div>
      <div class="cs-box"><div class="cs-lbl">📤 Saídas</div><div class="cs-val" style="color:#ef4444;">R$ ${fV(saiTot,false)}</div></div>
      <div class="cs-box" style="border-color:${impactoLiq>0?'rgba(16,185,129,.25)':impactoLiq<0?'rgba(239,68,68,.25)':'rgba(74,85,104,.25)'};"><div class="cs-lbl">⚡ Impacto Líquido</div><div class="cs-val" style="color:${clr(impactoLiq)};">R$ ${fV(impactoLiq,false)}</div></div>
      <div class="cs-box"><div class="cs-lbl">📌 Staged</div><div class="cs-val" style="color:#fbbf24;">${stagedPending} <span style="font-size:.55rem;opacity:.6;">pendente${stagedPending!==1?'s':''}</span></div></div>
      <div class="cs-box"><div class="cs-lbl">✔ Aplicado</div><div class="cs-val" style="color:#10b981;">${stagedApplied} <span style="font-size:.55rem;opacity:.6;">(R$ ${fV(conciliado,false)})</span></div></div>
      <div class="cs-box"><div class="cs-lbl">⏳ Não Vinculado</div><div class="cs-val" style="color:#fb923c;">${pend} <span style="font-size:.55rem;opacity:.6;">(R$ ${fV(pendVal,false)})</span></div></div>
    </div>

    ${weekLock ? '<div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:.72rem;color:#ef4444;font-weight:600;">🔒 Semana lockada — todas as alterações estão bloqueadas. Desbloqueie a semana para editar.</div>'
      : hasLocked ? '<div style="background:rgba(240,180,41,.06);border:1px solid rgba(240,180,41,.15);border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:.68rem;color:#fbbf24;">🔒 Sessão parcialmente lockada — importação e auto-vincular desabilitados para proteger integridade dos dados.</div>'
      : ''}

    <!-- Search + Filters -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <input type="text" placeholder="🔍 Buscar por ID ou nome..." value="${_concCPSearch.replace(/"/g,'&quot;')}"
        oninput="_concCPSearch=this.value;clearTimeout(window._ccpSt);window._ccpSt=setTimeout(renderConcChipPix,200);"
        style="background:var(--s2);border:1px solid var(--b1);color:var(--t1);padding:7px 12px;border-radius:8px;font-size:.74rem;width:220px;">
      <div style="display:flex;gap:4px;">
        ${fBtn('todos','Todos',rows.length)}
        ${fBtn('vinculado','✅ Vinculados',vinc)}
        ${fBtn('locked','🔒 Lockados',locked)}
        ${fBtn('aplicado','💳 Aplicados',aplic)}
        ${fBtn('pendente','⏳ Pendentes',pend)}
        ${fBtn('ignorado','🚫 Ignorados',ign)}
      </div>
      <div style="flex:1;"></div>
      <span style="font-size:.66rem;color:var(--t3);">${vis.length} de ${rows.length}</span>
    </div>

    ${vis.length ? `
    <div style="max-height:500px;overflow-y:auto;">
    <table class="tbl">
      <thead><tr>
        <th>ID / Nome</th>
        <th style="text-align:right;">Entrada</th>
        <th style="text-align:right;">Saída</th>
        <th style="text-align:right;">Impacto</th>
        <th>Status</th>
        <th style="text-align:center;">Financeiro</th>
        <th style="min-width:180px;">Vincular a</th>
        <th>Ação</th>
      </tr></thead>
      <tbody>
        ${vis.map(r=>_renderConcCPRow(r, r._idx, cpPlayers, playerOpts, allData, fKey, weekLock)).join('')}
      </tbody>
    </table>
    </div>
    ` : `
    <div class="cs" style="padding:24px;">
      <div class="ci">🔍</div>
      <h3>Nenhum resultado</h3>
      <p style="color:var(--t3);font-size:.78rem;">Ajuste os filtros ou busca</p>
    </div>`}
  `;
}

function _renderConcCPRow(r, idx, cpPlayers, playerOpts, allData, fKey, weekLock){
  const impacto = r.entrada - r.saida;
  const impCor  = impacto>0.01?'#10b981':impacto<-0.01?'#ef4444':'var(--t3)';

  // ── Badge (Status) ──
  let badge = '';
  // Check staging status for badge
  let isStgPending = false;
  if(r.aplicado && r.stagedId){
    const sm = getStaged().find(s=>s.id===r.stagedId);
    if(sm && sm.status==='staged') isStgPending = true;
  }

  if(r.aplicado && isStgPending) badge='<span style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);color:#fbbf24;padding:2px 8px;border-radius:5px;font-size:.6rem;font-weight:700;">📌 Staged</span>';
  else if(r.aplicado) badge='<span class="badge-applied">✔ Aplicado</span>';
  else if(r.locked){
    const pl = _cpFindPlayer(r, cpPlayers);
    badge = '<span style="background:rgba(240,180,41,.1);border:1px solid rgba(240,180,41,.25);color:var(--gold);padding:2px 8px;border-radius:5px;font-size:.6rem;font-weight:700;">🔒 '+(pl||r.entityId)+'</span>';
  }
  else if(r.ignorado) badge='<span style="color:var(--t3);font-size:.68rem;">🚫 Ignorado</span>';
  else if(r.entityId){
    const pl = _cpFindPlayer(r, cpPlayers);
    badge = '<span class="badge-linked">✅ '+(pl||r.entityId)+'</span>';
  }
  else badge='<span class="badge-unlinked">⏳ Pendente</span>';

  // ── Financeiro — check staged → movements → pm_fin (3-layer) ──
  let finCell = '<span style="color:var(--t3);font-size:.68rem;">—</span>';
  if(r.aplicado){
    const cpExtId = 'cp_'+r.idJog;

    // Check staged status
    let inStaged = false, stagedStatus = null;
    if(r.stagedId){
      const sm = getStaged().find(s=>s.id===r.stagedId);
      if(sm){ inStaged = true; stagedStatus = sm.status; }
    }
    if(!inStaged){
      const sm = getStaged().find(s=>s.method==='chippix' && s.externalId===cpExtId && s.status!=='rejected');
      if(sm){ inStaged = true; stagedStatus = sm.status; }
    }

    // Check movements
    let inMvs = false;
    if(r.linkedMovementId){
      inMvs = getMovements().some(m=>m.id===r.linkedMovementId);
    }
    if(!inMvs){
      inMvs = getMovements().some(m=>m.method==='chippix' && m.externalId===cpExtId);
    }

    // Check pm_fin
    let inFin = false;
    const fitKey = 'chippix_'+cpExtId;
    if(allData && allData[fKey]){
      inFin = Object.values(allData[fKey]).some(ent =>
        (ent.historico||[]).some(h => h.fitid === fitKey || h.fitid === cpExtId || h.cpId === r.idJog)
      );
    }

    // Display priority: applied > staged > error
    if(inMvs && inFin)                finCell = '<span style="color:#10b981;font-size:.68rem;font-weight:700;">✔ Aplicado</span>';
    else if(inMvs)                    finCell = '<span style="color:#10b981;font-size:.68rem;font-weight:700;">✔ Mov</span>';
    else if(inStaged && stagedStatus==='staged')
                                      finCell = '<span style="color:#fbbf24;font-size:.68rem;font-weight:700;">📌 Pendente</span>';
    else if(inStaged && stagedStatus==='applied')
                                      finCell = '<span style="color:#10b981;font-size:.68rem;font-weight:700;">✔ Aplicado</span>';
    else if(inStaged && stagedStatus==='rejected')
                                      finCell = '<span style="color:#ef4444;font-size:.68rem;font-weight:700;">🚫 Rejeitado</span>';
    else if(inFin)                    finCell = '<span style="color:#f59e0b;font-size:.68rem;font-weight:700;">⚠ Legado</span>';
    else                              finCell = '<span style="color:#ef4444;font-size:.68rem;font-weight:700;">✕ Erro</span>';
  } else if(r.entityId && !r.ignorado){
    finCell = '<span style="color:var(--t3);font-size:.62rem;">Aguardando</span>';
  }

  // ── Linking dropdown — disabled when week locked ──
  let linkCell = '<span style="color:var(--t3);font-size:.68rem;">—</span>';
  if(!r.aplicado && !r.ignorado && !r.locked && !weekLock){
    const curVal = r.entityId || '';
    let selOpts = playerOpts;
    if(curVal) selOpts = selOpts.replace('value="'+curVal+'"', 'value="'+curVal+'" selected');
    const placeholder = curVal ? '✕ Desvincular' : '— Selecionar jogador —';
    linkCell = '<select class="conc-entity-sel" style="max-width:180px;font-size:.7rem;" onchange="vincConcCP('+idx+',this.value)">'
      + '<option value="">'+placeholder+'</option>'
      + selOpts
      + '</select>';
  } else if(r.locked && !r.aplicado){
    const pl = _cpFindPlayer(r, cpPlayers);
    linkCell = '<span style="font-size:.72rem;font-weight:600;color:var(--gold);">🔒 '+(pl||r.entityId)+'</span>';
  } else if(weekLock && r.entityId && !r.aplicado){
    const pl = _cpFindPlayer(r, cpPlayers);
    linkCell = '<span style="font-size:.72rem;font-weight:600;color:var(--t3);">🔒 '+(pl||r.entityId)+'</span>';
  }

  // ── Action buttons — disabled when week locked ──
  let actBtns = '';
  if(weekLock || r.aplicado){
    actBtns = '<span style="color:var(--t3);font-size:.68rem;">✓</span>';
  } else if(r.ignorado){
    actBtns = '<button class="conc-btn-ign" onclick="ignorarCP('+idx+',false);setTimeout(renderConcChipPix,100);" title="Restaurar">↩</button>';
  } else {
    actBtns = '<button class="conc-btn-ign" onclick="ignorarCP('+idx+',true);setTimeout(renderConcChipPix,100);" title="Ignorar">🚫</button>';
  }

  const rowStyle = r.aplicado?'opacity:.5;':r.ignorado?'opacity:.4;':r.locked?'background:rgba(240,180,41,.02);':'';

  return '<tr style="'+rowStyle+'">'
    + '<td><div style="font-weight:700;color:#60a5fa;font-size:.78rem;">'+r.idJog+'</div><div style="font-size:.66rem;color:var(--t3);">'+r.nome+' · '+r.txns+' ops</div></td>'
    + '<td style="text-align:right;font-family:\'JetBrains Mono\',monospace;font-weight:600;color:#10b981;font-size:.78rem;">+'+fV(r.entrada,false)+'</td>'
    + '<td style="text-align:right;font-family:\'JetBrains Mono\',monospace;font-weight:600;color:'+(r.saida>0?'#ef4444':'var(--t3)')+';font-size:.78rem;">'+(r.saida>0?'-'+fV(r.saida,false):'—')+'</td>'
    + '<td style="text-align:right;font-family:\'JetBrains Mono\',monospace;font-weight:800;color:'+impCor+';font-size:.8rem;">'+(impacto>=0?'+':'')+fV(impacto,false)+'</td>'
    + '<td style="text-align:left;font-family:inherit;">'+badge+'</td>'
    + '<td style="text-align:center;font-family:inherit;">'+finCell+'</td>'
    + '<td style="text-align:left;font-family:inherit;">'+linkCell+'</td>'
    + '<td style="text-align:center;font-family:inherit;"><div style="display:flex;gap:3px;justify-content:center;">'+actBtns+'</div></td>'
    + '</tr>';
}

// Helper: find player display name from entityId
function _cpFindPlayer(r, cpPlayers){
  if(!r.entityId) return null;
  const pp = r.entityId.split('|')[0];
  const pid = pp.replace('pl_','');
  const pl = cpPlayers.find(p=>p.id===pid);
  return pl ? (pl.nick||pl.id) : null;
}

// Vincular jogador ChipPix via dropdown na aba inline
function vincConcCP(idx, entityId){
  if(isWeekLocked()){ showToast('🔒 Semana lockada — alterações bloqueadas','e'); return; }
  const rows = getCPSessao();
  rows[idx].entityId = entityId || null;
  rows[idx].locked = false;
  if(entityId){
    const map = getCPMap();
    map[rows[idx].idJog] = entityId;
    saveCPMap(map);
  }
  saveCPSessao(rows);
  renderConcChipPix();
}

// Lock individual row
function lockConcCP(idx){
  const rows = getCPSessao();
  if(!rows[idx].entityId){ showToast('⚠️ Vincule um jogador primeiro','e'); return; }
  rows[idx].locked = true;
  saveCPSessao(rows);
  renderConcChipPix();
}

// Unlock individual row
function unlockConcCP(idx){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows = getCPSessao();
  rows[idx].locked = false;
  saveCPSessao(rows);
  renderConcChipPix();
}

// Clear individual binding — also removes movement from BOTH ledgers
function clearConcCPBinding(idx){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows = getCPSessao();
  // Remove staged item if exists
  if(rows[idx].stagedId){
    const all = getStaged();
    const sm = all.find(s=>s.id===rows[idx].stagedId);
    if(sm && sm.status==='staged'){ sm.status='rejected'; saveStaged(all); }
  }
  // Remove applied movement if exists
  if(rows[idx].linkedMovementId){
    deleteMovement(rows[idx].linkedMovementId);
  }
  rows[idx].entityId = null;
  rows[idx].locked = false;
  rows[idx].aplicado = false;
  rows[idx].linkedMovementId = null;
  rows[idx].stagedId = null;
  saveCPSessao(rows);
  renderConcChipPix();
  renderFinanceiro();
}

// Resolve CP row entityId → financial entity ID
function _cpResolveEntityId(r){
  if(!r.entityId) return null;
  const plPart = r.entityId.split('|')[0];
  const plId   = plPart.replace(/^pl_/,'');
  const pl     = allPlayers.find(p=> String(p.id).trim()===String(plId).trim() && p.clube===activeClube);
  if(pl && pl.aname)              return makeEntityId('ag', pl.aname.trim());
  if(r.entityId.includes('|'))    return r.entityId.split('|')[1];
  return r.entityId;
}

// Lock ALL currently linked (not yet locked/applied)
function lockAllConcCP(){
  const rows = getCPSessao();
  let cnt = 0;
  rows.forEach(r=>{
    if(r.entityId && !r.ignorado && !r.aplicado && !r.locked){
      r.locked = true;
      cnt++;
    }
  });
  saveCPSessao(rows);
  renderConcChipPix();
  showToast('🔒 '+cnt+' vínculo'+(cnt!==1?'s':'')+' lockado'+(cnt!==1?'s':''));
}

// Clear ALL bindings — removes movements from BOTH pm_movements + pm_fin
function clearAllConcCPBindings(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada — não é possível limpar','e'); return; }
  const rows = getCPSessao();
  const total = rows.filter(r=>r.entityId || r.aplicado).length;
  if(!total){ showToast('⚠️ Nenhum vínculo para limpar','e'); return; }
  const aplicados = rows.filter(r=>r.aplicado).length;
  let msg = 'Limpar todos os '+total+' vínculos?';
  if(aplicados) msg += '\n⚠️ '+aplicados+' com staging/ledger serão removidos.';
  if(!confirm(msg)) return;

  const wk = weeks[selWeekIdx]||'0';

  // 1) Clean staged ChipPix items
  let stg = getStaged();
  stg = stg.filter(s=>!(s.method==='chippix' && s.weekKey===wk && s.clube===activeClube));
  saveStaged(stg);

  // 2) Remove applied movements via deleteMovement (handles BOTH pm_movements + pm_fin)
  rows.forEach(r=>{
    if(r.linkedMovementId) deleteMovement(r.linkedMovementId);
  });

  // 3) Fallback: clean orphaned ChipPix entries from pm_fin + pm_movements
  if(aplicados){
    const allData = getFinData();
    const key = finKey();
    if(allData[key]){
      Object.keys(allData[key]).forEach(eid=>{
        allData[key][eid].historico = (allData[key][eid].historico||[]).filter(h=>h.origem !== 'ChipPix');
      });
      saveFinData(allData);
    }
    let mvs = getMovements();
    mvs = mvs.filter(m=>!(m.method==='chippix' && m.weekKey===wk && m.clube===activeClube));
    saveMovements(mvs);
  }

  let cnt = 0;
  rows.forEach(r=>{
    if(r.entityId || r.aplicado){
      r.entityId = null;
      r.locked = false;
      r.aplicado = false;
      r.linkedMovementId = null;
      r.stagedId = null;
      cnt++;
    }
  });
  saveCPSessao(rows);
  renderConcChipPix();
  if(aplicados){ renderFinanceiro(); renderAgentClosing(); }
  showToast('🗑 '+cnt+' vínculo'+(cnt!==1?'s':'')+' removido'+(cnt!==1?'s':''));
}

// ═══════════════════════════════════════════════════════════════
// aplicarChipPixConc — STAGING PIPELINE
//   Creates stagedMovements (NOT direct movements)
//   User must confirm in Financeiro → Pendentes to apply
// ═══════════════════════════════════════════════════════════════
function aplicarChipPixConc(){
  if(isWeekLocked()){ showToast('🔒 Semana lockada','e'); return; }
  const rows = getCPSessao();
  const lockeds = rows.filter(r=>r.locked && !r.aplicado && r.entityId);
  if(!lockeds.length){ showToast('⚠️ Nenhum vínculo lockado para enviar','e'); return; }
  if(!confirm('Aplicar '+lockeds.length+' pagamento'+(lockeds.length!==1?'s':'')+' na Liquidação?\n\nOs valores serão registrados imediatamente.')) return;

  let staged = 0, dups = 0;

  rows.forEach((r,idx)=>{
    if(!r.locked || !r.entityId || r.ignorado || r.aplicado) return;
    if(r.entrada < 0.01 && r.saida < 0.01) return;

    const eid = _cpResolveEntityId(r);
    if(!eid) return;

    const saldoLiq = r.entrada - r.saida;
    const dir      = saldoLiq >= 0 ? 'in' : 'out';
    const valorLiq = Math.abs(saldoLiq);
    if(valorLiq < 0.01) return;

    const plPart = r.entityId.split('|')[0];
    const plId   = plPart.replace(/^pl_/,'');
    const pl     = allPlayers.find(p=> String(p.id).trim()===String(plId).trim() && p.clube===activeClube);
    const plNome = pl ? (pl.nick||pl.id) : r.nome;

    const result = createMovement({
      weekKey:     weeks[selWeekIdx] || '0',
      clube:       activeClube,
      entityId:    eid,
      dir,
      amount:      valorLiq,
      method:      'chippix',
      externalId:  'cp_'+r.idJog,
      date:        Date.now(),
      description: 'ChipPix · '+plNome+' · ent '+fV(r.entrada,false)+' − saí '+fV(r.saida,false)
    });

    if(result.ok){
      rows[idx].aplicado = true;
      staged++;
    } else if(result.reason === 'duplicate'){
      rows[idx].aplicado = true;
      dups++;
    }
  });

  saveCPSessao(rows);
  renderConcChipPix();
  renderFinanceiro();
  renderFechamentos();

  if(staged > 0)
    showToast('✅ '+staged+' pagamento'+(staged!==1?'s':'')+' aplicado'+(staged!==1?'s':'')+' na Liquidação'+(dups ? ' ('+dups+' dup ignorado'+(dups!==1?'s':'')+')' : ''));
  else if(dups > 0)
    showToast('ℹ️ Todos já existiam (anti-dup)');
  else
    showToast('⚠️ Nenhum lançamento criado','e');
}

// ── 4. Inline OFX Rendering ──────────────────────────────────
let _concOFXBankId = null;

function renderConcOFX(){
  const el = document.getElementById('conc-ofx-content');
  if(!activeClube){ el.innerHTML='<div class="cs"><div class="ci">📂</div><h3>Abra um clube</h3></div>'; return; }
  ensureOFXPicker();

  const allTxns  = getOFXSessao().map(normTx);
  const cats     = getTransactionCategories();
  const locked   = isWeekLocked();

  // ── KPIs ──
  const cntTotal    = allTxns.length;
  const cntConc     = allTxns.filter(t=>t.status==='aplicado').length;
  const cntVinc     = allTxns.filter(t=>t.status==='vinculado').length;
  const cntIgn      = allTxns.filter(t=>t.status==='ignorado').length;
  const cntPend     = allTxns.filter(t=>t.status==='pendente').length;
  const cntNaoClass = allTxns.filter(t=>t.status==='pendente'&&!t.categoria).length;
  const visKPI      = allTxns.filter(t=>t.status!=='ignorado');
  const totIn       = visKPI.filter(t=>t.dir==='in').reduce((s,t)=>s+Math.abs(t.valor),0);
  const totOut      = visKPI.filter(t=>t.dir==='out').reduce((s,t)=>s+Math.abs(t.valor),0);

  // ── Filtro ──
  const srch = (_ofxSearch||'').toLowerCase();
  let vis = allTxns.filter(t=>{
    if(_ofxFilter==='pendente')  return t.status==='pendente';
    if(_ofxFilter==='vinculado') return t.status==='vinculado';
    if(_ofxFilter==='aplicado')  return t.status==='aplicado';
    if(_ofxFilter==='ignorado')  return t.status==='ignorado';
    if(_ofxFilter==='nao-class') return t.status==='pendente'&&!t.categoria;
    if(_ofxFilter&&_ofxFilter!=='todos') return t.categoria===_ofxFilter;
    return true;
  });
  if(srch) vis=vis.filter(t=>
    (t.memo||'').toLowerCase().includes(srch)||
    (t.banco||'').toLowerCase().includes(srch)||
    (t.entityLabel||'').toLowerCase().includes(srch)
  );

  // ── Helpers ──
  const catOpts = cats.map(c=>`<option value="${c.id}">${c.icon} ${c.label}</option>`).join('');

  function buildEntityCell(t){
    const fid=t.fitid.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const cat=t.categoria;
    if(!cat) return '<span style="font-size:.65rem;color:var(--t3);">— selecione categoria —</span>';
    if(cat==='liga') return '<span style="font-size:.65rem;color:#f59e0b;font-weight:600;">🏆 Valor total à Liga</span>';
    if(cat==='despesas'){
      const subOpts=[{v:'software',l:'Software'},{v:'bancario',l:'Bancário'},{v:'pessoal',l:'Pessoal'},
        {v:'infraestrutura',l:'Infra'},{v:'marketing',l:'Marketing'},{v:'outros',l:'Outros'}]
        .map(s=>`<option value="${s.v}" ${t.subcategoria===s.v?'selected':''}>${s.l}</option>`).join('');
      const forn=(t.fornecedor||'').replace(/"/g,'&quot;');
      return `<div style="display:flex;flex-direction:column;gap:3px;">
        <select class="conc-entity-sel" onchange="ofxSetSub('${fid}',this.value)" style="font-size:.63rem;">
          <option value="">Subcategoria...</option>${subOpts}
        </select>
        <input type="text" placeholder="Fornecedor..." value="${forn}"
          style="background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:4px;padding:3px 7px;font-size:.63rem;width:100%;box-sizing:border-box;"
          onblur="ofxSetFornecedor('${fid}',this.value)">
      </div>`;
    }
    // Agentes / Jogadores / Outros / Clubes — usa picker pesquisável
    const opts=getOFXEntityOptions(cat);
    if(!opts.length) return '<span style="font-size:.65rem;color:var(--t3);">—</span>';
    const curEnt=opts.find(e=>e.id===t.entityId);
    const hasEnt=!!curEnt;
    const dispName=curEnt ? curEnt.nome : (t.entityLabel||'— Selecionar —');
    const dispPlatId=curEnt ? (curEnt.platformId||'—') : (t.platformId||'—');
    return `<button onclick="event.stopPropagation();ofxOpenEntityPicker('${fid}','${cat}',this)"
      style="background:${hasEnt?'rgba(129,140,248,.07)':'var(--s2)'};border:1px solid ${hasEnt?'rgba(129,140,248,.2)':'var(--b1)'};color:var(--t2);padding:5px 10px;border-radius:6px;font-size:.68rem;cursor:pointer;width:100%;text-align:left;box-sizing:border-box;line-height:1.4;">
      ${hasEnt
        ?`<div style="font-size:.72rem;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${dispName}</div>
           <div style="font-size:.62rem;color:var(--t3);font-family:'JetBrains Mono',monospace;">${dispPlatId}</div>`
        :`<div style="color:var(--t3);">— Selecionar —</div>`
      }
    </button>`;
  }

  const stBadge={
    pendente: '<span style="background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.2);color:#fb923c;padding:1px 6px;border-radius:4px;font-size:.58rem;font-weight:600;">⏳ Pendente</span>',
    vinculado:'<span style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:1px 6px;border-radius:4px;font-size:.58rem;font-weight:600;">🔗 Vinculado</span>',
    aplicado: '<span style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:#10b981;padding:1px 6px;border-radius:4px;font-size:.58rem;font-weight:600;">✅ Aplicado</span>',
    ignorado: '<span style="background:rgba(100,116,139,.08);border:1px solid rgba(100,116,139,.15);color:#64748b;padding:1px 6px;border-radius:4px;font-size:.58rem;font-weight:600;">🚫 Ignorado</span>',
  };

  function chip(key,label,cnt,rgb){
    const act=_ofxFilter===key;
    return `<button onclick="_ofxFilter='${key}';renderConcOFX()" style="background:${act?`rgba(${rgb},.15)`:'var(--s2)'};border:1px solid ${act?`rgba(${rgb},.35)`:'var(--b1)'};color:${act?`rgb(${rgb})`:'var(--t2)'};padding:4px 10px;border-radius:6px;font-size:.63rem;font-weight:${act?700:500};cursor:pointer;">${label} <span style="opacity:.7;">(${cnt})</span></button>`;
  }

  // ── Linhas da tabela ──
  const trows = vis.length ? vis.map(t=>{
    const fid=t.fitid.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    const corV=t.dir==='in'?'#10b981':'#ef4444';
    const sinal=t.dir==='in'?'+':'−';
    const dtF=new Date(t.dt).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
    const catObj=cats.find(c=>c.id===t.categoria);
    const catBadge=catObj?`<span style="color:${catObj.color};font-size:.6rem;font-weight:600;">${catObj.icon} ${catObj.label}</span>`:'';
    const isLocked=t.status==='aplicado'||t.status==='ignorado';

    // Categoria select (desabilitado se aplicado)
    const catCell=isLocked
      ?catBadge||'<span style="color:var(--t3);font-size:.65rem;">—</span>'
      :`<select class="conc-entity-sel" onchange="ofxSetCategoria('${fid}',this.value)" style="font-size:.63rem;">
          <option value="">— Categoria —</option>${catOpts.replace(`value="${t.categoria||''}"`,`value="${t.categoria||''}" selected`)}
        </select>`;

    // Entidade (desabilitado se aplicado/ignorado)
    const entCell=isLocked
      ?`<span style="font-size:.65rem;color:var(--t3);">${t.entityLabel||'—'}</span>`
      :buildEntityCell(t);

    // Botões de ação
    let acao='';
    if(t.status==='aplicado'){
      acao=locked
        ?`<span title="Semana lockada" style="font-size:.65rem;color:var(--t3);">🔒</span>`
        :`<button onclick="reverterOFX('${fid}')" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#ef4444;padding:3px 8px;border-radius:5px;font-size:.62rem;cursor:pointer;">↩ Reverter</button>`;
    } else if(t.status==='ignorado'){
      acao=`<button onclick="ofxRestaurar('${fid}')" style="background:var(--s2);border:1px solid var(--b1);color:var(--t2);padding:3px 8px;border-radius:5px;font-size:.62rem;cursor:pointer;">↩ Restaurar</button>`;
    } else if(t.status==='vinculado'){
      acao=`<div style="display:flex;gap:4px;align-items:center;">
        <button onclick="aplicarOFX('${fid}')" style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);color:#10b981;padding:3px 9px;border-radius:5px;font-size:.62rem;cursor:pointer;font-weight:700;">✓ Aplicar</button>
        <button onclick="ofxIgnorar('${fid}')" title="Ignorar" style="background:none;border:none;color:var(--t3);cursor:pointer;font-size:.7rem;">🚫</button>
      </div>`;
    } else {
      acao=`<button onclick="ofxIgnorar('${fid}')" title="Ignorar" style="background:none;border:none;color:var(--t3);cursor:pointer;font-size:.7rem;">🚫</button>`;
    }

    const rowStyle=t.status==='ignorado'?'opacity:.42;':t.status==='aplicado'?'opacity:.6;':'';
    return `<tr style="${rowStyle}">
      <td style="white-space:nowrap;font-size:.68rem;color:var(--t3);">${dtF}</td>
      <td style="text-align:left;font-family:inherit;">
        <div style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin-bottom:2px;">
          <span style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.15);color:#60a5fa;padding:1px 5px;border-radius:3px;font-size:.58rem;font-weight:600;">${t.banco||'—'}</span>
          <span style="font-size:.7rem;color:var(--t1);font-weight:500;">${(t.memo||'').substr(0,50)}</span>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;">${stBadge[t.status]||''} ${catBadge}</div>
      </td>
      <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:700;color:${corV};font-size:.76rem;white-space:nowrap;">R$ ${fV(t.valor,false)}</td>
      <td style="min-width:115px;text-align:left;font-family:inherit;">${catCell}</td>
      <td style="min-width:140px;text-align:left;font-family:inherit;">${entCell}</td>
      <td style="text-align:center;white-space:nowrap;">${acao}</td>
    </tr>`;
  }).join('') :
    `<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--t3);font-size:.78rem;">Nenhuma transação neste filtro</td></tr>`;

  el.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div style="font-size:.82rem;font-weight:700;color:var(--t1);">🏦 Conciliação OFX</div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <label class="conc-btn conc-btn-link" style="cursor:pointer;">
          📂 Importar OFX
          <input type="file" accept=".ofx,.OFX" multiple onchange="processOFX(this);setTimeout(renderConcOFX,400);" style="display:none;">
        </label>
        <button class="conc-btn" style="background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.25);color:#10b981;${locked?'opacity:.5;cursor:not-allowed;':''}"
          onclick="ofxAplicarTodos()" ${locked?'disabled':''}>
          ✓ Aplicar Vinculados (${cntVinc})
        </button>
      </div>
    </div>

    ${allTxns.length?`
    <div class="conc-summary">
      <div class="cs-box"><div class="cs-lbl">📄 Transações</div><div class="cs-val">${cntTotal}</div></div>
      <div class="cs-box"><div class="cs-lbl">📥 Entradas</div><div class="cs-val" style="color:#10b981;">R$ ${fV(totIn,false)}</div></div>
      <div class="cs-box"><div class="cs-lbl">📤 Saídas</div><div class="cs-val" style="color:#ef4444;">R$ ${fV(totOut,false)}</div></div>
      <div class="cs-box"><div class="cs-lbl">✅ Conciliados</div><div class="cs-val" style="color:#10b981;">${cntConc}</div></div>
      <div class="cs-box"><div class="cs-lbl">⚠️ Não classif.</div><div class="cs-val" style="color:#fb923c;">${cntNaoClass}</div></div>
    </div>

    <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;align-items:center;">
      ${chip('todos','Todos',cntTotal,'148,163,184')}
      ${chip('pendente','⏳ Pendentes',cntPend,'251,146,60')}
      ${chip('vinculado','🔗 Vinculados',cntVinc,'96,165,250')}
      ${chip('aplicado','✅ Conciliados',cntConc,'16,185,129')}
      ${chip('ignorado','🚫 Ignorados',cntIgn,'100,116,139')}
      ${chip('nao-class','⚠️ Não classif.',cntNaoClass,'251,146,60')}
      <input type="text" placeholder="🔍 Buscar..." value="${_ofxSearch||''}"
        oninput="_ofxSearch=this.value;renderConcOFX()"
        style="background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:6px;padding:4px 10px;font-size:.65rem;width:150px;margin-left:4px;">
    </div>

    <div style="overflow-x:auto;max-height:500px;overflow-y:auto;">
    <table class="tbl" style="min-width:720px;">
      <thead><tr>
        <th>Data</th>
        <th>Banco · Descrição</th>
        <th style="text-align:right;">Valor</th>
        <th>Categoria</th>
        <th>Vincular A</th>
        <th style="text-align:center;">Ações</th>
      </tr></thead>
      <tbody>${trows}</tbody>
    </table>
    </div>
    `:`
    <div class="cs" style="padding:40px;">
      <div class="ci">🏦</div>
      <h3>Nenhum extrato OFX carregado</h3>
      <p style="color:var(--t3);font-size:.78rem;">Importe um arquivo .OFX do seu banco para começar.</p>
    </div>`}
  `;
}

function aplicarOFXConc(){
  // mantido por retrocompatibilidade — redireciona para novo fluxo
  ofxAplicarTodos();
  setTimeout(renderConcOFX, 200);
}

// ── 5. Ledger View ───────────────────────────────────────────
function renderConcLedger(){
  const el = document.getElementById('conc-ledger-content');
  if(!activeClube){ el.innerHTML='<div class="cs"><div class="ci">📂</div><h3>Abra um clube</h3></div>'; return; }

  const wk = weeks[selWeekIdx]||'0';
  const mvs = getWeekMovements(wk, activeClube);
  const entities = calcFinEntities();

  const totalIn  = mvs.filter(m=>m.dir==='in').reduce((s,m)=>s+m.amount,0);
  const totalOut = mvs.filter(m=>m.dir==='out').reduce((s,m)=>s+m.amount,0);

  // Cross-check: get all historico entries with source info
  const allData = getFinData();
  const key = finKey();
  const weekData = allData[key] || {};
  let cntFechamento = 0, cntStaging = 0, cntManual = 0, cntConciliado = 0, cntNaoConciliado = 0;
  let allHist = [];
  Object.entries(weekData).forEach(([entityId, data]) => {
    (data.historico||[]).forEach(h => {
      const src = h.source || (h.fitid ? 'staging' : 'manual');
      const conc = h.conciliado || !!h.fitid;
      if(src === 'fechamento') cntFechamento++;
      else if(src === 'staging') cntStaging++;
      else cntManual++;
      if(conc) cntConciliado++;
      else cntNaoConciliado++;
      const en = entities.find(e=>e.id===entityId);
      allHist.push({ ...h, entityId, entityName: en ? en.nome : entityId, _source: src, _conciliado: conc });
    });
  });
  allHist.sort((a,b) => (b.ts||0) - (a.ts||0));

  // Source badge helper
  const srcBadge = (src) => {
    const map = {
      'fechamento': { bg:'rgba(96,165,250,.1)', border:'rgba(96,165,250,.2)', color:'#60a5fa', label:'Liquidação' },
      'staging':    { bg:'rgba(16,185,129,.08)', border:'rgba(16,185,129,.2)', color:'#10b981', label:'Import' },
      'manual':     { bg:'rgba(240,180,41,.08)', border:'rgba(240,180,41,.2)', color:'var(--gold)', label:'Manual' }
    };
    const s = map[src] || map.manual;
    return '<span style="background:'+s.bg+';border:1px solid '+s.border+';color:'+s.color+';padding:1px 6px;border-radius:3px;font-size:.52rem;font-weight:700;">'+s.label+'</span>';
  };

  const concBadge = (conc) => conc
    ? '<span style="color:#10b981;font-size:.7rem;">✅</span>'
    : '<span style="color:#f59e0b;font-size:.7rem;">⚠️</span>';

  el.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <div style="font-size:.82rem;font-weight:700;color:var(--t1);">📒 Ledger de Movimentações</div>
      <div style="font-size:.7rem;color:var(--t3);">${allHist.length} movimentações · Semana ${fWL(wk)}</div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px;">
      <div style="background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:8px 10px;border-top:2px solid #60a5fa;">
        <div style="font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);">💼 Liquidação</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:800;color:#60a5fa;">${cntFechamento}</div>
      </div>
      <div style="background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:8px 10px;border-top:2px solid #10b981;">
        <div style="font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);">📥 Import</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:800;color:#10b981;">${cntStaging}</div>
      </div>
      <div style="background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:8px 10px;border-top:2px solid ${cntConciliado>0?'#10b981':'#94a3b8'};">
        <div style="font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);">✅ Conciliados</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:800;color:${cntConciliado>0?'#10b981':'var(--t3)'};">${cntConciliado}</div>
      </div>
      <div style="background:var(--s2);border:1px solid var(--b1);border-radius:6px;padding:8px 10px;border-top:2px solid ${cntNaoConciliado>0?'#f59e0b':'#10b981'};">
        <div style="font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--t3);">⚠️ Pendentes</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:800;color:${cntNaoConciliado>0?'#f59e0b':'#10b981'};">${cntNaoConciliado > 0 ? cntNaoConciliado : '✓'}</div>
      </div>
    </div>

    ${allHist.length ? `
    <div style="max-height:400px;overflow-y:auto;">
    <table class="tbl">
      <thead><tr>
        <th>Data</th>
        <th>Entidade</th>
        <th>Método</th>
        <th>Origem</th>
        <th>Dir</th>
        <th style="text-align:right;">Valor</th>
        <th style="text-align:center;">Conc.</th>
      </tr></thead>
      <tbody>
        ${allHist.map(h=>{
          const dtF = new Date(h.ts).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
          const isIn = h.dir==='in';
          return `<tr>
            <td style="font-size:.7rem;color:var(--t3);white-space:nowrap;">${dtF}</td>
            <td style="font-size:.74rem;font-weight:600;text-align:left;font-family:inherit;">${h.entityName}</td>
            <td style="font-size:.68rem;text-align:left;font-family:inherit;">${h.metodo||'—'}</td>
            <td style="text-align:left;font-family:inherit;">${srcBadge(h._source)}</td>
            <td style="color:${isIn?'#10b981':'#60a5fa'};font-weight:700;font-size:.74rem;">${isIn?'↓ IN':'↑ OUT'}</td>
            <td style="text-align:right;font-family:'JetBrains Mono',monospace;font-weight:700;color:${isIn?'#10b981':'#ef4444'};font-size:.8rem;">${isIn?'+':'−'}R$ ${fV(h.valor||0,false)}</td>
            <td style="text-align:center;font-family:inherit;">${concBadge(h._conciliado)}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
    </div>
    ` : `
    <div class="cs" style="padding:30px;">
      <div class="ci">📒</div>
      <h3>Nenhuma movimentação registrada</h3>
      <p style="color:var(--t3);font-size:.78rem;">Registre pagamentos na aba Liquidação ou importe via ChipPix/OFX.</p>
    </div>`}
  `;
}

// ══════════════════ FIM MÓDULO CONCILIAÇÃO ═══════════════════

const agentRB = DataLayer.getAgentRBConfig();
// Estado de expand por agente (apenas visual, não persiste)
const agentExpanded = {};

function saveAgentRB(){
  DataLayer.saveAgentRBConfig(agentRB);
}

function renderAgentClosing(){
  if(!activeClube) return;
  const list = document.getElementById('agent-closing-list');
  const kpiEl = document.getElementById('comp-kpis');
  if(!list) return;

  const cp = allPlayers.filter(p => p.clube === activeClube);
  if(!cp.length){
    list.innerHTML = '<div class="cs"><div class="ci">📂</div><h3>Importe a planilha primeiro</h3></div>';
    if(kpiEl) kpiEl.innerHTML = '';
    return;
  }

  // Agrupa jogadores por agente
  const agentOrder = [], agentMap = {};
  cp.forEach(p => {
    const key = p.aname || '(sem agente)';
    if(!agentMap[key]){ agentMap[key]=[]; agentOrder.push(key); }
    agentMap[key].push(p);
  });

  // (financial data loaded via getEntityLedgerNet — mesma função de calcSettlements)

  // Calcula dados de cada agente
  const agentData = agentOrder.map(agKey => {
    const players    = agentMap[agKey];
    const rakeTime   = players.reduce((s,p)=>s+n(p.rake),0);
    const ganhosTime = players.reduce((s,p)=>s+n(p.ganhos),0);
    const cfg        = agentRB[agKey] || {};
    const pctAgente  = getAgentPctAgente(agKey);
    const avista     = !!cfg.avista;
    const rbAgente   = calcAgentRB(agKey, players);
    const rbPlTotal  = players.reduce((s,p)=>s+(Number(p.rake)||0)*getPlayerPctRB(p)/100, 0);
    const pctPlayerEfetivo = rakeTime > 0 ? (rbPlTotal / rakeTime * 100) : 0;
    const totalResPlayers = players.reduce((s,p)=>
      s + resPlayer(p.ganhos, p.rake, getPlayerPctRB(p), p.ggr), 0);
    const netFinal   = ganhosTime + rbAgente;

    const agEntityId = makeEntityId('ag', agKey);
    const saldoPrev  = getSaldoAnterior(agEntityId);
    const totalDevido = netFinal + saldoPrev;

    // Pagamentos desta semana — usa helper canônico (mesmo de calcSettlements)
    const ledger = getEntityLedgerNet(agEntityId);
    const pago = ledger.net;
    const pendente = totalDevido + pago;

    const isDirect   = !!agentDirect[agKey];
    return { agKey, players, rakeTime, ganhosTime, pctAgente, avista, rbAgente, isDirect,
             rbPlTotal, pctPlayerEfetivo, totalResPlayers, netFinal, saldoPrev, totalDevido,
             pago, pendente, cfg };
  });

  // Sort by absolute value (biggest first) — preserve order on toggle/expand
  if(!window._skipCompSort){
    agentData.sort((a,b) => Math.abs(b.pendente) - Math.abs(a.pendente));
    window._lastCompOrder = agentData.map(d => d.agKey);
  } else if(window._lastCompOrder){
    const orderMap = {};
    window._lastCompOrder.forEach((k,i) => orderMap[k] = i);
    agentData.sort((a,b) => (orderMap[a.agKey]??999) - (orderMap[b.agKey]??999));
  }
  window._skipCompSort = false;

  // Split by direct / normal
  const normalData = agentData.filter(d => !d.isDirect);
  const directData = agentData.filter(d =>  d.isDirect);
  const activeData = _activeCompTab === 'agencias' ? normalData : directData;

  // KPIs
  if(kpiEl){
    const totalAgentes = activeData.length;
    const totalPagar   = activeData.filter(d=>d.pendente<-0.01).reduce((s,d)=>s+Math.abs(d.pendente),0);
    const totalReceber = activeData.filter(d=>d.pendente>0.01).reduce((s,d)=>s+d.pendente,0);
    const kpiStyle = 'background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;text-align:center;';
    const kpiLbl = 'font-size:.52rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--t3);margin-bottom:3px;';
    const kpiVal = "font-family:'JetBrains Mono',monospace;font-size:.92rem;font-weight:800;";
    kpiEl.innerHTML = `
      <div style="${kpiStyle}border-top:2px solid var(--gold);">
        <div style="${kpiLbl}">Agentes</div>
        <div style="${kpiVal}color:var(--t1);">${totalAgentes}</div>
      </div>
      <div style="${kpiStyle}border-top:2px solid #ef4444;">
        <div style="${kpiLbl}">Saldo a Pagar</div>
        <div style="${kpiVal}color:#ef4444;">${totalPagar>0?fV(totalPagar,false):'—'}</div>
      </div>
      <div style="${kpiStyle}border-top:2px solid #10b981;">
        <div style="${kpiLbl}">Saldo a Receber</div>
        <div style="${kpiVal}color:#10b981;">${totalReceber>0?fV(totalReceber,false):'—'}</div>
      </div>`;
  }

  // Tab buttons
  const tabsHtml = `<div style="display:flex;gap:4px;margin-bottom:12px;border-bottom:1px solid var(--b1);padding-bottom:10px;">
    <button class="rb-itab ${_activeCompTab==='agencias'?'rb-itab-active':''}" onclick="switchCompTab('agencias')">🤝 Agências (${normalData.length})</button>
    <button class="rb-itab ${_activeCompTab==='diretos'?'rb-itab-active':''}" onclick="switchCompTab('diretos')">👤 Jogadores (${directData.length})</button>
  </div>`;

  // Cards — single row layout
  list.innerHTML = tabsHtml + activeData.map((d, idx) => {
    const { agKey, players, rakeTime, ganhosTime, pctAgente, avista, rbAgente, isDirect,
            rbPlTotal, pctPlayerEfetivo, totalResPlayers, netFinal, saldoPrev, totalDevido,
            pago, pendente, cfg } = d;
    const agSafe = agKey.replace(/'/g,"\\'");
    const isOpen = agentExpanded[agKey] || false;
    const hasMov = Math.abs(pendente) > 0.01 || Math.abs(totalDevido) > 0.01;
    const exported = window._compExported && window._compExported[agKey];
    const hasSaldo = Math.abs(saldoPrev) > 0.01;
    const hasPago = Math.abs(pago) > 0.01;
    const typeLocked = !!cfg.typeLocked;
    const typePending = !!cfg.typePending;
    const noMov = !hasMov;

    const typeHtml = typeLocked
      ? `<span onclick="event.stopPropagation()"><span class="comp-badge" style="background:${avista?'rgba(16,185,129,.08)':'rgba(239,68,68,.08)'};color:${avista?'#10b981':'#ef4444'};border-color:${avista?'rgba(16,185,129,.15)':'rgba(239,68,68,.15)'};">🔒 ${avista?'À Vista':'Fiado'}</span><button onclick="unlockAgentType('${agSafe}')" class="comp-edit-btn">✎</button></span>`
      : typePending
      ? `<span onclick="event.stopPropagation()"><span class="comp-tog"><button class="comp-tog-btn ${!avista?'sel':''}" onclick="setAgentType('${agSafe}',false)">💳 Fiado</button><button class="comp-tog-btn ${avista?'sel':''}" onclick="setAgentType('${agSafe}',true)">💵 À Vista</button></span><button onclick="confirmAgentType('${agSafe}')" class="comp-ok-btn">✓</button></span>`
      : `<span class="comp-tog" onclick="event.stopPropagation()"><button class="comp-tog-btn ${!avista?'sel':''}" onclick="setAgentType('${agSafe}',false)">💳 Fiado</button><button class="comp-tog-btn ${avista?'sel':''}" onclick="setAgentType('${agSafe}',true)">💵 À Vista</button></span>`;

    return `<div class="comp-card ${noMov?'comp-card-dim':''}" data-result="${pendente < -0.01 ? 'pagar' : pendente > 0.01 ? 'receber' : 'zero'}" data-name="${agKey.toLowerCase()}">
      <div class="comp-row">
        <div class="comp-left">
          <div class="comp-avatar">${isDirect?'👤':'🤝'}</div>
          <div>
            <div class="comp-name-line">
              <span class="comp-name">${agKey}</span>
              ${isDirect ? '<span style="font-size:.48rem;background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.2);color:#60a5fa;padding:1px 5px;border-radius:3px;font-weight:700;">DIRETO</span>' : ''}
              <span class="comp-cnt">${players.length} jog.</span>
            </div>
            <div class="comp-meta">${typeHtml}</div>
          </div>
        </div>
        <div class="comp-vals">
          <div class="comp-v" style="width:90px;">
            <div class="comp-v-lbl">GANHOS</div>
            <div class="comp-v-num ${ganhosTime>0?'vp':ganhosTime<0?'vn':'vz'}">${fV(ganhosTime,false)}</div>
          </div>
          <div class="comp-v" style="width:85px;">
            <div class="comp-v-lbl">${isDirect ? 'RB (Ind.)' : `RB AG. (${pctAgente}%)`}</div>
            <div class="comp-v-num" style="color:${isDirect?'#60a5fa':'#c084fc'};">${rbAgente>0.01?fV(rbAgente,false):'—'}</div>
          </div>
          <div class="comp-v" style="width:85px;">
            <div class="comp-v-lbl">SALDO ANT.</div>
            <div class="comp-v-num" style="color:var(--gold);">${hasSaldo?fV(saldoPrev,false):'—'}</div>
          </div>
          <div class="comp-v" style="width:85px;">
            <div class="comp-v-lbl">PAGO</div>
            <div class="comp-v-num" style="color:#38bdf8;">${hasPago?fV(pago,false):'—'}</div>
          </div>
          <div class="comp-v comp-v-final" style="width:100px;">
            <div class="comp-v-lbl">SALDO</div>
            <div class="comp-v-res ${pendente>0?'vp':pendente<0?'vn':'vz'}">${hasMov ? fV(pendente,false) : '—'}</div>
          </div>
        </div>
        <div class="comp-actions">
          ${hasMov
            ? `<button class="comp-btn-gen" onclick="event.stopPropagation();openAgentPDF('${agSafe}')">${exported?'✅ Comprovante Gerado':'📄 Gerar Comprovante'}</button>`
            : ''}
          <button class="comp-btn-det" onclick="event.stopPropagation();toggleAgentCard('${agSafe}')">
            ${isOpen ? '▲ Recolher' : '▶ Detalhes'}
          </button>
        </div>
      </div>
      ${isOpen ? `<div class="comp-expand">
        <div class="comp-fin">
          <div style="font-size:.65rem;font-weight:700;color:var(--t2);margin-bottom:6px;">🧮 Resumo Financeiro</div>
                    <div class="comp-fin-r"><span>Ganhos/Perdas</span><span class="${ganhosTime>0?'vp':ganhosTime<0?'vn':'vz'}" style="font-weight:700;">${fV(ganhosTime,false)}</span></div>
          <div class="comp-fin-r"><span style="color:var(--t3);">Rake Gerado</span><span style="color:var(--t3);">${fV(rakeTime,false)}</span></div>
          ${isDirect ? `<div class="comp-fin-r"><span>RB Individual (Σ jogadores)</span><span style="color:#60a5fa;font-weight:700;">${fV(rbAgente,false)}</span></div>` : (pctAgente > 0 ? `<div class="comp-fin-r"><span>RB Agente (${pctAgente}%)</span><span style="color:#c084fc;font-weight:700;">${fV(rbAgente,false)}</span></div>` : '')}
          <div class="comp-fin-r" style="border-top:1px solid var(--b1);padding-top:4px;margin-top:3px;"><span style="font-weight:700;">Resultado da Semana</span><span class="${netFinal>0?'vp':netFinal<0?'vn':'vz'}" style="font-weight:800;">${fV(netFinal,false)}</span></div>
          ${hasSaldo ? `<div class="comp-fin-r" style="color:var(--gold);"><span>Saldo Anterior</span><span style="font-weight:700;">${fV(saldoPrev,false)}</span></div>` : ''}
          <div class="comp-fin-r" style="border-top:1px solid var(--b1);padding-top:4px;margin-top:3px;"><span style="font-weight:700;">Total Devido</span><span class="${totalDevido>0?'vp':totalDevido<0?'vn':'vz'}" style="font-weight:800;">${fV(totalDevido,false)}</span></div>
          ${hasPago ? `<div class="comp-fin-r" style="color:#38bdf8;"><span>💳 Pagamentos</span><span style="font-weight:700;">${fV(pago,false)}</span></div>
          <div class="comp-fin-r" style="border-top:2px solid var(--b1);padding-top:4px;margin-top:3px;"><span style="font-weight:800;color:var(--t1);">Saldo Final</span><span class="${pendente>0?'vp':pendente<0?'vn':'vz'}" style="font-weight:900;font-size:.82rem;">${fV(pendente,false)}</span></div>` : ''}
        </div>
        <div style="margin-top:10px;">
          <div style="font-size:.62rem;font-weight:700;color:var(--t2);margin-bottom:4px;">👥 Jogadores (${players.length})</div>
          <div style="overflow-x:auto;">
          <table class="comp-pl">
            <thead><tr><th style="text-align:left;">Nick</th><th style="text-align:left;">ID</th><th style="text-align:right;">P/L</th><th style="text-align:right;">Rake</th><th style="text-align:right;">Resultado</th></tr></thead>
            <tbody>${players.map((p,pi) => {
              const pGanhos = n(p.ganhos);
              const pRes = resPlayer(p.ganhos, p.rake, getPlayerPctRB(p), p.ggr);
              return `<tr style="${pi%2?'background:rgba(255,255,255,.015);':''}"><td style="font-weight:600;">${p.nick||'—'}</td><td style="color:var(--t3);font-size:.58rem;">${p.id||'—'}</td><td style="text-align:right;" class="${pGanhos>0?'vp':pGanhos<0?'vn':'vz'}">${fV(pGanhos,false)}</td><td style="text-align:right;">${fV(n(p.rake),false)}</td><td style="text-align:right;font-weight:700;" class="${pRes>0?'vp':pRes<0?'vn':'vz'}">${fV(pRes,false)}</td></tr>`;
            }).join('')}</tbody>
          </table>
          </div>
        </div>
      </div>` : ''}
    </div>`;
  }).join('');
}

function setAgentType(agKey, avista){
  const prev = agentRB[agKey] || {};
  // Only set pending, don't lock yet
  agentRB[agKey] = { ...prev, avista, typeLocked: false, typePending: true };
  saveAgentRB();
  window._skipCompSort = true;
  renderAgentClosing();
}

function confirmAgentType(agKey){
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, typeLocked: true, typePending: false };
  saveAgentRB();
  window._skipCompSort = true;
  renderAgentClosing();
}

function unlockAgentType(agKey){
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, typeLocked: false, typePending: false };
  saveAgentRB();
  window._skipCompSort = true;
  renderAgentClosing();
}

function lockAgentRB(agKey){
  const agId = agKey.replace(/[^a-zA-Z0-9]/g,'_');
  const inpAgente = document.getElementById('rb-inp-'+agId);
  const pctAgente = parseFloat(inpAgente?.value)||0;
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, pctAgente, pct: pctAgente, locked: true };
  saveAgentRB();
  renderAgentClosing();
}

function setAgentRBDual(agKey, tipo, val){
  const prev = agentRB[agKey] || {};
  const v    = parseFloat(val)||0;
  agentRB[agKey] = { ...prev, pctAgente: v, pct: v };
  saveAgentRB();
  // Re-render suave
  const entities = calcFinEntities();
  const e = entities.find(x=>x.nome===agKey);
  if(e){
    const agId = makeEntityId('ag', agKey);
    const saldoPrev = getSaldoAnterior(agId);
    const movTotal  = getMovTotal(agId);
    const saldoAt   = FinanceEngine.calcSaldoAtual(saldoPrev, -e.valor, movTotal);
    setSaldoAberto(agId, saldoAt);
  }
}
function unlockAgentRB(agKey){
  const prev = agentRB[agKey] || {};
  agentRB[agKey] = { ...prev, locked: false };
  saveAgentRB();
  renderAgentClosing();
  setTimeout(()=>{
    const agId = agKey.replace(/[^a-zA-Z0-9]/g,'_');
    document.getElementById('rb-inp-'+agId)?.focus();
  },50);
}
function filterAgentList(q){
  const term = (q||'').toLowerCase().trim();
  const resultFilter = document.getElementById('comp-filter-result')?.value || 'all';
  document.querySelectorAll('#agent-closing-list .comp-card').forEach(el=>{
    const name = (el.dataset.name||'');
    const result = el.dataset.result||'zero';
    const matchName = !term || name.includes(term);
    const matchResult = resultFilter === 'all' || result === resultFilter;
    el.style.display = (matchName && matchResult) ? '' : 'none';
  });
}

function setAgentRB(agKey, val){
  const prev = agentRB[agKey] || {};
  const v = parseFloat(val)||0;
  agentRB[agKey] = { ...prev, pctAgente: v, pct: v, locked: false };
  saveAgentRB();
  renderAgentClosing();
}

function toggleAgentCard(agKey){
  agentExpanded[agKey] = !agentExpanded[agKey];
  window._skipCompSort = true;
  renderAgentClosing();
}

// ── EXPORTAÇÃO JPG do AGENTE ──
function openAgentPDF(agKey){
  if(!activeClube) return;
  const cp = allPlayers.filter(p=>p.clube===activeClube && p.aname===agKey);
  if(!cp.length) return;

  // Mark as exported
  if(!window._compExported) window._compExported = {};
  window._compExported[agKey] = true;

  const rakeTime   = cp.reduce((s,p)=>s+n(p.rake),0);
  const ganhosTime = cp.reduce((s,p)=>s+n(p.ganhos),0);
  const cfg        = agentRB[agKey] || {};
  const pctAgente  = getAgentPctAgente(agKey); // snapshot-aware
  const avista     = !!cfg.avista;
  const rbAg       = calcAgentRB(agKey, cp);
  const rbPlTotal  = cp.reduce((s,p)=>s+(Number(p.rake)||0)*getPlayerPctRB(p)/100, 0);
  const pctPlayerEfetivo = rakeTime > 0 ? (rbPlTotal / rakeTime * 100) : 0;
  const totalResPlayers = cp.reduce((s,p)=>s+resPlayer(p.ganhos,p.rake,getPlayerPctRB(p),p.ggr),0);
  const resultadoFinal  = ganhosTime + rbAg;

  // Fórmula de liquidação: pendente = totalDevido + pago (mesma de calcSettlements)
  const agId      = makeEntityId('ag', agKey);
  const saldoPrev = getSaldoAnterior(agId);
  const ledger    = getEntityLedgerNet(agId);
  const totalDevido = resultadoFinal + saldoPrev;
  const pago      = ledger.net;
  const pendente  = totalDevido + pago;
  const allData   = getFinData();
  const hist      = allData[finKey()]?.[agId]?.historico || [];
  const statusPag = Math.abs(pendente) < 0.01 ? 'pago' : Math.abs(pago) > 0.01 ? 'parcial' : 'aberto';

  const week  = weeks[selWeekIdx] ? fW(weeks[selWeekIdx]) : '—';
  const clube = activeClube;
  const m     = CMETA[clube]||{};

  const fmtA = v => (v<0?'-':'')+'R$ '+fV(Math.abs(v),false);
  const clrV = v => v>=0?'#16a34a':'#dc2626';
  const clrStatus = statusPag==='pago'?'#16a34a':statusPag==='parcial'?'#d97706':'#6b7280';
  const lblStatus = statusPag==='pago'?'✅ Quitado':statusPag==='parcial'?'◑ Parcialmente pago':'⏳ Em aberto';

  const html = `
  <div class="pdf-doc" id="pdf-capture">
    <div class="pdf-header-doc">
      <!-- Logo e nome do clube em destaque -->
      <div style="display:flex;align-items:center;gap:12px;">
        ${clubLogos[clube]
          ? `<img src="${clubLogos[clube]}" style="width:48px;height:48px;border-radius:10px;object-fit:cover;">`
          : `<div style="width:48px;height:48px;border-radius:10px;background:#1e2538;display:flex;align-items:center;justify-content:center;font-size:1.6rem;">${m.icon}</div>`
        }
        <div>
          <div style="font-size:1.2rem;font-weight:900;color:#111;letter-spacing:-.5px;">${clube}</div>
          <div style="font-size:.72rem;color:#888;font-weight:500;margin-top:1px;">Fechamento Semanal</div>
        </div>
      </div>
      <div class="pdf-period">
        <div style="font-weight:700;font-size:.85rem;color:#333">📅 ${week}</div>
      </div>
    </div>

    <div class="pdf-agent-title">🤝 ${agKey}</div>
    <div class="pdf-agent-sub">Extrato de fechamento · ${cp.length} jogador${cp.length!==1?'es':''} · ${avista?'À Vista':'Fiado'}</div>

    <!-- Player Breakdown Table -->
    <div style="margin-top:16px;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;">
      <table style="width:100%;border-collapse:collapse;font-size:.72rem;">
        <thead>
          <tr style="background:#f1f5f9;">
            <th style="padding:6px 10px;text-align:left;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">Jogador</th>
            <th style="padding:6px 8px;text-align:left;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">ID</th>
            <th style="padding:6px 8px;text-align:right;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">P/L</th>
            <th style="padding:6px 8px;text-align:right;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">Rake</th>
            ${cp.some(p=>n(p.ggr)!==0)?'<th style="padding:6px 8px;text-align:right;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">GGR</th>':''}
            <th style="padding:6px 8px;text-align:right;font-size:.55rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;">Resultado</th>
          </tr>
        </thead>
        <tbody>
          ${cp.map((p,pi) => {
            const pRake = n(p.rake);
            const pPct = getPlayerPctRB(p);
            const pGGR = n(p.ggr);
            const pGanhos = n(p.ganhos);
            const pRes = resPlayer(p.ganhos, p.rake, pPct, p.ggr);
            return `<tr style="border-top:1px solid #f1f5f9;${pi%2?'background:#fafbfc;':''}">
              <td style="padding:5px 10px;font-weight:600;color:#111;">${p.nick||'—'}</td>
              <td style="padding:5px 8px;color:#94a3b8;font-family:'Courier New',monospace;font-size:.65rem;">${p.id||'—'}</td>
              <td style="padding:5px 8px;text-align:right;font-family:'Courier New',monospace;color:${clrV(pGanhos)};font-weight:600;">${fmtA(pGanhos)}</td>
              <td style="padding:5px 8px;text-align:right;font-family:'Courier New',monospace;color:#16a34a;">${fV(pRake,false)}</td>
              ${cp.some(pp=>n(pp.ggr)!==0)?`<td style="padding:5px 8px;text-align:right;font-family:'Courier New',monospace;color:${clrV(pGGR)};">${pGGR!==0?fmtA(pGGR):'—'}</td>`:''}
              <td style="padding:5px 8px;text-align:right;font-family:'Courier New',monospace;font-weight:700;color:${clrV(pRes)};">${fmtA(pRes)}</td>
            </tr>`;
          }).join('')}
        </tbody>
        <tfoot>
          <tr style="border-top:2px solid #e2e8f0;background:#f8fafc;">
            <td style="padding:6px 10px;font-weight:800;color:#111;" colspan="2">TOTAL</td>
            <td style="padding:6px 8px;text-align:right;font-family:'Courier New',monospace;font-weight:800;color:${clrV(ganhosTime)};">${fmtA(ganhosTime)}</td>
            <td style="padding:6px 8px;text-align:right;font-family:'Courier New',monospace;font-weight:800;color:#16a34a;">${fV(rakeTime,false)}</td>
            ${cp.some(p=>n(p.ggr)!==0)?`<td style="padding:6px 8px;text-align:right;font-family:'Courier New',monospace;font-weight:800;color:${clrV(cp.reduce((s,p)=>s+n(p.ggr),0))};">${fmtA(cp.reduce((s,p)=>s+n(p.ggr),0))}</td>`:''}
            <td style="padding:6px 8px;text-align:right;font-family:'Courier New',monospace;font-weight:800;color:${clrV(totalResPlayers)};">${fmtA(totalResPlayers)}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Valores calculados -->
    <div class="pdf-totals" style="margin-top:20px;">
      ${avista ? '' : `<div class="pdf-total-row">
          <span class="pdf-total-label">Ganhos / Perdas dos Jogadores</span>
          <span class="pdf-total-val" style="color:${clrV(ganhosTime)}">${fmtA(ganhosTime)}</span>
        </div>`}
      <div class="pdf-total-row">
        <span class="pdf-total-label" style="color:#aaa;font-style:italic;">Rake Gerado <span style="font-size:.7rem;">(informativo)</span></span>
        <span class="pdf-total-val" style="color:#aaa;">R$ ${fV(rakeTime,false)}</span>
      </div>
      ${pctAgente>0?`<div class="pdf-total-row">
        <span class="pdf-total-label">RB Agente (${pctAgente}% do Rake)</span>
        <span class="pdf-total-val" style="color:#7c3aed;">R$ ${fV(rbAg,false)}</span>
      </div>`:''}
      ${Math.abs(saldoPrev)>0.01?`
      <div class="pdf-total-row" style="color:#b45309;">
        <span class="pdf-total-label">⚠ Saldo semana anterior</span>
        <span class="pdf-total-val" style="color:#b45309;">${fmtA(saldoPrev)}</span>
      </div>`:''}
      <div class="pdf-total-row" style="margin-top:8px;border-top:2px solid #e2e8f0;padding-top:8px;">
        <span style="font-weight:800;color:#111;">
          ${Math.abs(saldoPrev)>0.01 ? 'Total com Saldo' : 'Resultado Final'}
        </span>
        <span class="pdf-total-val" style="font-size:1.1rem;color:${clrV(totalDevido)};font-weight:900;">
          ${fmtA(totalDevido)}
        </span>
      </div>
      ${Math.abs(saldoPrev)>0.01?`<div class="pdf-total-row" style="margin-top:2px;">
        <span class="pdf-total-label" style="color:#aaa;font-size:.68rem;font-style:italic;">Resultado da semana: ${fmtA(resultadoFinal)}</span>
      </div>`:''}
    </div>

    <!-- Pagamentos realizados -->
    ${hist.length > 0 ? `
    <div style="margin-top:14px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
      <div style="background:#f1f5f9;padding:8px 14px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:#64748b;display:flex;justify-content:space-between;">
        <span>💳 Pagamentos Registrados</span>
        <span style="color:${clrStatus}">${lblStatus}</span>
      </div>
      ${hist.map(h=>{
        const dt = new Date(h.ts).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
        const origem = h.origem==='OFX'?' · via OFX':'';
        const dirLabel = h.dir==='out' ? '−' : '+';
        const dirColor = h.dir==='out' ? '#dc2626' : '#16a34a';
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 14px;border-top:1px solid #e5e7eb;font-size:.78rem;">
          <div>
            <span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:5px;font-size:.68rem;font-weight:700;margin-right:8px;">${h.metodo}</span>
            <span style="color:#64748b;font-size:.7rem;">${dt}${origem}</span>
            ${h.comp&&!h.comp.startsWith('data:image')?`<span style="color:#94a3b8;font-size:.68rem;margin-left:6px;">— ${h.comp.substring(0,35)}${h.comp.length>35?'…':''}</span>`:''}
          </div>
          <span style="font-family:'Courier New',monospace;font-weight:700;color:${dirColor};">${dirLabel}R$ ${fV(h.valor,false)}</span>
        </div>`;
      }).join('')}
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 14px;background:#f8fafc;border-top:2px solid #e5e7eb;">
        <div style="font-size:.78rem;">
          <span style="font-weight:700;color:#111;">Saldo atual:</span>
        </div>
        <span style="font-family:'Courier New',monospace;font-weight:900;font-size:.95rem;color:${clrStatus};">
          ${Math.abs(pendente)<0.01 ? '✅ Quitado' : (pendente<0?'R$ '+fV(Math.abs(pendente),false)+' a pagar':'R$ '+fV(pendente,false)+' a receber')}
        </span>
      </div>
    </div>` : ''}

    <div class="pdf-footer-doc">${clube} · Gerado em ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</div>
  </div>`;

  document.getElementById('pdf-doc-render').innerHTML = html;
  window._pdfAgentKey = agKey;
  document.getElementById('pdf-modal').classList.add('open');
}

function downloadAgentImage(){
  const el = document.getElementById('pdf-capture');
  if(!el || typeof html2canvas === 'undefined'){
    showToast('⚠️ Biblioteca de captura não disponível');
    return;
  }
  html2canvas(el, {scale:2, backgroundColor:'#fff', useCORS:true}).then(canvas=>{
    const link = document.createElement('a');
    link.download = `extrato_${(window._pdfAgentKey||'agente').replace(/[^a-zA-Z0-9]/g,'_')}_${activeClube}.jpg`;
    link.href = canvas.toDataURL('image/jpeg', 0.95);
    link.click();
    showToast('✅ Extrato salvo como JPG!');
    renderAgentClosing();
  });
}

function exportAllAgentsPDF(){
  if(!activeClube){ showToast('⚠️ Abra um clube primeiro'); return; }
  const cp = allPlayers.filter(p=>p.clube===activeClube);
  const agents = [...new Set(cp.map(p=>p.aname||'(sem agente)'))];
  if(!agents.length){ showToast('⚠️ Nenhum agente encontrado'); return; }
  if(typeof html2canvas === 'undefined'){ showToast('⚠️ Biblioteca de captura não disponível'); return; }

  showToast(`📄 Exportando ${agents.length} extratos...`);
  let idx = 0;
  function next(){
    if(idx >= agents.length){ showToast(`✅ ${agents.length} extratos exportados!`); return; }
    openAgentPDF(agents[idx]);
    setTimeout(()=>{
      const el = document.getElementById('pdf-capture');
      if(el){
        html2canvas(el,{scale:2,backgroundColor:'#fff',useCORS:true}).then(canvas=>{
          const link = document.createElement('a');
          link.download = `extrato_${(agents[idx]||'agente').replace(/[^a-zA-Z0-9]/g,'_')}_${activeClube}.jpg`;
          link.href = canvas.toDataURL('image/jpeg', 0.95);
          link.click();
          idx++;
          setTimeout(next, 400);
        });
      } else { idx++; next(); }
    }, 300);
  }
  next();
}

// ══════════════════ UNLINKED ══════════════════
function checkUnlinkedOv(){
  const n=allPlayers.filter(p=>p.clube==='?').length;
  document.getElementById('unl-bar-ov').style.display=n>0?'flex':'none';
  document.getElementById('unl-count-ov').textContent=n;
  document.getElementById('ov-unk').textContent=n;
  checkIgnoredAgents();
  updateSidebar();
}
function checkUnlinkedClub(){
  if(!activeClube)return;
  const cp=allPlayers.filter(p=>p.clube===activeClube);
  const n=cp.filter(p=>p.clube==='?').length;
  document.getElementById('unl-bar-club').style.display=n>0?'flex':'none';
  document.getElementById('unl-count-club').textContent=n;
}

// ── Agentes Ignorados ─────────────────────────────────────────────────
function checkIgnoredAgents() {
  const ignored = DataLayer.getIgnoredAgents();
  const count   = Object.keys(ignored).length;
  const bar     = document.getElementById('ignored-bar');
  const cnt     = document.getElementById('ignored-count');
  if (bar) bar.style.display = count > 0 ? 'flex' : 'none';
  if (cnt) cnt.textContent   = count;
}

function openIgnoredPanel() {
  const panel = document.getElementById('ignored-panel');
  const list  = document.getElementById('ignored-list');
  if (!panel || !list) return;
  const ignored = DataLayer.getIgnoredAgents();
  if (Object.keys(ignored).length === 0) {
    list.innerHTML = '<div style="font-size:.65rem;color:var(--t3);padding:6px 0;">Nenhum agente ignorado.</div>';
  } else {
    let html = '';
    Object.entries(ignored).forEach(([agentId, data]) => {
      const dt = data.ignoredAt ? new Date(data.ignoredAt).toLocaleDateString('pt-BR') : '';
      html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--b1);">';
      html += '<div style="flex:1;">';
      html += '<div style="font-size:.67rem;font-weight:600;color:var(--t1);">'+data.agentName+'</div>';
      html += '<div style="font-size:.55rem;color:var(--t3);">ID '+agentId+(dt?' · ignorado em '+dt:'')+'</div>';
      html += '</div>';
      html += '<button onclick="reativarAgent(\''+agentId+'\')" style="font-size:.6rem;padding:3px 10px;border-radius:5px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#10b981;cursor:pointer;font-weight:700;">Reativar</button>';
      html += '</div>';
    });
    list.innerHTML = html;
  }
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function reativarAgent(agentId) {
  const ignored = DataLayer.getIgnoredAgents();
  const name    = (ignored[agentId] || {}).agentName || agentId;
  DataLayer.unignoreAgent(agentId);
  showToast('✅ Agente "'+name+'" reativado — será classificado na próxima importação');
  checkIgnoredAgents();
  openIgnoredPanel(); // re-render panel
}

// ══════════════════ LINK ══════════════════
function openLink(idx){
  pendingLinkIdx=idx;selOpt=null;
  const p=allPlayers[idx];
  document.getElementById('ml-id').textContent='ID: '+(p.id||'—');
  document.getElementById('ml-nick').textContent='Nick: '+(p.nick||'—');
  document.getElementById('ml-agent').textContent=p.aname||'—';
  document.querySelectorAll('.co').forEach(o=>o.classList.remove('sel'));
  document.getElementById('mLink').classList.add('open');
}
function pickOpt(el){document.querySelectorAll('.co').forEach(o=>o.classList.remove('sel'));el.classList.add('sel');selOpt=el.dataset.opt;}
function confirmLink(){
  if(!selOpt||pendingLinkIdx===null){showToast('Selecione um clube!','e');return;}
  const agentName = allPlayers[pendingLinkIdx].aname;
  // Salva por agente — reclassifica todos com mesmo nome de agente
  saveManualLink(String(agentName).toUpperCase().trim(), selOpt);
  closeM('mLink');
  filteredAll=[...allPlayers];renderAllTable();
  if(activeClube){filteredClub=allPlayers.filter(p=>p.clube===activeClube);renderClubTable();}
  checkUnlinkedOv();updateSidebar();
  renderOverview();
  const unk = allPlayers.filter(p=>p.aname.toUpperCase().trim()===String(agentName).toUpperCase().trim()).length;
  showToast(`✅ ${agentName} → ${selOpt} (${unk} jogador${unk!==1?'es':''} reclassificado${unk!==1?'s':''})`);
}

// BULK
function openBulk(){buildBulkList(allPlayers.filter(p=>p.clube==='?'));}
function openBulkClub(){buildBulkList(allPlayers.filter(p=>p.clube==='?'));}
function buildBulkList(unk){
  document.getElementById('bulkSub').textContent=`${unk.length} jogadores sem classificação:`;
  const list=document.getElementById('bulkList');
  list.innerHTML=unk.map(p=>{
    const ri=allPlayers.indexOf(p);
    return`<div style="background:var(--s2);border:1px solid var(--b1);border-radius:9px;padding:10px 12px;margin-bottom:7px;" id="bl-${ri}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
        <div>
          <span style="font-family:'JetBrains Mono',monospace;color:var(--gold);font-size:.8rem;font-weight:600">${p.id||'—'}</span>
          <span style="color:var(--t2);font-size:.78rem;margin-left:7px">${p.nick}</span>
          <span style="color:var(--t3);font-size:.72rem;margin-left:5px">· ${p.aname||'—'}</span>
        </div>
        <span id="bls-${ri}" style="font-size:.73rem;color:var(--t3)">Pendente</span>
      </div>
      <div style="display:flex;gap:5px;flex-wrap:wrap;">
        ${CLUBS.map(c=>{const m=CMETA[c];return`<button onclick="bulkLink(${ri},'${c}')" 
          style="background:var(--s3);border:1px solid var(--b2);color:var(--t2);padding:4px 10px;border-radius:12px;cursor:pointer;font-size:.73rem;font-family:'Outfit',sans-serif"
          onmouseover="this.style.color='var(--gold)';this.style.borderColor='var(--gold)'"
          onmouseout="this.style.color='var(--t2)';this.style.borderColor='var(--b2)'">${m.icon} ${c}</button>`;}).join('')}
      </div>
    </div>`;
  }).join('');
  document.getElementById('mBulk').classList.add('open');
}
function bulkLink(idx,clube){
  const agentName = allPlayers[idx].aname;
  saveManualLink(String(agentName).toUpperCase().trim(), clube);
  const row=document.getElementById(`bl-${idx}`);
  if(row){row.style.opacity='.4';row.style.pointerEvents='none';}
  const s=document.getElementById(`bls-${idx}`);
  if(s){s.textContent='✓ '+clube;s.style.color='var(--green)';}
  filteredAll=[...allPlayers];renderAllTable();
  if(activeClube){filteredClub=allPlayers.filter(p=>p.clube===activeClube);renderClubTable();}
  checkUnlinkedOv();updateSidebar();
}

// EXPORTS
function exportAll(){
  if(!allPlayers.length){showToast('Nenhum dado!','e');return;}
  csvDl(filteredAll,`todos_clubes_${fW(weeks[selWeekIdx]).replace(/ /g,'').replace(/→/g,'-')}.csv`);
}
function exportClub(){
  if(!activeClube){return;}
  const data=allPlayers.filter(p=>p.clube===activeClube);
  if(!data.length){showToast('Clube sem jogadores!','e');return;}
  csvDl(data,`${activeClube}_${fW(weeks[selWeekIdx]).replace(/ /g,'').replace(/→/g,'-')}.csv`);
}
// INIT
window.addEventListener('DOMContentLoaded', ()=>{ applyLogosEverywhere(); });
initWeeks();
</script>
</body>
</html>
